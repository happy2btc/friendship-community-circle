import"./modulepreload-polyfill-B5Qt9EMX.js";import{s as d}from"./supabase-vDZkBp_j.js";const E="site_visit_recorded_date",R="site_visits_local",x="visitor_id_v1";async function O(){try{const t=new Date().toISOString().slice(0,10);let c=localStorage.getItem(x);if(!c){try{c=crypto&&crypto.randomUUID?crypto.randomUUID():"v-"+Date.now()+"-"+Math.floor(Math.random()*1e6)}catch{c="v-"+Date.now()+"-"+Math.floor(Math.random()*1e6)}localStorage.setItem(x,c)}if(localStorage.getItem(E)===t)return;const u=document.referrer||null,m=window.location.href||null,f=new URLSearchParams(window.location.search||""),p=f.get("utm_source"),l=f.get("utm_medium"),a=f.get("utm_campaign");try{await d.from("site_visits").insert([{path:window.location.pathname,user_agent:navigator.userAgent,visitor_id:c,referrer:u,landing_url:m,utm_source:p,utm_medium:l,utm_campaign:a}]),localStorage.setItem(E,t);return}catch(r){console.warn("site_visits insert failed, saving locally",r)}try{const r=JSON.parse(localStorage.getItem(R)||"[]");r.unshift({id:"local-"+Date.now(),visitor_id:c,path:window.location.pathname,user_agent:navigator.userAgent,referrer:document.referrer||null,landing_url:window.location.href||null,utm_source:p,utm_medium:l,utm_campaign:a,created_at:new Date().toISOString()}),localStorage.setItem(R,JSON.stringify(r.slice(0,1e3))),localStorage.setItem(E,t)}catch(r){console.warn("local site_visits save failed",r)}}catch(_){console.warn("recordVisitOncePerDay general error",_)}}async function C(){const _=document.getElementById("visits-today-banner")||document.getElementById("visits-today"),t=document.getElementById("visits-week-banner")||document.getElementById("visits-week");if(!_||!t)return;const c=new Date,u=new Date(c.getFullYear(),c.getMonth(),c.getDate()).toISOString(),m=new Date(c.getTime()-10080*60*1e3).toISOString();try{const f=await d.from("site_visits").select("id",{count:"exact"}).gte("created_at",u),p=await d.from("site_visits").select("id",{count:"exact"}).gte("created_at",m);if(f.error||p.error)throw new Error("db count error");const l=f.count??0,a=p.count??0;_.textContent=String(l),t.textContent=String(a);return}catch{try{const p=JSON.parse(localStorage.getItem(R)||"[]");let l=0,a=0;for(const r of p)r.created_at&&(r.created_at>=u&&l++,r.created_at>=m&&a++);_.textContent=String(l||"—"),t.textContent=String(a||"—")}catch(p){console.warn("loadVisitCounts fallback failed",p);try{_&&(_.textContent="—"),t&&(t.textContent="—")}catch{}}}}(async()=>(await O(),await C()))();const A=document.getElementById("sync-visits-btn");document.getElementById("sync-status");if(A){let c=function(l){return l?String(l).replace(/[&<>"]/g,a=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[a]):""},u=function(l){const a=Date.now(),r=a-10080*60*1e3,i=(l||t||[]).filter(s=>{if(!s.created_at)return!1;const n=new Date(s.created_at).getTime();return n>=r&&n<=a});if(_.innerHTML="",!i.length){_.innerHTML='<div class="empty">No recent activity in the last 7 days.</div>';return}for(const s of i){const n=document.createElement("div");n.className="ann",n.innerHTML=`<div class="activity-item"><div class="activity-left"><div style="font-weight:700">${c(s.action||"Action")}</div><div style="margin-top:6px">${c(s.meta||"")}</div></div><div class="activity-right"><div>${c(s.display_name||"Member")}</div><div class="meta">${s.points?"+"+c(String(s.points))+" pts":""}${s.created_at?" • "+c(new Date(s.created_at).toLocaleString()):""}</div></div></div>`,_.appendChild(n)}},f=function(l,a,r){if(!a)return null;const i=Date.now(),s=i-10080*60*1e3;let n=null;switch(l){case"event_attendance":return n=a.created_at?new Date(a.created_at).getTime():null,!a.user_id||n===null||n<s||n>i?null:{display_name:r[a.user_id]||a.user_id,action:"Attended an event",meta:"",points:5,created_at:a.created_at};case"agreement_votes":return n=a.created_at?new Date(a.created_at).getTime():null,!a.voter_id||n===null||n<s||n>i?null:{display_name:r[a.voter_id]||a.voter_id,action:"Voted",meta:"",points:1,created_at:a.created_at};case"suggestions":return n=a.created_at?new Date(a.created_at).getTime():null,!a.author_id||n===null||n<s||n>i?null:{display_name:r[a.author_id]||a.author_id,action:"Suggested",meta:a.title?`Suggestion: ${a.title}`:"Submitted a suggestion",points:1,created_at:a.created_at};case"comments":return n=a.created_at?new Date(a.created_at).getTime():null,!a.author_id||n===null||n<s||n>i?null:{display_name:r[a.author_id]||a.author_id,action:"Commented",meta:a.reply_text?a.reply_text.slice(0,120):"Commented",points:1,created_at:a.created_at};case"celebrations":return n=a.created_at?new Date(a.created_at).getTime():null,!a.user_id||n===null||n<s||n>i?null:{display_name:r[a.user_id]||a.user_id,action:"Posted on Celebration Wall",meta:"",points:5,created_at:a.created_at};case"events":return n=a.created_at?new Date(a.created_at).getTime():null,!a.created_by||n===null||n<s||n>i?null:{display_name:r[a.created_by]||a.created_by,action:"Created event",meta:"",points:5,created_at:a.created_at};case"group_projects":return n=a.created_at?new Date(a.created_at).getTime():null,!a.proposer_id||n===null||n<s||n>i?null:{display_name:r[a.proposer_id]||a.proposer_id,action:"Proposed a project",meta:"",points:5,created_at:a.created_at};case"writers_wall":return n=a.created_at?new Date(a.created_at).getTime():null,!(a.author_id||a.author_name)||n===null||n<s||n>i?null:{display_name:a.author_id&&r[a.author_id]||a.author_name||a.author_id,action:"Wrote for Writers Wall",meta:a.title||"",points:1,created_at:a.created_at};case"skill_shares":return n=a.created_at?new Date(a.created_at).getTime():null,!a.presenter_id||!a.video_url||n===null||n<s||n>i?null:{display_name:r[a.presenter_id]||a.presenter_id,action:"Shared a skill with video",meta:a.skill_name?`Skill: ${a.skill_name}`:"Skill shared with video",points:5,created_at:a.created_at};default:return null}};const _=document.getElementById("activity-feed");let t=[];async function m(){_.innerHTML='<div class="empty">Loading activity...</div>';try{console.log("Starting to load activities...");const l=[d.from("agreement_votes").select("voter_id,created_at").order("created_at",{ascending:!1}).limit(100).catch(e=>(console.warn("agreement_votes query failed:",e),{data:[],error:e})),d.from("suggestions").select("id,author_id,title,created_at").order("created_at",{ascending:!1}).limit(100).catch(e=>(console.warn("suggestions query failed:",e),{data:[],error:e})),d.from("comments").select("author_id,created_at,reply_text").order("created_at",{ascending:!1}).limit(100).catch(e=>(console.warn("comments query failed:",e),{data:[],error:e})),d.from("celebrations").select("user_id,created_at").order("created_at",{ascending:!1}).limit(100).catch(e=>(console.warn("celebrations query failed:",e),{data:[],error:e})),d.from("events").select("created_by,created_at").order("created_at",{ascending:!1}).limit(100).catch(e=>(console.warn("events query failed:",e),{data:[],error:e})),d.from("group_projects").select("proposer_id,created_at").order("created_at",{ascending:!1}).limit(100).catch(e=>(console.warn("group_projects query failed:",e),{data:[],error:e})),d.from("writers_wall").select("author_id,author_name,title,created_at").order("created_at",{ascending:!1}).limit(100).catch(e=>(console.warn("writers_wall query failed:",e),{data:[],error:e})),d.from("event_attendance").select("user_id,created_at").order("created_at",{ascending:!1}).limit(100).catch(e=>(console.warn("event_attendance query failed:",e),{data:[],error:e})),d.from("profiles").select("id,full_name").catch(e=>(console.warn("profiles query failed:",e),{data:[],error:e})),d.from("member_video").select("user_id,created_at,caption").order("created_at",{ascending:!1}).limit(100).catch(e=>(console.warn("member_video query failed:",e),{data:[],error:e})),d.from("skill_shares").select("presenter_id,created_at,skill_name,video_url").order("created_at",{ascending:!1}).limit(100).catch(e=>(console.warn("skill_shares query failed:",e),{data:[],error:e}))],a=await Promise.all(l),[r,i,s,n,b,D,S,g,w,M,T]=a;console.log("All queries completed, processing results...");const y={};(w.data||[]).forEach(e=>{e&&e.id&&(y[e.id]=e.full_name||e.id)});const v=Date.now(),k=v-10080*60*1e3,h=[];(M.data||[]).forEach(e=>{if(!e||!e.user_id)return;const o=new Date(e.created_at).getTime();o<k||o>v||h.push({display_name:y[e.user_id]||"Member",action:"Posted a video",meta:e.caption?`Video: ${e.caption}`:"Video posted",points:5,created_at:e.created_at})}),(T.error?[]:T.data||[]).forEach(e=>{if(!e||!e.presenter_id||!e.video_url)return;const o=new Date(e.created_at).getTime();o<k||o>v||h.push({display_name:y[e.presenter_id]||"Member",action:"Shared a skill with video",meta:e.skill_name?`Skill: ${e.skill_name}`:"Skill shared with video",points:5,created_at:e.created_at})}),(r.data||[]).forEach(e=>{if(!e||!e.voter_id)return;const o=new Date(e.created_at).getTime();o<k||o>v||h.push({display_name:y[e.voter_id]||"Member",action:"Voted",meta:"",points:1,created_at:e.created_at})}),(i.data||[]).forEach(e=>{if(!e||!e.author_id)return;const o=new Date(e.created_at).getTime();if(o<k||o>v)return;const I=e.title?`Suggestion: ${e.title}`:"Submitted a suggestion";h.push({display_name:y[e.author_id]||"Member",action:"Suggested",meta:I,points:1,created_at:e.created_at})}),(s.data||[]).forEach(e=>{if(!e||!e.author_id)return;const o=new Date(e.created_at).getTime();if(o<k||o>v)return;const I=e.reply_text?e.reply_text.slice(0,120):"Commented";h.push({display_name:y[e.author_id]||"Member",action:"Commented",meta:I,points:1,created_at:e.created_at})}),(n.data||[]).forEach(e=>{if(!e||!e.user_id)return;const o=new Date(e.created_at).getTime();o<k||o>v||h.push({display_name:y[e.user_id]||"Member",action:"Posted on Celebration Wall",meta:"",points:5,created_at:e.created_at})}),(b.data||[]).forEach(e=>{if(!e||!e.created_by)return;const o=new Date(e.created_at).getTime();o<k||o>v||h.push({display_name:y[e.created_by]||"Member",action:"Created event",meta:"",points:5,created_at:e.created_at})}),(D.data||[]).forEach(e=>{if(!e||!e.proposer_id)return;const o=new Date(e.created_at).getTime();o<k||o>v||h.push({display_name:y[e.proposer_id]||"Member",action:"Proposed a project",meta:"",points:5,created_at:e.created_at})}),(S.data||[]).forEach(e=>{if(!e)return;const o=new Date(e.created_at).getTime();if(o<k||o>v)return;const I=e.author_id&&y[e.author_id]||e.author_name||e.author_id||"Member";h.push({display_name:I,action:"Wrote for Writers Wall",meta:e.title||"",points:1,created_at:e.created_at})}),(g.data||[]).forEach(e=>{if(!e||!e.user_id)return;const o=new Date(e.created_at).getTime();o<k||o>v||h.push({display_name:y[e.user_id]||"Member",action:"Attended an event",meta:"",points:5,created_at:e.created_at})}),console.log(`Collected ${h.length} total activity items`),h.sort((e,o)=>new Date(o.created_at||0)-new Date(e.created_at||0)),t=h.slice(0,50).slice(),console.log(`Rendering ${t.length} recent activity items`),u(t)}catch(l){console.error("Failed to load activity:",l),_.innerHTML='<div class="empty">Failed to load activity.</div>'}}async function p(){let l={};try{((await d.from("profiles").select("id,full_name")).data||[]).forEach(i=>{i&&i.id&&(l[i.id]=i.full_name||i.id)})}catch{}const a=["agreement_votes","suggestions","comments","celebrations","events","group_projects","writers_wall","event_attendance"];try{if(typeof d.channel=="function"){const r=d.channel("realtime-activity");a.forEach(i=>{r.on("postgres_changes",{event:"INSERT",schema:"public",table:i},s=>{try{const n=f(i,s.new,l);if(!n)return;const b=`${n.display_name}|${n.action}|${n.created_at}`;if(t.some(g=>`${g.display_name}|${g.action}|${g.created_at}`===b))return;t.unshift(n);const D=Date.now(),S=D-10080*60*1e3;t=t.filter(g=>{if(!g.created_at)return!1;const w=new Date(g.created_at).getTime();return w>=S&&w<=D}).slice(0,50),u(t)}catch(n){console.warn("realtime payload error",n)}})});try{r.on("postgres_changes",{event:"INSERT",schema:"public",table:"skill_shares"},i=>{try{const s=f("skill_shares",i.new,l);if(!s)return;const n=`${s.display_name}|${s.action}|${s.created_at}`;if(t.some(S=>`${S.display_name}|${S.action}|${S.created_at}`===n))return;t.unshift(s);const b=Date.now(),D=b-10080*60*1e3;t=t.filter(S=>{if(!S.created_at)return!1;const g=new Date(S.created_at).getTime();return g>=D&&g<=b}).slice(0,50),u(t)}catch(s){console.warn("skill_shares realtime payload error",s)}})}catch(i){console.warn("Failed to subscribe to skill_shares realtime (table may not exist):",i)}await r.subscribe().catch(i=>console.warn("Realtime subscription failed:",i));return}}catch(r){console.warn("realtime channel subscribe failed",r)}try{a.forEach(r=>{d.from(r).on("INSERT",i=>{try{const s=f(r,i.new,l);if(!s)return;const n=`${s.display_name}|${s.action}|${s.created_at}`;if(t.some(b=>`${b.display_name}|${b.action}|${b.created_at}`===n))return;t.unshift(s),t=t.slice(0,50),u(t)}catch{}}).subscribe().catch(i=>console.warn(`Realtime subscription failed for ${r}:`,i))});try{d.from("skill_shares").on("INSERT",r=>{try{const i=f("skill_shares",r.new,l);if(!i)return;const s=`${i.display_name}|${i.action}|${i.created_at}`;if(t.some(n=>`${n.display_name}|${n.action}|${n.created_at}`===s))return;t.unshift(i),t=t.slice(0,50),u(t)}catch(i){console.warn("skill_shares realtime fallback error",i)}}).subscribe().catch(r=>console.warn("Realtime subscription failed for skill_shares:",r))}catch(r){console.warn("Failed to subscribe to skill_shares realtime fallback (table may not exist):",r)}}catch(r){console.warn("realtime fallback failed",r)}}(async()=>(await m(),await p(),setInterval(()=>{m().catch(()=>{})},6e4)))()}function N(_,t){if(!t)return null;try{switch(_){case"agreement_votes":return t.voter_id?{display_name:t.voter_id,action:"Voted",meta:"",points:1,created_at:t.created_at||new Date().toISOString()}:null;case"suggestions":return t.author_id?{display_name:t.author_id,action:"Suggested",meta:t.title?`Suggestion: ${t.title}`:"Submitted a suggestion",points:1,created_at:t.created_at||new Date().toISOString()}:null;case"comments":return t.author_id?{display_name:t.author_id,action:"Commented",meta:t.reply_text?t.reply_text.slice(0,120):"Commented",points:1,created_at:t.created_at||new Date().toISOString()}:null;case"celebrations":return t.user_id?{display_name:t.user_id,action:"Posted on Celebration Wall",meta:"",points:5,created_at:t.created_at||new Date().toISOString()}:null;case"events":return t.created_by?{display_name:t.created_by,action:"Created event",meta:"",points:5,created_at:t.created_at||new Date().toISOString()}:null;case"group_projects":return t.proposer_id?{display_name:t.proposer_id,action:"Proposed a project",meta:"",points:5,created_at:t.created_at||new Date().toISOString()}:null;case"writers_wall":return t.author_id||t.author_name?{display_name:t.author_id||t.author_name,action:"Wrote for Writers Wall",meta:t.title||"",points:1,created_at:t.created_at||new Date().toISOString()}:null;case"event_attendance":return t.user_id?{display_name:t.user_id,action:"Attended an event",meta:"",points:5,created_at:t.created_at||new Date().toISOString()}:null;case"skill_shares":return t.presenter_id&&t.video_url?{display_name:t.presenter_id,action:"Shared a skill with video",meta:t.skill_name?`Skill: ${t.skill_name}`:"Skill shared with video",points:5,created_at:t.created_at||new Date().toISOString()}:null;case"site_visits":return{created_at:t.created_at||new Date().toISOString(),visit:!0};default:return null}}catch{return null}}function $(_,t){const c=N(_,t);if(!c)return;if(_==="site_visits"){try{const m=document.getElementById("visits-today-banner"),f=document.getElementById("visits-week-banner");if(m&&f&&c.created_at){isNaN(Number(m.textContent))||(m.textContent=String(Number(m.textContent)+1)),isNaN(Number(f.textContent))||(f.textContent=String(Number(f.textContent)+1)),setTimeout(C,5e3);return}}catch{}C().catch(()=>{});return}const u=`${c.display_name}|${c.action}|${c.created_at}`;currentItems.some(m=>`${m.display_name}|${m.action}|${m.created_at}`===u)||(currentItems.unshift(c),currentItems=currentItems.slice(0,50),renderActivities(currentItems))}async function q(){const _=["agreement_votes","suggestions","comments","celebrations","events","group_projects","writers_wall","site_visits","event_attendance"];try{if(typeof d.channel=="function"){const t=d.channel("realtime-activity");_.forEach(c=>{t.on("postgres_changes",{event:"INSERT",schema:"public",table:c},u=>{try{$(c,u.new)}catch(m){console.warn("realtime payload handling error",m)}})});try{t.on("postgres_changes",{event:"INSERT",schema:"public",table:"skill_shares"},c=>{try{$("skill_shares",c.new)}catch(u){console.warn("skill_shares realtime payload handling error",u)}})}catch(c){console.warn("Failed to subscribe to skill_shares realtime (table may not exist):",c)}await t.subscribe(),console.log("Realtime channel subscribed for activity tables");return}}catch(t){console.warn("channel subscribe failed",t)}try{_.forEach(t=>{try{const c=d.from(t).on("INSERT",u=>{try{$(t,u.new)}catch{}}).subscribe()}catch{}});try{const t=d.from("skill_shares").on("INSERT",c=>{try{$("skill_shares",c.new)}catch(u){console.warn("skill_shares realtime fallback error",u)}}).subscribe()}catch(t){console.warn("Failed to subscribe to skill_shares realtime fallback (table may not exist):",t)}console.log("Realtime fallback subscriptions registered")}catch(t){console.warn("realtime fallback failed",t)}}(async()=>(await loadActivities(),await q(),setInterval(()=>{loadActivities().catch(()=>{})},6e4)))();
