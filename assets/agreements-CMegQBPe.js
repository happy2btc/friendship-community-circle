import"./modulepreload-polyfill-B5Qt9EMX.js";import{s as u}from"./supabase-vDZkBp_j.js";console.log("agreements.html script loaded");const v=document.getElementById("agreements-container"),d=document.getElementById("circle-select");let g=null;async function y(){d.innerHTML="";const t=document.createElement("option");t.value="",t.textContent="Everyone",d.appendChild(t);const{data:e,error:n}=await u.from("circles").select("id, name");console.log("[CircleDropdown] circles:",e,"error:",n),e&&e.length>0?(e.forEach(s=>{console.log("[CircleDropdown] Adding circle option:",s);const c=document.createElement("option");c.value=s.id,c.textContent=s.name,d.appendChild(c)}),console.log("[CircleDropdown] Finished adding circle options")):console.log("[CircleDropdown] No circles returned from Supabase")}y().then(()=>{g=d.value===""?null:d.value,h()});async function h(){console.log("Calling loadAgreements, selectedCircleId:",g);let t=u.from("agreements").select("id, agreement_text, proposer_id, created_at, status, circle_id");g&&g!==""&&(t=t.eq("circle_id",g));const{data:e,error:n}=await t;if(n){v.innerHTML=`<p style="color: red;">Error loading agreements: ${n.message}</p>`;return}if(!e||e.length===0){v.innerHTML="<p>There are no agreements up for voting in this circle.</p>";return}const s=await b(),{data:c}=await u.auth.getUser(),l=c?.user?.id,r=(e||[]).sort((o,a)=>new Date(a.created_at)-new Date(o.created_at)),m=[];for(const o of r){const a=await w(o.id),p=s?Math.round(a/s*100):0;o.voteCount=a,o.votePercent=p,m.push(o)}if(v.innerHTML="",m.length===0){v.innerHTML="<p>No agreements meet the voting criteria for this circle.</p>";return}for(const o of m){const a=document.createElement("div");a.className="agreement-card",a.innerHTML=`
      <p><strong>${o.agreement_text}</strong></p>
      <p class="proposer"></p>
      <div class="vote-info">Votes: ${o.voteCount} (${o.votePercent}% of members)</div>
      <div class="vote-buttons">
        <button class="agree" data-vote="agree">Agree</button>
        <button class="disagree" data-vote="disagree">Disagree</button>
        <button class="abstain" data-vote="abstain">Abstain</button>
      </div>
      <div class="vote-status"></div>
      <div class="voters-list"></div>
    `;const p=a.querySelector(".proposer");q(o.proposer_id).then(i=>{p.textContent=`Proposed by: ${i}`}),a.querySelectorAll(".vote-buttons button").forEach(i=>{i.onclick=async()=>{if(!l){alert("You must be signed in to vote.");return}await E(o.id,i.getAttribute("data-vote"),l,a)}}),l&&A(o.id,l).then(i=>{i&&(a.querySelector(".vote-status").textContent=`Your vote: ${i.charAt(0).toUpperCase()+i.slice(1)}`)}),C(o.id).then(i=>{const _=a.querySelector(".voters-list");i.length===0?_.textContent="No votes yet.":_.innerHTML='<strong>Voters:</strong><ul style="margin:0; padding-left:1em;">'+i.map(f=>`<li>${f.name}: ${f.vote.charAt(0).toUpperCase()+f.vote.slice(1)}</li>`).join("")+"</ul>"}),v.appendChild(a)}}d.addEventListener("change",()=>{g=d.value===""?null:d.value,h()});g=d.value===""?null:d.value;h();async function b(){const{count:t,error:e}=await u.from("profiles").select("id",{count:"exact",head:!0});return t||1}async function w(t){const{count:e,error:n}=await u.from("agreement_votes").select("id",{count:"exact",head:!0}).eq("agreement_id",t);return e||0}async function A(t,e){const{data:n,error:s}=await u.from("agreement_votes").select("vote_value").eq("agreement_id",t).eq("voter_id",e).limit(1);return n&&n.length>0?n[0].vote_value:null}async function C(t){const{data:e,error:n}=await u.from("agreement_votes").select("voter_id, vote_value").eq("agreement_id",t);if(!e||e.length===0)return[];const s=e.map(r=>r.voter_id),{data:c}=await u.from("profiles").select("id, full_name").in("id",s),l={};return c?.forEach(r=>{l[r.id]=r.full_name}),e.map(r=>({name:l[r.voter_id]||"Unknown",vote:r.vote_value,voter_id:r.voter_id}))}async function q(t){if(!t)return"A Circle Member";const{data:e,error:n}=await u.from("profiles").select("full_name").eq("id",t).single();return e?.full_name||"A Circle Member"}async function E(t,e,n,s){const{error:c}=await u.from("agreement_votes").upsert([{agreement_id:t,voter_id:n,vote_value:e}],{onConflict:["agreement_id","voter_id"]});c?alert("Error submitting vote: "+c.message):(s.querySelector(".vote-status").textContent=`Your vote: ${e.charAt(0).toUpperCase()+e.slice(1)}`,alert("Your vote has been recorded! You can change your vote at any time."),C(t).then(l=>{const r=s.querySelector(".voters-list");l.length===0?r.textContent="No votes yet.":r.innerHTML='<strong>Voters:</strong><ul style="margin:0; padding-left:1em;">'+l.map(m=>`<li>${m.name}: ${m.vote.charAt(0).toUpperCase()+m.vote.slice(1)}</li>`).join("")+"</ul>"}))}
