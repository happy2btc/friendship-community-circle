import"./modulepreload-polyfill-B5Qt9EMX.js";import{s}from"./supabase-vDZkBp_j.js";const m=document.getElementById("agreements-container"),f=document.getElementById("circle-select"),h=10080*60*1e3;async function b(){const{data:t}=await s.auth.getUser(),e=t?.user?.id,{data:n}=await s.from("circle_members").select("circle_id").eq("user_id",e);if(!n||n.length===0)return[];const c=n.map(l=>l.circle_id),{data:u}=await s.from("circles").select("id, name").in("id",c);return u||[]}async function y(t){const{count:e,error:n}=await s.from("circle_members").select("id",{count:"exact",head:!0}).eq("circle_id",t);return e||1}async function C(t){const{count:e,error:n}=await s.from("agreement_votes").select("id",{count:"exact",head:!0}).eq("agreement_id",t);return e||0}async function w(t,e){const{data:n,error:c}=await s.from("agreement_votes").select("vote_value").eq("agreement_id",t).eq("voter_id",e).single();return n?n.vote_value:null}async function _(t){const{data:e,error:n}=await s.from("agreement_votes").select("voter_id, vote_value").eq("agreement_id",t);if(!e||e.length===0)return[];const c=e.map(r=>r.voter_id),{data:u}=await s.from("profiles").select("id, full_name").in("id",c),l={};return u?.forEach(r=>{l[r.id]=r.full_name}),e.map(r=>({name:l[r.voter_id]||"Unknown",vote:r.vote_value}))}async function q(t){if(!t)return"A Circle Member";const{data:e,error:n}=await s.from("profiles").select("full_name").eq("id",t).single();return e?.full_name||"A Circle Member"}async function M(t,e,n,c){const{error:u}=await s.from("agreement_votes").upsert([{agreement_id:t,voter_id:n,vote_value:e}],{onConflict:["agreement_id","voter_id"]});u?alert("Error submitting vote: "+u.message):(c.querySelector(".vote-status").textContent=`Your vote: ${e.charAt(0).toUpperCase()+e.slice(1)}`,alert("Your vote has been recorded!"),_(t).then(l=>{const r=c.querySelector(".voters-list");l.length===0?r.textContent="No votes yet.":r.innerHTML='<strong>Voters:</strong><ul style="margin:0; padding-left:1em;">'+l.map(d=>`<li>${d.name}: ${d.vote.charAt(0).toUpperCase()+d.vote.slice(1)}</li>`).join("")+"</ul>"}))}async function A(t){if(!t){m.innerHTML="<p>Select a circle to view agreements.</p>";return}const{data:e,error:n}=await s.from("agreements").select("id, agreement_text, proposer_id, created_at, status, circle_id").eq("status","voting").eq("circle_id",t);if(n){m.innerHTML=`<p style="color: red;">Error loading agreements: ${n.message}</p>`;return}if(!e||e.length===0){m.innerHTML="<p>There are no agreements up for voting in this circle.</p>";return}const c=await y(t),u=Date.now(),{data:l}=await s.auth.getUser(),r=l?.user?.id,d=[];for(const a of e){const i=new Date(a.created_at).getTime(),p=u-i,o=await C(a.id),g=o/c;p>h&&g<.5||(a.voteCount=o,a.votePercent=Math.round(g*100),d.push(a))}if(m.innerHTML="",d.length===0){m.innerHTML="<p>No agreements meet the voting criteria in this circle.</p>";return}for(const a of d){const i=document.createElement("div");i.className="agreement-card",i.innerHTML=`
          <p><strong>${a.agreement_text}</strong></p>
          <p class="proposer"></p>
          <div class="vote-info">Votes: ${a.voteCount} (${a.votePercent}% of members)</div>
          <div class="vote-buttons">
            <button class="agree" data-vote="agree">Agree</button>
            <button class="disagree" data-vote="disagree">Disagree</button>
            <button class="abstain" data-vote="abstain">Abstain</button>
          </div>
          <div class="vote-status"></div>
          <div class="voters-list"></div>
        `,q(a.proposer_id).then(o=>{i.querySelector(".proposer").textContent=`Proposed by: ${o}`}),i.querySelectorAll(".vote-buttons button").forEach(o=>{o.onclick=async()=>{if(!r){alert("You must be signed in to vote.");return}await M(a.id,o.getAttribute("data-vote"),r,i)}}),r&&w(a.id,r).then(o=>{o&&(i.querySelector(".vote-status").textContent=`Your vote: ${o.charAt(0).toUpperCase()+o.slice(1)}`)}),_(a.id).then(o=>{const g=i.querySelector(".voters-list");o.length===0?g.textContent="No votes yet.":g.innerHTML='<strong>Voters:</strong><ul style="margin:0; padding-left:1em;">'+o.map(v=>`<li>${v.name}: ${v.vote.charAt(0).toUpperCase()+v.vote.slice(1)}</li>`).join("")+"</ul>"}),m.appendChild(i)}}b().then(t=>{f.innerHTML='<option value="">Select a Circle...</option>'+t.map(e=>`<option value="${e.id}">${e.name}</option>`).join(""),f.onchange=()=>{A(f.value)}});
