import"./modulepreload-polyfill-B5Qt9EMX.js";import{s as _}from"./supabase-vDZkBp_j.js";const C="site_visit_recorded_date",$="site_visits_local",T="visitor_id_v1";async function w(){try{const a=new Date().toISOString().slice(0,10);let c=localStorage.getItem(T);if(!c){try{c=crypto&&crypto.randomUUID?crypto.randomUUID():"v-"+Date.now()+"-"+Math.floor(Math.random()*1e6)}catch{c="v-"+Date.now()+"-"+Math.floor(Math.random()*1e6)}localStorage.setItem(T,c)}if(localStorage.getItem(C)===a)return;const f=document.referrer||null,u=window.location.href||null,m=new URLSearchParams(window.location.search||""),p=m.get("utm_source"),l=m.get("utm_medium"),e=m.get("utm_campaign");try{await _.from("site_visits").insert([{path:window.location.pathname,user_agent:navigator.userAgent,visitor_id:c,referrer:f,landing_url:u,utm_source:p,utm_medium:l,utm_campaign:e}]),localStorage.setItem(C,a);return}catch(r){console.warn("site_visits insert failed, saving locally",r)}try{const r=JSON.parse(localStorage.getItem($)||"[]");r.unshift({id:"local-"+Date.now(),visitor_id:c,path:window.location.pathname,user_agent:navigator.userAgent,referrer:document.referrer||null,landing_url:window.location.href||null,utm_source:p,utm_medium:l,utm_campaign:e,created_at:new Date().toISOString()}),localStorage.setItem($,JSON.stringify(r.slice(0,1e3))),localStorage.setItem(C,a)}catch(r){console.warn("local site_visits save failed",r)}}catch(d){console.warn("recordVisitOncePerDay general error",d)}}async function R(){const d=document.getElementById("visits-today-banner")||document.getElementById("visits-today"),a=document.getElementById("visits-week-banner")||document.getElementById("visits-week");if(!d||!a)return;const c=new Date,f=new Date(c.getFullYear(),c.getMonth(),c.getDate()).toISOString(),u=new Date(c.getTime()-10080*60*1e3).toISOString();try{const m=await _.from("site_visits").select("id",{count:"exact"}).gte("created_at",f),p=await _.from("site_visits").select("id",{count:"exact"}).gte("created_at",u);if(m.error||p.error)throw new Error("db count error");const l=m.count??0,e=p.count??0;d.textContent=String(l),a.textContent=String(e);return}catch{try{const p=JSON.parse(localStorage.getItem($)||"[]");let l=0,e=0;for(const r of p)r.created_at&&(r.created_at>=f&&l++,r.created_at>=u&&e++);d.textContent=String(l||"—"),a.textContent=String(e||"—")}catch(p){console.warn("loadVisitCounts fallback failed",p);try{d&&(d.textContent="—"),a&&(a.textContent="—")}catch{}}}}(async()=>(await w(),await R()))();const M=document.getElementById("sync-visits-btn");document.getElementById("sync-status");if(M){let c=function(l){return l?String(l).replace(/[&<>"]/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[e]):""},f=function(l){const e=Date.now(),r=e-10080*60*1e3,o=(l||a||[]).filter(i=>{if(!i.created_at)return!1;const n=new Date(i.created_at).getTime();return n>=r&&n<=e});if(d.innerHTML="",!o.length){d.innerHTML='<div class="empty">No recent activity in the last 7 days.</div>';return}for(const i of o){const n=document.createElement("div");n.className="ann",n.innerHTML=`<div class="activity-item"><div class="activity-left"><div style="font-weight:700">${c(i.action||"Action")}</div><div style="margin-top:6px">${c(i.meta||"")}</div></div><div class="activity-right"><div>${c(i.display_name||"Member")}</div><div class="meta">${i.points?"+"+c(String(i.points))+" pts":""}${i.created_at?" • "+c(new Date(i.created_at).toLocaleString()):""}</div></div></div>`,d.appendChild(n)}},m=function(l,e,r){if(!e)return null;const o=Date.now(),i=o-10080*60*1e3;let n=null;switch(l){case"event_attendance":return n=e.created_at?new Date(e.created_at).getTime():null,!e.user_id||n===null||n<i||n>o?null:{display_name:r[e.user_id]||e.user_id,action:"Attended an event",meta:"",points:5,created_at:e.created_at};case"agreement_votes":return n=e.created_at?new Date(e.created_at).getTime():null,!e.voter_id||n===null||n<i||n>o?null:{display_name:r[e.voter_id]||e.voter_id,action:"Voted",meta:"",points:1,created_at:e.created_at};case"suggestions":return n=e.created_at?new Date(e.created_at).getTime():null,!e.author_id||n===null||n<i||n>o?null:{display_name:r[e.author_id]||e.author_id,action:"Suggested",meta:e.title?`Suggestion: ${e.title}`:"Submitted a suggestion",points:1,created_at:e.created_at};case"comments":return n=e.created_at?new Date(e.created_at).getTime():null,!e.author_id||n===null||n<i||n>o?null:{display_name:r[e.author_id]||e.author_id,action:"Commented",meta:e.reply_text?e.reply_text.slice(0,120):"Commented",points:1,created_at:e.created_at};case"celebrations":return n=e.created_at?new Date(e.created_at).getTime():null,!e.user_id||n===null||n<i||n>o?null:{display_name:r[e.user_id]||e.user_id,action:"Posted on Celebration Wall",meta:"",points:5,created_at:e.created_at};case"events":return n=e.created_at?new Date(e.created_at).getTime():null,!e.created_by||n===null||n<i||n>o?null:{display_name:r[e.created_by]||e.created_by,action:"Created event",meta:"",points:5,created_at:e.created_at};case"group_projects":return n=e.created_at?new Date(e.created_at).getTime():null,!e.proposer_id||n===null||n<i||n>o?null:{display_name:r[e.proposer_id]||e.proposer_id,action:"Proposed a project",meta:"",points:5,created_at:e.created_at};case"writers_wall":return n=e.created_at?new Date(e.created_at).getTime():null,!(e.author_id||e.author_name)||n===null||n<i||n>o?null:{display_name:e.author_id&&r[e.author_id]||e.author_name||e.author_id,action:"Wrote for Writers Wall",meta:e.title||"",points:1,created_at:e.created_at};case"skill_shares":return n=e.created_at?new Date(e.created_at).getTime():null,!e.presenter_id||!e.video_url||n===null||n<i||n>o?null:{display_name:r[e.presenter_id]||e.presenter_id,action:"Shared a skill with video",meta:e.skill_name?`Skill: ${e.skill_name}`:"Skill shared with video",points:5,created_at:e.created_at};default:return null}};const d=document.getElementById("activity-feed");let a=[];async function u(){d.innerHTML='<div class="empty">Loading activity...</div>';try{const[l,e,r,o,i,n,b,I,k,S,E]=await Promise.all([_.from("agreement_votes").select("voter_id,created_at").order("created_at",{ascending:!1}).limit(100),_.from("suggestions").select("id,author_id,title,created_at").order("created_at",{ascending:!1}).limit(100),_.from("comments").select("author_id,created_at,reply_text").order("created_at",{ascending:!1}).limit(100),_.from("celebrations").select("user_id,created_at").order("created_at",{ascending:!1}).limit(100),_.from("events").select("created_by,created_at").order("created_at",{ascending:!1}).limit(100),_.from("group_projects").select("proposer_id,created_at").order("created_at",{ascending:!1}).limit(100),_.from("writers_wall").select("author_id,author_name,title,created_at").order("created_at",{ascending:!1}).limit(100),_.from("event_attendance").select("user_id,created_at").order("created_at",{ascending:!1}).limit(100),_.from("profiles").select("id,full_name"),_.from("member_video").select("user_id,created_at,caption").order("created_at",{ascending:!1}).limit(100),_.from("skill_shares").select("presenter_id,created_at,skill_name,video_url").order("created_at",{ascending:!1}).limit(100)]),h={};(k.data||[]).forEach(t=>{t&&t.id&&(h[t.id]=t.full_name||t.id)});const y=Date.now(),v=y-10080*60*1e3,g=[];(S.data||[]).forEach(t=>{if(!t||!t.user_id)return;const s=new Date(t.created_at).getTime();s<v||s>y||g.push({display_name:h[t.user_id]||"Member",action:"Posted a video",meta:t.caption?`Video: ${t.caption}`:"Video posted",points:5,created_at:t.created_at})}),(E.data||[]).forEach(t=>{if(!t||!t.presenter_id||!t.video_url)return;const s=new Date(t.created_at).getTime();s<v||s>y||g.push({display_name:h[t.presenter_id]||"Member",action:"Shared a skill with video",meta:t.skill_name?`Skill: ${t.skill_name}`:"Skill shared with video",points:5,created_at:t.created_at})}),(l.data||[]).forEach(t=>{if(!t||!t.voter_id)return;const s=new Date(t.created_at).getTime();s<v||s>y||g.push({display_name:h[t.voter_id]||"Member",action:"Voted",meta:"",points:1,created_at:t.created_at})}),(e.data||[]).forEach(t=>{if(!t||!t.author_id)return;const s=new Date(t.created_at).getTime();if(s<v||s>y)return;const D=t.title?`Suggestion: ${t.title}`:"Submitted a suggestion";g.push({display_name:h[t.author_id]||"Member",action:"Suggested",meta:D,points:1,created_at:t.created_at})}),(r.data||[]).forEach(t=>{if(!t||!t.author_id)return;const s=new Date(t.created_at).getTime();if(s<v||s>y)return;const D=t.reply_text?t.reply_text.slice(0,120):"Commented";g.push({display_name:h[t.author_id]||"Member",action:"Commented",meta:D,points:1,created_at:t.created_at})}),(o.data||[]).forEach(t=>{if(!t||!t.user_id)return;const s=new Date(t.created_at).getTime();s<v||s>y||g.push({display_name:h[t.user_id]||"Member",action:"Posted on Celebration Wall",meta:"",points:5,created_at:t.created_at})}),(i.data||[]).forEach(t=>{if(!t||!t.created_by)return;const s=new Date(t.created_at).getTime();s<v||s>y||g.push({display_name:h[t.created_by]||"Member",action:"Created event",meta:"",points:5,created_at:t.created_at})}),(n.data||[]).forEach(t=>{if(!t||!t.proposer_id)return;const s=new Date(t.created_at).getTime();s<v||s>y||g.push({display_name:h[t.proposer_id]||"Member",action:"Proposed a project",meta:"",points:5,created_at:t.created_at})}),(b.data||[]).forEach(t=>{if(!t)return;const s=new Date(t.created_at).getTime();if(s<v||s>y)return;const D=t.author_id&&h[t.author_id]||t.author_name||t.author_id||"Member";g.push({display_name:D,action:"Wrote for Writers Wall",meta:t.title||"",points:1,created_at:t.created_at})}),(I.data||[]).forEach(t=>{if(!t||!t.user_id)return;const s=new Date(t.created_at).getTime();s<v||s>y||g.push({display_name:h[t.user_id]||"Member",action:"Attended an event",meta:"",points:5,created_at:t.created_at})}),g.sort((t,s)=>new Date(s.created_at||0)-new Date(t.created_at||0)),a=g.slice(0,50).slice(),f(a)}catch{d.innerHTML='<div class="empty">Failed to load activity.</div>'}}async function p(){let l={};try{((await _.from("profiles").select("id,full_name")).data||[]).forEach(o=>{o&&o.id&&(l[o.id]=o.full_name||o.id)})}catch{}const e=["agreement_votes","suggestions","comments","celebrations","events","group_projects","writers_wall","event_attendance","skill_shares"];try{if(typeof _.channel=="function"){const r=_.channel("realtime-activity");e.forEach(o=>{r.on("postgres_changes",{event:"INSERT",schema:"public",table:o},i=>{try{const n=m(o,i.new,l);if(!n)return;const b=`${n.display_name}|${n.action}|${n.created_at}`;if(a.some(S=>`${S.display_name}|${S.action}|${S.created_at}`===b))return;a.unshift(n);const I=Date.now(),k=I-10080*60*1e3;a=a.filter(S=>{if(!S.created_at)return!1;const E=new Date(S.created_at).getTime();return E>=k&&E<=I}).slice(0,50),f(a)}catch(n){console.warn("realtime payload error",n)}})}),await r.subscribe();return}}catch(r){console.warn("realtime channel subscribe failed",r)}try{e.forEach(r=>{_.from(r).on("INSERT",o=>{try{const i=m(r,o.new,l);if(!i)return;const n=`${i.display_name}|${i.action}|${i.created_at}`;if(a.some(b=>`${b.display_name}|${b.action}|${b.created_at}`===n))return;a.unshift(i),a=a.slice(0,50),f(a)}catch{}}).subscribe()})}catch(r){console.warn("realtime fallback failed",r)}}(async()=>(await u(),await p(),setInterval(()=>{u().catch(()=>{})},6e4)))()}function O(d,a){if(!a)return null;try{switch(d){case"agreement_votes":return a.voter_id?{display_name:a.voter_id,action:"Voted",meta:"",points:1,created_at:a.created_at||new Date().toISOString()}:null;case"suggestions":return a.author_id?{display_name:a.author_id,action:"Suggested",meta:a.title?`Suggestion: ${a.title}`:"Submitted a suggestion",points:1,created_at:a.created_at||new Date().toISOString()}:null;case"comments":return a.author_id?{display_name:a.author_id,action:"Commented",meta:a.reply_text?a.reply_text.slice(0,120):"Commented",points:1,created_at:a.created_at||new Date().toISOString()}:null;case"celebrations":return a.user_id?{display_name:a.user_id,action:"Posted on Celebration Wall",meta:"",points:5,created_at:a.created_at||new Date().toISOString()}:null;case"events":return a.created_by?{display_name:a.created_by,action:"Created event",meta:"",points:5,created_at:a.created_at||new Date().toISOString()}:null;case"group_projects":return a.proposer_id?{display_name:a.proposer_id,action:"Proposed a project",meta:"",points:5,created_at:a.created_at||new Date().toISOString()}:null;case"writers_wall":return a.author_id||a.author_name?{display_name:a.author_id||a.author_name,action:"Wrote for Writers Wall",meta:a.title||"",points:1,created_at:a.created_at||new Date().toISOString()}:null;case"site_visits":return{created_at:a.created_at||new Date().toISOString(),visit:!0};default:return null}}catch{return null}}function x(d,a){const c=O(d,a);if(!c)return;if(d==="site_visits"){try{const u=document.getElementById("visits-today-banner"),m=document.getElementById("visits-week-banner");if(u&&m&&c.created_at){isNaN(Number(u.textContent))||(u.textContent=String(Number(u.textContent)+1)),isNaN(Number(m.textContent))||(m.textContent=String(Number(m.textContent)+1)),setTimeout(R,5e3);return}}catch{}R().catch(()=>{});return}const f=`${c.display_name}|${c.action}|${c.created_at}`;currentItems.some(u=>`${u.display_name}|${u.action}|${u.created_at}`===f)||(currentItems.unshift(c),currentItems=currentItems.slice(0,50),renderActivities(currentItems))}async function A(){const d=["agreement_votes","suggestions","comments","celebrations","events","group_projects","writers_wall","site_visits"];try{if(typeof _.channel=="function"){const a=_.channel("realtime-activity");d.forEach(c=>{a.on("postgres_changes",{event:"INSERT",schema:"public",table:c},f=>{try{x(c,f.new)}catch(u){console.warn("realtime payload handling error",u)}})}),await a.subscribe(),console.log("Realtime channel subscribed for activity tables");return}}catch(a){console.warn("channel subscribe failed",a)}try{d.forEach(a=>{try{const c=_.from(a).on("INSERT",f=>{try{x(a,f.new)}catch{}}).subscribe()}catch{}}),console.log("Realtime fallback subscriptions registered")}catch(a){console.warn("realtime fallback failed",a)}}(async()=>(await loadActivities(),await A(),setInterval(()=>{loadActivities().catch(()=>{})},6e4)))();
