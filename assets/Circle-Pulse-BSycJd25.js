import"./modulepreload-polyfill-B5Qt9EMX.js";import{s as d}from"./supabase-vDZkBp_j.js";const E="site_visit_recorded_date",R="site_visits_local",x="visitor_id_v1";async function O(){try{const t=new Date().toISOString().slice(0,10);let c=localStorage.getItem(x);if(!c){try{c=crypto&&crypto.randomUUID?crypto.randomUUID():"v-"+Date.now()+"-"+Math.floor(Math.random()*1e6)}catch{c="v-"+Date.now()+"-"+Math.floor(Math.random()*1e6)}localStorage.setItem(x,c)}if(localStorage.getItem(E)===t)return;const _=document.referrer||null,m=window.location.href||null,f=new URLSearchParams(window.location.search||""),h=f.get("utm_source"),l=f.get("utm_medium"),a=f.get("utm_campaign");try{await d.from("site_visits").insert([{path:window.location.pathname,user_agent:navigator.userAgent,visitor_id:c,referrer:_,landing_url:m,utm_source:h,utm_medium:l,utm_campaign:a}]),localStorage.setItem(E,t);return}catch(n){console.warn("site_visits insert failed, saving locally",n)}try{const n=JSON.parse(localStorage.getItem(R)||"[]");n.unshift({id:"local-"+Date.now(),visitor_id:c,path:window.location.pathname,user_agent:navigator.userAgent,referrer:document.referrer||null,landing_url:window.location.href||null,utm_source:h,utm_medium:l,utm_campaign:a,created_at:new Date().toISOString()}),localStorage.setItem(R,JSON.stringify(n.slice(0,1e3))),localStorage.setItem(E,t)}catch(n){console.warn("local site_visits save failed",n)}}catch(u){console.warn("recordVisitOncePerDay general error",u)}}async function C(){const u=document.getElementById("visits-today-banner")||document.getElementById("visits-today"),t=document.getElementById("visits-week-banner")||document.getElementById("visits-week");if(!u||!t)return;const c=new Date,_=new Date(c.getFullYear(),c.getMonth(),c.getDate()).toISOString(),m=new Date(c.getTime()-10080*60*1e3).toISOString();try{const f=await d.from("site_visits").select("id",{count:"exact"}).gte("created_at",_),h=await d.from("site_visits").select("id",{count:"exact"}).gte("created_at",m);if(f.error||h.error)throw new Error("db count error");const l=f.count??0,a=h.count??0;u.textContent=String(l),t.textContent=String(a);return}catch{try{const h=JSON.parse(localStorage.getItem(R)||"[]");let l=0,a=0;for(const n of h)n.created_at&&(n.created_at>=_&&l++,n.created_at>=m&&a++);u.textContent=String(l||"—"),t.textContent=String(a||"—")}catch(h){console.warn("loadVisitCounts fallback failed",h);try{u&&(u.textContent="—"),t&&(t.textContent="—")}catch{}}}}(async()=>(await O(),await C()))();const A=document.getElementById("sync-visits-btn");document.getElementById("sync-status");if(A){let c=function(l){return l?String(l).replace(/[&<>"]/g,a=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[a]):""},_=function(l){const a=Date.now(),n=a-10080*60*1e3,i=(l||t||[]).filter(s=>{if(!s.created_at)return!1;const r=new Date(s.created_at).getTime();return r>=n&&r<=a});if(u.innerHTML="",!i.length){u.innerHTML='<div class="empty">No recent activity in the last 7 days.</div>';return}for(const s of i){const r=document.createElement("div");r.className="ann",r.innerHTML=`<div class="activity-item"><div class="activity-left"><div style="font-weight:700">${c(s.action||"Action")}</div><div style="margin-top:6px">${c(s.meta||"")}</div></div><div class="activity-right"><div>${c(s.display_name||"Member")}</div><div class="meta">${s.points?"+"+c(String(s.points))+" pts":""}${s.created_at?" • "+c(new Date(s.created_at).toLocaleString()):""}</div></div></div>`,u.appendChild(r)}},f=function(l,a,n){if(!a)return null;const i=Date.now(),s=i-10080*60*1e3;let r=null;switch(l){case"event_attendance":return r=a.created_at?new Date(a.created_at).getTime():null,!a.user_id||r===null||r<s||r>i?null:{display_name:n[a.user_id]||a.user_id,action:"Attended an event",meta:"",points:5,created_at:a.created_at};case"agreement_votes":return r=a.created_at?new Date(a.created_at).getTime():null,!a.voter_id||r===null||r<s||r>i?null:{display_name:n[a.voter_id]||a.voter_id,action:"Voted",meta:"",points:1,created_at:a.created_at};case"suggestions":return r=a.created_at?new Date(a.created_at).getTime():null,!a.author_id||r===null||r<s||r>i?null:{display_name:n[a.author_id]||a.author_id,action:"Suggested",meta:a.title?`Suggestion: ${a.title}`:"Submitted a suggestion",points:1,created_at:a.created_at};case"comments":return r=a.created_at?new Date(a.created_at).getTime():null,!a.author_id||r===null||r<s||r>i?null:{display_name:n[a.author_id]||a.author_id,action:"Commented",meta:a.reply_text?a.reply_text.slice(0,120):"Commented",points:1,created_at:a.created_at};case"celebrations":return r=a.created_at?new Date(a.created_at).getTime():null,!a.user_id||r===null||r<s||r>i?null:{display_name:n[a.user_id]||a.user_id,action:"Posted on Celebration Wall",meta:"",points:5,created_at:a.created_at};case"events":return r=a.created_at?new Date(a.created_at).getTime():null,!a.created_by||r===null||r<s||r>i?null:{display_name:n[a.created_by]||a.created_by,action:"Created event",meta:"",points:5,created_at:a.created_at};case"group_projects":return r=a.created_at?new Date(a.created_at).getTime():null,!a.proposer_id||r===null||r<s||r>i?null:{display_name:n[a.proposer_id]||a.proposer_id,action:"Proposed a project",meta:"",points:5,created_at:a.created_at};case"writers_wall":return r=a.created_at?new Date(a.created_at).getTime():null,!(a.author_id||a.author_name)||r===null||r<s||r>i?null:{display_name:a.author_id&&n[a.author_id]||a.author_name||a.author_id,action:"Wrote for Writers Wall",meta:a.title||"",points:1,created_at:a.created_at};case"skill_shares":return r=a.created_at?new Date(a.created_at).getTime():null,!a.presenter_id||!a.video_url||r===null||r<s||r>i?null:{display_name:n[a.presenter_id]||a.presenter_id,action:"Shared a skill with video",meta:a.skill_name?`Skill: ${a.skill_name}`:"Skill shared with video",points:5,created_at:a.created_at};default:return null}};const u=document.getElementById("activity-feed");let t=[];async function m(){u.innerHTML='<div class="empty">Loading activity...</div>';try{console.log("Starting to load activities...");const l=[(async()=>{try{return await d.from("agreement_votes").select("voter_id,created_at").order("created_at",{ascending:!1}).limit(100)}catch(e){return console.warn("agreement_votes query failed:",e),{data:[],error:e}}})(),(async()=>{try{return await d.from("suggestions").select("id,author_id,title,created_at").order("created_at",{ascending:!1}).limit(100)}catch(e){return console.warn("suggestions query failed:",e),{data:[],error:e}}})(),(async()=>{try{return await d.from("comments").select("author_id,created_at,reply_text").order("created_at",{ascending:!1}).limit(100)}catch(e){return console.warn("comments query failed:",e),{data:[],error:e}}})(),(async()=>{try{return await d.from("celebrations").select("user_id,created_at").order("created_at",{ascending:!1}).limit(100)}catch(e){return console.warn("celebrations query failed:",e),{data:[],error:e}}})(),(async()=>{try{return await d.from("events").select("created_by,created_at").order("created_at",{ascending:!1}).limit(100)}catch(e){return console.warn("events query failed:",e),{data:[],error:e}}})(),(async()=>{try{return await d.from("group_projects").select("proposer_id,created_at").order("created_at",{ascending:!1}).limit(100)}catch(e){return console.warn("group_projects query failed:",e),{data:[],error:e}}})(),(async()=>{try{return await d.from("writers_wall").select("author_id,author_name,title,created_at").order("created_at",{ascending:!1}).limit(100)}catch(e){return console.warn("writers_wall query failed:",e),{data:[],error:e}}})(),(async()=>{try{return await d.from("event_attendance").select("user_id,created_at").order("created_at",{ascending:!1}).limit(100)}catch(e){return console.warn("event_attendance query failed:",e),{data:[],error:e}}})(),(async()=>{try{return await d.from("profiles").select("id,full_name")}catch(e){return console.warn("profiles query failed:",e),{data:[],error:e}}})(),(async()=>{try{return await d.from("member_video").select("user_id,created_at,caption").order("created_at",{ascending:!1}).limit(100)}catch(e){return console.warn("member_video query failed:",e),{data:[],error:e}}})(),(async()=>{try{return await d.from("skill_shares").select("presenter_id,created_at,skill_name,video_url").order("created_at",{ascending:!1}).limit(100)}catch(e){return console.warn("skill_shares query failed:",e),{data:[],error:e}}})()],a=await Promise.all(l),[n,i,s,r,b,w,S,p,I,M,T]=a;console.log("All queries completed, processing results...");const g={};(I.data||[]).forEach(e=>{e&&e.id&&(g[e.id]=e.full_name||e.id)});const v=Date.now(),k=v-10080*60*1e3,y=[];(M.data||[]).forEach(e=>{if(!e||!e.user_id)return;const o=new Date(e.created_at).getTime();o<k||o>v||y.push({display_name:g[e.user_id]||"Member",action:"Posted a video",meta:e.caption?`Video: ${e.caption}`:"Video posted",points:5,created_at:e.created_at})}),(T.error?[]:T.data||[]).forEach(e=>{if(!e||!e.presenter_id||!e.video_url)return;const o=new Date(e.created_at).getTime();o<k||o>v||y.push({display_name:g[e.presenter_id]||"Member",action:"Shared a skill with video",meta:e.skill_name?`Skill: ${e.skill_name}`:"Skill shared with video",points:5,created_at:e.created_at})}),(n.data||[]).forEach(e=>{if(!e||!e.voter_id)return;const o=new Date(e.created_at).getTime();o<k||o>v||y.push({display_name:g[e.voter_id]||"Member",action:"Voted",meta:"",points:1,created_at:e.created_at})}),(i.data||[]).forEach(e=>{if(!e||!e.author_id)return;const o=new Date(e.created_at).getTime();if(o<k||o>v)return;const D=e.title?`Suggestion: ${e.title}`:"Submitted a suggestion";y.push({display_name:g[e.author_id]||"Member",action:"Suggested",meta:D,points:1,created_at:e.created_at})}),(s.data||[]).forEach(e=>{if(!e||!e.author_id)return;const o=new Date(e.created_at).getTime();if(o<k||o>v)return;const D=e.reply_text?e.reply_text.slice(0,120):"Commented";y.push({display_name:g[e.author_id]||"Member",action:"Commented",meta:D,points:1,created_at:e.created_at})}),(r.data||[]).forEach(e=>{if(!e||!e.user_id)return;const o=new Date(e.created_at).getTime();o<k||o>v||y.push({display_name:g[e.user_id]||"Member",action:"Posted on Celebration Wall",meta:"",points:5,created_at:e.created_at})}),(b.data||[]).forEach(e=>{if(!e||!e.created_by)return;const o=new Date(e.created_at).getTime();o<k||o>v||y.push({display_name:g[e.created_by]||"Member",action:"Created event",meta:"",points:5,created_at:e.created_at})}),(w.data||[]).forEach(e=>{if(!e||!e.proposer_id)return;const o=new Date(e.created_at).getTime();o<k||o>v||y.push({display_name:g[e.proposer_id]||"Member",action:"Proposed a project",meta:"",points:5,created_at:e.created_at})}),(S.data||[]).forEach(e=>{if(!e)return;const o=new Date(e.created_at).getTime();if(o<k||o>v)return;const D=e.author_id&&g[e.author_id]||e.author_name||e.author_id||"Member";y.push({display_name:D,action:"Wrote for Writers Wall",meta:e.title||"",points:1,created_at:e.created_at})}),(p.data||[]).forEach(e=>{if(!e||!e.user_id)return;const o=new Date(e.created_at).getTime();o<k||o>v||y.push({display_name:g[e.user_id]||"Member",action:"Attended an event",meta:"",points:5,created_at:e.created_at})}),console.log(`Collected ${y.length} total activity items`),y.sort((e,o)=>new Date(o.created_at||0)-new Date(e.created_at||0)),t=y.slice(0,50).slice(),console.log(`Rendering ${t.length} recent activity items`),_(t)}catch(l){console.error("Failed to load activity:",l),u.innerHTML='<div class="empty">Failed to load activity.</div>'}}async function h(){let l={};try{((await d.from("profiles").select("id,full_name")).data||[]).forEach(i=>{i&&i.id&&(l[i.id]=i.full_name||i.id)})}catch{}const a=["agreement_votes","suggestions","comments","celebrations","events","group_projects","writers_wall","event_attendance"];try{if(typeof d.channel=="function"){const n=d.channel("realtime-activity");a.forEach(i=>{n.on("postgres_changes",{event:"INSERT",schema:"public",table:i},s=>{try{const r=f(i,s.new,l);if(!r)return;const b=`${r.display_name}|${r.action}|${r.created_at}`;if(t.some(p=>`${p.display_name}|${p.action}|${p.created_at}`===b))return;t.unshift(r);const w=Date.now(),S=w-10080*60*1e3;t=t.filter(p=>{if(!p.created_at)return!1;const I=new Date(p.created_at).getTime();return I>=S&&I<=w}).slice(0,50),_(t)}catch(r){console.warn("realtime payload error",r)}})});try{n.on("postgres_changes",{event:"INSERT",schema:"public",table:"skill_shares"},i=>{try{const s=f("skill_shares",i.new,l);if(!s)return;const r=`${s.display_name}|${s.action}|${s.created_at}`;if(t.some(S=>`${S.display_name}|${S.action}|${S.created_at}`===r))return;t.unshift(s);const b=Date.now(),w=b-10080*60*1e3;t=t.filter(S=>{if(!S.created_at)return!1;const p=new Date(S.created_at).getTime();return p>=w&&p<=b}).slice(0,50),_(t)}catch(s){console.warn("skill_shares realtime payload error",s)}})}catch(i){console.warn("Failed to subscribe to skill_shares realtime (table may not exist):",i)}await n.subscribe().catch(i=>console.warn("Realtime subscription failed:",i));return}}catch(n){console.warn("realtime channel subscribe failed",n)}try{a.forEach(n=>{d.from(n).on("INSERT",i=>{try{const s=f(n,i.new,l);if(!s)return;const r=`${s.display_name}|${s.action}|${s.created_at}`;if(t.some(b=>`${b.display_name}|${b.action}|${b.created_at}`===r))return;t.unshift(s),t=t.slice(0,50),_(t)}catch{}}).subscribe().catch(i=>console.warn(`Realtime subscription failed for ${n}:`,i))});try{d.from("skill_shares").on("INSERT",n=>{try{const i=f("skill_shares",n.new,l);if(!i)return;const s=`${i.display_name}|${i.action}|${i.created_at}`;if(t.some(r=>`${r.display_name}|${r.action}|${r.created_at}`===s))return;t.unshift(i),t=t.slice(0,50),_(t)}catch(i){console.warn("skill_shares realtime fallback error",i)}}).subscribe().catch(n=>console.warn("Realtime subscription failed for skill_shares:",n))}catch(n){console.warn("Failed to subscribe to skill_shares realtime fallback (table may not exist):",n)}}catch(n){console.warn("realtime fallback failed",n)}}(async()=>(await m(),await h(),setInterval(()=>{m().catch(()=>{})},6e4)))()}function N(u,t){if(!t)return null;try{switch(u){case"agreement_votes":return t.voter_id?{display_name:t.voter_id,action:"Voted",meta:"",points:1,created_at:t.created_at||new Date().toISOString()}:null;case"suggestions":return t.author_id?{display_name:t.author_id,action:"Suggested",meta:t.title?`Suggestion: ${t.title}`:"Submitted a suggestion",points:1,created_at:t.created_at||new Date().toISOString()}:null;case"comments":return t.author_id?{display_name:t.author_id,action:"Commented",meta:t.reply_text?t.reply_text.slice(0,120):"Commented",points:1,created_at:t.created_at||new Date().toISOString()}:null;case"celebrations":return t.user_id?{display_name:t.user_id,action:"Posted on Celebration Wall",meta:"",points:5,created_at:t.created_at||new Date().toISOString()}:null;case"events":return t.created_by?{display_name:t.created_by,action:"Created event",meta:"",points:5,created_at:t.created_at||new Date().toISOString()}:null;case"group_projects":return t.proposer_id?{display_name:t.proposer_id,action:"Proposed a project",meta:"",points:5,created_at:t.created_at||new Date().toISOString()}:null;case"writers_wall":return t.author_id||t.author_name?{display_name:t.author_id||t.author_name,action:"Wrote for Writers Wall",meta:t.title||"",points:1,created_at:t.created_at||new Date().toISOString()}:null;case"event_attendance":return t.user_id?{display_name:t.user_id,action:"Attended an event",meta:"",points:5,created_at:t.created_at||new Date().toISOString()}:null;case"skill_shares":return t.presenter_id&&t.video_url?{display_name:t.presenter_id,action:"Shared a skill with video",meta:t.skill_name?`Skill: ${t.skill_name}`:"Skill shared with video",points:5,created_at:t.created_at||new Date().toISOString()}:null;case"site_visits":return{created_at:t.created_at||new Date().toISOString(),visit:!0};default:return null}}catch{return null}}function $(u,t){const c=N(u,t);if(!c)return;if(u==="site_visits"){try{const m=document.getElementById("visits-today-banner"),f=document.getElementById("visits-week-banner");if(m&&f&&c.created_at){isNaN(Number(m.textContent))||(m.textContent=String(Number(m.textContent)+1)),isNaN(Number(f.textContent))||(f.textContent=String(Number(f.textContent)+1)),setTimeout(C,5e3);return}}catch{}C().catch(()=>{});return}const _=`${c.display_name}|${c.action}|${c.created_at}`;currentItems.some(m=>`${m.display_name}|${m.action}|${m.created_at}`===_)||(currentItems.unshift(c),currentItems=currentItems.slice(0,50),renderActivities(currentItems))}async function q(){const u=["agreement_votes","suggestions","comments","celebrations","events","group_projects","writers_wall","site_visits","event_attendance"];try{if(typeof d.channel=="function"){const t=d.channel("realtime-activity");u.forEach(c=>{t.on("postgres_changes",{event:"INSERT",schema:"public",table:c},_=>{try{$(c,_.new)}catch(m){console.warn("realtime payload handling error",m)}})});try{t.on("postgres_changes",{event:"INSERT",schema:"public",table:"skill_shares"},c=>{try{$("skill_shares",c.new)}catch(_){console.warn("skill_shares realtime payload handling error",_)}})}catch(c){console.warn("Failed to subscribe to skill_shares realtime (table may not exist):",c)}await t.subscribe(),console.log("Realtime channel subscribed for activity tables");return}}catch(t){console.warn("channel subscribe failed",t)}try{u.forEach(t=>{try{const c=d.from(t).on("INSERT",_=>{try{$(t,_.new)}catch{}}).subscribe()}catch{}});try{const t=d.from("skill_shares").on("INSERT",c=>{try{$("skill_shares",c.new)}catch(_){console.warn("skill_shares realtime fallback error",_)}}).subscribe()}catch(t){console.warn("Failed to subscribe to skill_shares realtime fallback (table may not exist):",t)}console.log("Realtime fallback subscriptions registered")}catch(t){console.warn("realtime fallback failed",t)}}(async()=>(await loadActivities(),await q(),setInterval(()=>{loadActivities().catch(()=>{})},6e4)))();
