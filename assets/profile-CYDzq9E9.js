import"./modulepreload-polyfill-B5Qt9EMX.js";import{s as c}from"./supabase-vDZkBp_j.js";async function J(){let e=new URLSearchParams(window.location.search).get("id");if(!e){const{data:{user:l}}=await c.auth.getUser();if(!l)return;e=l.id}const{data:n}=await c.from("circle_members").select("circle_id").eq("user_id",e);if(!n||n.length===0){document.getElementById("member-circles-list").innerHTML="<li>Not a member of any circles yet.</li>";return}const t=n.map(l=>l.circle_id),{data:o}=await c.from("circles").select("id, name").in("id",t),s=document.getElementById("member-circles-list");if(!o||o.length===0){s.innerHTML="<li>Not a member of any circles yet.</li>";return}s.innerHTML=o.map(l=>`<li><a href="circle.html?id=${l.id}" style="color:#1976d2;text-decoration:underline;">${l.name}</a></li>`).join("")}J();const f=document.getElementById("show-messages-btn"),O=document.getElementById("all-messages-section"),p=document.getElementById("messages-list");f?.addEventListener("click",async()=>{f.disabled=!0,p.innerHTML="<em>Loading messages...</em>",O.style.display="block";let i;const e=new URLSearchParams(window.location.search).get("id");if(e)i=e;else{const{data:{user:o}}=await c.auth.getUser();if(!o){p.innerHTML='<span style="color:red;">Not logged in.</span>';return}i=o.id}const{data:n,error:t}=await c.from("personal_messages").select("id, content, created_at").eq("sender_id",i).order("created_at",{ascending:!1});if(t){p.innerHTML=`<span style='color:red;'>Error loading messages: ${t.message}</span>`,f.disabled=!1;return}if(!n||n.length===0){p.innerHTML="<em>No messages sent yet.</em>",f.disabled=!1;return}p.innerHTML=n.map(o=>`<div style='margin-bottom:14px;padding:10px 12px;background:#fff;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,0.04);'>
                    <div style='font-size:0.98em;color:#333;'>${o.content}</div>
                    <div style='font-size:0.85em;color:#888;margin-top:4px;'>Sent: ${new Date(o.created_at).toLocaleString()}</div>
                </div>`).join(""),f.disabled=!1});const K=document.getElementById("profile-images"),$=document.getElementById("image-thumbnails");K?.addEventListener("change",async i=>{$.innerHTML="";const a=Array.from(i.target.files),{data:e}=await c.auth.getUser();if(!e||!e.user){alert("Please log in to upload images."),window.location.href="login.html";return}const n=e.user.id;let t=[];for(const o of a){const s=`${n}/${Date.now()}_${o.name}`;let l;try{l=await c.storage.from("profile-pictures").upload(s,o,{upsert:!0})}catch(_){console.error("Upload threw error:",_),t.push(`Exception uploading ${o.name}: ${_.message||_}`);continue}const{data:r,error:d}=l;if(d){console.error("Supabase upload error:",d,l),t.push(`Error uploading ${o.name}: ${d.message}`);continue}if(console.log("Debug upload:",{userId:n,filePath:s,fileName:o.name}),!n||!s){t.push(`❌ Missing required fields for <b>${o.name}</b>: <code>user_id</code> or <code>file_path</code>. userId: <code>${n}</code>, filePath: <code>${s}</code>`);continue}const{error:m}=await c.from("profile_images").insert([{user_id:n,image_url:s}]);if(m){if(m.message&&m.message.includes("foreign key constraint")){t.push(`Foreign key error for ${o.name}: Your user ID does not match any profile. Please contact support.`);continue}if(m.message&&m.message.includes("row-level security policy")){t.push(`RLS policy error for ${o.name}: You are not allowed to insert this image. Make sure you are logged in and your user ID matches your profile.`);continue}t.push(`Error saving image info for ${o.name}: ${m.message}`);continue}const{data:g,error:M}=await c.storage.from("profile-pictures").createSignedUrl(s,3600);if(M||!g?.signedUrl){t.push(`Error creating signed URL for ${o.name}: ${M?.message||"No signed URL returned."}`);continue}const b=document.createElement("img");b.src=g.signedUrl,b.style.width="80px",b.style.margin="8px",$.appendChild(b)}t.length?$.innerHTML+=`<div style="color:red;margin-top:10px;">${t.join("<br>")}</div>`:await D()});const h=document.getElementById("linkedin"),U=document.getElementById("linkedin-link"),G=document.getElementById("website-list"),T=document.getElementById("website-link"),v=document.getElementById("substack"),H=document.getElementById("substack-link"),w=document.getElementById("instagram"),R=document.getElementById("instagram-link"),E=document.getElementById("facebook"),C=document.getElementById("facebook-link"),I=document.getElementById("twitter"),P=document.getElementById("twitter-link"),k=document.getElementById("youtube"),S=document.getElementById("youtube-link"),q=document.getElementById("contact-info"),A=document.getElementById("show-contact"),Q=document.getElementById("profile-form"),N=document.getElementById("update-button"),u=document.getElementById("status"),j=document.getElementById("full-name"),F=document.getElementById("phone"),V=document.getElementById("email"),z=document.getElementById("bio"),W=document.getElementById("avatar-input"),y=document.getElementById("avatar-image");let x,Y;document.getElementById("view-gallery-btn")?.addEventListener("click",async()=>{await D(),document.getElementById("gallery-modal").style.display="block"});async function D(){const{data:i}=await c.auth.getUser();if(!i?.user){console.log("[Gallery Debug] No user found, aborting gallery load.");return}const a=i.user.id,{data:e,error:n}=await c.from("profile_images").select("image_url, uploaded_at").limit(100).eq("user_id",a),t=document.getElementById("gallery-images");if(!t){console.log("[Gallery Debug] #gallery-images element not found in DOM.");return}if(console.log("[Gallery Debug] Retrieved images from DB:",e,"Count:",e?.length||0),e&&e.length){const o=await Promise.all(e.map(async s=>{const{data:l,error:r}=await c.storage.from("profile-pictures").createSignedUrl(s.image_url,3600);if(r||!l?.signedUrl)return console.log("[Gallery Debug] Error creating signed URL for",s.image_url,r),`<div style='color:red;'>Error loading image: ${r?.message||"No signed URL."}</div>`;const d=new Date(s.uploaded_at).toLocaleString();return`<div class="gallery-image-container">
                        <img src="${l.signedUrl}" style="width:180px;border-radius:8px;">
                        <div style="display:flex; flex-direction:column; align-items:center;">
                            <div class="icon-overlay" style="position:absolute; top:8px; right:8px;">
                                <button class="gallery-icon-btn icon-trash" title='Delete' onclick="deleteGalleryImage('${s.image_url}')"></button>
                                <button class="gallery-icon-btn icon-expand" title='Expand' onclick="window.open('${l.signedUrl}','_blank')"></button>
                            </div>
                            <div style="font-size:0.85em; color:#555; margin-top:4px;">${d}</div>
                        </div></div>`}));console.log("[Gallery Debug] Generated signed URLs, count:",o.length),t.innerHTML=o.join(""),console.log("[Gallery Debug] Rendered gallery HTML to #gallery-images.")}else t.innerHTML="<p>No pictures uploaded yet.</p>",console.log("[Gallery Debug] No images found for user, showing empty message.")}window.deleteGalleryImage=async function(i){if(!confirm("Delete this image? This cannot be undone."))return;const{error:a}=await c.storage.from("profile-pictures").remove([i]);if(a){alert("Error deleting from storage: "+a.message);return}const{error:e}=await c.from("profile_images").delete().eq("image_url",i);if(e){alert("Error deleting from database: "+e.message);return}D()};async function X(){const a=new URLSearchParams(window.location.search).get("id"),{data:{user:e}}=await c.auth.getUser();if(!e&&!a){window.location.href="index.html";return}x=e;const n=a||e&&e.id,{data:t,error:o}=await c.from("profiles").select("full_name, phone, avatar_url, bio, youtube, twitter, substack, website, linkedin, facebook, instagram, contact_info, show_contact").eq("id",n).single();if(o){console.error("Error loading profile:",o),y.src="https://via.placeholder.com/150";return}if(t){Y=t,j.value=t.full_name||"",F.value=t.phone||"",z.value=t.bio||"",k.value=t.youtube||"",I.value=t.twitter||"",v.value=t.substack||"";const s=t.website||"";G.innerHTML="",s&&s.trim()!==""?s.split(/\r?\n/).map(d=>d.trim()).filter(Boolean).forEach(d=>B(d)):B(""),h.value=t.linkedin||"",E.value=t.facebook||"",w.value=t.instagram||"";const l=t.avatar_url;if(l&&l.trim()!=="")if(l.startsWith("http"))y.src=l+"?t="+new Date().getTime();else{const{data:r}=c.storage.from("avatars").getPublicUrl(l);y.src=r.publicUrl+"?t="+new Date().getTime()}else y.src="https://via.placeholder.com/150";V.value=e&&n===e.id?e.email:"",t.contact_info!==void 0&&(q.value=t.contact_info||""),t.show_contact!==void 0&&(A.checked=!!t.show_contact)}}function B(i=""){const a=document.createElement("div");a.style.display="flex",a.style.gap="8px",a.style.marginBottom="8px";const e=document.createElement("input");e.type="text",e.className="website-input",e.placeholder="https://example.com",e.style.flex="1",e.style.padding="8px",e.value=i;const n=document.createElement("button");return n.type="button",n.textContent="✖",n.title="Remove",n.style.background="#e74c3c",n.style.color="#fff",n.style.border="none",n.style.borderRadius="6px",n.style.width="40px",n.style.cursor="pointer",n.addEventListener("click",()=>{a.remove(),L()}),e.addEventListener("input",()=>L()),a.appendChild(e),a.appendChild(n),G.appendChild(a),L(),e}document.getElementById("add-website-btn").addEventListener("click",()=>B(""));function L(){const i=Array.from(document.querySelectorAll(".website-input")).map(a=>a.value.trim()).filter(Boolean);if(i.length===0){T.innerHTML="";return}T.innerHTML=i.map(a=>{let e=a;return/^https?:\/\//i.test(e)||(e="https://"+e),`<div style="margin-bottom:6px;"><a href="${e}" target="_blank" style="color:#2196f3;text-decoration:underline;">${a}</a></div>`}).join("")}W.addEventListener("change",i=>{const a=i.target.files[0];if(a){const e=new FileReader;e.onload=n=>{y.src=n.target.result},e.readAsDataURL(a)}});Q.addEventListener("submit",async i=>{if(k.value.trim()!==""){let r=k.value.trim();S.innerHTML=`<a href="${r}" target="_blank" style="color:#2196f3;text-decoration:underline;">${r}</a>`}else S.innerHTML="";if(I.value.trim()!==""){let r=I.value.trim();P.innerHTML=`<a href="${r}" target="_blank" style="color:#2196f3;text-decoration:underline;">${r}</a>`}else P.innerHTML="";if(v.value.trim()!==""){let r=v.value.trim();H.innerHTML=`<a href="${r}" target="_blank" style="color:#2196f3;text-decoration:underline;">${r}</a>`}else H.innerHTML="";const e=Array.from(document.querySelectorAll(".website-input")).map(r=>r.value.trim()).filter(Boolean).join(`
`);if(L(),h.value.trim()!==""){let r=h.value.trim();U.innerHTML=`<a href="${r}" target="_blank" style="color:#2196f3;text-decoration:underline;">${r}</a>`}else U.innerHTML="";if(E.value.trim()!==""){let r=E.value.trim();C.innerHTML=`<a href="${r}" target="_blank" style="color:#2196f3;text-decoration:underline;">${r}</a>`}else C.innerHTML="";if(w.value.trim()!==""){let r=w.value.trim();R.innerHTML=`<a href="${r}" target="_blank" style="color:#2196f3;text-decoration:underline;">${r}</a>`}else R.innerHTML="";i.preventDefault(),N.disabled=!0,u.textContent="Updating...",u.style.color="black";const n=j.value.trim(),t=F.value.trim(),o=z.value.trim(),s=W.files[0];let l=Y.avatar_url;try{if(s){const d=s.name.split(".").pop(),m=`${x.id}/${Date.now()}.${d}`,{error:g}=await c.storage.from("avatars").upload(m,s,{upsert:!0});if(g)throw g;l=m}const{error:r}=await c.from("profiles").update({full_name:n,phone:t,avatar_url:l,bio:o,youtube:k.value.trim(),twitter:I.value.trim(),substack:v.value.trim(),website:e,linkedin:h.value.trim(),facebook:E.value.trim(),instagram:w.value.trim(),contact_info:q.value.trim(),show_contact:!!A.checked}).eq("id",x.id);r?(u.textContent=`❌ Update failed: ${r.message}`,u.style.color="red",console.error("Supabase update error:",r)):(u.textContent="✅ Profile updated successfully!",u.style.color="green",window.location.reload())}catch(r){u.textContent=`Error: ${r.message}`,u.style.color="red",console.error(r)}finally{N.disabled=!1}});async function Z(){const{data:i,error:a}=await c.from("profiles").select("full_name, email");if(a){console.error("Error fetching member emails:",a);return}const e=document.getElementById("email-list");i.sort((n,t)=>n.full_name.localeCompare(t.full_name,void 0,{sensitivity:"base"})),i.forEach(n=>{const t=document.createElement("li");t.textContent=`${n.full_name} - ${n.email}`,e.appendChild(t)})}Z();X();
