import"./modulepreload-polyfill-B5Qt9EMX.js";import{s}from"./supabase-vDZkBp_j.js";async function g(){const u=new Date(Date.now()-12096e5),r=u.toISOString().split(".")[0]+"Z";try{const e=document.getElementById("news-list");e&&document.querySelectorAll(".container > .news-card").forEach(i=>{if(i.compareDocumentPosition(e)&Node.DOCUMENT_POSITION_FOLLOWING){const h=i.querySelector(".news-date");if(!h)return;const o=new Date(h.textContent.trim());!isNaN(o)&&o<u&&i.remove()}})}catch(e){console.warn("Prune static cards failed",e)}let a,w,b,y,d,c,m,l,p,n,f,_;try{[a,w,b,y,d,c,m,l,p,n,f,_]=await Promise.all([s.from("agreements").select("id, created_at, agreement_text").gte("created_at",r),s.from("circles").select("id, created_at, name, description").gte("created_at",r),s.from("comments").select("id, created_at, content, project_id, discussion_id").gte("created_at",r),s.from("discussions").select("id, created_at, title, description").gte("created_at",r),s.from("group_projects").select("id, created_at, name").gte("created_at",r),s.from("suggestions").select("id, created_at, description").gte("created_at",r),s.from("events").select("id, title, description, start_time, end_time, location, zoom_link, timezone, created_at").gte("created_at",r),s.from("support_requests").select("id, created_at, mission_title, mission_description").gte("created_at",r),s.from("member_offerings").select("id, created_at, title, description").gte("created_at",r),s.from("skill_shares").select("id, created_at, skill_name, skill_description, video_url").gte("created_at",r),s.from("member_video").select("id, created_at, caption, video_url").gte("created_at",r),s.from("contributions").select("id, created_at, title, description").gte("created_at",r)])}catch(e){console.error("Failed fetching whats-new data:",e),a=w=b=y=d=c=m=l=p=n=f=_={data:[]}}console.log("Agreements response:",a),a.error&&console.error("Agreements error:",a.error),console.log("Suggestions response:",c),c.error&&console.error("Suggestions error:",c.error),m.error&&console.error("Events error:",m.error),console.log("Support Requests response:",l),l.error&&console.error("Support Requests error:",l.error),console.log("Group Projects response:",d),d.error&&console.error("Group Projects error:",d.error),console.log("Member Offerings response:",p),p.error&&console.error("Member Offerings error:",p.error),console.log("Skill Shares response:",n),n.error&&console.error("Skill Shares error:",n.error),console.log("Member Video response:",f),f.error&&console.error("Member Video error:",f.error),console.log("Contributions response:",_),_.error&&console.error("Contributions error:",_.error);const t=[];m.data?.forEach(e=>{t.push({type:"Event",id:e.id,title:e.title||"New Event",description:(e.description?e.description+"<br>":"")+(e.start_time?`<b>Start:</b> ${new Date(e.start_time).toLocaleString()}<br>`:"")+(e.end_time?`<b>End:</b> ${new Date(e.end_time).toLocaleString()}<br>`:"")+(e.location?`<b>Location:</b> ${e.location}<br>`:"")+(e.zoom_link?`<b>Zoom:</b> <a href='${e.zoom_link}' target='_blank'>Join Meeting</a><br>`:""),created_at:e.created_at})}),a.data?.forEach(e=>{t.push({type:"Agreement",id:e.id,title:"New Agreement",description:e.agreement_text||"",created_at:e.created_at})}),w.data?.forEach(e=>{t.push({type:"Circle",id:e.id,title:e.name||"New Circle",description:e.description||"",created_at:e.created_at})}),b.data?.forEach(e=>{let i="";e.project_id?i=`group-projects.html?id=${e.project_id}`:e.discussion_id&&(i=`discussions.html?id=${e.discussion_id}`),t.push({type:"Comment",id:e.id,title:"New Comment",description:e.content||"",created_at:e.created_at,link:i})}),y.data?.forEach(e=>{t.push({type:"Discussion",id:e.id,title:e.title||"New Discussion",description:e.description||"",created_at:e.created_at})}),d.data?.forEach(e=>{t.push({type:"Group Project",id:e.id,title:e.name||"New Group Project",description:"",created_at:e.created_at||new Date().toISOString()})}),p.data?.forEach(e=>{t.push({type:"Member Offering",id:e.id,title:e.title||"New Member Offering",description:e.description||"",created_at:e.created_at})}),n.data?.forEach(e=>{t.push({type:"Skill Share",id:e.id,title:e.title||"New Skill Share",description:e.description||"",created_at:e.created_at})}),f.data?.forEach(e=>{t.push({type:"Member Video",id:e.id,title:e.caption||"New Member Video",description:e.video_url?`Video: ${e.video_url}`:"",created_at:e.created_at})}),n.data?.forEach(e=>{e.video_url&&t.push({type:"Skill Share Video",id:e.id,title:e.skill_name||"New Skill Share",description:e.skill_description?`${e.skill_description} - Video: ${e.video_url}`:`Video: ${e.video_url}`,created_at:e.created_at})}),_.data?.forEach(e=>{t.push({type:"Contribution",id:e.id,title:e.title||"New Contribution",description:e.description||"",created_at:e.created_at})}),c.data?.forEach(e=>{t.push({type:"Discussion",id:e.id,title:"New Discussion",description:e.description||"",created_at:e.created_at})}),l.data?.forEach(e=>{t.push({type:"Support Request",id:e.id,title:e.mission_title||"New Support Request",description:e.mission_description||"",created_at:e.created_at})}),t.forEach(e=>{e.created_at||(e.created_at=new Date().toISOString())}),t.sort((e,i)=>new Date(i.created_at)-new Date(e.created_at));const S=document.getElementById("news-list");if(t.length===0){S.innerHTML="<em>No new activities or updates in the last 5 days.</em>";return}S.innerHTML=t.map(function(e){let i="",h=e.title,o="";return e.type==="Event"&&e.id&&(i='<span style="font-size:1.2em;">üìÖ</span> ',o='<a href="events-calendar.html">View Calendar</a>'),e.type==="Circle"&&e.id&&(i='<span style="color:gold;font-size:1.2em;">&#9733;&#9733;&#9733;</span> <span style="font-size:1.2em;">üëèüëè</span> ',o=`<a href="circle.html?id=${e.id}">View Circle</a>`),e.type==="Agreement"&&e.id&&(h="Agreement for Voting",i='<span style="font-size:1.2em;">üó≥Ô∏èüó≥Ô∏èüó≥Ô∏è</span> ',o=`<a href="agreements.html?id=${e.id}">View Agreement</a>`),e.type==="Discussion"&&e.id&&(o=`<a href="discussions.html?id=${e.id}">View Discussion</a>`),e.type==="Group Project"&&e.id&&(o=`<a href="group-projects.html?id=${e.id}">View Project</a>`),e.type==="Contribution"&&e.id&&(o=`<a href="activities.html?id=${e.id}">View Activity</a>`),e.type==="Skill Share"&&e.id&&(o=`<a href="skill-shares.html?id=${e.id}">View Skill Share</a>`),e.type==="Member Offering"&&e.id&&(o=`<a href="member-offering.html?id=${e.id}">View Offering</a>`),e.type==="Support Request"&&e.id&&(o=`<a href="view-support-request.html?id=${e.id}">View Support Request</a>`),e.link&&(o=`<a href="${e.link}" target="_blank">Explore</a>`),['<div class="news-card">',"<div>",'<span class="news-type">',e.type,"</span>",'<span class="news-date">',new Date(e.created_at).toLocaleString(),"</span>","</div>",'<div class="news-title">',i,h,"</div>","<div>",e.description||"","</div>",o,"</div>"].join("")}).join("")}g();document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&g()});setInterval(g,6e4);(function(){try{["group_projects","events","suggestions","agreements","support_requests","member_offerings","skill_shares","member_video","contributions","comments"].forEach(r=>{try{s.from(r).on("*",a=>{window._whatsNewTimer&&clearTimeout(window._whatsNewTimer),window._whatsNewTimer=setTimeout(g,500)}).subscribe()}catch(a){console.warn("Realtime subscribe failed for",r,a)}})}catch(u){console.warn("Realtime subscription setup failed",u)}})();
