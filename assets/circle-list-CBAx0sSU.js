import"./modulepreload-polyfill-B5Qt9EMX.js";import{s as r}from"./supabase-vDZkBp_j.js";const l=document.getElementById("circles");let s=null,f=[],d={};async function w(){const{data:e}=await r.auth.getUser();if(s=e?.user?.id,s){const c=localStorage.getItem(`circleLastRead_${s}`);c&&(d=JSON.parse(c))}}async function h(){const{data:e}=await r.from("circle_members").select("circle_id").eq("user_id",s);f=e?e.map(c=>c.circle_id):[]}async function b(e){if(!s)return 0;const c=d[e]||"1970-01-01T00:00:00Z";let t=0;try{const{data:i}=await r.from("circle_messages").select("id").eq("circle_id",e).gt("created_at",c),{data:n}=await r.from("blog_posts").select("id").eq("circle_id",e).gt("created_at",c);t=(i?.length||0)+(n?.length||0)}catch(i){console.warn("Error checking for new content:",i)}return t}async function p(){await w(),await h();const{data:e,error:c}=await r.from("circles").select("*");if(l.innerHTML="",c){console.error("Error loading circles:",c),l.innerHTML="<p>Error loading circles. Please try again later.</p>";return}if(!e||e.length===0){l.innerHTML=`
          <div class="circle-card">
            <strong>Welcome Circle</strong><br>
            <span>A place for new members to get started and connect with the community.</span>
            <div class="circle-actions">
              <button>Join Circle</button>
            </div>
          </div>
          <p style="margin-top: 2rem;"><a href="create-circle.html" class="menu-button" style="display:inline-block;">Create a New Circle</a></p>
        `;return}for(const t of e){const i=await b(t.id),n=i>0?`<span style="background:#ff4444;color:white;padding:2px 6px;border-radius:10px;font-size:0.8em;margin-left:8px;">${i} new</span>`:"",a=document.createElement("div");a.className="circle-card",a.innerHTML=`
          <strong>${t.name}${n}</strong><br>
          <span>${t.description||""}</span>
          <div class="circle-actions"></div>
        `;const m=a.querySelector(".circle-actions");if(f.includes(t.id)){const o=document.createElement("button");o.textContent="Leave Circle",o.onclick=async()=>{await r.from("circle_members").delete().eq("circle_id",t.id).eq("user_id",s),alert("Left circle!"),p()},m.appendChild(o);const u=document.createElement("button");u.textContent="Enter Circle",u.onclick=()=>{d[t.id]=new Date().toISOString(),localStorage.setItem(`circleLastRead_${s}`,JSON.stringify(d)),localStorage.setItem("active_circle_id",t.id),alert("Entered "+t.name),window.location.href=`circle.html?id=${t.id}`},m.appendChild(u)}else{const o=document.createElement("button");o.textContent="Join Circle",o.onclick=async()=>{await r.from("circle_members").insert([{circle_id:t.id,user_id:s}]),alert("Joined circle!"),p()},m.appendChild(o)}l.appendChild(a)}}function _(e,c){const t=document.createElement("a");return t.href=`circle.html?id=${encodeURIComponent(e.id)}`,t.className="quick-circle-btn",t.innerHTML=`<span>${e.name}</span>`+(typeof c=="number"?`<span class="quick-circle-count">(${c})</span>`:""),t}async function g(){const e=document.getElementById("quick-circles");e.innerHTML="";try{const{data:c,error:t}=await r.from("circles").select("id,name");if(t){console.warn("Error loading quick circles:",t);return}if(!c||!c.length){e.innerHTML="<em>No circles available</em>";return}const i=await Promise.all(c.map(async n=>{const{count:a}=await r.from("circle_members").select("id",{head:!0,count:"exact"}).eq("circle_id",n.id);return{id:n.id,name:n.name,count:a||0}}));i.sort((n,a)=>a.count-n.count),i.forEach(n=>e.appendChild(_(n,n.count)))}catch(c){console.warn("Quick circles load failed",c)}}g();try{r.channel("public:circle_members").on("postgres_changes",{event:"*",schema:"public",table:"circle_members"},()=>{clearTimeout(window.__quickCirclesTimer),window.__quickCirclesTimer=setTimeout(g,500)}).subscribe()}catch(e){console.warn("Realtime quick circles failed",e)}p();
