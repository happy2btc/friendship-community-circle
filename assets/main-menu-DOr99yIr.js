import"./modulepreload-polyfill-B5Qt9EMX.js";import{s}from"./supabase-vDZkBp_j.js";async function q(){try{let m=function(e){_[e]||(_[e]={votes:0,suggestions:0,comments:0,wants:0,offers:0,passion:0,projects:0,profile:0,circles_created:0,members_added:0,celebrations_posted:0,events_created:0,events_attended:0,help_hours:0,help_points:0,support_responses:0,writer_posts:0,writer_points:0,videos_posted:0,positive_impact:0,projects_proposed:0})};const[a,i,c,h,f,g,E,k,R,v,$,y,N,l,p,d,w]=await Promise.all([s.from("agreement_votes").select("voter_id"),s.from("suggestions").select("author_id"),s.from("comments").select("author_id"),s.from("member_offerings").select("user_id, want, give, passion"),s.from("contributions").select("user_id, project, challenge, help, collab, skills, urgency, contact"),s.from("profiles").select("id, full_name, avatar_url, personal_story"),s.from("circles").select("created_by"),s.from("circle_members").select("added_by"),s.from("celebrations").select("user_id"),s.from("events").select("created_by"),s.from("help_given").select("helper_id, hours"),s.from("support_responses").select("responder_id"),s.from("writers_wall").select("author_id, points"),s.from("member_video").select("user_id"),s.from("positive_impact").select("contributor_id, points_awarded"),s.from("event_attendance").select("user_id"),s.from("group_projects").select("proposer_id")]),b="81c50097-74f3-4c7a-b00c-598995b8d1cb",n={},_={};a.data?.forEach(e=>{e.voter_id!==b&&(m(e.voter_id),_[e.voter_id].votes+=1,n[e.voter_id]=(n[e.voter_id]||0)+1)}),i.data?.forEach(e=>{e.author_id!==b&&(m(e.author_id),_[e.author_id].suggestions+=1,n[e.author_id]=(n[e.author_id]||0)+1)}),c.data?.forEach(e=>{e.author_id!==b&&(m(e.author_id),_[e.author_id].comments+=1,n[e.author_id]=(n[e.author_id]||0)+1)}),h.data?.forEach(e=>{e.user_id!==b&&(m(e.user_id),e.want?.trim()&&(_[e.user_id].wants+=1,n[e.user_id]=(n[e.user_id]||0)+1),e.give?.trim()&&(_[e.user_id].offers+=1,n[e.user_id]=(n[e.user_id]||0)+1),e.passion?.trim()&&(_[e.user_id].passion+=1,n[e.user_id]=(n[e.user_id]||0)+1))}),f.data?.forEach(e=>{if(e.user_id!==b){m(e.user_id);let t=0;["project","challenge","help","collab","skills","urgency","contact"].forEach(o=>{e[o]?.trim()&&(t+=1)}),_[e.user_id].projects+=t,n[e.user_id]=(n[e.user_id]||0)+t}}),g.data?.forEach(e=>{if(e.id!==b){let t=0;e.full_name?.trim()&&t++,e.avatar_url?.trim()&&t++,t>=1&&(m(e.id),_[e.id].profile=1,n[e.id]=(n[e.id]||0)+5)}}),E.data?.forEach(e=>{e.created_by&&e.created_by!==b&&(m(e.created_by),_[e.created_by].circles_created+=1,n[e.created_by]=(n[e.created_by]||0)+10)}),k.data?.forEach(e=>{e.added_by&&e.added_by!==b&&(m(e.added_by),_[e.added_by].members_added+=1,n[e.added_by]=(n[e.added_by]||0)+2)}),R.data?.forEach(e=>{e.user_id&&e.user_id!==b&&(m(e.user_id),_[e.user_id].celebrations_posted+=1,n[e.user_id]=(n[e.user_id]||0)+5)}),v.data?.forEach(e=>{e.created_by&&e.created_by!==b&&(m(e.created_by),_[e.created_by].events_created+=1,n[e.created_by]=(n[e.created_by]||0)+5)}),d.data?.forEach(e=>{e.user_id&&e.user_id!==b&&(m(e.user_id),_[e.user_id].events_attended+=1,n[e.user_id]=(n[e.user_id]||0)+5)}),$.data?.forEach(e=>{e.helper_id&&e.hours&&e.helper_id!==b&&(m(e.helper_id),_[e.helper_id].help_hours+=Number(e.hours),_[e.helper_id].help_points+=e.hours*5,n[e.helper_id]=(n[e.helper_id]||0)+e.hours*5)}),y.data?.forEach(e=>{e.responder_id&&e.responder_id!==b&&(m(e.responder_id),_[e.responder_id].support_responses+=1,n[e.responder_id]=(n[e.responder_id]||0)+5)}),N.data?.forEach(e=>{e.author_id&&(m(e.author_id),_[e.author_id].writer_posts+=1,_[e.author_id].writer_points+=e.points||0,n[e.author_id]=(n[e.author_id]||0)+(e.points||0))}),l.data?.forEach(e=>{e.user_id&&e.user_id!==b&&(m(e.user_id),_[e.user_id].videos_posted=(_[e.user_id].videos_posted||0)+1,n[e.user_id]=(n[e.user_id]||0)+5)}),p.data?.forEach(e=>{e.contributor_id&&(m(e.contributor_id),_[e.contributor_id].positive_impact+=e.points_awarded,n[e.contributor_id]=(n[e.contributor_id]||0)+e.points_awarded)}),w.data?.forEach(e=>{e.proposer_id&&e.proposer_id!==b&&(m(e.proposer_id),_[e.proposer_id].projects_proposed+=1,n[e.proposer_id]=(n[e.proposer_id]||0)+5)});const j=Object.keys(n).filter(e=>e&&e!=="null");if(j.length>0){const e={};g.data?.forEach(u=>{e[u.id]=u});const t=j.map(u=>({id:u,profile:e[u]||{full_name:u,avatar_url:"",personal_story:""},total:n[u],breakdown:_[u]}));t.sort((u,I)=>I.total-u.total);const o=t[0],r=document.getElementById("most-active-member");r.innerHTML=`
            <a href="activities.html" style="text-decoration: none; color: inherit; display: block;">
                <img src="${o.profile.avatar_url||"default-avatar.png"}" alt="Profile Picture" style="width:64px;height:64px;border-radius:50%;object-fit:cover;margin-bottom:1em;">
                <h3>${o.profile.full_name||o.id}</h3>
                <div class="activity-breakdown" style="margin-top:0.5em;">
                    <strong>Total: ${o.total}</strong>
                </div>
            </a>`}}catch(a){console.error("Error fetching most active member:",a)}}q();async function F(){const[a,i,c,h,f,g,E,k,R,v,$,y,N]=await Promise.all([s.from("agreement_votes").select("voter_id, created_at"),s.from("suggestions").select("author_id, created_at"),s.from("comments").select("author_id, created_at"),s.from("member_offerings").select("user_id, want, give, passion"),s.from("contributions").select("user_id, project, challenge, help, collab, skills, urgency, contact"),s.from("profiles").select("id, full_name, avatar_url, personal_story, bio, youtube, twitter, substack, facebook, instagram, linkedin, website"),s.from("circles").select("id, name, created_by"),s.from("circle_members").select("added_by"),s.from("celebrations").select("user_id"),s.from("events").select("id, created_by"),s.from("help_given").select("helper_id, hours"),s.from("support_responses").select("responder_id"),s.from("writers_wall").select("author_id, points")]);let l=await s.from("event_attendance").select("event_id, user_id");const p="81c50097-74f3-4c7a-b00c-598995b8d1cb",d={};function w(t){d[t]||(d[t]={votes:0,suggestions:0,comments:0,wants:0,offers:0,passion:0,projects:0,profile:0,circles_created:0,members_added:0,celebrations_posted:0,events_created:0,events_attended:0,help_hours:0,help_points:0,support_responses:0,writer_posts:0,writer_points:0})}$.data&&$.data.forEach(t=>{t.helper_id&&t.hours&&t.helper_id!==p&&(w(t.helper_id),d[t.helper_id].help_hours=(Number(d[t.helper_id].help_hours)||0)+Number(t.hours),d[t.helper_id].help_points=(d[t.helper_id].help_points||0)+t.hours*5)}),y.data&&y.data.forEach(t=>{t.responder_id&&t.responder_id!==p&&(w(t.responder_id),d[t.responder_id].support_responses=(d[t.responder_id].support_responses||0)+1)}),a.data?.forEach(t=>{t.voter_id!==p&&(w(t.voter_id),d[t.voter_id].votes+=1)}),i.data?.forEach(t=>{t.author_id!==p&&(w(t.author_id),d[t.author_id].suggestions+=1)}),c.data?.forEach(t=>{t.author_id!==p&&(w(t.author_id),d[t.author_id].comments+=1)}),h.data?.forEach(t=>{t.user_id!==p&&(w(t.user_id),t.want&&t.want.trim()!==""&&(d[t.user_id].wants+=1),t.give&&t.give.trim()!==""&&(d[t.user_id].offers+=1),t.passion&&t.passion.trim()!==""&&(d[t.user_id].passion+=1))});const b={};f.data?.forEach(t=>{t.user_id!==p&&(b[t.user_id]=b[t.user_id]||[],b[t.user_id].push(t))}),Object.entries(b).forEach(([t,o])=>{w(t);let r=0;o.forEach(u=>{["project","challenge","help","collab","skills","urgency","contact"].forEach(I=>{u[I]&&u[I].trim()!==""&&(r+=1)})}),d[t].projects+=r}),g.data?.forEach(t=>{if(t.id!==p){let o=0;t.full_name&&t.full_name.trim()!==""&&o++,t.bio&&t.bio.trim()!==""&&o++,t.avatar_url&&t.avatar_url.trim()!==""&&o++,(t.youtube||t.twitter||t.substack||t.facebook||t.instagram||t.linkedin||t.website)&&o++,o>=2&&(w(t.id),d[t.id].profile=1)}}),E.data?.forEach(t=>{t.created_by&&t.created_by!==p&&(w(t.created_by),d[t.created_by].circles_created=(d[t.created_by].circles_created||0)+1)}),membersData?.forEach(t=>{t.added_by&&t.added_by!==p&&(w(t.added_by),d[t.added_by].members_added=(d[t.added_by].members_added||0)+1)}),R.data?.forEach(t=>{t.user_id&&t.user_id!==p&&(w(t.user_id),d[t.user_id].celebrations_posted=(d[t.user_id].celebrations_posted||0)+1)}),v.data?.forEach(t=>{const o=t.created_by;o&&o!==p&&(w(o),d[o].events_created=(d[o].events_created||0)+1)}),l.data?.forEach(t=>{const o=t.user_id;o&&o!==p&&(w(o),d[o].events_attended=(d[o].events_attended||0)+1)}),N.data&&N.data.forEach(t=>{t.author_id&&(w(t.author_id),d[t.author_id].writer_posts=(d[t.author_id].writer_posts||0)+1,d[t.author_id].writer_points=(d[t.author_id].writer_points||0)+(t.points||0))});const n={};Array.isArray(g.data)&&g.data.forEach(t=>{t&&typeof t.id=="string"&&t.id.trim()!==""&&(n[t.id]=t)});const _=Object.keys(d).filter(t=>t&&t!=="null"),m=document.getElementById("most-active-member");if(m.innerHTML="",_.length===0){m.innerHTML="<em>No other member has been active.</em>";return}const j=_.map(t=>{const o=d[t],r=n[t]||{full_name:t,avatar_url:"",personal_story:""},u=(o.votes||0)*1+(o.suggestions||0)*1+(o.comments||0)*1+(o.wants||0)*1+(o.offers||0)*1+(o.passion||0)*1+(o.projects||0)*1+(o.projects_proposed||0)*5+(o.events_created||0)*5+(o.events_attended||0)*5+(o.profile||0)*5+(o.circles_created||0)*10+(o.members_added||0)*2+(o.celebrations_posted||0)*5+(o.help_points||0)+(o.support_responses||0)*5+(o.writer_points||0);return{id:t,profile:r,total:u,breakdown:o}});j.sort((t,o)=>o.total-t.total);const e=j[0];m.innerHTML+=`
      <a href="view-profile.html?id=${e.id}" style="text-decoration: none; color: inherit; display: block;">
          <img src="${e.profile.avatar_url&&e.profile.avatar_url.trim()!==""?e.profile.avatar_url:"default-avatar.png"}" alt="Profile Picture" style="width:64px;height:64px;border-radius:50%;object-fit:cover;margin-bottom:1em;">
          <h3>${e.profile.full_name}</h3>
          <div class="activity-breakdown" style="margin-top:0.5em;">
              <strong>All-Time Activities:</strong><br>
              Votes: ${e.breakdown.votes||0}<br>
              Suggestions: ${e.breakdown.suggestions||0}<br>
              Comments: ${e.breakdown.comments||0}<br>
              Wants: ${e.breakdown.wants||0}<br>
              Offers: ${e.breakdown.offers||0}<br>
              Passion: ${e.breakdown.passion||0}<br>
              Projects & Struggles: ${e.breakdown.projects||0}<br>
              <span style="color:#2e8b57;font-weight:bold;">Help Given: ${e.breakdown.help_hours||0} hours</span><br>
              Events Created: ${e.breakdown.events_created||0}<br>
              Events Attended: ${e.breakdown.events_attended||0}<br>
              Profile Completed: ${e.breakdown.profile?"‚úîÔ∏è":"‚Äî"}<br>
              Circles Created: ${e.breakdown.circles_created||0}<br>
              Members Added: ${e.breakdown.members_added||0}<br>
              Celebration Wall Posts: ${e.breakdown.celebrations_posted||0}<br>
              Support Responses: ${e.breakdown.support_responses||0}<br>
              <span style="color:#4a7c59;font-weight:bold;">Writer's Posts: ${e.breakdown.writer_posts||0}</span><br>
              <strong>Total:</strong> ${e.total}
          </div>
          <div class="personal-story">${e.profile.personal_story||""}</div>
      </a>`}async function G(){const a="81c50097-74f3-4c7a-b00c-598995b8d1cb",i={},c={},[h,f,g,E,k,R,v,$,y,N,l,p,d,w,b]=await Promise.all([s.from("writers_wall").select("author_id, points"),s.from("help_given").select("helper_id, hours"),s.from("event_attendance").select("user_id"),s.from("events").select("created_by"),s.from("support_responses").select("responder_id"),s.from("agreement_votes").select("voter_id"),s.from("suggestions").select("author_id"),s.from("comments").select("author_id"),s.from("member_offerings").select("user_id, want, give, passion"),s.from("contributions").select("user_id, project, challenge, help, collab, skills, urgency, contact"),s.from("profiles").select("id"),s.from("circles").select("created_by"),s.from("circle_members").select("added_by"),s.from("celebrations").select("user_id"),s.from("group_projects").select("proposer_id")]);function n(r){c[r]||(c[r]={})}(h.data||[]).forEach(r=>{r.author_id&&r.author_id!==a&&(n(r.author_id),c[r.author_id].writer_points=(c[r.author_id].writer_points||0)+(r.points||0),c[r.author_id].writer_posts=(c[r.author_id].writer_posts||0)+1,i[r.author_id]=(i[r.author_id]||0)+(r.points||0))}),(f.data||[]).forEach(r=>{r.helper_id&&r.helper_id!==a&&(n(r.helper_id),c[r.helper_id].help_hours=(c[r.helper_id].help_hours||0)+Number(r.hours||0),c[r.helper_id].help_points=(c[r.helper_id].help_points||0)+Number(r.hours||0)*5,i[r.helper_id]=(i[r.helper_id]||0)+Number(r.hours||0)*5)});const _={};(g.data||[]).forEach(r=>{r.user_id&&r.user_id!==a&&(_[r.user_id]=(_[r.user_id]||0)+1)}),Object.entries(_).forEach(([r,u])=>{i[r]=(i[r]||0)+u*5}),(E.data||[]).forEach(r=>{r.created_by&&r.created_by!==a&&(i[r.created_by]=(i[r.created_by]||0)+5)}),(k.data||[]).forEach(r=>{r.responder_id&&r.responder_id!==a&&(i[r.responder_id]=(i[r.responder_id]||0)+5)}),(R.data||[]).forEach(r=>{r.voter_id&&r.voter_id!==a&&(i[r.voter_id]=(i[r.voter_id]||0)+1)}),(v.data||[]).forEach(r=>{r.author_id&&r.author_id!==a&&(i[r.author_id]=(i[r.author_id]||0)+1)}),($.data||[]).forEach(r=>{r.author_id&&r.author_id!==a&&(i[r.author_id]=(i[r.author_id]||0)+1)}),(y.data||[]).forEach(r=>{if(r.user_id&&r.user_id!==a){let u=0;r.want&&r.want.trim()&&(u+=1),r.give&&r.give.trim()&&(u+=1),r.passion&&r.passion.trim()&&(u+=1),i[r.user_id]=(i[r.user_id]||0)+u}});const m={};(N.data||[]).forEach(r=>{r.user_id&&r.user_id!==a&&(m[r.user_id]=m[r.user_id]||[],m[r.user_id].push(r))}),Object.entries(m).forEach(([r,u])=>{let I=0;u.forEach(x=>{["project","challenge","help","collab","skills","urgency","contact"].forEach(S=>{x[S]&&x[S].toString().trim()!==""&&I++})}),i[r]=(i[r]||0)+I}),(l.data||[]).forEach(r=>{r.id&&r.id!==a&&(i[r.id]=(i[r.id]||0)+0)}),(p.data||[]).forEach(r=>{r.created_by&&r.created_by!==a&&(i[r.created_by]=(i[r.created_by]||0)+10)}),(d.data||[]).forEach(r=>{r.added_by&&r.added_by!==a&&(i[r.added_by]=(i[r.added_by]||0)+2)}),(w.data||[]).forEach(r=>{r.user_id&&r.user_id!==a&&(i[r.user_id]=(i[r.user_id]||0)+5)}),(b.data||[]).forEach(r=>{r.proposer_id&&r.proposer_id!==a&&(i[r.proposer_id]=(i[r.proposer_id]||0)+5)});const j=Object.keys(i).filter(r=>r&&r!=="null"),{data:e}=await s.from("profiles").select("id, full_name, avatar_url"),t={};(e||[]).forEach(r=>{t[r.id]=r});const o=j.map(r=>({id:r,profile:t[r]||{full_name:r},total:i[r]}));return o.sort((r,u)=>u.total-r.total),o}async function A(){const a=document.getElementById("community-total");if(a){a.textContent="Loading community total...";try{const c=(await G()||[]).reduce((h,f)=>h+(Number(f.total)||0),0);a.textContent=`Community Total Achievement Points: ${c}`}catch(i){console.error("Error computing community total from activities:",i),a.textContent="Community total unavailable"}}}function z(){["agreement_votes","suggestions","comments","member_offerings","contributions","profiles","circles","circle_members","celebrations","events","help_given","support_responses","writers_wall","event_attendance","group_projects"].forEach(i=>{try{s.from(i).on("*",c=>{window._communityTotalTimer&&clearTimeout(window._communityTotalTimer),window._communityTotalTimer=setTimeout(A,500)}).subscribe()}catch(c){console.warn("Realtime subscribe failed for",i,c)}})}A();z();async function K(){const a=new Date("2025-09-19T00:00:00Z"),{data:i}=await s.from("profiles").select("id, full_name, avatar_url, affirmation_text, affirmation_date").order("affirmation_date",{ascending:!1}),c=(i||[]).filter(f=>f.affirmation_date&&new Date(f.affirmation_date)>=a).sort((f,g)=>new Date(g.affirmation_date)-new Date(f.affirmation_date)).slice(0,3),h=document.getElementById("newest-member");if(h.innerHTML="",c.length===0){h.innerHTML="<em>No new member since 9/19/2025.</em>";return}for(const f of c){const{data:g}=await s.from("circle_members").select("circle_id").eq("user_id",f.id),{data:E}=await s.from("circles").select("id, name").eq("created_by",f.id);let k=[],R=[];if(E&&E.length>0)for(const y of E)R.push(y.name),k.push(y.name+" (creator)");if(g&&g.length>0){const y=g.map(l=>l.circle_id),{data:N}=await s.from("circles").select("id, name").in("id",y);if(N)for(const l of N)!R.includes(l.name)&&!k.includes(l.name)&&k.push(l.name)}const v=document.createElement("a");v.href=`view-profile.html?id=${f.id}`,v.className="member-card",v.style.marginBottom="1em",v.style.textDecoration="none",v.style.color="inherit",v.style.display="block";const $=f.avatar_url&&f.avatar_url.trim()!==""?f.avatar_url:"public/default-avatar.png";v.innerHTML=`
          <img src="${$}" alt="Profile Picture" style="width:64px;height:64px;border-radius:50%;object-fit:cover;margin-bottom:0.5em;">
          <strong>${f.full_name||"Unnamed Member"}</strong>
          <div style="color:#888;">Joined: ${f.affirmation_date?new Date(f.affirmation_date).toLocaleDateString():"‚Äî"}</div>
          <div style="color:#555;">Circles: ${k.length?k.join(", "):"None"}</div>
      `,h.appendChild(v)}}F();K();const H=document.getElementById("notification-bell"),B=document.getElementById("notification-dropdown"),T=document.getElementById("notification-count"),P=document.getElementById("notification-list"),V=document.getElementById("mark-all-read");let D=[],M=0,L=null;function O(a){B.style.display=a?"block":"none"}H.addEventListener("click",a=>{a.stopPropagation(),O(B.style.display!=="block")});document.addEventListener("click",a=>{!B.contains(a.target)&&a.target!==H&&O(!1)});async function C(){const{data:a}=await s.auth.getUser(),i=a?.user?.id;if(!i)return;const{data:c,error:h}=await s.from("notifications").select("*").eq("user_id",i).order("created_at",{ascending:!1}).limit(20);if(h){P.innerHTML="<em>Error loading notifications</em>",T.style.display="none";return}D=c||[],M=D.filter(f=>!f.read).length,U()}function U(){if(P.innerHTML="",!D.length){P.innerHTML="<em>No notifications</em>",T.style.display="none";return}D.forEach(a=>{const i=document.createElement("div");i.style.padding="0.5em 0.2em",i.style.borderBottom="1px solid #eee",i.style.background=a.read?"#f7f7f7":"#e6f7f2",i.style.cursor="pointer",i.innerHTML=`<span style="font-size:1.1em;">${a.icon||"üîî"}</span> <span style="font-size:12pt;">${a.message}</span><br><span style="font-size:0.85em;color:#888;">${new Date(a.created_at).toLocaleString()}</span>`,a.read||(i.style.fontWeight="bold"),i.addEventListener("click",async()=>{a.read||(await Z(a.id),a.read=!0,U()),a.link&&(window.location.href=a.link)}),P.appendChild(i)}),M>0?(T.textContent=M,T.style.display="inline-block"):T.style.display="none"}async function Z(a){await s.from("notifications").update({read:!0}).eq("id",a),C()}V.addEventListener("click",async()=>{const{data:a}=await s.auth.getUser(),i=a?.user?.id;i&&(await s.from("notifications").update({read:!0}).eq("user_id",i),C())});function J(){C(),L&&clearInterval(L),L=setInterval(C,15e3)}J();async function W(){try{const{data:a}=await s.auth.getUser(),i=a?.user?.id;if(!i)return;const c=localStorage.getItem(`lastRead_whatsNew_${i}`)||"1970-01-01T00:00:00Z",h=new Date(Date.now()-336*60*60*1e3).toISOString(),[f,g,E,k,R,v,$]=await Promise.all([s.from("circles").select("id, name, created_at").gte("created_at",c),s.from("member_video").select("id, caption, created_at, user_id").gte("created_at",c),s.from("events").select("id, title, created_at, created_by").gte("created_at",c),s.from("comments").select("id, content, created_at, author_id").gte("created_at",c),s.from("suggestions").select("id, title, created_at, author_id").gte("created_at",c),s.from("group_projects").select("id, name, created_at, proposer_id").gte("created_at",c),s.from("skill_shares").select("id, skill_name, created_at, presenter_id, video_url").gte("created_at",c)]),y=[];!f.error&&f.data&&f.data.forEach(l=>{y.push({type:"circle",message:`New circle "${l.name}" was created`,icon:"‚≠ï",link:"circle-list.html"})}),!g.error&&g.data&&g.data.forEach(l=>{const p=l.caption||"New video";y.push({type:"video",message:`New video: "${p}"`,icon:"üé•",link:"community-videos.html"})}),!E.error&&E.data&&E.data.forEach(l=>{y.push({type:"event",message:`New event: "${l.title}"`,icon:"üìÖ",link:"events.html"})}),!k.error&&k.data&&k.data.forEach(l=>{const p=l.content?.substring(0,50)||"New comment";y.push({type:"comment",message:`New comment: "${p}..."`,icon:"üí¨",link:"discussions.html"})}),!R.error&&R.data&&R.data.forEach(l=>{y.push({type:"suggestion",message:`New suggestion: "${l.title}"`,icon:"üí°",link:"suggestions.html"})}),!v.error&&v.data&&v.data.forEach(l=>{y.push({type:"project",message:`New project: "${l.name}"`,icon:"üöÄ",link:"group-projects.html"})}),!$.error&&$.data&&$.data.forEach(l=>{l.video_url&&y.push({type:"skill_share",message:`New skill shared: "${l.skill_name}"`,icon:"üé•",link:"skill-shares.html"})});for(const l of y){const p=`${l.type}_${l.message}`;localStorage.getItem(`notified_${i}_${p}`)||(await s.from("notifications").insert([{user_id:i,message:l.message,icon:l.icon,link:l.link,read:!1}]),localStorage.setItem(`notified_${i}_${p}`,"true"),"Notification"in window&&Notification.permission==="granted"&&new Notification("Friendship Community",{body:l.message,icon:"/default-avatar.png"}))}const N=y.length}catch(a){console.warn("Error checking what's new:",a)}}document.getElementById("whats-new-link").addEventListener("click",async()=>{const{data:a}=await s.auth.getUser(),i=a?.user?.id;if(i){localStorage.setItem(`lastRead_whatsNew_${i}`,new Date().toISOString());const c=document.getElementById("whats-new-link");c.innerHTML="üÜï What's New"}});W();setInterval(W,6e4);async function Q(){const{data:a}=await s.auth.getUser(),i=a?.user?.id;if(!i)return;[{name:"member_video",icon:"üé•",message:"New video posted",link:"community-videos.html"},{name:"events",icon:"üìÖ",message:"New event created",link:"events.html"},{name:"comments",icon:"üí¨",message:"New comment posted",link:"discussions.html"},{name:"suggestions",icon:"üí°",message:"New suggestion submitted",link:"suggestions.html"},{name:"group_projects",icon:"üöÄ",message:"New project proposed",link:"group-projects.html"},{name:"circles",icon:"‚≠ï",message:"New circle created",link:"circle-list.html"},{name:"skill_shares",icon:"üé•",message:"New skill shared with video",link:"skill-shares.html"}].forEach(h=>{s.channel(`${h.name}_notifications`).on("postgres_changes",{event:"INSERT",schema:"public",table:h.name},async f=>{const g=`${h.name}_${f.new.id}_${Date.now()}`;localStorage.getItem(`realtime_notified_${i}_${g}`)||(await s.from("notifications").insert([{user_id:i,message:h.message,icon:h.icon,link:h.link,read:!1}]),localStorage.setItem(`realtime_notified_${i}_${g}`,"true"),"Notification"in window&&Notification.permission==="granted"&&new Notification("Friendship Community",{body:h.message,icon:"/default-avatar.png"}),C())}).subscribe()})}Q();
