import"./modulepreload-polyfill-B5Qt9EMX.js";import{s as r}from"./supabase-vDZkBp_j.js";async function q(){if(!("Notification"in window)){alert("This browser does not support desktop notification");return}let i=Notification.permission;if(i==="default")try{i=await Notification.requestPermission()}catch(o){alert("Error requesting notification permission: "+o);return}i==="granted"?(alert("Permission granted! Showing test notification."),new Notification("ðŸ”” Friendship Community Circle",{body:"This is a test notification! You will see real notifications here soon.",icon:"/default-avatar.png"})):alert("Notifications are blocked or denied. Please enable them in your browser settings.")}document.getElementById("notif-test-btn").onclick=q;const D=document.getElementById("notification-bell"),L=document.getElementById("notification-dropdown"),v=document.getElementById("notification-count"),k=document.getElementById("notification-list"),S=document.getElementById("mark-all-read");let R=[],I=0,C=null;function T(i){L.style.display=i?"block":"none"}D.addEventListener("click",i=>{i.stopPropagation(),T(L.style.display!=="block")});document.addEventListener("click",i=>{!L.contains(i.target)&&i.target!==D&&T(!1)});async function N(){const{data:i}=await r.auth.getUser(),o=i?.user?.id;if(!o)return;const{data:h,error:u}=await r.from("notifications").select("*").eq("user_id",o).order("created_at",{ascending:!1}).limit(20);if(u){k.innerHTML="<em>Error loading notifications</em>",v.style.display="none";return}R=h||[],I=R.filter(a=>!a.read).length,j()}function j(){if(k.innerHTML="",!R.length){k.innerHTML="<em>No notifications</em>",v.style.display="none";return}R.forEach(i=>{const o=document.createElement("div");o.style.padding="0.5em 0.2em",o.style.borderBottom="1px solid #eee",o.style.background=i.read?"#f7f7f7":"#e6f7f2",o.style.cursor="pointer",o.innerHTML=`<span style="font-size:1.1em;">${i.icon||"ðŸ””"}</span> <span style="font-size:12pt;">${i.message}</span><br><span style="font-size:0.85em;color:#888;">${new Date(i.created_at).toLocaleString()}</span>`,i.read||(o.style.fontWeight="bold"),o.addEventListener("click",async()=>{i.read||(await W(i.id),i.read=!0,j()),i.link&&(window.location.href=i.link)}),k.appendChild(o)}),I>0?(v.textContent=I,v.style.display="inline-block"):v.style.display="none"}async function W(i){await r.from("notifications").update({read:!0}).eq("id",i),N()}S.addEventListener("click",async()=>{const{data:i}=await r.auth.getUser(),o=i?.user?.id;o&&(await r.from("notifications").update({read:!0}).eq("user_id",o),N())});function z(){N(),C&&clearInterval(C),C=setInterval(N,15e3)}z();async function U(){try{let n=function(e){s[e]||(s[e]={votes:0,suggestions:0,comments:0,wants:0,offers:0,passion:0,projects:0,profile:0,circles_created:0,members_added:0,celebrations_posted:0,events_created:0,events_attended:0,help_hours:0,help_points:0,support_responses:0,writer_posts:0,writer_points:0,videos_posted:0,positive_impact:0,projects_proposed:0})};const[i,o,h,u,a,_,g,m,E,c,P,b,w,p,B,$,x]=await Promise.all([r.from("agreement_votes").select("voter_id"),r.from("suggestions").select("author_id"),r.from("comments").select("author_id"),r.from("member_offerings").select("user_id, want, give, passion"),r.from("contributions").select("user_id, project, challenge, help, collab, skills, urgency, contact"),r.from("profiles").select("id, full_name, avatar_url, personal_story"),r.from("circles").select("created_by"),r.from("circle_members").select("added_by"),r.from("celebrations").select("user_id"),r.from("events").select("created_by"),r.from("help_given").select("helper_id, hours"),r.from("support_responses").select("responder_id"),r.from("writers_wall").select("author_id, points"),r.from("member_video").select("user_id"),r.from("positive_impact").select("contributor_id, points_awarded"),r.from("event_attendance").select("user_id"),r.from("group_projects").select("proposer_id")]),d="81c50097-74f3-4c7a-b00c-598995b8d1cb",t={},s={};i.data?.forEach(e=>{e.voter_id!==d&&(n(e.voter_id),s[e.voter_id].votes+=1,t[e.voter_id]=(t[e.voter_id]||0)+1)}),o.data?.forEach(e=>{e.author_id!==d&&(n(e.author_id),s[e.author_id].suggestions+=1,t[e.author_id]=(t[e.author_id]||0)+1)}),h.data?.forEach(e=>{e.author_id!==d&&(n(e.author_id),s[e.author_id].comments+=1,t[e.author_id]=(t[e.author_id]||0)+1)}),u.data?.forEach(e=>{e.user_id!==d&&(n(e.user_id),e.want?.trim()&&(s[e.user_id].wants+=1,t[e.user_id]=(t[e.user_id]||0)+1),e.give?.trim()&&(s[e.user_id].offers+=1,t[e.user_id]=(t[e.user_id]||0)+1),e.passion?.trim()&&(s[e.user_id].passion+=1,t[e.user_id]=(t[e.user_id]||0)+1))}),a.data?.forEach(e=>{if(e.user_id!==d){n(e.user_id);let l=0;["project","challenge","help","collab","skills","urgency","contact"].forEach(y=>{e[y]?.trim()&&(l+=1)}),s[e.user_id].projects+=l,t[e.user_id]=(t[e.user_id]||0)+l}}),_.data?.forEach(e=>{if(e.id!==d){let l=0;e.full_name?.trim()&&l++,e.avatar_url?.trim()&&l++,l>=1&&(n(e.id),s[e.id].profile=1,t[e.id]=(t[e.id]||0)+5)}}),g.data?.forEach(e=>{e.created_by&&e.created_by!==d&&(n(e.created_by),s[e.created_by].circles_created+=1,t[e.created_by]=(t[e.created_by]||0)+10)}),m.data?.forEach(e=>{e.added_by&&e.added_by!==d&&(n(e.added_by),s[e.added_by].members_added+=1,t[e.added_by]=(t[e.added_by]||0)+2)}),E.data?.forEach(e=>{e.user_id&&e.user_id!==d&&(n(e.user_id),s[e.user_id].celebrations_posted+=1,t[e.user_id]=(t[e.user_id]||0)+5)}),c.data?.forEach(e=>{e.created_by&&e.created_by!==d&&(n(e.created_by),s[e.created_by].events_created+=1,t[e.created_by]=(t[e.created_by]||0)+5)}),$.data?.forEach(e=>{e.user_id&&e.user_id!==d&&(n(e.user_id),s[e.user_id].events_attended+=1,t[e.user_id]=(t[e.user_id]||0)+5)}),P.data?.forEach(e=>{e.helper_id&&e.hours&&e.helper_id!==d&&(n(e.helper_id),s[e.helper_id].help_hours+=Number(e.hours),s[e.helper_id].help_points+=e.hours*5,t[e.helper_id]=(t[e.helper_id]||0)+e.hours*5)}),b.data?.forEach(e=>{e.responder_id&&e.responder_id!==d&&(n(e.responder_id),s[e.responder_id].support_responses+=1,t[e.responder_id]=(t[e.responder_id]||0)+5)}),w.data?.forEach(e=>{e.author_id&&(n(e.author_id),s[e.author_id].writer_posts+=1,s[e.author_id].writer_points+=e.points||0,t[e.author_id]=(t[e.author_id]||0)+(e.points||0))}),p.data?.forEach(e=>{e.user_id&&e.user_id!==d&&(n(e.user_id),s[e.user_id].videos_posted=(s[e.user_id].videos_posted||0)+1,t[e.user_id]=(t[e.user_id]||0)+5)}),B.data?.forEach(e=>{e.contributor_id&&(n(e.contributor_id),s[e.contributor_id].positive_impact+=e.points_awarded,t[e.contributor_id]=(t[e.contributor_id]||0)+e.points_awarded)}),x.data?.forEach(e=>{e.proposer_id&&e.proposer_id!==d&&(n(e.proposer_id),s[e.proposer_id].projects_proposed+=1,t[e.proposer_id]=(t[e.proposer_id]||0)+5)});const M=Object.keys(t).filter(e=>e&&e!=="null");if(M.length>0){const e={};_.data?.forEach(f=>{e[f.id]=f});const l=M.map(f=>({id:f,profile:e[f]||{full_name:f,avatar_url:"",personal_story:""},total:t[f],breakdown:s[f]}));l.sort((f,H)=>H.total-f.total);const y=l[0],A=document.getElementById("most-active-member");A.innerHTML=`
                    <a href="activities.html" style="text-decoration: none; color: inherit; display: block;">
                        <img src="${y.profile.avatar_url||"default-avatar.png"}" alt="Profile Picture" style="width:64px;height:64px;border-radius:50%;object-fit:cover;margin-bottom:1em;">
                        <h3>${y.profile.full_name||y.id}</h3>
                        <div class="activity-breakdown" style="margin-top:0.5em;">
                            <strong>All-Time Activities:</strong><br>
                            <strong>Total: ${y.total}</strong>
                        </div>
                    </a>
                    <div style="font-size:0.95em;color:#888;margin-bottom:0.5em;">
                        <strong>Activities Legend:</strong><br>
                        Votes, Suggestions, Comments, Wants, Offers, Passion, Projects & Struggles = 1 point each<br>
                        Events Created/Attended, Profile Completed, Circles Created, Members Added, Celebration Wall Posts, Support Responses = 5-10 points<br>
                        Help Given = 5 points/hour<br>
                        <span style="color:#4a7c59;font-weight:bold;">Writer's Post = 1 point per 1000 words</span>
                    </div>`}}catch(i){console.error("Error fetching most active member:",i)}}async function G(){const i=new Date("2025-09-19T00:00:00Z"),{data:o}=await r.from("profiles").select("id, full_name, avatar_url, affirmation_text, affirmation_date").order("affirmation_date",{ascending:!1}),h=(o||[]).filter(a=>a.affirmation_date&&new Date(a.affirmation_date)>=i).sort((a,_)=>new Date(_.affirmation_date)-new Date(a.affirmation_date)).slice(0,3),u=document.getElementById("newest-member");if(u.innerHTML="",h.length===0){u.innerHTML="<em>No new member since 9/19/2025.</em>";return}for(const a of h){const{data:_}=await r.from("circle_members").select("circle_id").eq("user_id",a.id),{data:g}=await r.from("circles").select("id, name").eq("created_by",a.id);let m=[],E=[];if(g&&g.length>0)for(const b of g)E.push(b.name),m.push(b.name+" (creator)");if(_&&_.length>0){const b=_.map(p=>p.circle_id),{data:w}=await r.from("circles").select("id, name").in("id",b);if(w)for(const p of w)!E.includes(p.name)&&!m.includes(p.name)&&m.push(p.name)}const c=document.createElement("a");c.href=`view-profile.html?id=${a.id}`,c.className="member-card",c.style.marginBottom="1em",c.style.textDecoration="none",c.style.color="inherit",c.style.display="block";const P=a.avatar_url&&a.avatar_url.trim()!==""?a.avatar_url:"public/default-avatar.png";c.innerHTML=`
            <img src="${P}" alt="Profile Picture" style="width:64px;height:64px;border-radius:50%;object-fit:cover;margin-bottom:0.5em;">
            <strong>${a.full_name||"Unnamed Member"}</strong>
            <div style="color:#888;">Joined: ${a.affirmation_date?new Date(a.affirmation_date).toLocaleDateString():"â€”"}</div>
            <div style="color:#555;">Circles: ${m.length?m.join(", "):"None"}</div>
        `,u.appendChild(c)}}U();G();
