import"./modulepreload-polyfill-B5Qt9EMX.js";import{s as g}from"./supabase-vDZkBp_j.js";const f="site_visit_recorded_date",y="site_visits_local",_="visitor_id_v1";async function h(){try{const e=new Date().toISOString().slice(0,10);let n=localStorage.getItem(_);if(!n){try{n=crypto&&crypto.randomUUID?crypto.randomUUID():"v-"+Date.now()+"-"+Math.floor(Math.random()*1e6)}catch{n="v-"+Date.now()+"-"+Math.floor(Math.random()*1e6)}localStorage.setItem(_,n)}if(localStorage.getItem(f)===e)return;const d=document.referrer||null,u=window.location.href||null,i=new URLSearchParams(window.location.search||""),r=i.get("utm_source"),a=i.get("utm_medium"),s=i.get("utm_campaign");try{await g.from("site_visits").insert([{path:window.location.pathname,user_agent:navigator.userAgent,visitor_id:n,referrer:d,landing_url:u,utm_source:r,utm_medium:a,utm_campaign:s}]),localStorage.setItem(f,e);return}catch(o){console.warn("site_visits insert failed, saving locally",o)}try{const o=JSON.parse(localStorage.getItem(y)||"[]");o.unshift({id:"local-"+Date.now(),visitor_id:n,path:window.location.pathname,user_agent:navigator.userAgent,referrer:document.referrer||null,landing_url:window.location.href||null,utm_source:r,utm_medium:a,utm_campaign:s,created_at:new Date().toISOString()}),localStorage.setItem(y,JSON.stringify(o.slice(0,1e3))),localStorage.setItem(f,e)}catch(o){console.warn("local site_visits save failed",o)}}catch(t){console.warn("recordVisitOncePerDay general error",t)}}async function S(){const t=document.getElementById("visits-today-banner")||document.getElementById("visits-today"),e=document.getElementById("visits-week-banner")||document.getElementById("visits-week");if(!t||!e)return;const n=new Date,d=new Date(n.getFullYear(),n.getMonth(),n.getDate()).toISOString(),u=new Date(n.getTime()-10080*60*1e3).toISOString();try{const i=await g.from("site_visits").select("id",{count:"exact"}).gte("created_at",d),r=await g.from("site_visits").select("id",{count:"exact"}).gte("created_at",u);if(i.error||r.error)throw new Error("db count error");const a=i.count??0,s=r.count??0;t.textContent=String(a),e.textContent=String(s);return}catch{try{const r=JSON.parse(localStorage.getItem(y)||"[]");let a=0,s=0;for(const o of r)o.created_at&&(o.created_at>=d&&a++,o.created_at>=u&&s++);t.textContent=String(a||"—"),e.textContent=String(s||"—")}catch(r){console.warn("loadVisitCounts fallback failed",r);try{t&&(t.textContent="—"),e&&(e.textContent="—")}catch{}}}}(async()=>(await h(),await S()))();const c=document.getElementById("sync-visits-btn"),l=document.getElementById("sync-status");c&&c.addEventListener("click",async()=>{try{c.disabled=!0,l.textContent="Syncing...";const t=JSON.parse(localStorage.getItem(y)||"[]");if(!t||t.length===0){l.textContent="No local visits to sync.",c.disabled=!1;return}const e={type:"sync-visits",visits:t};let n;try{n=await g.functions.invoke("record-point-event",{body:e})}catch(d){console.error("functions.invoke error",d),l.textContent="Sync failed (network).",c.disabled=!1;return}if(n.error){console.error("sync response error",n.error),l.textContent="Sync failed: "+(n.error.message||n.error),c.disabled=!1;return}localStorage.removeItem(y),l.textContent="Synced "+t.length+" visits.",await S()}catch(t){console.error("sync error",t),l.textContent="Sync failed."}finally{c.disabled=!1,setTimeout(()=>{l.textContent=""},4e3)}});const v=document.getElementById("activity-feed");function m(t){return t?String(t).replace(/[&<>"]/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[e]):""}function w(t){if(v.innerHTML="",!t||t.length===0){v.innerHTML='<div class="empty">No recent activity.</div>';return}for(const e of t){const n=document.createElement("div");n.className="ann",n.innerHTML=`<div class="activity-item"><div class="activity-left"><div style="font-weight:700">${m(e.action||"Action")}</div><div style="margin-top:6px">${m(e.meta||"")}</div></div><div class="activity-right"><div>${m(e.display_name||"Member")}</div><div class="meta">${e.points?"+"+m(String(e.points))+" pts":""}${e.created_at?" • "+m(new Date(e.created_at).toLocaleString()):""}</div></div></div>`,v.appendChild(n)}}async function p(){v.innerHTML='<div class="empty">Loading activity...</div>';try{const{data:t,error:e}=await g.from("member_point_events").select("id,display_name,action,meta,points,created_at").order("created_at",{ascending:!1}).limit(50);if(e){console.warn("member_point_events load error",e.message);const n=JSON.parse(localStorage.getItem("member_point_events_local")||"[]");w(n);return}w(t||[])}catch(t){console.error("loadActivities error",t);const e=JSON.parse(localStorage.getItem("member_point_events_local")||"[]");w(e)}}(async()=>(await p(),setInterval(()=>{p().catch(()=>{})},6e4)))();
