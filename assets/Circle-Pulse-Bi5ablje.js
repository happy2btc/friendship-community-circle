import"./modulepreload-polyfill-B5Qt9EMX.js";import{s as d}from"./supabase-vDZkBp_j.js";const w="site_visit_recorded_date",R="site_visits_local",x="visitor_id_v1";async function O(){try{const e=new Date().toISOString().slice(0,10);let c=localStorage.getItem(x);if(!c){try{c=crypto&&crypto.randomUUID?crypto.randomUUID():"v-"+Date.now()+"-"+Math.floor(Math.random()*1e6)}catch{c="v-"+Date.now()+"-"+Math.floor(Math.random()*1e6)}localStorage.setItem(x,c)}if(localStorage.getItem(w)===e)return;const u=document.referrer||null,m=window.location.href||null,f=new URLSearchParams(window.location.search||""),p=f.get("utm_source"),o=f.get("utm_medium"),t=f.get("utm_campaign");try{await d.from("site_visits").insert([{path:window.location.pathname,user_agent:navigator.userAgent,visitor_id:c,referrer:u,landing_url:m,utm_source:p,utm_medium:o,utm_campaign:t}]),localStorage.setItem(w,e);return}catch(r){console.warn("site_visits insert failed, saving locally",r)}try{const r=JSON.parse(localStorage.getItem(R)||"[]");r.unshift({id:"local-"+Date.now(),visitor_id:c,path:window.location.pathname,user_agent:navigator.userAgent,referrer:document.referrer||null,landing_url:window.location.href||null,utm_source:p,utm_medium:o,utm_campaign:t,created_at:new Date().toISOString()}),localStorage.setItem(R,JSON.stringify(r.slice(0,1e3))),localStorage.setItem(w,e)}catch(r){console.warn("local site_visits save failed",r)}}catch(_){console.warn("recordVisitOncePerDay general error",_)}}async function C(){const _=document.getElementById("visits-today-banner")||document.getElementById("visits-today"),e=document.getElementById("visits-week-banner")||document.getElementById("visits-week");if(!_||!e)return;const c=new Date,u=new Date(c.getFullYear(),c.getMonth(),c.getDate()).toISOString(),m=new Date(c.getTime()-10080*60*1e3).toISOString();try{const f=await d.from("site_visits").select("id",{count:"exact"}).gte("created_at",u),p=await d.from("site_visits").select("id",{count:"exact"}).gte("created_at",m);if(f.error||p.error)throw new Error("db count error");const o=f.count??0,t=p.count??0;_.textContent=String(o),e.textContent=String(t);return}catch{try{const p=JSON.parse(localStorage.getItem(R)||"[]");let o=0,t=0;for(const r of p)r.created_at&&(r.created_at>=u&&o++,r.created_at>=m&&t++);_.textContent=String(o||"—"),e.textContent=String(t||"—")}catch(p){console.warn("loadVisitCounts fallback failed",p);try{_&&(_.textContent="—"),e&&(e.textContent="—")}catch{}}}}(async()=>(await O(),await C()))();const A=document.getElementById("sync-visits-btn");document.getElementById("sync-status");if(A){let c=function(o){return o?String(o).replace(/[&<>"]/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[t]):""},u=function(o){const t=Date.now(),r=t-10080*60*1e3,i=(o||e||[]).filter(s=>{if(!s.created_at)return!1;const n=new Date(s.created_at).getTime();return n>=r&&n<=t});if(_.innerHTML="",!i.length){_.innerHTML='<div class="empty">No recent activity in the last 7 days.</div>';return}for(const s of i){const n=document.createElement("div");n.className="ann",n.innerHTML=`<div class="activity-item"><div class="activity-left"><div style="font-weight:700">${c(s.action||"Action")}</div><div style="margin-top:6px">${c(s.meta||"")}</div></div><div class="activity-right"><div>${c(s.display_name||"Member")}</div><div class="meta">${s.points?"+"+c(String(s.points))+" pts":""}${s.created_at?" • "+c(new Date(s.created_at).toLocaleString()):""}</div></div></div>`,_.appendChild(n)}},f=function(o,t,r){if(!t)return null;const i=Date.now(),s=i-10080*60*1e3;let n=null;switch(o){case"event_attendance":return n=t.created_at?new Date(t.created_at).getTime():null,!t.user_id||n===null||n<s||n>i?null:{display_name:r[t.user_id]||t.user_id,action:"Attended an event",meta:"",points:5,created_at:t.created_at};case"agreement_votes":return n=t.created_at?new Date(t.created_at).getTime():null,!t.voter_id||n===null||n<s||n>i?null:{display_name:r[t.voter_id]||t.voter_id,action:"Voted",meta:"",points:1,created_at:t.created_at};case"suggestions":return n=t.created_at?new Date(t.created_at).getTime():null,!t.author_id||n===null||n<s||n>i?null:{display_name:r[t.author_id]||t.author_id,action:"Suggested",meta:t.title?`Suggestion: ${t.title}`:"Submitted a suggestion",points:1,created_at:t.created_at};case"comments":return n=t.created_at?new Date(t.created_at).getTime():null,!t.author_id||n===null||n<s||n>i?null:{display_name:r[t.author_id]||t.author_id,action:"Commented",meta:t.reply_text?t.reply_text.slice(0,120):"Commented",points:1,created_at:t.created_at};case"celebrations":return n=t.created_at?new Date(t.created_at).getTime():null,!t.user_id||n===null||n<s||n>i?null:{display_name:r[t.user_id]||t.user_id,action:"Posted on Celebration Wall",meta:"",points:5,created_at:t.created_at};case"events":return n=t.created_at?new Date(t.created_at).getTime():null,!t.created_by||n===null||n<s||n>i?null:{display_name:r[t.created_by]||t.created_by,action:"Created event",meta:"",points:5,created_at:t.created_at};case"group_projects":return n=t.created_at?new Date(t.created_at).getTime():null,!t.proposer_id||n===null||n<s||n>i?null:{display_name:r[t.proposer_id]||t.proposer_id,action:"Proposed a project",meta:"",points:5,created_at:t.created_at};case"writers_wall":return n=t.created_at?new Date(t.created_at).getTime():null,!(t.author_id||t.author_name)||n===null||n<s||n>i?null:{display_name:t.author_id&&r[t.author_id]||t.author_name||t.author_id,action:"Wrote for Writers Wall",meta:t.title||"",points:1,created_at:t.created_at};case"skill_shares":return n=t.created_at?new Date(t.created_at).getTime():null,!t.presenter_id||!t.video_url||n===null||n<s||n>i?null:{display_name:r[t.presenter_id]||t.presenter_id,action:"Shared a skill with video",meta:t.skill_name?`Skill: ${t.skill_name}`:"Skill shared with video",points:5,created_at:t.created_at};default:return null}};const _=document.getElementById("activity-feed");let e=[];async function m(){_.innerHTML='<div class="empty">Loading activity...</div>';try{const o=[d.from("agreement_votes").select("voter_id,created_at").order("created_at",{ascending:!1}).limit(100),d.from("suggestions").select("id,author_id,title,created_at").order("created_at",{ascending:!1}).limit(100),d.from("comments").select("author_id,created_at,reply_text").order("created_at",{ascending:!1}).limit(100),d.from("celebrations").select("user_id,created_at").order("created_at",{ascending:!1}).limit(100),d.from("events").select("created_by,created_at").order("created_at",{ascending:!1}).limit(100),d.from("group_projects").select("proposer_id,created_at").order("created_at",{ascending:!1}).limit(100),d.from("writers_wall").select("author_id,author_name,title,created_at").order("created_at",{ascending:!1}).limit(100),d.from("event_attendance").select("user_id,created_at").order("created_at",{ascending:!1}).limit(100),d.from("profiles").select("id,full_name"),d.from("member_video").select("user_id,created_at,caption").order("created_at",{ascending:!1}).limit(100)];let t=d.from("skill_shares").select("presenter_id,created_at,skill_name,video_url").order("created_at",{ascending:!1}).limit(100);t=t.catch(a=>(console.warn("skill_shares query failed (table may not exist):",a),{data:[],error:a})),o.push(t);const[r,i,s,n,b,D,S,g,$,M,T]=await Promise.all(o),y={};($.data||[]).forEach(a=>{a&&a.id&&(y[a.id]=a.full_name||a.id)});const v=Date.now(),k=v-10080*60*1e3,h=[];(M.data||[]).forEach(a=>{if(!a||!a.user_id)return;const l=new Date(a.created_at).getTime();l<k||l>v||h.push({display_name:y[a.user_id]||"Member",action:"Posted a video",meta:a.caption?`Video: ${a.caption}`:"Video posted",points:5,created_at:a.created_at})}),(T.error?[]:T.data||[]).forEach(a=>{if(!a||!a.presenter_id||!a.video_url)return;const l=new Date(a.created_at).getTime();l<k||l>v||h.push({display_name:y[a.presenter_id]||"Member",action:"Shared a skill with video",meta:a.skill_name?`Skill: ${a.skill_name}`:"Skill shared with video",points:5,created_at:a.created_at})}),(r.data||[]).forEach(a=>{if(!a||!a.voter_id)return;const l=new Date(a.created_at).getTime();l<k||l>v||h.push({display_name:y[a.voter_id]||"Member",action:"Voted",meta:"",points:1,created_at:a.created_at})}),(i.data||[]).forEach(a=>{if(!a||!a.author_id)return;const l=new Date(a.created_at).getTime();if(l<k||l>v)return;const I=a.title?`Suggestion: ${a.title}`:"Submitted a suggestion";h.push({display_name:y[a.author_id]||"Member",action:"Suggested",meta:I,points:1,created_at:a.created_at})}),(s.data||[]).forEach(a=>{if(!a||!a.author_id)return;const l=new Date(a.created_at).getTime();if(l<k||l>v)return;const I=a.reply_text?a.reply_text.slice(0,120):"Commented";h.push({display_name:y[a.author_id]||"Member",action:"Commented",meta:I,points:1,created_at:a.created_at})}),(n.data||[]).forEach(a=>{if(!a||!a.user_id)return;const l=new Date(a.created_at).getTime();l<k||l>v||h.push({display_name:y[a.user_id]||"Member",action:"Posted on Celebration Wall",meta:"",points:5,created_at:a.created_at})}),(b.data||[]).forEach(a=>{if(!a||!a.created_by)return;const l=new Date(a.created_at).getTime();l<k||l>v||h.push({display_name:y[a.created_by]||"Member",action:"Created event",meta:"",points:5,created_at:a.created_at})}),(D.data||[]).forEach(a=>{if(!a||!a.proposer_id)return;const l=new Date(a.created_at).getTime();l<k||l>v||h.push({display_name:y[a.proposer_id]||"Member",action:"Proposed a project",meta:"",points:5,created_at:a.created_at})}),(S.data||[]).forEach(a=>{if(!a)return;const l=new Date(a.created_at).getTime();if(l<k||l>v)return;const I=a.author_id&&y[a.author_id]||a.author_name||a.author_id||"Member";h.push({display_name:I,action:"Wrote for Writers Wall",meta:a.title||"",points:1,created_at:a.created_at})}),(g.data||[]).forEach(a=>{if(!a||!a.user_id)return;const l=new Date(a.created_at).getTime();l<k||l>v||h.push({display_name:y[a.user_id]||"Member",action:"Attended an event",meta:"",points:5,created_at:a.created_at})}),h.sort((a,l)=>new Date(l.created_at||0)-new Date(a.created_at||0)),e=h.slice(0,50).slice(),u(e)}catch{_.innerHTML='<div class="empty">Failed to load activity.</div>'}}async function p(){let o={};try{((await d.from("profiles").select("id,full_name")).data||[]).forEach(i=>{i&&i.id&&(o[i.id]=i.full_name||i.id)})}catch{}const t=["agreement_votes","suggestions","comments","celebrations","events","group_projects","writers_wall","event_attendance"];try{if(typeof d.channel=="function"){const r=d.channel("realtime-activity");t.forEach(i=>{r.on("postgres_changes",{event:"INSERT",schema:"public",table:i},s=>{try{const n=f(i,s.new,o);if(!n)return;const b=`${n.display_name}|${n.action}|${n.created_at}`;if(e.some(g=>`${g.display_name}|${g.action}|${g.created_at}`===b))return;e.unshift(n);const D=Date.now(),S=D-10080*60*1e3;e=e.filter(g=>{if(!g.created_at)return!1;const $=new Date(g.created_at).getTime();return $>=S&&$<=D}).slice(0,50),u(e)}catch(n){console.warn("realtime payload error",n)}})});try{r.on("postgres_changes",{event:"INSERT",schema:"public",table:"skill_shares"},i=>{try{const s=f("skill_shares",i.new,o);if(!s)return;const n=`${s.display_name}|${s.action}|${s.created_at}`;if(e.some(S=>`${S.display_name}|${S.action}|${S.created_at}`===n))return;e.unshift(s);const b=Date.now(),D=b-10080*60*1e3;e=e.filter(S=>{if(!S.created_at)return!1;const g=new Date(S.created_at).getTime();return g>=D&&g<=b}).slice(0,50),u(e)}catch(s){console.warn("skill_shares realtime payload error",s)}})}catch(i){console.warn("Failed to subscribe to skill_shares realtime (table may not exist):",i)}await r.subscribe().catch(i=>console.warn("Realtime subscription failed:",i));return}}catch(r){console.warn("realtime channel subscribe failed",r)}try{t.forEach(r=>{d.from(r).on("INSERT",i=>{try{const s=f(r,i.new,o);if(!s)return;const n=`${s.display_name}|${s.action}|${s.created_at}`;if(e.some(b=>`${b.display_name}|${b.action}|${b.created_at}`===n))return;e.unshift(s),e=e.slice(0,50),u(e)}catch{}}).subscribe().catch(i=>console.warn(`Realtime subscription failed for ${r}:`,i))});try{d.from("skill_shares").on("INSERT",r=>{try{const i=f("skill_shares",r.new,o);if(!i)return;const s=`${i.display_name}|${i.action}|${i.created_at}`;if(e.some(n=>`${n.display_name}|${n.action}|${n.created_at}`===s))return;e.unshift(i),e=e.slice(0,50),u(e)}catch(i){console.warn("skill_shares realtime fallback error",i)}}).subscribe().catch(r=>console.warn("Realtime subscription failed for skill_shares:",r))}catch(r){console.warn("Failed to subscribe to skill_shares realtime fallback (table may not exist):",r)}}catch(r){console.warn("realtime fallback failed",r)}}(async()=>(await m(),await p(),setInterval(()=>{m().catch(()=>{})},6e4)))()}function N(_,e){if(!e)return null;try{switch(_){case"agreement_votes":return e.voter_id?{display_name:e.voter_id,action:"Voted",meta:"",points:1,created_at:e.created_at||new Date().toISOString()}:null;case"suggestions":return e.author_id?{display_name:e.author_id,action:"Suggested",meta:e.title?`Suggestion: ${e.title}`:"Submitted a suggestion",points:1,created_at:e.created_at||new Date().toISOString()}:null;case"comments":return e.author_id?{display_name:e.author_id,action:"Commented",meta:e.reply_text?e.reply_text.slice(0,120):"Commented",points:1,created_at:e.created_at||new Date().toISOString()}:null;case"celebrations":return e.user_id?{display_name:e.user_id,action:"Posted on Celebration Wall",meta:"",points:5,created_at:e.created_at||new Date().toISOString()}:null;case"events":return e.created_by?{display_name:e.created_by,action:"Created event",meta:"",points:5,created_at:e.created_at||new Date().toISOString()}:null;case"group_projects":return e.proposer_id?{display_name:e.proposer_id,action:"Proposed a project",meta:"",points:5,created_at:e.created_at||new Date().toISOString()}:null;case"writers_wall":return e.author_id||e.author_name?{display_name:e.author_id||e.author_name,action:"Wrote for Writers Wall",meta:e.title||"",points:1,created_at:e.created_at||new Date().toISOString()}:null;case"event_attendance":return e.user_id?{display_name:e.user_id,action:"Attended an event",meta:"",points:5,created_at:e.created_at||new Date().toISOString()}:null;case"skill_shares":return e.presenter_id&&e.video_url?{display_name:e.presenter_id,action:"Shared a skill with video",meta:e.skill_name?`Skill: ${e.skill_name}`:"Skill shared with video",points:5,created_at:e.created_at||new Date().toISOString()}:null;case"site_visits":return{created_at:e.created_at||new Date().toISOString(),visit:!0};default:return null}}catch{return null}}function E(_,e){const c=N(_,e);if(!c)return;if(_==="site_visits"){try{const m=document.getElementById("visits-today-banner"),f=document.getElementById("visits-week-banner");if(m&&f&&c.created_at){isNaN(Number(m.textContent))||(m.textContent=String(Number(m.textContent)+1)),isNaN(Number(f.textContent))||(f.textContent=String(Number(f.textContent)+1)),setTimeout(C,5e3);return}}catch{}C().catch(()=>{});return}const u=`${c.display_name}|${c.action}|${c.created_at}`;currentItems.some(m=>`${m.display_name}|${m.action}|${m.created_at}`===u)||(currentItems.unshift(c),currentItems=currentItems.slice(0,50),renderActivities(currentItems))}async function P(){const _=["agreement_votes","suggestions","comments","celebrations","events","group_projects","writers_wall","site_visits","event_attendance"];try{if(typeof d.channel=="function"){const e=d.channel("realtime-activity");_.forEach(c=>{e.on("postgres_changes",{event:"INSERT",schema:"public",table:c},u=>{try{E(c,u.new)}catch(m){console.warn("realtime payload handling error",m)}})});try{e.on("postgres_changes",{event:"INSERT",schema:"public",table:"skill_shares"},c=>{try{E("skill_shares",c.new)}catch(u){console.warn("skill_shares realtime payload handling error",u)}})}catch(c){console.warn("Failed to subscribe to skill_shares realtime (table may not exist):",c)}await e.subscribe(),console.log("Realtime channel subscribed for activity tables");return}}catch(e){console.warn("channel subscribe failed",e)}try{_.forEach(e=>{try{const c=d.from(e).on("INSERT",u=>{try{E(e,u.new)}catch{}}).subscribe()}catch{}});try{const e=d.from("skill_shares").on("INSERT",c=>{try{E("skill_shares",c.new)}catch(u){console.warn("skill_shares realtime fallback error",u)}}).subscribe()}catch(e){console.warn("Failed to subscribe to skill_shares realtime fallback (table may not exist):",e)}console.log("Realtime fallback subscriptions registered")}catch(e){console.warn("realtime fallback failed",e)}}(async()=>(await loadActivities(),await P(),setInterval(()=>{loadActivities().catch(()=>{})},6e4)))();
