import"./modulepreload-polyfill-B5Qt9EMX.js";import{s}from"./supabase-vDZkBp_j.js";const _=new URLSearchParams(window.location.search),a=_.get("user"),w=document.getElementById("chat-header"),i=document.getElementById("chat-messages"),c=document.getElementById("chat-input"),o=document.getElementById("chat-send"),u=document.getElementById("chat-status");let t=null,l="";async function p(){const{data:e}=await s.auth.getUser();return e?.user?.id||null}async function v(){if(!a)return"";const{data:e}=await s.from("profiles").select("full_name").eq("id",a).single();return e?.full_name||"Member"}async function m(){if(!t||!a)return;const{data:e,error:r}=await s.from("personal_messages").select("id, sender_id, receiver_id, content, created_at").or(`and(sender_id.eq.${t},receiver_id.eq.${a}),and(sender_id.eq.${a},receiver_id.eq.${t})`).order("created_at",{ascending:!0});if(r){i.innerHTML="<em>Error loading messages.</em>";return}i.innerHTML=(e||[]).map(n=>`
        <div class="${n.sender_id===t?"chat-message-self":"chat-message-other"}">
          <div>${n.content.replace(/</g,"&lt;")}</div>
          <div class="chat-message-meta">${n.sender_id===t?"You":l} &middot; ${new Date(n.created_at).toLocaleString()}</div>
        </div>
      `).join(""),i.scrollTop=i.scrollHeight}async function f(){const e=c.value.trim();if(!e)return;o.disabled=!0,u.textContent="";const{error:r}=await s.from("personal_messages").insert([{sender_id:t,receiver_id:a,content:e}]);if(r){u.textContent="Error sending message: "+r.message,o.disabled=!1;return}let n="Someone";try{const{data:d}=await s.from("profiles").select("full_name").eq("id",t).single();d&&d.full_name&&(n=d.full_name)}catch{}const g=`${n} sent you a message.`,h=`personal-chat.html?user=${encodeURIComponent(t)}`;await s.from("notifications").insert([{user_id:a,message:g,icon:"ðŸ’¬",link:h,read:!1}]),c.value="",await m(),o.disabled=!1}o.addEventListener("click",f);c.addEventListener("keydown",e=>{e.key==="Enter"&&f()});(async()=>(t=await p(),l=await v(),w.textContent=`Chat with ${l}`,await m(),setInterval(m,5e3)))();
