import"./modulepreload-polyfill-B5Qt9EMX.js";import{s as u}from"./supabase-vDZkBp_j.js";function V(){return new URLSearchParams(window.location.search).get("circle_id")||""}let L=V();const S=document.getElementById("discussion-container"),U=document.getElementById("error-message");let D;function g(r){U.textContent=r,U.style.display="block",setTimeout(()=>{U.style.display="none"},6e3)}let Y=[];async function j(){const{data:{user:r}}=await u.auth.getUser();if(!r)return;const{data:c}=await u.from("circles").select("id, name");Y=c||[];let n='<option value="">Everyone (Public)</option>';Y.forEach(t=>{n+=`<option value="${t.id}">${t.name}</option>`});const o=document.getElementById("circle-filter");o.innerHTML=n,L&&(o.value=L),o.addEventListener("change",()=>{L=o.value,q()})}async function q(){const{data:{user:r}}=await u.auth.getUser();D=r;let c=u.from("suggestions").select("*");L?c=c.eq("circle_id",L).eq("status","open"):c=c.is("circle_id",null).eq("status","open");const{data:n,error:o}=await c;if(o){g(`Error loading discussions: ${o.message}`),S.innerHTML=`<p>Error loading discussions: ${o.message}</p>`;return}if(!n||n.length===0){S.innerHTML="<p>No active discussions at the moment.</p>";return}const t=n.filter(e=>e.status==="open"),d=n.filter(e=>e.status==="voting"),a=n.map(e=>e.id).filter(e=>typeof e=="number"||typeof e=="string"&&e.length>0);let l=[];if(a.length>0){const{data:e,error:m}=await u.from("comments").select("*").in("suggestion_id",a).order("created_at",{ascending:!0});l=e}else l=[];const s=Array.isArray(l)?l:[],y=[...new Set([...n.map(e=>(e.author_id||"").trim().toLowerCase()),...s.map(e=>(e.author_id||"").trim().toLowerCase())])],{data:N,error:w}=await u.from("profiles").select("id, full_name").in("id",y),E={};(N||[]).forEach(e=>{E[(e.id||"").trim().toLowerCase()]=e.full_name});function f(e,m,i){const h=m.filter(x=>x.suggestion_id===e);return h.length===0?new Date(i).getTime():Math.max(...h.map(x=>new Date(x.created_at).getTime()))}t.sort((e,m)=>{const i=f(e.id,s,e.created_at);return f(m.id,s,m.created_at)-i}),d.sort((e,m)=>new Date(e.created_at)-new Date(m.created_at)),S.innerHTML="";for(const e of t){if(!e.title)continue;const m=(e.author_id||"").trim().toLowerCase(),i=e.id,h=s?s.filter(k=>k.suggestion_id===i):[],x=h.length,v=D&&(D.id||"").trim().toLowerCase()===m,C=document.createElement("details");C.className="discussion-block",C.dataset.suggestionId=i;const $=document.createElement("summary"),A=E[m]||"A member";$.textContent=`${e.title} `;const b=document.createElement("span");b.className="summary-meta",b.textContent=`(by ${A}, ${x} comments/replies)`,$.appendChild(b);const p=document.createElement("div");p.className="discussion-content",p.dataset.suggestionId=i;const _=document.createElement("p");_.textContent=e.description;const I=document.createElement("button");I.className="action-button",I.dataset.action="add-comment",I.dataset.suggestionId=i,I.textContent="Make a Comment";const B=document.createElement("div");if(B.className="comment-thread",B.id=`thread-for-${i}`,p.appendChild(_),p.appendChild(I),p.appendChild(B),v&&e.status==="open"){const k=document.createElement("div");k.className="agreement-box";const M=document.createElement("div");M.className="author-instruction",M.textContent="As the author, when you feel the discussion is complete, you may propose an agreement for the group to vote on.";const z=document.createElement("h3");z.textContent="Propose an Agreement";const R=document.createElement("p");R.textContent="Once submitted, this discussion will be locked and will move to the voting page.";const H=document.createElement("label");H.htmlFor=`agreement-text-${i}`,H.textContent="Proposed Agreement Text:";const P=document.createElement("textarea");P.id=`agreement-text-${i}`,P.rows=4;const O=document.createElement("br"),T=document.createElement("button");T.className="action-button",T.dataset.action="submit-agreement",T.dataset.suggestionId=i,T.textContent="Submit and Start Vote",k.append(M,z,R,H,P,O,T),p.appendChild(k)}C.appendChild($),C.appendChild(p),S.appendChild(C),F(h,B,null,E,D)}for(const e of d){if(!e.title)continue;const m=(e.author_id||"").trim().toLowerCase(),i=e.id,h=s?s.filter(I=>I.suggestion_id===i):[],x=h.length,v=document.createElement("details");v.className="discussion-block",v.dataset.suggestionId=i;const C=document.createElement("summary"),$=E[m]||"A member";C.textContent=`${e.title} `;const A=document.createElement("span");A.className="summary-meta",A.textContent=`(by ${$}, ${x} comments/replies, sent to voting)`,C.appendChild(A);const b=document.createElement("div");b.className="discussion-content",b.dataset.suggestionId=i;const p=document.createElement("p");p.textContent=e.description;const _=document.createElement("div");_.className="comment-thread",_.id=`thread-for-${i}`,b.appendChild(p),b.appendChild(_),v.appendChild(C),v.appendChild(b),S.appendChild(v),F(h,_,null,E,D)}}j();L="";q();function F(r,c,n=null,o={},t=null){const d=r.filter(a=>a.parent_id===n);for(const a of d){const l=(a.author_id||"").trim().toLowerCase(),s=document.createElement("div");s.className="comment";const y=o[l]||"Unknown",N=new Date(a.created_at).toLocaleString(),w=document.createElement("div");w.className="comment-meta",w.textContent=`by ${y} on ${N}`;const E=document.createElement("p");E.textContent=a.content;const f=document.createElement("button");if(f.className="action-button reply-button",f.dataset.action="reply",f.dataset.commentId=a.id,f.dataset.suggestionId=a.suggestion_id,f.textContent="Reply",s.appendChild(w),s.appendChild(E),s.appendChild(f),t&&(t.id||"").trim().toLowerCase()===l){const e=document.createElement("button");e.className="delete-icon",e.title="Delete comment",e.innerHTML="ðŸ—‘ï¸",e.onclick=async()=>{if(!confirm("Delete this comment?"))return;const{error:m}=await u.from("comments").delete().eq("id",a.id);m?g("Error deleting comment: "+m.message):await q()},s.appendChild(e)}c.appendChild(s),F(r,s,a.id,o,t)}}document.addEventListener("click",async r=>{const c=r.target,n=c.closest("[data-action]");if(c.id==="expand-all"){document.querySelectorAll("details.discussion-block").forEach(t=>t.open=!0);return}if(c.id==="collapse-all"){document.querySelectorAll("details.discussion-block").forEach(t=>t.open=!1);return}if(!n)return;const o=n.dataset.action;if(o==="add-comment"||o==="reply"){const t=o==="reply"?n.parentElement:n.nextElementSibling,d=o==="reply"?n.dataset.commentId:null,a=n.dataset.suggestionId;G(t,a,d)}if(o==="submit-agreement"){if(!D)return g("You must be logged in to submit an agreement.");let t=n.dataset.suggestionId;if(!t){const w=n.closest(".discussion-block");w&&(t=w.dataset.suggestionId)}const d=n.closest(".agreement-box").querySelector("textarea"),a=d?d.value:"";if(!a.trim())return g("Agreement text cannot be empty.");if(!t)return g("Suggestion ID is missing.");const{data:l,error:s}=await u.from("agreements").select("id").eq("suggestion_id",t);if(s){g(`Error checking for existing agreement: ${s.message}`);return}if(l&&l.length>0){g("An agreement has already been submitted for this discussion.");return}console.log("Updating suggestion status to voting for id:",t);const{error:y}=await u.from("suggestions").update({status:"voting"}).eq("id",t);if(y){g(`Error updating discussion status: ${y.message}`),console.error(y);return}const{error:N}=await u.from("agreements").insert({suggestion_id:t,agreement_text:a,proposer_id:D.id,status:"voting"});N?g(`Error submitting agreement: ${N.message}`):(alert("Agreement submitted successfully! You will now be taken to the voting page."),window.location.href="agreements.html")}});function G(r,c,n=null){r.querySelector(".comment-box")&&r.querySelector(".comment-box").remove();const o=document.createElement("div");o.className="comment-box";const t=document.createElement("textarea");t.placeholder="Type your thoughts...";const d=document.createElement("button");d.className="action-button",d.textContent="Submit",d.onclick=async()=>{const{data:{user:a}}=await u.auth.getUser();if(!a)return g("You must be logged in to comment.");const l=t.value;if(!l.trim())return;const{error:s}=await u.from("comments").insert({suggestion_id:c,parent_id:n,content:l,author_id:a.id});s?g(`Error: ${s.message}`):await q()},o.appendChild(t),o.appendChild(d),r.appendChild(o),t.focus()}q();
