import"./modulepreload-polyfill-B5Qt9EMX.js";import{s as c}from"./supabase-vDZkBp_j.js";const p=document.getElementById("event-select"),g=document.getElementById("event-details"),E=document.getElementById("attendance-list"),y=document.getElementById("members-select"),M=document.getElementById("members-attending-btn"),d=document.getElementById("members-attending-status");async function _(){const{data:t,error:o}=await c.from("profiles").select("id, full_name").order("full_name");if(y.innerHTML="",o||!t){y.innerHTML="<option disabled>Error loading members</option>";return}t.forEach(e=>{const a=document.createElement("option");a.value=e.id,a.textContent=e.full_name,y.appendChild(a)})}const T=document.getElementById("refresh-btn");let s=null,f=[];async function v(t){if(!t)return;const{data:o,error:e}=await c.from("event_attendance").select("user_id, attended_at, profiles(full_name)").eq("event_id",t).order("attended_at",{ascending:!1});if(e){console.error("Error loading attendance:",e),E.innerHTML="<li>Error loading attendance.</li>";return}if(!o||o.length===0){E.innerHTML="<li>No one has marked attendance yet.</li>";return}E.innerHTML=o.map(a=>{const n=new Date(a.attended_at).toLocaleString();return`<li><strong>${a.profiles?.full_name||"Unknown User"}</strong> attended on ${n}</li>`}).join("")}async function I(){const{data:t,error:o}=await c.from("events").select("id, title, start_time, repeat").order("start_time",{ascending:!0});if(o||!t||t.length===0){p.innerHTML='<option value="">No events found</option>',g.textContent="No event selected.",attendBtn.style.display="none";return}const e=new Date(Date.now()-4320*60*1e3),a=new Date(Date.now()+5760*60*1e3);if(f=t.map(n=>{const r=new Date(n.start_time);if(n.repeat==="weekly"){const i=new Date(r);for(;i<e;)i.setDate(i.getDate()+7);if(i>=e&&i<=a)return n.nextOccurrence=i,n}else if(r>=e&&r<=a)return n.nextOccurrence=r,n}).filter(Boolean),f.length===0){p.innerHTML='<option value="">No events found in the next 7 days</option>',g.textContent="No event selected.",attendBtn.style.display="none",document.getElementById("import-section").style.display="none";return}p.innerHTML=f.map(n=>`<option value="${n.id}">${n.title}</option>`).join(""),s=f[0].id,await b(s,f[0].nextOccurrence),await v(s)}async function b(t,o){if(!t){g.textContent="No event selected.",attendBtn.style.display="none",document.getElementById("import-section").style.display="none";return}const{data:e,error:a}=await c.from("events").select("*").eq("id",t).single();if(a||!e){g.textContent="Event not found.",attendBtn.style.display="none",document.getElementById("import-section").style.display="none";return}g.innerHTML=`<h2>${e.title}</h2><div><strong>Date:</strong> ${o?o.toDateString():""}</div><div><strong>Description:</strong> ${e.description||""}</div>`,attendBtn.style.display="",document.getElementById("import-section").style.display="block"}p.addEventListener("change",async t=>{s=t.target.value;const o=f.find(e=>e.id==s);await b(s,o.nextOccurrence),await v(s),statusDiv.textContent=""});M.addEventListener("click",async()=>{const t=Array.from(y.selectedOptions).map(r=>r.value);if(!s||t.length===0){d.textContent="Please select at least one member.",d.style.color="red";return}d.textContent="Marking attendance...",d.style.color="#2e8b57";const o=new Date().toISOString(),e=t.map(r=>({event_id:s,user_id:r,attended_at:o})),{error:a}=await c.from("event_attendance").insert(e);if(a){d.textContent="Error: "+a.message,d.style.color="red";return}let n=null;for(const r of t){const{data:i,error:u}=await c.from("profiles").select("points").eq("id",r).single();if(u){n=u;continue}const l=i&&typeof i.points=="number"?i.points:0,{error:m}=await c.from("profiles").update({points:l+5}).eq("id",r);m&&(n=m)}n?(d.textContent="Attendance marked, but error updating points: "+n.message,d.style.color="orange"):(d.textContent="Attendance and points marked!",d.style.color="#2e8b57"),await v(s)});_();p.addEventListener("change",_);document.getElementById("parse-log-btn").addEventListener("click",async()=>{const t=document.getElementById("attendance-log").value.trim();if(!t){alert("Please paste the attendance log.");return}const o=t.split(`
`);if(o.length<2){alert("Invalid log format. Expected CSV with header.");return}const e=o[0].split(","),a=o.slice(1),n=e.findIndex(l=>l.trim().toLowerCase()==="name (original name)"),r=e.findIndex(l=>l.trim().toLowerCase()==="email"),i=e.findIndex(l=>l.trim().toLowerCase()==="join time");if(n===-1||r===-1||i===-1){alert('CSV must contain "Name (original name)", "Email", and "Join time" columns.');return}const u=document.getElementById("log-preview");u.innerHTML='<h4>Parsed Log:</h4><table border="1" style="width:100%;"><tr><th>Name</th><th>Email</th><th>Join Time</th><th>Action</th></tr>';for(const l of a){const m=l.split(",").map(k=>k.trim().replace(/^"|"$/g,""));if(m.length<=Math.max(n,r,i))continue;const w=m[n].replace(/\s*\(Host\)\s*$/,""),B=m[r],h=m[i],{data:L}=await c.from("profiles").select("id, full_name").eq("full_name",w).single(),x=L?.id,D=L?.full_name||w,C=x?`<button onclick="markAttendedFromLog('${x}', '${h}')">Mark Attended</button>`:"User not found";u.innerHTML+=`<tr><td>${D}</td><td>${B}</td><td>${h}</td><td>${C}</td></tr>`}u.innerHTML+="</table>"});window.markAttendedFromLog=async(t,o)=>{const e=new Date(o);if(isNaN(e)){alert("Invalid date format: "+o);return}const a=e.toISOString(),{error:n}=await c.from("event_attendance").insert({event_id:s,user_id:t,attended_at:a});n?alert("Error marking attendance: "+n.message):(alert("Attendance marked!"),v(s))};T.addEventListener("click",()=>{I()});I();
