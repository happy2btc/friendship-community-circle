import"./modulepreload-polyfill-B5Qt9EMX.js";import{s as m}from"./supabase-vDZkBp_j.js";function v(s){return(s.trim().match(/\b\w+\b/g)||[]).length}const w=document.getElementById("writer-form"),r=document.getElementById("form-status");w.onsubmit=async s=>{s.preventDefault(),r.textContent="";const h=w.title.value.trim(),i=w.content.value.trim(),{data:y}=await m.auth.getUser(),f=y?.user;if(!f){r.textContent="You must be logged in to post.",r.style.color="red";return}await m.from("profiles").select("id, full_name").eq("id",f.id).single();const u=f.id;if(!h||!i){r.textContent="All fields required.",r.style.color="red";return}let t=[];const o=w.images.files;if(o&&o.length>0)for(let n=0;n<o.length;n++){const p=o[n],c=`writers-wall/${u}/${Date.now()}_${p.name}`;let{error:d}=await m.storage.from("writers-wall").upload(c,p,{upsert:!1});if(d){r.textContent=`Image upload failed: ${d.message}`,r.style.color="red";return}const{data:g}=m.storage.from("writers-wall").getPublicUrl(c);g&&g.publicUrl&&t.push(g.publicUrl)}const l=v(i),e=Math.max(1,Math.floor(l/1e3)),{error:a}=await m.from("writers_wall").insert([{author_id:u,title:h,content:i,points:e,images:t}]);a?(r.textContent="Error: "+a.message,r.style.color="red"):(r.textContent="Posted!",r.style.color="#2e8b57",w.reset(),$())};async function $(){const{data:s,error:h}=await m.from("writers_wall").select("id, author_id, title, content, created_at, points, images").order("created_at",{ascending:!1}),i=document.getElementById("post-list");if(h){i.innerHTML="<em>Error loading posts.</em>";return}if(!s||s.length===0){i.innerHTML="<em>No posts yet. Be the first to share your writing!</em>";return}const y=[...new Set(s.map(t=>t.author_id).filter(Boolean))];let f={};if(y.length>0){const{data:t}=await m.from("profiles").select("id, full_name").in("id",y);t&&t.forEach(o=>{f[o.id]=o.full_name})}const u=s.map((t,o)=>{const l=f[t.author_id]||"Unknown";let e=t.content.split(/\r?\n/).slice(0,3).join(" ");e.length>200&&(e=e.slice(0,200)+"...");const a=e.replace(/</g,"&lt;"),n=t.content.replace(/</g,"&lt;");return{idx:o,safePreview:a,safeFull:n,authorName:l,post:t}});i.innerHTML=u.map(({idx:t,safePreview:o,authorName:l,post:e})=>`
                            <div class="post-card" id="post-card-${t}">
                                <div class="post-title">${e.title}</div>
                                <div class="post-meta">by <a href="view-profile.html?id=${e.author_id}"><strong>${l}</strong></a> &middot; ${new Date(e.created_at).toLocaleString()}</div>
                                <div class="post-gallery" id="post-gallery-${t}" style="margin-bottom:0.7em;"></div>
                                <div class="post-content" id="post-content-${t}">${o}</div>
                                <a href="#" class="read-more" id="read-more-${t}" style="color:#6b4f1d;font-weight:bold;">Read More</a>
                                <div class="post-points">Points: ${e.points} (${v(e.content)} words)</div>
                            </div>
                        `).join(""),u.forEach(({idx:t,safePreview:o,safeFull:l})=>{const e=document.getElementById(`read-more-${t}`),a=document.getElementById(`post-content-${t}`);let n=!1;e&&a&&e.addEventListener("click",function(d){d.preventDefault(),n?(a.innerHTML=o,e.textContent="Read More"):(a.innerHTML=l,e.textContent="Show Less"),n=!n});const p=document.getElementById(`post-gallery-${t}`),c=u[t].post;p&&c.images&&Array.isArray(c.images)&&c.images.length>0&&(p.innerHTML=c.images.map((d,g)=>`<img src="${d}" alt="Story image ${g+1}" style="max-width:90px;max-height:90px;margin:0 6px 6px 0;border-radius:6px;object-fit:cover;cursor:pointer;box-shadow:0 1px 4px #ccc;" onclick="window.open('${d}','_blank')">`).join(""))})}$();
