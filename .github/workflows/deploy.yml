name: 🪄 Deploy Ritual

on:
  push:
    branches:
      - main

jobs:
  setup_env:
    name: 🧱 Setup Environment
    runs-on: ubuntu-latest

    steps:
      - name: 🧾 Checkout repository
        uses: actions/checkout@v4

      - name: 🌿 Export HOME for workflow context
        run: echo "HOME=$HOME" >> $GITHUB_ENV

      - name: 🛠️ Install dbmate to $HOME/bin
        run: |
          mkdir -p $HOME/bin
          curl -fsSL https://github.com/amacneil/dbmate/releases/download/v1.15.0/dbmate-linux-amd64 -o $HOME/bin/dbmate
          chmod +x $HOME/bin/dbmate

      - name: 📦 Upload dbmate binary
        uses: actions/upload-artifact@v4
        with:
          name: dbmate
          path: ${{ env.HOME }}/bin/dbmate

  deploy_ritual:
    name: 🔮 Deploy Ritual
    runs-on: ubuntu-latest
    needs: setup_env

    steps:
      - name: 🧾 Checkout repository
        uses: actions/checkout@v4

      - name: 🌿 Export HOME for workflow context
        run: echo "HOME=$HOME" >> $GITHUB_ENV

      - name: 📥 Download dbmate binary
        uses: actions/download-artifact@v4
        with:
          name: dbmate
          path: ${{ env.HOME }}/bin

      - name: 🧪 Run dbmate migration
        run: |
          chmod +x $HOME/bin/dbmate
          $HOME/bin/dbmate --help
          $HOME/bin/dbmate up
