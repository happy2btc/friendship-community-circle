name: 🪄 Deploy Ritual

on:
  push:
    branches:
      - main

jobs:
  setup_env:
    name: 🧱 Setup Environment
    runs-on: ubuntu-latest

    steps:
      - name: 🧾 Checkout repository
        uses: actions/checkout@v4

      - name: 🌿 Export HOME for workflow context
        run: echo "HOME=$HOME" >> $GITHUB_ENV

      - name: 🛠️ Install dbmate to $HOME/bin
        run: |
          mkdir -p $HOME/bin
          curl -fsSL https://github.com/amacneil/dbmate/releases/download/v1.15.0/dbmate-linux-amd64 -o $HOME/bin/dbmate
          chmod +x $HOME/bin/dbmate

      - name: 📦 Upload dbmate binary
        uses: actions/upload-artifact@v4
        with:
          name: dbmate
          path: ${{ env.HOME }}/bin/dbmate

      - name: 🛠️ Install Supabase CLI via .deb
        run: |
          curl -sL https://github.com/supabase/cli/releases/download/v2.39.2/supabase_2.39.2_linux_amd64.deb -o supabase.deb
          sudo dpkg -i supabase.deb

      - name: 📦 Copy Supabase CLI to $HOME/bin
        run: |
          mkdir -p $HOME/bin
          cp /usr/bin/supabase $HOME/bin/supabase

      - name: 📦 Upload Supabase CLI binary
        uses: actions/upload-artifact@v4
        with:
          name: supabase-cli
          path: ${{ env.HOME }}/bin/supabase

  deploy_ritual:
    name: 🔮 Deploy Ritual
    runs-on: ubuntu-latest
    needs: setup_env

    env:
      DATABASE_URL: ${{ secrets.SUPABASE_DB_SESSION_URL }}
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}

    steps:
      - name: 🧾 Checkout repository
        uses: actions/checkout@v4

      - name: 🌿 Export HOME for workflow context
        run: echo "HOME=$HOME" >> $GITHUB_ENV

      - name: 📥 Download dbmate binary
        uses: actions/download-artifact@v4
        with:
          name: dbmate
          path: ${{ env.HOME }}/bin

      - name: 📥 Download Supabase CLI binary
        uses: actions/download-artifact@v4
        with:
          name: supabase-cli
          path: ${{ env.HOME }}/bin

      - name: 📜 Run database migrations and log output
        run: |
          chmod +x $HOME/bin/dbmate
          $HOME/bin/dbmate up | tee migration-scroll.txt

      - name: 📦 Upload migration scroll
        uses: actions/upload-artifact@v4
        with:
          name: migration-scroll
          path: migration-scroll.txt

      - name: "🚀 Auto-deploy all Edge Functions"
        run: |
          chmod +x $HOME/bin/supabase
          for dir in supabase/functions/*/; do
            fname=$(basename "$dir")
            echo "Deploying function: $fname"
            $HOME/bin/supabase functions deploy "$fname" \
              --project-ref "${SUPABASE_PROJECT_ID}" \
              --no-verify-jwt
          done
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
