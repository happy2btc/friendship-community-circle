name: ðŸª„ Deploy Ritual

on:
  push:
    branches:
      - main

jobs:
  setup_env:
    name: ðŸ§± Setup Environment
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŒ¿ Export HOME for workflow context
        run: echo "HOME=$HOME" >> $GITHUB_ENV

      - name: ðŸ› ï¸ Install dbmate to $HOME/bin
        run: |
          mkdir -p $HOME/bin
          curl -fsSL https://github.com/amacneil/dbmate/releases/download/v1.15.0/dbmate-linux-amd64 -o $HOME/bin/dbmate
          chmod +x $HOME/bin/dbmate

      - name: ðŸ“¦ Upload dbmate binary
        uses: actions/upload-artifact@v4
        with:
          name: dbmate
          path: ${{ env.HOME }}/bin/dbmate

  deploy_ritual:
    name: ðŸ”® Deploy Ritual
    runs-on: ubuntu-latest
    needs: setup_env

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŒ¿ Export HOME for workflow context
        run: echo "HOME=$HOME" >> $GITHUB_ENV

      - name: ðŸ“¥ Download dbmate binary
        uses: actions/download-artifact@v4
        with:
          name: dbmate
          path: ${{ env.HOME }}/bin

      - name: ðŸ§ª Run dbmate migration
        run: |
          chmod +x $HOME/bin/dbmate
          $HOME/bin/dbmate --help
          $HOME/bin/dbmate up
