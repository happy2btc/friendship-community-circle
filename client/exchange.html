<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;">
  <title>üåê Circle of Exchange</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f9f9f9;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
  background: url('public/badge-ribbons.png') center/cover no-repeat;
      z-index: 0;
      opacity: 0.5;
      pointer-events: none;
    }

    main, form, h2, .menu-button, #confirmation {
      position: relative;
      z-index: 1;
    }
    h2 {
      text-align: center;
      margin-bottom: 1rem;
    }
    label {
  display: block;
  margin-top: 1rem;
  font-weight: bold;
  color: #000;
  background: rgba(255,255,255,0.85);
  padding: 0.25em 0.5em;
  border-radius: 4px;
    }
    textarea, input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.25rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    input[readonly] {
      background-color: #eee;
      cursor: not-allowed;
    }
    button {
      margin-top: 1.5rem;
      padding: 0.75rem 1.5rem;
      background-color: #8c6f4e;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
    }
    button:disabled {
      background-color: #ccc;
    }
    #confirmation {
      margin-top: 1rem;
      font-weight: bold;
      text-align: center;
    }
    .menu-button {
      background-color: #6b4f1d;
      color: #fff;
      padding: 12px 20px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      display: block;
      width: fit-content;
      margin: 30px auto 0;
    }
  </style>
</head>
<body>
  <h2>üåê Circle of Exchange</h2>

  <form id="exchangeForm">
    <label for="email">üì¨ Your Email</label>
    <input type="text" id="email" name="email" readonly />

    <label for="want">üå± What do you seek?</label>
    <textarea id="want" name="want" rows="3"></textarea>

    <label for="give">üåæ What do you offer?</label>
    <textarea id="give" name="give" rows="3"></textarea>

    <label for="passion">üî• What is your passion?</label>
    <textarea id="passion" name="passion" rows="3"></textarea>

    <label for="offer-images">üñºÔ∏è Offer Images (optional)</label>
    <input type="file" id="offer-images" accept="image/*" multiple />
    <div id="image-thumbnails" style="margin-top:10px;"></div>

    <label>
      <input type="checkbox" id="visible" checked />
      Make this visible to others in the Circle
    </label>

    <button type="submit">Update My Offering</button>
  </form>

  <div id="confirmation"></div>

  <a href="view-exchanges.html" class="menu-button">üéÅ Browse All Offerings</a>
  <a href="main-menu.html" class="menu-button">üîô Return to Menu</a>

  <script type="module">
    import { supabase } from '/lib/supabase.js';

    const form = document.getElementById("exchangeForm");
    const confirmationDiv = document.getElementById("confirmation");
    const submitButton = form.querySelector('button');

    // Function to load user data and their existing offering
    async function loadUserData() {
      const { data: { user } } = await supabase.auth.getUser();

      if (!user) {
        confirmationDiv.textContent = "‚ö†Ô∏è You must be logged in to use the Circle of Exchange.";
        confirmationDiv.style.color = 'red';
        form.style.display = 'none';
        return;
      }

      // Display user info
      document.getElementById('email').value = user.email;

      // Fetch the user's existing offering using their unique user ID
      const { data: offering, error } = await supabase
        .from('member_offerings')
        .select('*')
        .eq('user_id', user.id) // Use user.id instead of wallet address
        .single();

      if (error && error.code !== 'PGRST116') { // Ignore 'PGRST116' (0 rows) error
        console.error("Error fetching offering:", error);
        confirmationDiv.textContent = "‚ö†Ô∏è Could not load your offering.";
        confirmationDiv.style.color = 'red';
      }

      // If an offering was found, populate the form
      if (offering) {
        document.getElementById('want').value = offering.want || '';
        document.getElementById('give').value = offering.give || '';
        document.getElementById('passion').value = offering.passion || '';
        document.getElementById('visible').checked = offering.visible;
      }
    }

    // Handle form submission
    form.addEventListener("submit", async function(event) {
      event.preventDefault();
      submitButton.disabled = true;
      confirmationDiv.textContent = "Updating...";
      confirmationDiv.style.color = 'black';

      const { data: { user } } = await supabase.auth.getUser();

      // DEBUGGING: Log user object and user ID
      console.log("User object:", user);
      console.log("User ID for upload:", user ? user.id : 'User is null');

      if (!user) {
        confirmationDiv.textContent = "‚ö†Ô∏è Cannot submit: You are not logged in.";
        confirmationDiv.style.color = 'red';
        return;
      }

      const offeringData = {
        user_id: user.id,
        want: document.getElementById("want").value,
        give: document.getElementById("give").value,
        passion: document.getElementById("passion").value,
        visible: document.getElementById("visible").checked,
      };
      const { error: offeringError } = await supabase.from('member_offerings').upsert(offeringData);
      if (offeringError) {
        console.error("Submission failed:", error);
        confirmationDiv.textContent = `‚ö†Ô∏è Something went wrong: ${error.message}`;
        confirmationDiv.style.color = 'red';
      } else {
        await handleImageUploads(user.id);
        // On complete success, show a final message and reload the page
        // to ensure a clean state and show the latest data.
        confirmationDiv.textContent = "‚úÖ Your offering has been updated! Reloading...";
        setTimeout(() => window.location.reload(), 1500);
      }
      submitButton.disabled = false;
    });

    // --- Show local image previews on file selection ---
    const imagesInput = document.getElementById('offer-images');
    const thumbnailsDiv = document.getElementById('image-thumbnails');
    imagesInput?.addEventListener('change', (e) => {
        thumbnailsDiv.innerHTML = ''; // Clear previous previews
        const files = Array.from(e.target.files);

        for (const file of files) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = document.createElement('img');
                img.src = event.target.result;
                img.style.width = '80px';
                img.style.margin = '8px';
                thumbnailsDiv.appendChild(img);
            };
            reader.readAsDataURL(file);
        }
    });

    // --- Multiple Image Upload for Offers ---
    async function handleImageUploads(userId) {
        const imagesInput = document.getElementById('offer-images');
        const thumbnailsDiv = document.getElementById('image-thumbnails');
        const files = Array.from(imagesInput.files);
        if (files.length === 0) return; // No files to upload

        thumbnailsDiv.innerHTML = 'Processing images...';

        // --- Clear existing images ONLY if new files are selected ---
        const { data: existingImages, error: fetchErr } = await supabase.from('offer_images').select('id, image_url').eq('user_id', userId);

        if (existingImages && existingImages.length > 0) {
            const pathsToRemove = existingImages.map(img => img.image_url);
            const idsToRemove = existingImages.map(img => img.id);

            // Perform deletion from storage and database
            await supabase.storage.from('offer-images').remove(pathsToRemove);
            await supabase.from('offer_images').delete().in('id', idsToRemove);
        }
        
        thumbnailsDiv.innerHTML = ''; // Clear for new thumbnails
        let uploadErrors = [];

        for (const file of files) {
            const filePath = `offers/${userId}/${Date.now()}_${file.name}`;
            const { error: uploadError } = await supabase.storage.from('offer-images').upload(filePath, file);
            if (uploadError) {
                uploadErrors.push(`Error uploading ${file.name}: ${uploadError.message}`);
                continue;
            }

            const { error: dbError } = await supabase.from('offer_images').insert({ user_id: userId, image_url: filePath });
            if (dbError) {
                uploadErrors.push(`Error saving ${file.name} to database: ${dbError.message}`);
                continue;
            }
        }
        if (uploadErrors.length) {
            confirmationDiv.innerHTML += `<br><span style="color:red;">Image upload issues: ${uploadErrors.join(', ')}</span>`;
        } else {
            // This message will be briefly visible before the page reloads.
            confirmationDiv.textContent = "‚úÖ Offering and images saved successfully!";
            confirmationDiv.style.color = 'green';
            thumbnailsDiv.innerHTML = ''; // Clear thumbnails after successful upload
        }
    }

    // Load the user's data as soon as the page is ready
    document.addEventListener('DOMContentLoaded', loadUserData);
  </script>
</body>
</html>