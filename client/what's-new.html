<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>What's New</title>
  <style>
    body { font-family: Georgia, serif; background: #f9f6f1; color: #3b2f2f; padding: 2rem; }
    .container { max-width: 800px; margin: auto; }
    h1 { font-size: 2em; margin-bottom: 1em; }
    .news-list { margin-top: 2em; }
    .news-card { background: #fff; border-radius: 8px; padding: 1em; margin-bottom: 1.5em; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .news-title { font-size: 1.2em; font-weight: bold; margin-bottom: 0.5em; }
    .news-type { color: #4a7c59; font-weight: bold; margin-right: 1em; }
    .news-date { color: #888; font-size: 0.95em; margin-left: 1em; }
    .menu-button { display: block; width: fit-content; margin: 2em auto 0 auto; background-color: #4a7c59; color: #fff; padding: 10px 18px; border-radius: 6px; text-decoration: none; font-weight: bold; text-align: center; }
    .menu-button:hover { background: #388e3c; }
  </style>
</head>
<body>
  <div class="container">
    <h1>What's New</h1>

  <div class="news-list" id="news-list"></div>
  <a href="main-menu.html" id="back-to-menu" style="position: fixed; top: 0; left: 0; width: 100%; background: #1976d2; color: #fff; z-index: 1000; padding: 16px 0; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.12); font-weight: bold; border-radius: 0 0 12px 12px; box-sizing: border-box; font-size: 1.15em; letter-spacing: 0.5px;">&larr; Back to Menu</a>
  <a href="main-menu.html" class="menu-button">üîô Return to Menu</a>
  </div>
  <script type="module">

    import { supabase } from '/lib/supabase.js';
    async function loadWhatsNew() {

  // Ensure ISO format (YYYY-MM-DDTHH:mm:ssZ)
  // Use a 14-day window for recent items
  const windowDays = 14;
  const cutoffDate = new Date(Date.now() - windowDays * 24 * 60 * 60 * 1000);
  const cutoff = cutoffDate.toISOString().split('.')[0] + 'Z';
      // Prune any hard-coded news-card elements that appear before the dynamic feed
      try {
        const newsListEl = document.getElementById('news-list');
        if (newsListEl) {
          document.querySelectorAll('.container > .news-card').forEach(card => {
            // only consider cards that are before the dynamic news-list node
            if (card.compareDocumentPosition(newsListEl) & Node.DOCUMENT_POSITION_FOLLOWING) {
              const dateEl = card.querySelector('.news-date');
              if (!dateEl) return;
              const parsed = new Date(dateEl.textContent.trim());
              if (!isNaN(parsed) && parsed < cutoffDate) {
                card.remove();
              }
            }
          });
        }
      } catch (e) { console.warn('Prune static cards failed', e); }
      // Fetch from all actual tables, including events and new tables
  let agreementsRes, circlesRes, commentsRes, discussionsRes, groupProjectsRes, suggestionsRes, eventsRes, supportRequestsRes, memberOfferingsRes, skillSharesRes, memberVideoRes, contributionsRes;
      try {
        [agreementsRes, circlesRes, commentsRes, discussionsRes, groupProjectsRes, suggestionsRes, eventsRes, supportRequestsRes, memberOfferingsRes, skillSharesRes, memberVideoRes, contributionsRes] = await Promise.all([
          supabase.from('agreements').select('id, created_at, agreement_text').gte('created_at', cutoff),
          supabase.from('circles').select('id, created_at, name, description').gte('created_at', cutoff),
          supabase.from('comments').select('id, created_at, content, project_id, discussion_id').gte('created_at', cutoff),
          supabase.from('discussions').select('id, created_at, title, description').gte('created_at', cutoff),
          supabase.from('group_projects').select('id, created_at, name').gte('created_at', cutoff),
          supabase.from('suggestions').select('id, created_at, description').gte('created_at', cutoff),
          supabase.from('events').select('id, title, description, start_time, end_time, location, zoom_link, timezone, created_at').gte('created_at', cutoff),
          supabase.from('support_requests').select('id, created_at, mission_title, mission_description').gte('created_at', cutoff),
          supabase.from('member_offerings').select('id, created_at, title, description').gte('created_at', cutoff),
          supabase.from('skill_shares').select('id, created_at, skill_name, skill_description, video_url').gte('created_at', cutoff),
          supabase.from('member_video').select('id, created_at, caption, video_url').gte('created_at', cutoff),
          supabase.from('contributions').select('id, created_at, title, description').gte('created_at', cutoff)
        ]);
      } catch (e) {
        console.error('Failed fetching whats-new data:', e);
        // fall back to empty responses so feed can render static cards
        agreementsRes = circlesRes = commentsRes = discussionsRes = groupProjectsRes = suggestionsRes = eventsRes = supportRequestsRes = memberOfferingsRes = skillSharesRes = memberVideoRes = contributionsRes = { data: [] };
      }


  // Debug output for agreements, suggestions, and videos
  console.log('Agreements response:', agreementsRes);
  if (agreementsRes.error) console.error('Agreements error:', agreementsRes.error);
  console.log('Suggestions response:', suggestionsRes);
  if (suggestionsRes.error) console.error('Suggestions error:', suggestionsRes.error);
  if (eventsRes.error) console.error('Events error:', eventsRes.error);
  console.log('Support Requests response:', supportRequestsRes);
  if (supportRequestsRes.error) console.error('Support Requests error:', supportRequestsRes.error);

  console.log('Group Projects response:', groupProjectsRes);
  if (groupProjectsRes.error) console.error('Group Projects error:', groupProjectsRes.error);
  console.log('Member Offerings response:', memberOfferingsRes);
  if (memberOfferingsRes.error) console.error('Member Offerings error:', memberOfferingsRes.error);
  console.log('Skill Shares response:', skillSharesRes);
  if (skillSharesRes.error) console.error('Skill Shares error:', skillSharesRes.error);
  console.log('Member Video response:', memberVideoRes);
  if (memberVideoRes.error) console.error('Member Video error:', memberVideoRes.error);
  console.log('Contributions response:', contributionsRes);
  if (contributionsRes.error) console.error('Contributions error:', contributionsRes.error);

  const allNews = [];
      // Events (calendar)
      eventsRes.data?.forEach(ev => {
        allNews.push({
          type: 'Event',
          id: ev.id,
          title: ev.title || 'New Event',
          description: (ev.description ? ev.description + '<br>' : '') +
            (ev.start_time ? `<b>Start:</b> ${new Date(ev.start_time).toLocaleString()}<br>` : '') +
            (ev.end_time ? `<b>End:</b> ${new Date(ev.end_time).toLocaleString()}<br>` : '') +
            (ev.location ? `<b>Location:</b> ${ev.location}<br>` : '') +
            (ev.zoom_link ? `<b>Zoom:</b> <a href='${ev.zoom_link}' target='_blank'>Join Meeting</a><br>` : ''),
          created_at: ev.created_at
        });
      });
      // Agreements
      agreementsRes.data?.forEach(ag => {
        allNews.push({
          type: 'Agreement',
          id: ag.id,
          title: 'New Agreement',
          description: ag.agreement_text || '',
          created_at: ag.created_at
        });
      });
      // Circles
      circlesRes.data?.forEach(c => {
        allNews.push({
          type: 'Circle',
          id: c.id,
          title: c.name || 'New Circle',
          description: c.description || '',
          created_at: c.created_at
        });
      });
      // Comments - now added to news feed
      commentsRes.data?.forEach(c => {
        let link = '';
        if (c.project_id) {
          link = `group-projects.html?id=${c.project_id}`;
        } else if (c.discussion_id) {
          link = `discussions.html?id=${c.discussion_id}`;
        }
        allNews.push({
          type: 'Comment',
          id: c.id,
          title: 'New Comment',
          description: c.content || '',
          created_at: c.created_at,
          link: link
        });
      });
      // Discussions
      discussionsRes.data?.forEach(d => {
        allNews.push({
          type: 'Discussion',
          id: d.id,
          title: d.title || 'New Discussion',
          description: d.description || '',
          created_at: d.created_at
        });
      });
      // Group Projects
      groupProjectsRes.data?.forEach(gp => {
        allNews.push({
          type: 'Group Project',
          id: gp.id,
          title: gp.name || 'New Group Project',
          description: '',
          created_at: gp.created_at || new Date().toISOString()
        });
      });
      // Member Offerings
      memberOfferingsRes.data?.forEach(mo => {
        allNews.push({
          type: 'Member Offering',
          id: mo.id,
          title: mo.title || 'New Member Offering',
          description: mo.description || '',
          created_at: mo.created_at
        });
      });
      // Skill Shares
      skillSharesRes.data?.forEach(ss => {
        allNews.push({
          type: 'Skill Share',
          id: ss.id,
          title: ss.title || 'New Skill Share',
          description: ss.description || '',
          created_at: ss.created_at
        });
      });
      // Member Videos
      memberVideoRes.data?.forEach(mv => {
        allNews.push({
          type: 'Member Video',
          id: mv.id,
          title: mv.caption || 'New Member Video',
          description: mv.video_url ? `Video: ${mv.video_url}` : '',
          created_at: mv.created_at
        });
      });
      // Skill Share Videos
      skillSharesRes.data?.forEach(ss => {
        if (ss.video_url) { // Only include skill shares that have videos
          allNews.push({
            type: 'Skill Share Video',
            id: ss.id,
            title: ss.skill_name || 'New Skill Share',
            description: ss.skill_description ? `${ss.skill_description} - Video: ${ss.video_url}` : `Video: ${ss.video_url}`,
            created_at: ss.created_at
          });
        }
      });
      // Contributions
      contributionsRes.data?.forEach(cont => {
        allNews.push({
          type: 'Contribution',
          id: cont.id,
          title: cont.title || 'New Contribution',
          description: cont.description || '',
          created_at: cont.created_at
        });
      });
      // Suggestions
      // Show suggestions as discussions
      suggestionsRes.data?.forEach(sg => {
        allNews.push({
          type: 'Discussion',
          id: sg.id,
          title: 'New Discussion',
          description: sg.description || '',
          created_at: sg.created_at
        });
      });
      // Support Requests
      supportRequestsRes.data?.forEach(sr => {
        allNews.push({
          type: 'Support Request',
          id: sr.id,
          title: sr.mission_title || 'New Support Request',
          description: sr.mission_description || '',
          created_at: sr.created_at
        });
      });

  // Ensure every item has a valid created_at before sorting
  allNews.forEach(item => { if (!item.created_at) item.created_at = new Date().toISOString(); });
  allNews.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      const newsList = document.getElementById('news-list');
      if (allNews.length === 0) {
        newsList.innerHTML = '<em>No new activities or updates in the last 5 days.</em>';
        return;
      }

      newsList.innerHTML = allNews.map(function(item) {
        let prefix = '';
        let title = item.title;
        let autoLink = '';
        if (item.type === 'Event' && item.id) {
          prefix = '<span style="font-size:1.2em;">üìÖ</span> ';
          autoLink = `<a href="events-calendar.html">View Calendar</a>`;
        }
        if (item.type === 'Circle' && item.id) {
          prefix = '<span style="color:gold;font-size:1.2em;">&#9733;&#9733;&#9733;</span> <span style="font-size:1.2em;">üëèüëè</span> ';
          autoLink = `<a href="circle.html?id=${item.id}">View Circle</a>`;
        }
        if (item.type === 'Agreement' && item.id) {
          title = 'Agreement for Voting';
          prefix = '<span style="font-size:1.2em;">üó≥Ô∏èüó≥Ô∏èüó≥Ô∏è</span> ';
          autoLink = `<a href="agreements.html?id=${item.id}">View Agreement</a>`;
        }
        if (item.type === 'Discussion' && item.id) {
          autoLink = `<a href="discussions.html?id=${item.id}">View Discussion</a>`;
        }
        if (item.type === 'Group Project' && item.id) {
          // point to the listing/project detail page (group-projects.html handles id query)
          autoLink = `<a href="group-projects.html?id=${item.id}">View Project</a>`;
        }
        if (item.type === 'Contribution' && item.id) {
          autoLink = `<a href="activities.html?id=${item.id}">View Activity</a>`;
        }
        if (item.type === 'Skill Share' && item.id) {
          autoLink = `<a href="skill-shares.html?id=${item.id}">View Skill Share</a>`;
        }
        if (item.type === 'Member Offering' && item.id) {
          autoLink = `<a href="member-offering.html?id=${item.id}">View Offering</a>`;
        }
        if (item.type === 'Support Request' && item.id) {
          autoLink = `<a href="view-support-request.html?id=${item.id}">View Support Request</a>`;
        }
        // If a manual link is present, use it instead
        if (item.link) {
          autoLink = `<a href="${item.link}" target="_blank">Explore</a>`;
        }
        return [
          '<div class="news-card">',
            '<div>',
              '<span class="news-type">', item.type, '</span>',
              '<span class="news-date">', new Date(item.created_at).toLocaleString(), '</span>',
            '</div>',
            '<div class="news-title">', prefix, title, '</div>',
            '<div>', (item.description || ''), '</div>',
            autoLink,
          '</div>'
        ].join('');
      }).join('');
    }

    loadWhatsNew();

    // Reload news when the page becomes visible (e.g., tab switch, navigation)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        loadWhatsNew();
      }
    });
    // Periodic refresh every minute
    setInterval(loadWhatsNew, 60_000);

    // Realtime subscriptions to refresh the feed when key tables change
    (function subscribeRealtime() {
      try {
        const tables = ['group_projects','events','suggestions','agreements','support_requests','member_offerings','skill_shares','member_video','contributions','comments'];
        tables.forEach(t => {
          try {
            supabase.from(t).on('*', payload => {
              // small debounce
              if (window._whatsNewTimer) clearTimeout(window._whatsNewTimer);
              window._whatsNewTimer = setTimeout(loadWhatsNew, 500);
            }).subscribe();
          } catch (e) { console.warn('Realtime subscribe failed for', t, e); }
        });
      } catch (e) { console.warn('Realtime subscription setup failed', e); }
    })();
  </script>
</body>
</html>