<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>View Profile</title>
  <script type="module" src="/lib/supabase.js"></script>
  <style>
    body { font-family: sans-serif; background: #f9f9f9; padding: 2rem; }
    .profile-container { max-width: 400px; margin: 2rem auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #eee; padding: 2rem; text-align: center; }
    .profile-img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 2px solid #4a7c59; background: #eee; margin-bottom: 1rem; }
    .profile-name { font-size: 1.3em; font-weight: bold; color: #4a7c59; margin-bottom: 0.5em; }
    .profile-bio { font-size: 1em; color: #555; margin-bottom: 1em; }
    .menu-button { display: block; margin: 30px auto 0 auto; background-color: #6b4f1d; color: #fff; padding: 12px 24px; border-radius: 8px; text-align: center; font-weight: bold; text-decoration: none; font-size: 1.1em; width: fit-content; border: none; cursor: pointer; box-shadow: 0 2px 8px #eee; }
    .menu-button:hover { background-color: #4a7c59; }
  </style>
</head>
<body>
  <div class="profile-container" id="profile-container">
    <div>Loading...</div>
  </div>
  <a href="menu.html" class="menu-button">⬅️ Back to Menu</a>
  <a href="view-profiles.html" class="menu-button">⬅️ Back to All Profiles</a>
  <script type="module">
    import { supabase } from '/lib/supabase.js';
    const container = document.getElementById('profile-container');
    const params = new URLSearchParams(window.location.search);
    const profileId = params.get('id');
    async function loadProfile() {
      if (!profileId) {
        container.innerHTML = '<div>No profile selected.</div>';
        return;
      }
      const { data, error } = await supabase
        .from('profiles')
        .select('full_name, avatar_url, bio')
        .eq('id', profileId)
        .single();
      if (error || !data) {
        container.innerHTML = `<div>Error loading profile.</div>`;
        return;
      }
      let avatarSrc = data.avatar_url;
      if (avatarSrc && !avatarSrc.startsWith('http')) {
        avatarSrc = `https://guykaykkefwabnuhqcyv.supabase.co/storage/v1/object/public/avatars/${avatarSrc}`;
      }
      // Fetch gallery images for this user
      const { data: images, error: imgError } = await supabase
        .from('profile_images')
        .select('image_url')
        .eq('user_id', profileId)
        .limit(100); // Fetch up to 100 images

      let galleryHtml = '';
      if (images && images.length) {
        const signedUrls = await Promise.all(images.map(async img => {
            const { data: signedUrlData } = await supabase.storage.from('profile-pictures').createSignedUrl(img.image_url, 3600);
            if (signedUrlData?.signedUrl) {
                return `<a href="${signedUrlData.signedUrl}" target="_blank"><img src="${signedUrlData.signedUrl}" style="width:100px;height:100px;object-fit:cover;border-radius:8px;box-shadow:0 2px 8px #eee;"></a>`;
            }
            return '';
        }));
        galleryHtml = `<h3 style="margin-top:2em;color:#4a7c59;">Gallery</h3><div style="display:flex;flex-wrap:wrap;justify-content:center;gap:16px;">${signedUrls.join('')}</div>`;
      }
      container.innerHTML = `
        <img class="profile-img" src="${avatarSrc || 'https://via.placeholder.com/120'}" alt="Profile Picture">
        <div class="profile-name">${data.full_name || 'No Name'}</div>
        <div class="profile-bio">${data.bio || ''}</div>
        ${galleryHtml}
      `;
    }
    loadProfile();
  </script>
</body>
</html>
