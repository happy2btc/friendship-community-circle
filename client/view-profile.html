<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>View Profile</title>
  <script type="module" src="/lib/supabase.js"></script>
  <style>
    body { font-family: sans-serif; background: #f9f9f9; padding: 2rem; }
    .profile-container { max-width: 400px; margin: 2rem auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #eee; padding: 2rem; text-align: center; }
    .profile-img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 2px solid #4a7c59; background: #eee; margin-bottom: 1rem; }
    .profile-name { font-size: 1.3em; font-weight: bold; color: #4a7c59; margin-bottom: 0.5em; }
    .profile-bio { font-size: 1em; color: #555; margin-bottom: 1em; }
    .menu-button { display: block; margin: 30px auto 0 auto; background-color: #6b4f1d; color: #fff; padding: 12px 24px; border-radius: 8px; text-align: center; font-weight: bold; text-decoration: none; font-size: 1.1em; width: fit-content; border: none; cursor: pointer; box-shadow: 0 2px 8px #eee; }
    .menu-button:hover { background-color: #4a7c59; }
  </style>
</head>
<body>
  <div class="profile-container" id="profile-container">
    <div>Loading...</div>
  </div>
  <a href="main-menu.html" class="menu-button">‚¨ÖÔ∏è Back to Menu</a>
  <a href="view-profiles.html" class="menu-button">‚¨ÖÔ∏è Back to All Profiles</a>
  <script type="module">
    import { supabase } from '/lib/supabase.js';
    const container = document.getElementById('profile-container');
    const params = new URLSearchParams(window.location.search);
    const profileId = params.get('id');
    async function loadProfile() {
      if (!profileId) {
        container.innerHTML = '<div>No profile selected.</div>';
        return;
      }
      const { data, error } = await supabase
        .from('profiles')
        .select('full_name, avatar_url, bio, contact_info, show_contact')
        .eq('id', profileId)
        .single();
      if (error || !data) {
        container.innerHTML = `<div>Error loading profile.</div>`;
        return;
      }
      let avatarSrc = data.avatar_url;
      if (avatarSrc && !avatarSrc.startsWith('http')) {
        avatarSrc = `https://guykaykkefwabnuhqcyv.supabase.co/storage/v1/object/public/avatars/${avatarSrc}`;
      }
      // Fetch gallery images for this user
      const { data: images, error: imgError } = await supabase
        .from('profile_images')
        .select('image_url')
        .eq('user_id', profileId)
        .limit(100); // Fetch up to 100 images

      // Try resolving a stored path to a usable URL.
      async function resolveImageUrl(path) {
        if (!path) return null;
        // If it's already an absolute URL, use it directly
        if (/^https?:\/\//i.test(path)) return path;
        // Normalize path: remove leading slash
        let normalized = path.replace(/^\/+/, '');
        // If path looks like "bucket/obj...", split out the bucket
        let bucket = 'profile-pictures'; // confirmed bucket name
        let objectPath = normalized;
        const parts = normalized.split('/');
        if (parts.length > 1 && parts[0] === bucket) {
          // stored value included bucket, strip it
          parts.shift();
          objectPath = parts.join('/');
        }

        // Try public URL first (no network call if public)
        try {
          const { data: pubData, error: pubErr } = supabase.storage.from(bucket).getPublicUrl(objectPath);
          if (!pubErr && pubData && pubData.publicUrl) return pubData.publicUrl;
        } catch (e) {
          // ignore and try signed url
        }

        // Try creating a signed URL
        try {
          const { data: signedData, error: sErr } = await supabase.storage.from(bucket).createSignedUrl(objectPath, 3600);
          if (!sErr && signedData && signedData.signedUrl) return signedData.signedUrl;
        } catch (e) {
          // ignore and fall back
        }

        // Fallback: attempt to construct a public URL using the project's storage path pattern
        try {
          const fallback = `https://guykaykkefwabnuhqcyv.supabase.co/storage/v1/object/public/${bucket}/${encodeURIComponent(objectPath)}`;
          return fallback;
        } catch (e) {
          console.warn('Could not construct fallback URL for', path);
        }

        console.warn('Could not resolve image path:', path);
        return null;
      }

      let galleryHtml = '';
      if (images && images.length) {
        const signedUrls = await Promise.all(images.map(async img => {
            const url = await resolveImageUrl(img.image_url);
            if (url) {
                return `<a href="${url}" target="_blank"><img src="${url}" style="width:100px;height:100px;object-fit:cover;border-radius:8px;box-shadow:0 2px 8px #eee;"></a>`;
            }
            return '';
        }));
        const content = signedUrls.filter(Boolean).join('');
        if (content) {
          galleryHtml = `<h3 style="margin-top:2em;color:#4a7c59;">Gallery</h3><div style="display:flex;flex-wrap:wrap;justify-content:center;gap:16px;">${content}</div>`;
        }
      }
      container.innerHTML = `
        <img class="profile-img" src="${avatarSrc || 'https://via.placeholder.com/120'}" alt="Profile Picture">
        <div class="profile-name">${data.full_name || 'No Name'}</div>
        <div class="profile-bio">${data.bio || ''}</div>
        <button id="chat-btn" class="menu-button" style="margin-top:1em;background:#2196f3;">üí¨ Chat with ${data.full_name || 'this member'}</button>
        ${data.show_contact ? `<div id="contact-block" style="margin-top:14px;text-align:left;border-top:1px solid #eee;padding-top:12px;"><h3 style="margin:0 0 6px 0;">Contact</h3><div style="white-space:pre-wrap;color:#222;background:rgba(255,255,255,0.9);padding:10px;border-radius:6px;">${(data.contact_info||'')}</div></div>` : ''}
        ${galleryHtml}
      `;
      // Add chat button handler
      const chatBtn = document.getElementById('chat-btn');
      if (chatBtn) {
        chatBtn.addEventListener('click', () => {
          window.location.href = `personal-chat.html?user=${encodeURIComponent(profileId)}`;
        });
      }
    }
    loadProfile();
  </script>
</body>
</html>
