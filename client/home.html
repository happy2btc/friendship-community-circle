<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Friendship Community Circle</title>
  <style>
    body {
      font-family: sans-serif;
      background: #e6f7f2;
      color: #333;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .welcome-box {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 16px #e0e0e0;
      padding: 3em 2em;
      text-align: center;
      max-width: 400px;
    }
    .welcome-box h1 {
      color: #2e8b57;
      margin-bottom: 0.5em;
    }
    .welcome-box p {
      font-size: 1.15em;
      margin-bottom: 2em;
    }
    .menu-link {
      display: inline-block;
      background: #6b4f1d;
      color: #fff;
      padding: 1em 2em;
      border-radius: 8px;
      font-size: 1.2em;
      font-weight: bold;
      text-decoration: none;
      transition: background 0.2s;
    }
    .menu-link:hover {
      background: #8c6f4e;
    }
  </style>
</head>
<body>
  <div class="welcome-box" style="max-width:700px;">
    <h1 style="display: flex; align-items: center; justify-content: center; gap: 1rem;">
      ðŸŒ¸ Welcome!
      <div id="notification-bell-container" style="position: relative;">
        <button id="notification-bell" style="background: none; border: none; cursor: pointer; position: relative; font-size: 1.7em;">
          ðŸ””
          <span id="notification-count" style="display:none; position: absolute; top: -8px; right: -8px; background: red; color: white; border-radius: 50%; padding: 2px 7px; font-size: 0.8em; font-weight: bold; min-width: 18px; text-align: center;"></span>
        </button>
        <div id="notification-dropdown" style="display: none; position: absolute; right: 0; top: 2.5em; background: #fff; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 8px #eee; min-width: 260px; z-index: 2000; max-height: 350px; overflow-y: auto; overflow-wrap: break-word;">
          <div id="notification-list" style="padding: 0.5em 0.5em 0.5em 0.5em;"></div>
          <div style="text-align: right; padding: 0.5em 0.7em 0.5em 0.5em;">
            <button id="mark-all-read" style="background: #e6f7f2; color: #333; border: none; border-radius: 5px; padding: 4px 10px; font-size: 0.95em; cursor: pointer;">Mark all as read</button>
          </div>
        </div>
      </div>
    </h1>
    <button id="notif-test-btn" style="margin: 1em auto; display: block; background: #2196f3; color: #fff; border: none; border-radius: 6px; padding: 10px 18px; font-size: 1em; font-weight: bold; cursor: pointer;">Enable Desktop Notifications</button>
    <div style="display: flex; gap: 2rem; flex-wrap: wrap; margin-bottom: 2rem; justify-content:center;">
      <div style="flex: 1; min-width: 300px; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #eee; padding: 1rem;">
        <h2>ðŸŒŸ Most Active Member</h2>
        <div id="most-active-member"></div>
      </div>
      <div style="flex: 1; min-width: 300px; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #eee; padding: 1rem;">
        <h2> Newest Member</h2>
        <div id="newest-member"></div>
      </div>
    </div>
    <a href="welcome.html" class="menu-button" style="background:#ffe082;color:#6b4f1d;font-weight:bold;margin-bottom:8px;display:inline-block;">ðŸ‘‹ In Case You Missed It</a>
    <a href="what's-new.html" class="menu-button" style="background:#b3c6e6;color:#2e2e2e;font-weight:bold;margin-bottom:18px;display:inline-block;">ðŸ†• What's New</a>
  <a href="main-menu.html" class="menu-link" style="margin-top:2em;">Enter Community Menu</a>
  <script type="module">
    // --- Desktop Notification Permission & Test ---
    async function requestAndShowNotification() {
      if (!('Notification' in window)) {
        alert('This browser does not support desktop notification');
        return;
      }
      let permission = Notification.permission;
      if (permission === 'default') {
        try {
          permission = await Notification.requestPermission();
        } catch (e) {
          alert('Error requesting notification permission: ' + e);
          return;
        }
      }
      if (permission === 'granted') {
        alert('Permission granted! Showing test notification.');
        new Notification('ðŸ”” Friendship Community Circle', {
          body: 'This is a test notification! You will see real notifications here soon.',
          icon: '/default-avatar.png'
        });
      } else {
        alert('Notifications are blocked or denied. Please enable them in your browser settings.');
      }
    }
    document.getElementById('notif-test-btn').onclick = requestAndShowNotification;
    // --- Notification Bell Logic ---
    import { supabase } from '/lib/supabase.js';
    const bell = document.getElementById('notification-bell');
    const dropdown = document.getElementById('notification-dropdown');
    const notifCount = document.getElementById('notification-count');
    const notifList = document.getElementById('notification-list');
    const markAllReadBtn = document.getElementById('mark-all-read');
    let notifications = [];
    let unreadCount = 0;
    let pollingInterval = null;
    function showDropdown(show) {
      dropdown.style.display = show ? 'block' : 'none';
    }
    bell.addEventListener('click', (e) => {
      e.stopPropagation();
      showDropdown(dropdown.style.display !== 'block');
    });
    document.addEventListener('click', (e) => {
      if (!dropdown.contains(e.target) && e.target !== bell) {
        showDropdown(false);
      }
    });
    async function fetchNotifications() {
      const { data: userData } = await supabase.auth.getUser();
      const userId = userData?.user?.id;
      if (!userId) return;
      const { data, error } = await supabase
        .from('notifications')
        .select('*')
        .eq('user_id', userId)
        .order('created_at', { ascending: false })
        .limit(20);
      if (error) {
        notifList.innerHTML = '<em>Error loading notifications</em>';
        notifCount.style.display = 'none';
        return;
      }
      notifications = data || [];
      unreadCount = notifications.filter(n => !n.read).length;
      renderNotifications();
    }
    function renderNotifications() {
      notifList.innerHTML = '';
      if (!notifications.length) {
        notifList.innerHTML = '<em>No notifications</em>';
        notifCount.style.display = 'none';
        return;
      }
      notifications.forEach(n => {
        const div = document.createElement('div');
        div.style.padding = '0.5em 0.2em';
        div.style.borderBottom = '1px solid #eee';
        div.style.background = n.read ? '#f7f7f7' : '#e6f7f2';
        div.style.cursor = 'pointer';
        div.innerHTML = `<span style=\"font-size:1.1em;\">${n.icon || 'ðŸ””'}</span> <span style=\"font-size:12pt;\">${n.message}</span><br><span style=\"font-size:0.85em;color:#888;\">${new Date(n.created_at).toLocaleString()}</span>`;
        if (!n.read) {
          div.style.fontWeight = 'bold';
        }
        div.addEventListener('click', async () => {
          if (!n.read) {
            await markNotificationRead(n.id);
            n.read = true;
            renderNotifications();
          }
          if (n.link) {
            window.location.href = n.link;
          }
        });
        notifList.appendChild(div);
      });
      if (unreadCount > 0) {
        notifCount.textContent = unreadCount;
        notifCount.style.display = 'inline-block';
      } else {
        notifCount.style.display = 'none';
      }
    }
    async function markNotificationRead(id) {
      await supabase.from('notifications').update({ read: true }).eq('id', id);
      fetchNotifications();
    }
    markAllReadBtn.addEventListener('click', async () => {
      const { data: userData } = await supabase.auth.getUser();
      const userId = userData?.user?.id;
      if (!userId) return;
      await supabase.from('notifications').update({ read: true }).eq('user_id', userId);
      fetchNotifications();
    });
    function startNotificationPolling() {
      fetchNotifications();
      if (pollingInterval) clearInterval(pollingInterval);
      pollingInterval = setInterval(fetchNotifications, 15000); // every 15s
    }
    startNotificationPolling();
    // --- End Notification Bell Logic ---

    // --- Most Active Member ---
    async function showMostActiveMember() {
        try {
            // Simplified query to get the top member from activities
            const [votesRes, suggestionsRes, commentsRes, offeringsRes, contributionsRes, profilesRes, circlesRes, membersRes, celebrationsRes, eventsRes, helpGivenRes, supportResponsesRes, writersWallRes, memberVideosRes, positiveImpactsRes, eventAttendanceRes, groupProjectsRes] = await Promise.all([
                supabase.from('agreement_votes').select('voter_id'),
                supabase.from('suggestions').select('author_id'),
                supabase.from('comments').select('author_id'),
                supabase.from('member_offerings').select('user_id, want, give, passion'),
                supabase.from('contributions').select('user_id, project, challenge, help, collab, skills, urgency, contact'),
                supabase.from('profiles').select('id, full_name, avatar_url, personal_story'),
                supabase.from('circles').select('created_by'),
                supabase.from('circle_members').select('added_by'),
                supabase.from('celebrations').select('user_id'),
                supabase.from('events').select('created_by'),
                supabase.from('help_given').select('helper_id, hours'),
                supabase.from('support_responses').select('responder_id'),
                supabase.from('writers_wall').select('author_id, points'),
                supabase.from('member_video').select('user_id'),
                supabase.from('positive_impact').select('contributor_id, points_awarded'),
                supabase.from('event_attendance').select('user_id'),
                supabase.from('group_projects').select('proposer_id')
            ]);

            const builderId = "81c50097-74f3-4c7a-b00c-598995b8d1cb";
            const activity = {};
            const breakdown = {};

            // Simplified activity calculation (same logic as activities.html but condensed)
            function initBreakdown(id) {
                if (!breakdown[id]) {
                    breakdown[id] = { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, events_created: 0, events_attended: 0, help_hours: 0, help_points: 0, support_responses: 0, writer_posts: 0, writer_points: 0, videos_posted: 0, positive_impact: 0, projects_proposed: 0 };
                }
            }

            // Process all activities (simplified version)
            votesRes.data?.forEach(v => { if (v.voter_id !== builderId) { initBreakdown(v.voter_id); breakdown[v.voter_id].votes += 1; activity[v.voter_id] = (activity[v.voter_id] || 0) + 1; } });
            suggestionsRes.data?.forEach(s => { if (s.author_id !== builderId) { initBreakdown(s.author_id); breakdown[s.author_id].suggestions += 1; activity[s.author_id] = (activity[s.author_id] || 0) + 1; } });
            commentsRes.data?.forEach(c => { if (c.author_id !== builderId) { initBreakdown(c.author_id); breakdown[c.author_id].comments += 1; activity[c.author_id] = (activity[c.author_id] || 0) + 1; } });

            offeringsRes.data?.forEach(o => {
                if (o.user_id !== builderId) {
                    initBreakdown(o.user_id);
                    if (o.want?.trim()) { breakdown[o.user_id].wants += 1; activity[o.user_id] = (activity[o.user_id] || 0) + 1; }
                    if (o.give?.trim()) { breakdown[o.user_id].offers += 1; activity[o.user_id] = (activity[o.user_id] || 0) + 1; }
                    if (o.passion?.trim()) { breakdown[o.user_id].passion += 1; activity[o.user_id] = (activity[o.user_id] || 0) + 1; }
                }
            });

            contributionsRes.data?.forEach(con => {
                if (con.user_id !== builderId) {
                    initBreakdown(con.user_id);
                    let fields = 0;
                    ['project','challenge','help','collab','skills','urgency','contact'].forEach(field => {
                        if (con[field]?.trim()) fields += 1;
                    });
                    breakdown[con.user_id].projects += fields;
                    activity[con.user_id] = (activity[con.user_id] || 0) + fields;
                }
            });

            profilesRes.data?.forEach(p => {
                if (p.id !== builderId) {
                    let filled = 0;
                    if (p.full_name?.trim()) filled++;
                    if (p.avatar_url?.trim()) filled++;
                    if (filled >= 1) {
                        initBreakdown(p.id);
                        breakdown[p.id].profile = 1;
                        activity[p.id] = (activity[p.id] || 0) + 5;
                    }
                }
            });

            circlesRes.data?.forEach(c => { if (c.created_by && c.created_by !== builderId) { initBreakdown(c.created_by); breakdown[c.created_by].circles_created += 1; activity[c.created_by] = (activity[c.created_by] || 0) + 10; } });
            membersRes.data?.forEach(m => { if (m.added_by && m.added_by !== builderId) { initBreakdown(m.added_by); breakdown[m.added_by].members_added += 1; activity[m.added_by] = (activity[m.added_by] || 0) + 2; } });
            celebrationsRes.data?.forEach(c => { if (c.user_id && c.user_id !== builderId) { initBreakdown(c.user_id); breakdown[c.user_id].celebrations_posted += 1; activity[c.user_id] = (activity[c.user_id] || 0) + 5; } });
            eventsRes.data?.forEach(e => { if (e.created_by && e.created_by !== builderId) { initBreakdown(e.created_by); breakdown[e.created_by].events_created += 1; activity[e.created_by] = (activity[e.created_by] || 0) + 5; } });
            eventAttendanceRes.data?.forEach(a => { if (a.user_id && a.user_id !== builderId) { initBreakdown(a.user_id); breakdown[a.user_id].events_attended += 1; activity[a.user_id] = (activity[a.user_id] || 0) + 5; } });

            helpGivenRes.data?.forEach(row => {
                if (row.helper_id && row.hours && row.helper_id !== builderId) {
                    initBreakdown(row.helper_id);
                    breakdown[row.helper_id].help_hours += Number(row.hours);
                    breakdown[row.helper_id].help_points += (row.hours * 5);
                    activity[row.helper_id] = (activity[row.helper_id] || 0) + (row.hours * 5);
                }
            });

            supportResponsesRes.data?.forEach(row => { if (row.responder_id && row.responder_id !== builderId) { initBreakdown(row.responder_id); breakdown[row.responder_id].support_responses += 1; activity[row.responder_id] = (activity[row.responder_id] || 0) + 5; } });

            writersWallRes.data?.forEach(row => {
                if (row.author_id) {
                    initBreakdown(row.author_id);
                    breakdown[row.author_id].writer_posts += 1;
                    breakdown[row.author_id].writer_points += (row.points || 0);
                    activity[row.author_id] = (activity[row.author_id] || 0) + (row.points || 0);
                }
            });

            memberVideosRes.data?.forEach(row => { if (row.user_id && row.user_id !== builderId) { initBreakdown(row.user_id); breakdown[row.user_id].videos_posted = (breakdown[row.user_id].videos_posted || 0) + 1; activity[row.user_id] = (activity[row.user_id] || 0) + 5; } });
            positiveImpactsRes.data?.forEach(row => { if (row.contributor_id) { initBreakdown(row.contributor_id); breakdown[row.contributor_id].positive_impact += row.points_awarded; activity[row.contributor_id] = (activity[row.contributor_id] || 0) + row.points_awarded; } });
            groupProjectsRes.data?.forEach(gp => { if (gp.proposer_id && gp.proposer_id !== builderId) { initBreakdown(gp.proposer_id); breakdown[gp.proposer_id].projects_proposed += 1; activity[gp.proposer_id] = (activity[gp.proposer_id] || 0) + 5; } });

            // Get top member
            const userIds = Object.keys(activity).filter(id => id && id !== 'null');
            if (userIds.length > 0) {
                const idToProfile = {};
                profilesRes.data?.forEach(p => { idToProfile[p.id] = p; });

                const members = userIds.map(id => ({
                    id,
                    profile: idToProfile[id] || { full_name: id, avatar_url: '', personal_story: '' },
                    total: activity[id],
                    breakdown: breakdown[id]
                }));

                members.sort((a, b) => b.total - a.total);
                const topMember = members[0];

                const container = document.getElementById('most-active-member');
                container.innerHTML = `
                    <a href="activities.html" style="text-decoration: none; color: inherit; display: block;">
                        <img src="${topMember.profile.avatar_url || 'default-avatar.png'}" alt="Profile Picture" style="width:64px;height:64px;border-radius:50%;object-fit:cover;margin-bottom:1em;">
                        <h3>${topMember.profile.full_name || topMember.id}</h3>
                        <div class="activity-breakdown" style="margin-top:0.5em;">
                            <strong>All-Time Activities:</strong><br>
                            <strong>Total: ${topMember.total}</strong>
                        </div>
                    </a>
                    <div style="font-size:0.95em;color:#888;margin-bottom:0.5em;">
                        <strong>Activities Legend:</strong><br>
                        Votes, Suggestions, Comments, Wants, Offers, Passion, Projects & Struggles = 1 point each<br>
                        Events Created/Attended, Profile Completed, Circles Created, Members Added, Celebration Wall Posts, Support Responses = 5-10 points<br>
                        Help Given = 5 points/hour<br>
                        <span style="color:#4a7c59;font-weight:bold;">Writer's Post = 1 point per 1000 words</span>
                    </div>`;
            }
        } catch (error) {
            console.error('Error fetching most active member:', error);
        }
    }

    // --- Newest Member ---
    async function showNewestMember() {
      const cutoffDate = new Date('2025-09-19T00:00:00Z');
      const { data: profiles } = await supabase
        .from('profiles')
        .select('id, full_name, avatar_url, affirmation_text, affirmation_date')
        .order('affirmation_date', { ascending: false });
      const recentProfiles = (profiles || [])
        .filter(p => p.affirmation_date && new Date(p.affirmation_date) >= cutoffDate)
        .sort((a, b) => new Date(b.affirmation_date) - new Date(a.affirmation_date))
        .slice(0, 3); // Show up to 3 recent members

      const newestMemberDiv = document.getElementById('newest-member');
      newestMemberDiv.innerHTML = '';
      if (recentProfiles.length === 0) {
        newestMemberDiv.innerHTML = "<em>No new member since 9/19/2025.</em>";
        return;
      }
      for (const profile of recentProfiles) {
        // Get circles for this member (membership)
        const { data: memberCircles } = await supabase
          .from('circle_members')
          .select('circle_id')
          .eq('user_id', profile.id);
        // Get circles created by this member (credit)
        const { data: createdCircles } = await supabase
          .from('circles')
          .select('id, name')
          .eq('created_by', profile.id);
        let circleNames = [];
        // Always add circles created by member, marked as creator
        let createdNames = [];
        if (createdCircles && createdCircles.length > 0) {
          for (const c of createdCircles) {
            createdNames.push(c.name);
            circleNames.push(c.name + ' (creator)');
          }
        }
        // Add circles where member is a member, but not already credited as creator
        if (memberCircles && memberCircles.length > 0) {
          const circleIds = memberCircles.map(c => c.circle_id);
          const { data: circleData } = await supabase
            .from('circles')
            .select('id, name')
            .in('id', circleIds);
          if (circleData) {
            for (const c of circleData) {
              // Only add if not already credited as creator (by name)
              if (!createdNames.includes(c.name) && !circleNames.includes(c.name)) {
                circleNames.push(c.name);
              }
            }
          }
        }

        const memberCard = document.createElement('a');
        memberCard.href = `view-profile.html?id=${profile.id}`;
        memberCard.className = 'member-card';
        memberCard.style.marginBottom = '1em';
        memberCard.style.textDecoration = 'none';
        memberCard.style.color = 'inherit';
        memberCard.style.display = 'block';
        // Use avatar_url or default
        const avatarUrl = profile.avatar_url && profile.avatar_url.trim() !== ''
          ? profile.avatar_url
          : 'public/default-avatar.png';
        memberCard.innerHTML = `
            <img src="${avatarUrl}" alt="Profile Picture" style="width:64px;height:64px;border-radius:50%;object-fit:cover;margin-bottom:0.5em;">
            <strong>${profile.full_name || 'Unnamed Member'}</strong>
            <div style="color:#888;">Joined: ${profile.affirmation_date ? new Date(profile.affirmation_date).toLocaleDateString() : 'â€”'}</div>
            <div style="color:#555;">Circles: ${circleNames.length ? circleNames.join(', ') : 'None'}</div>
        `;
        newestMemberDiv.appendChild(memberCard);
      }
  // removed extra closing brace
    }

    showMostActiveMember();
    showNewestMember();
  </script>
</body>
</html>
