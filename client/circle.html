<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Circle Community</title>
  <script type="module" src="/lib/supabase.js"></script>
  <style>
    body { font-family: Georgia, serif; background: #f9f6f1; color: #3b2f2f; padding: 2rem; }
    .section { margin-bottom: 2rem; }
    .agreement-card { background: #fff; border: 1px solid #d8bfa3; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .member-list { margin-top: 1rem; }
    .menu-button { display: block; width: fit-content; margin: 2rem auto 0 auto; background-color: #6c757d; color: #fff; padding: 10px 18px; border-radius: 6px; text-decoration: none; font-weight: bold; text-align: center; }
  </style>
</head>
<body>
  <h1 id="circle-name">Loading...</h1>
  <div id="circle-description" class="section"></div>
  <div id="agreements-section" class="section"></div>
  <div id="members-section" class="section"></div>
  <a href="menu.html" class="menu-button">ðŸ”™ Return to Menu</a>
  <script type="module">
    import { supabase } from '/lib/supabase.js';
    const params = new URLSearchParams(window.location.search);
    const circleId = params.get('id');

    async function loadCircle() {
      // Load circle info
      const { data: circle, error } = await supabase
        .from('circles')
        .select('*')
        .eq('id', circleId)
        .single();
      if (!circle) {
        document.getElementById('circle-name').textContent = "Circle not found.";
        return;
      }
      document.getElementById('circle-name').textContent = circle.name;
      document.getElementById('circle-description').textContent = circle.description || '';

      // Load agreements for this circle
      const { data: agreements } = await supabase
        .from('agreements')
        .select('id, agreement_text, status, created_at')
        .eq('circle_id', circleId)
        .order('created_at', { ascending: false });
      const agreementsSection = document.getElementById('agreements-section');
      agreementsSection.innerHTML = '<h2>Agreements</h2>';
      if (!agreements || agreements.length === 0) {
        agreementsSection.innerHTML += '<p>No agreements yet for this circle.</p>';
      } else {
        agreements.forEach(agreement => {
          const card = document.createElement('div');
          card.className = 'agreement-card';
          card.innerHTML = `
            <strong>${agreement.agreement_text}</strong><br>
            <span>Status: ${agreement.status}</span><br>
            <span>Created: ${new Date(agreement.created_at).toLocaleString()}</span>
          `;
          agreementsSection.appendChild(card);
        });
      }

      // Load members for this circle
      const { data: members } = await supabase
        .from('circle_members')
        .select('user_id')
        .eq('circle_id', circleId);
      const memberIds = members ? members.map(m => m.user_id) : [];
      let memberListHtml = '<h2>Members</h2>';
      if (memberIds.length === 0) {
        memberListHtml += '<p>No members yet.</p>';
      } else {
        // Get member profiles
        const { data: profiles } = await supabase
          .from('profiles')
          .select('full_name, avatar_url')
          .in('id', memberIds);
        memberListHtml += '<div class="member-list">';
        profiles.forEach(profile => {
          memberListHtml += `
            <div>
              <img src="${profile.avatar_url || 'default-avatar.png'}" alt="avatar" width="32" height="32" style="vertical-align:middle;border-radius:50%;">
              <span>${profile.full_name}</span>
            </div>
          `;
        });
        memberListHtml += '</div>';
      }
      document.getElementById('members-section').innerHTML = memberListHtml;
    }

    loadCircle();
  </script>
</body>
</html>