<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Circle Community</title>
  <script type="module" src="/lib/supabase.js"></script>
  <style>
    body { font-family: Georgia, serif; background: #f9f6f1; color: #3b2f2f; padding: 2rem; }
    .section { margin-bottom: 2rem; }
    .agreement-card { background: #fff; border: 1px solid #d8bfa3; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .member-list { margin-top: 1rem; }
    .menu-button { display: block; width: fit-content; margin: 2rem auto 0 auto; background-color: #6c757d; color: #fff; padding: 10px 18px; border-radius: 6px; text-decoration: none; font-weight: bold; text-align: center; }
  </style>
</head>
<body>
  <h1 id="circle-name">Loading...</h1>
  <div id="circle-description" class="section"></div>
  <div id="agreements-section" class="section"></div>
  <div id="members-section" class="section"></div>
  <div id="chat-section" class="section">
    <h2>Circle Chat Room</h2>
    <div id="chat-messages" style="height:300px;overflow-y:auto;border:1px solid #ccc;padding:1em;background:#fff;margin-bottom:1em;"></div>
    <form id="chat-form" style="display:flex;gap:1em;">
      <input type="text" id="chat-input" placeholder="Type your message..." style="flex:1;">
      <button type="submit">Send</button>
    </form>
  </div>
  <a href="menu.html" class="menu-button">ðŸ”™ Return to Menu</a>
  <script type="module">
    import { supabase } from '/lib/supabase.js';
    const params = new URLSearchParams(window.location.search);
    const circleId = params.get('id');

    async function loadCircle() {
      // Load circle info
      const { data: circle, error } = await supabase
        .from('circles')
        .select('*')
        .eq('id', circleId)
        .single();
      if (!circle) {
        document.getElementById('circle-name').textContent = "Circle not found.";
        return;
      }
      document.getElementById('circle-name').textContent = circle.name;
      document.getElementById('circle-description').textContent = circle.description || '';

      // Load agreements for this circle
      const { data: agreements } = await supabase
        .from('agreements')
        .select('id, agreement_text, status, created_at')
        .eq('circle_id', circleId)
        .order('created_at', { ascending: false });
      const agreementsSection = document.getElementById('agreements-section');
      agreementsSection.innerHTML = '<h2>Agreements</h2>';
      if (!agreements || agreements.length === 0) {
        agreementsSection.innerHTML += '<p>No agreements yet for this circle.</p>';
      } else {
        agreements.forEach(agreement => {
          const card = document.createElement('div');
          card.className = 'agreement-card';
          card.innerHTML = `
            <strong>${agreement.agreement_text}</strong><br>
            <span>Status: ${agreement.status}</span><br>
            <span>Created: ${new Date(agreement.created_at).toLocaleString()}</span>
          `;
          agreementsSection.appendChild(card);
        });
      }

      // Load members for this circle
      const { data: members } = await supabase
        .from('circle_members')
        .select('user_id')
        .eq('circle_id', circleId);
      const memberIds = members ? members.map(m => m.user_id) : [];
      let memberListHtml = '<h2>Members</h2>';
      if (memberIds.length === 0) {
        memberListHtml += '<p>No members yet.</p>';
      } else {
        // Get member profiles
        const { data: profiles } = await supabase
          .from('profiles')
          .select('full_name, avatar_url')
          .in('id', memberIds);
        memberListHtml += '<div class="member-list">';
        profiles.forEach(profile => {
          memberListHtml += `
            <div>
              <img src="${profile.avatar_url || 'default-avatar.png'}" alt="avatar" width="32" height="32" style="vertical-align:middle;border-radius:50%;">
              <span>${profile.full_name}</span>
            </div>
          `;
        });
        memberListHtml += '</div>';
      }
      document.getElementById('members-section').innerHTML = memberListHtml;
    }

    // --- Chat Integration ---
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    async function loadMessages() {
      const { data: messages } = await supabase
        .from('circle_messages')
        .select('message, created_at, user_id')
        .eq('circle_id', circleId)
        .order('created_at', { ascending: true });
      chatMessages.innerHTML = '';
      for (const msg of messages || []) {
        // Get sender profile
        const { data: profile } = await supabase
          .from('profiles')
          .select('full_name, avatar_url')
          .eq('id', msg.user_id)
          .single();
        chatMessages.innerHTML += `
          <div style="margin-bottom:1em;">
            <img src="${profile?.avatar_url || 'default-avatar.png'}" width="24" height="24" style="vertical-align:middle;border-radius:50%;">
            <strong>${profile?.full_name || 'Unknown'}:</strong>
            <span>${msg.message}</span>
            <small style="color:#888;">${new Date(msg.created_at).toLocaleTimeString()}</small>
          </div>
        `;
      }
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = chatInput.value.trim();
      if (!message) return;
      // Get current user
      const { data: userData } = await supabase.auth.getUser();
      const userId = userData?.user?.id;
      if (!userId) {
        alert('You must be signed in to send messages.');
        return;
      }
      await supabase
        .from('circle_messages')
        .insert([{ circle_id: circleId, user_id: userId, message }]);
      chatInput.value = '';
      await loadMessages();
    });

    // Initial chat load
    loadMessages();
    // Optionally, reload messages every 10 seconds for near real-time updates
    setInterval(loadMessages, 10000);

    // ...existing loadCircle() call...
    loadCircle();
  </script>
</body>
</html>