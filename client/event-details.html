<!DOCTYPE html>
<html lang="en">
<head>
  <style>
    .menu-top-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background:#6b4f1d;
      color:#fff;
      padding:12px 20px;
      border-radius:6px;
      text-decoration:none;
      font-weight:bold;
      z-index:1000;
      box-shadow: 0 2px 8px #eee;
    }
    .menu-top-btn:hover {
      background:#8c6f4e;
    }
  </style>
  <meta charset="UTF-8">
  <title>Event Details & Attendance</title>
  <link rel="icon" href="data:," />
  <link rel="shortcut icon" href="data:," />
  <style>
    body { font-family: sans-serif; background: #f9f9f9; color: #222; }
    h1 { text-align: center; color: #2e8b57; }
    #event-details { max-width: 600px; margin: 2em auto; background: #fff; padding: 2em; border-radius: 10px; box-shadow: 0 2px 8px #eee; }
    #attendance-list { margin-top: 2em; }
    #attendance-list li { margin-bottom: 0.5em; }
    .attend-btn { background: #4a7c59; color: #fff; border: none; padding: 10px 18px; border-radius: 6px; font-weight: bold; cursor: pointer; }
    .attend-btn:disabled { background: #ccc; }
  </style>
</head>
<body>
  <a href="menu.html" class="menu-top-btn">← Back to Menu</a>
  <h1>Event Details & Attendance</h1>
      <div style="text-align:center;margin-bottom:2em;">
        <label for="event-select"><strong>Select Event:</strong></label>
        <select id="event-select" style="padding:8px 12px;border-radius:6px;font-size:1em;"></select>
        <button id="refresh-btn" style="padding:8px 12px;border-radius:6px;font-size:1em;margin-left:1em;">Refresh</button>
      </div>
    <div id="event-details"></div>
    <h2 style="text-align:center;">Attendance</h2>
    <ul id="attendance-list"></ul>
    <button id="attend-btn" class="attend-btn">Mark Myself as Attended</button>
    <div id="status"></div>
    <h3>Import Attendance Log</h3>
    <textarea id="attendance-log" placeholder="Paste Zoom attendance log here (CSV format: Name,Email,Join Time,Leave Time,Duration)..." rows="10" style="width:100%;"></textarea>
    <button id="parse-log-btn" class="attend-btn" style="margin-top:1em;">Parse and Import Log</button>
    <div id="log-preview" style="margin-top:1em;"></div>
    <a href="events.html" class="attend-btn" style="display:block;width:fit-content;margin:2em auto 0 auto;">← Back to Events</a>
    <script type="module">
      import { supabase } from '/lib/supabase.js';
      const eventSelect = document.getElementById('event-select');
      const eventDetailsDiv = document.getElementById('event-details');
      const attendanceList = document.getElementById('attendance-list');
      const attendBtn = document.getElementById('attend-btn');
      const statusDiv = document.getElementById('status');
      const refreshBtn = document.getElementById('refresh-btn');
      let currentEventId = null;
      let currentEvents = [];

      async function loadAttendance(eventId) {
        if (!eventId) return;
        const { data: attendance, error } = await supabase
          .from('event_attendance')
          .select('user_id, attended_at, profiles(full_name)')
          .eq('event_id', eventId)
          .order('attended_at', { ascending: false });

        if (error) {
          console.error('Error loading attendance:', error);
          attendanceList.innerHTML = '<li>Error loading attendance.</li>';
          return;
        }

        if (!attendance || attendance.length === 0) {
          attendanceList.innerHTML = '<li>No one has marked attendance yet.</li>';
          return;
        }

        attendanceList.innerHTML = attendance.map(a => {
          const date = new Date(a.attended_at).toLocaleString();
          const name = a.profiles?.full_name || 'Unknown User';
          return `<li><strong>${name}</strong> attended on ${date}</li>`;
        }).join('');
      }

      async function loadEventList() {
        const { data: events, error } = await supabase
          .from('events')
          .select('id, title, start_time, repeat')
          .order('start_time', { ascending: true });

        if (error || !events || events.length === 0) {
          eventSelect.innerHTML = '<option value="">No events found</option>';
          eventDetailsDiv.textContent = 'No event selected.';
          attendBtn.style.display = 'none';
          return;
        }

        const startDate = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000);
        const endDate = new Date(Date.now() + 4 * 24 * 60 * 60 * 1000);

        currentEvents = events.map(e => {
          const eventDate = new Date(e.start_time);

          if (e.repeat === 'weekly') {
            // For weekly repeating events, calculate the next occurrence
            const nextOccurrence = new Date(eventDate);
            while (nextOccurrence < startDate) {
              nextOccurrence.setDate(nextOccurrence.getDate() + 7);
            }
            if (nextOccurrence >= startDate && nextOccurrence <= endDate) {
              e.nextOccurrence = nextOccurrence;
              return e;
            }
          } else {
            // For non-repeating events, just check if the event date is within the window
            if (eventDate >= startDate && eventDate <= endDate) {
              e.nextOccurrence = eventDate;
              return e;
            }
          }
        }).filter(Boolean);

        if (currentEvents.length === 0) {
          eventSelect.innerHTML = '<option value="">No events found in the next 7 days</option>';
          eventDetailsDiv.textContent = 'No event selected.';
          attendBtn.style.display = 'none';
          return;
        }

        eventSelect.innerHTML = currentEvents.map(e => `<option value="${e.id}">${e.title}</option>`).join('');
        currentEventId = currentEvents[0].id;
        await loadEvent(currentEventId, currentEvents[0].nextOccurrence);
        await loadAttendance(currentEventId);
      }

      async function loadEvent(eventId, nextOccurrence) {
        if (!eventId) {
          eventDetailsDiv.textContent = 'No event selected.';
          attendBtn.style.display = 'none';
          return;
        }
        const { data: event, error } = await supabase.from('events').select('*').eq('id', eventId).single();
        if (error || !event) {
          eventDetailsDiv.textContent = 'Event not found.';
          attendBtn.style.display = 'none';
          return;
        }
        eventDetailsDiv.innerHTML = `<h2>${event.title}</h2><div><strong>Date:</strong> ${nextOccurrence ? nextOccurrence.toDateString() : ''}</div><div><strong>Description:</strong> ${event.description || ''}</div>`;
        attendBtn.style.display = '';
      }

      eventSelect.addEventListener('change', async (e) => {
        currentEventId = e.target.value;
        const selectedEvent = currentEvents.find(event => event.id == currentEventId);
        await loadEvent(currentEventId, selectedEvent.nextOccurrence);
        await loadAttendance(currentEventId);
        statusDiv.textContent = '';
      });

      attendBtn.addEventListener('click', async () => {
        attendBtn.disabled = true;
        statusDiv.textContent = '';
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          statusDiv.textContent = 'You must be logged in to mark attendance.';
          attendBtn.disabled = false;
          return;
        }
        const { error } = await supabase.from('event_attendance').insert({ event_id: currentEventId, user_id: user.id, attended_at: new Date().toISOString() });
        if (error) {
          statusDiv.textContent = 'Error marking attendance: ' + error.message;
          attendBtn.disabled = false;
        } else {
          statusDiv.textContent = 'Attendance marked!';
          await loadAttendance(currentEventId);
          attendBtn.disabled = false;
        }
      });
  
      document.getElementById('parse-log-btn').addEventListener('click', async () => {
        const logText = document.getElementById('attendance-log').value.trim();
        if (!logText) {
          alert('Please paste the attendance log.');
          return;
        }
        const lines = logText.split('\n');
        if (lines.length < 2) {
          alert('Invalid log format. Expected CSV with header.');
          return;
        }
        const header = lines[0].split(',');
        const dataLines = lines.slice(1);
        const previewDiv = document.getElementById('log-preview');
        previewDiv.innerHTML = '<h4>Parsed Log:</h4><table border="1" style="width:100%;"><tr><th>Name</th><th>Email</th><th>Join Time</th><th>Action</th></tr>';
        for (const line of dataLines) {
          const cols = line.split(',');
          if (cols.length < 3) continue;
          const name = cols[0].trim();
          const email = cols[1].trim();
          const joinTime = cols[2].trim();
          // Find user by email
          const { data: profile } = await supabase.from('profiles').select('id, full_name').eq('email', email).single();
          const userId = profile?.id;
          const displayName = profile?.full_name || name;
          const action = userId ? `<button onclick="markAttendedFromLog('${userId}', '${joinTime}')">Mark Attended</button>` : 'User not found';
          previewDiv.innerHTML += `<tr><td>${displayName}</td><td>${email}</td><td>${joinTime}</td><td>${action}</td></tr>`;
        }
        previewDiv.innerHTML += '</table>';
      });
  
      window.markAttendedFromLog = async (userId, joinTime) => {
        // Parse joinTime to ISO
        const parsedDate = new Date(joinTime);
        if (isNaN(parsedDate)) {
          alert('Invalid date format: ' + joinTime);
          return;
        }
        const attendedAt = parsedDate.toISOString();
        const { error } = await supabase.from('event_attendance').insert({ event_id: currentEventId, user_id: userId, attended_at: attendedAt });
        if (error) {
          alert('Error marking attendance: ' + error.message);
        } else {
          alert('Attendance marked!');
          loadAttendance(currentEventId);
        }
      };
  
      refreshBtn.addEventListener('click', () => {
        loadEventList();
      });
  
      // Initial load
      loadEventList();
    </script></body>
</html>
