<!DOCTYPE html>
<html lang="en">
<head>
  <style>
    .menu-top-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background:#6b4f1d;
      color:#fff;
      padding:12px 20px;
      border-radius:6px;
      text-decoration:none;
      font-weight:bold;
      z-index:1000;
      box-shadow: 0 2px 8px #eee;
    }
    .menu-top-btn:hover {
      background:#8c6f4e;
    }
  </style>
  <meta charset="UTF-8">
  <title>Event Details & Attendance</title>
  <link rel="icon" href="data:," />
  <link rel="shortcut icon" href="data:," />
  <style>
    body { font-family: sans-serif; background: #f9f9f9; color: #222; }
    h1 { text-align: center; color: #2e8b57; }
    #event-details { max-width: 600px; margin: 2em auto; background: #fff; padding: 2em; border-radius: 10px; box-shadow: 0 2px 8px #eee; }
    #attendance-list { margin-top: 2em; }
    #attendance-list li { margin-bottom: 0.5em; }
    .attend-btn { background: #4a7c59; color: #fff; border: none; padding: 10px 18px; border-radius: 6px; font-weight: bold; cursor: pointer; }
    .attend-btn:disabled { background: #ccc; }
  </style>
</head>
<body>
  <a href="menu.html" class="menu-top-btn">← Back to Menu</a>
  <h1>Event Details & Attendance</h1>
      <div style="text-align:center;margin-bottom:2em;">
        <label for="event-select"><strong>Select Event:</strong></label>
        <select id="event-select" style="padding:8px 12px;border-radius:6px;font-size:1em;"></select>
        <button id="refresh-btn" style="padding:8px 12px;border-radius:6px;font-size:1em;margin-left:1em;">Refresh</button>
      </div>
    <div id="event-details"></div>
    <h2 style="text-align:center;">Attendance</h2>
    <ul id="attendance-list"></ul>
    <div id="members-attending-section" style="margin:1.5em 0;">
      <label for="members-select"><strong>Select members who attended:</strong></label>
      <select id="members-select" multiple size="6" style="width:100%;padding:8px;border-radius:6px;margin-bottom:1em;"></select>
      <button id="members-attending-btn" class="attend-btn" style="width:100%;">Members Attending</button>
      <div id="members-attending-status" style="margin-top:1em;color:#2e8b57;font-weight:bold;"></div>
    </div>
    <div id="import-section" style="display:none;">
    <h3>Import Attendance Log for Selected Event</h3>
    <textarea id="attendance-log" placeholder="Paste Zoom attendance log here (CSV format)..." rows="10" style="width:100%;"></textarea>
    <button id="parse-log-btn" class="attend-btn" style="margin-top:1em;">Parse and Import Log</button>
    <div id="log-preview" style="margin-top:1em;"></div>
    </div>
    <a href="events.html" class="attend-btn" style="display:block;width:fit-content;margin:2em auto 0 auto;">← Back to Events</a>
    <script type="module">
      import { supabase } from '/lib/supabase.js';
      const eventSelect = document.getElementById('event-select');
      const eventDetailsDiv = document.getElementById('event-details');
      const attendanceList = document.getElementById('attendance-list');
  const membersSelect = document.getElementById('members-select');
  const membersAttendingBtn = document.getElementById('members-attending-btn');
  const membersAttendingStatus = document.getElementById('members-attending-status');
      // Load all profiles for the multi-select
      async function loadProfilesForAttendance() {
        const { data: profiles, error } = await supabase.from('profiles').select('id, full_name').order('full_name');
        membersSelect.innerHTML = '';
        if (error || !profiles) {
          membersSelect.innerHTML = '<option disabled>Error loading members</option>';
          return;
        }
        profiles.forEach(profile => {
          const option = document.createElement('option');
          option.value = profile.id;
          option.textContent = profile.full_name;
          membersSelect.appendChild(option);
        });
      }
      const refreshBtn = document.getElementById('refresh-btn');
      let currentEventId = null;
      let currentEvents = [];

      async function loadAttendance(eventId) {
        if (!eventId) return;
        const { data: attendance, error } = await supabase
          .from('event_attendance')
          .select('user_id, attended_at, profiles(full_name)')
          .eq('event_id', eventId)
          .order('attended_at', { ascending: false });

        if (error) {
          console.error('Error loading attendance:', error);
          attendanceList.innerHTML = '<li>Error loading attendance.</li>';
          return;
        }

        if (!attendance || attendance.length === 0) {
          attendanceList.innerHTML = '<li>No one has marked attendance yet.</li>';
          return;
        }

        attendanceList.innerHTML = attendance.map(a => {
          const date = new Date(a.attended_at).toLocaleString();
          const name = a.profiles?.full_name || 'Unknown User';
          return `<li><strong>${name}</strong> attended on ${date}</li>`;
        }).join('');
      }

      async function loadEventList() {
        const { data: events, error } = await supabase
          .from('events')
          .select('id, title, start_time, repeat')
          .order('start_time', { ascending: true });

        if (error || !events || events.length === 0) {
          eventSelect.innerHTML = '<option value="">No events found</option>';
          eventDetailsDiv.textContent = 'No event selected.';
          attendBtn.style.display = 'none';
          return;
        }

        const startDate = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000);
        const endDate = new Date(Date.now() + 4 * 24 * 60 * 60 * 1000);

        currentEvents = events.map(e => {
          const eventDate = new Date(e.start_time);

          if (e.repeat === 'weekly') {
            // For weekly repeating events, calculate the next occurrence
            const nextOccurrence = new Date(eventDate);
            while (nextOccurrence < startDate) {
              nextOccurrence.setDate(nextOccurrence.getDate() + 7);
            }
            if (nextOccurrence >= startDate && nextOccurrence <= endDate) {
              e.nextOccurrence = nextOccurrence;
              return e;
            }
          } else {
            // For non-repeating events, just check if the event date is within the window
            if (eventDate >= startDate && eventDate <= endDate) {
              e.nextOccurrence = eventDate;
              return e;
            }
          }
        }).filter(Boolean);

        if (currentEvents.length === 0) {
          eventSelect.innerHTML = '<option value="">No events found in the next 7 days</option>';
          eventDetailsDiv.textContent = 'No event selected.';
          attendBtn.style.display = 'none';
          document.getElementById('import-section').style.display = 'none';
          return;
        }

        eventSelect.innerHTML = currentEvents.map(e => `<option value="${e.id}">${e.title}</option>`).join('');
        currentEventId = currentEvents[0].id;
        await loadEvent(currentEventId, currentEvents[0].nextOccurrence);
        await loadAttendance(currentEventId);
      }

      async function loadEvent(eventId, nextOccurrence) {
        if (!eventId) {
          eventDetailsDiv.textContent = 'No event selected.';
          attendBtn.style.display = 'none';
          document.getElementById('import-section').style.display = 'none';
          return;
        }
        const { data: event, error } = await supabase.from('events').select('*').eq('id', eventId).single();
        if (error || !event) {
          eventDetailsDiv.textContent = 'Event not found.';
          attendBtn.style.display = 'none';
          document.getElementById('import-section').style.display = 'none';
          return;
        }
        eventDetailsDiv.innerHTML = `<h2>${event.title}</h2><div><strong>Date:</strong> ${nextOccurrence ? nextOccurrence.toDateString() : ''}</div><div><strong>Description:</strong> ${event.description || ''}</div>`;
        attendBtn.style.display = '';
        document.getElementById('import-section').style.display = 'block';
      }

      eventSelect.addEventListener('change', async (e) => {
        currentEventId = e.target.value;
        const selectedEvent = currentEvents.find(event => event.id == currentEventId);
        await loadEvent(currentEventId, selectedEvent.nextOccurrence);
        await loadAttendance(currentEventId);
        statusDiv.textContent = '';
      });


      membersAttendingBtn.addEventListener('click', async () => {
        const selected = Array.from(membersSelect.selectedOptions).map(opt => opt.value);
        if (!currentEventId || selected.length === 0) {
          membersAttendingStatus.textContent = 'Please select at least one member.';
          membersAttendingStatus.style.color = 'red';
          return;
        }
        membersAttendingStatus.textContent = 'Marking attendance...';
        membersAttendingStatus.style.color = '#2e8b57';
        const now = new Date().toISOString();
        const rows = selected.map(user_id => ({
          event_id: currentEventId,
          user_id,
          attended_at: now
        }));
        const { error } = await supabase.from('event_attendance').insert(rows);
        if (error) {
          membersAttendingStatus.textContent = 'Error: ' + error.message;
          membersAttendingStatus.style.color = 'red';
          return;
        }
        // Increment total_points in profiles for each attendee
        // Points update removed: increment_profile_points function does not exist
        // Add 5 points to each attendee's profile
        let updateError = null;
        for (const user_id of selected) {
          // Fetch current points
          const { data: profile, error: fetchError } = await supabase
            .from('profiles')
            .select('points')
            .eq('id', user_id)
            .single();
          if (fetchError) {
            updateError = fetchError;
            continue;
          }
          const currentPoints = (profile && typeof profile.points === 'number') ? profile.points : 0;
          const { error: upError } = await supabase
            .from('profiles')
            .update({ points: currentPoints + 5 })
            .eq('id', user_id);
          if (upError) updateError = upError;
        }
        if (updateError) {
          membersAttendingStatus.textContent = 'Attendance marked, but error updating points: ' + updateError.message;
          membersAttendingStatus.style.color = 'orange';
        } else {
          membersAttendingStatus.textContent = 'Attendance and points marked!';
          membersAttendingStatus.style.color = '#2e8b57';
        }
        await loadAttendance(currentEventId);
      });
  // Load profiles for the dropdown on page load and when event changes
  loadProfilesForAttendance();
  eventSelect.addEventListener('change', loadProfilesForAttendance);
  
      document.getElementById('parse-log-btn').addEventListener('click', async () => {
        const logText = document.getElementById('attendance-log').value.trim();
        if (!logText) {
          alert('Please paste the attendance log.');
          return;
        }
        const lines = logText.split('\n');
        if (lines.length < 2) {
          alert('Invalid log format. Expected CSV with header.');
          return;
        }
        const header = lines[0].split(',');
        const dataLines = lines.slice(1);
        // Find column indices
        const nameIndex = header.findIndex(h => h.trim().toLowerCase() === 'name (original name)');
        const emailIndex = header.findIndex(h => h.trim().toLowerCase() === 'email');
        const joinTimeIndex = header.findIndex(h => h.trim().toLowerCase() === 'join time');
        if (nameIndex === -1 || emailIndex === -1 || joinTimeIndex === -1) {
          alert('CSV must contain "Name (original name)", "Email", and "Join time" columns.');
          return;
        }
        const previewDiv = document.getElementById('log-preview');
        previewDiv.innerHTML = '<h4>Parsed Log:</h4><table border="1" style="width:100%;"><tr><th>Name</th><th>Email</th><th>Join Time</th><th>Action</th></tr>';
        for (const line of dataLines) {
          const cols = line.split(',').map(col => col.trim().replace(/^"|"$/g, '')); // Trim and remove surrounding quotes
          if (cols.length <= Math.max(nameIndex, emailIndex, joinTimeIndex)) continue;
          const name = cols[nameIndex].replace(/\s*\(Host\)\s*$/, ''); // Remove (Host) suffix
          const email = cols[emailIndex];
          const joinTime = cols[joinTimeIndex];
          // Find user by name (since email not in profiles table)
          const { data: profile } = await supabase.from('profiles').select('id, full_name').eq('full_name', name).single();
          const userId = profile?.id;
          const displayName = profile?.full_name || name;
          const action = userId ? `<button onclick="markAttendedFromLog('${userId}', '${joinTime}')">Mark Attended</button>` : 'User not found';
          previewDiv.innerHTML += `<tr><td>${displayName}</td><td>${email}</td><td>${joinTime}</td><td>${action}</td></tr>`;
        }
        previewDiv.innerHTML += '</table>';
      });
  
      window.markAttendedFromLog = async (userId, joinTime) => {
        // Parse joinTime to ISO
        const parsedDate = new Date(joinTime);
        if (isNaN(parsedDate)) {
          alert('Invalid date format: ' + joinTime);
          return;
        }
        const attendedAt = parsedDate.toISOString();
        const { error } = await supabase.from('event_attendance').insert({ event_id: currentEventId, user_id: userId, attended_at: attendedAt });
        if (error) {
          alert('Error marking attendance: ' + error.message);
        } else {
          alert('Attendance marked!');
          loadAttendance(currentEventId);
        }
      };
  
      refreshBtn.addEventListener('click', () => {
        loadEventList();
      });
  
      // Initial load
      loadEventList();
    </script></body>
</html>
