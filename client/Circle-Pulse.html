<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Circle Pulse â€” What's Happening This Week</title>
  <script type="module" src="/lib/supabase.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--accent:#2e8b57;--muted:#666;--card:#fff;--bg:#f7faf7}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;padding:1.25rem;background:var(--bg);color:#111}
    .wrap{max-width:900px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center;margin-bottom:1rem}
    h1{margin:0;font-size:1.5rem}
    .lead{color:var(--muted);margin-top:0.25rem}
    .card{background:var(--card);border:1px solid #eee;border-radius:10px;padding:1rem;margin-bottom:1rem;box-shadow:0 2px 6px rgba(0,0,0,0.04)}
    form{display:grid;gap:8px}
    input,textarea,select{padding:10px;border-radius:6px;border:1px solid #ddd;font-size:1rem}
    button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
    .small{font-size:0.9rem;color:var(--muted)}
    .ann-list{display:grid;gap:8px}
    .ann{border-left:4px solid var(--accent);padding:8px 12px;background:#fff;border-radius:6px}
    .meta{font-size:0.85rem;color:var(--muted)}
    .empty{color:var(--muted);padding:8px}
    .status{font-size:0.95rem;color:var(--muted)}
    .actions{display:flex;gap:8px}
  .visit-banner{background:var(--accent);color:#fff;padding:12px;border-radius:10px;margin-bottom:12px;display:flex;gap:18px;align-items:center;justify-content:space-between}
  .visit-banner .big{font-size:1.15rem;font-weight:800}
  .visit-banner .small{color:rgba(255,255,255,0.95);font-weight:600}
  .activity-item{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
  .activity-left{flex:1}
  .activity-right{white-space:nowrap;color:var(--muted);font-size:0.85rem}
    @media (max-width:600px){body{padding:0.75rem}} 
  </style>
</head>
<body>
  <a href="main-menu.html" aria-label="Back to Menu" style="position:fixed; top:16px; left:16px; z-index:1200; background:#2b6b4f; color:#fff; padding:8px 12px; border-radius:8px; text-decoration:none; font-weight:600; box-shadow:0 2px 6px rgba(0,0,0,0.15);">ðŸ”™ Back to Menu</a>
  <div class="wrap">
    <!-- Prominent visit banner (first thing on the page) -->
    <div class="visit-banner" id="visit-banner">
      <div>
        <div class="small">Visits today</div>
        <div class="big" id="visits-today-banner">â€¦</div>
      </div>
      <div style="text-align:right">
        <div class="small">Visits this week</div>
        <div class="big" id="visits-week-banner">â€¦</div>
      </div>
      <div style="margin-left:12px;display:flex;align-items:center;gap:8px">
        <button id="sync-visits-btn" type="button" style="background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.18);color:#fff;padding:6px 8px;border-radius:6px;font-weight:700">Sync visits</button>
        <div id="sync-status" class="small" style="color:rgba(255,255,255,0.9)"></div>
      </div>
    </div>
    <header>
      <div>
        <h1>Activity Pulse</h1>
        <div class="lead">Recent member activity that awarded points (most recent actions appear first).</div>
      </div>
    </header>

    <!-- Posting form removed â€” this page now focuses on activity and site metrics -->

    <!-- Activity feed: show member actions that awarded points -->
    <section class="card" id="activity-section">
      <h2 style="margin-top:0">Recent activity (points awarded)</h2>
      <div id="activity-feed" class="ann-list">
        <div class="empty">Loading activity...</div>
      </div>
    </section>

    <!-- footer removed per request -->
  </div>

  <script type="module">
    import { supabase } from '/lib/supabase.js';

    // ----------------------
    // Visit counting (day / week)
    // Records one visit per browser per day. Tries to insert into `site_visits` table.
    // If DB insert fails, stores a local fallback list under 'site_visits_local'.
    // Then loads counts from DB when available, otherwise computes from local fallback.
    // ----------------------

    const visitRecordedKey = 'site_visit_recorded_date';
    const siteVisitsLocalKey = 'site_visits_local';
  const visitorIdKey = 'visitor_id_v1';

    async function recordVisitOncePerDay(){
      try{
        const now = new Date();
        const today = now.toISOString().slice(0,10);
        // create or reuse a persistent visitor id so we can correlate pre-login activity
        let visitorId = localStorage.getItem(visitorIdKey);
        if (!visitorId) {
          try { visitorId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : 'v-' + Date.now() + '-' + Math.floor(Math.random()*1000000); }catch(e){ visitorId = 'v-' + Date.now() + '-' + Math.floor(Math.random()*1000000); }
          localStorage.setItem(visitorIdKey, visitorId);
        }

        if(localStorage.getItem(visitRecordedKey) === today) return; // already recorded today from this browser

        // collect referrer and utm params
        const referrer = document.referrer || null;
        const landing_url = window.location.href || null;
        const urlParams = new URLSearchParams(window.location.search || '');
        const utm_source = urlParams.get('utm_source');
        const utm_medium = urlParams.get('utm_medium');
        const utm_campaign = urlParams.get('utm_campaign');

        // Attempt DB insert (includes visitor_id and referrer/UTM info)
        try{
          await supabase.from('site_visits').insert([{
            path: window.location.pathname,
            user_agent: navigator.userAgent,
            visitor_id: visitorId,
            referrer,
            landing_url,
            utm_source,
            utm_medium,
            utm_campaign
          }]);
          localStorage.setItem(visitRecordedKey, today);
          return;
        }catch(dbErr){
          console.warn('site_visits insert failed, saving locally', dbErr);
          // fall through to local save
        }

        // Local fallback record
        try{
          const arr = JSON.parse(localStorage.getItem(siteVisitsLocalKey) || '[]');
          arr.unshift({ id: 'local-'+Date.now(), visitor_id: visitorId, path: window.location.pathname, user_agent: navigator.userAgent, referrer: document.referrer || null, landing_url: window.location.href || null, utm_source, utm_medium, utm_campaign, created_at: new Date().toISOString() });
          localStorage.setItem(siteVisitsLocalKey, JSON.stringify(arr.slice(0, 1000)));
          localStorage.setItem(visitRecordedKey, today);
        }catch(e){ console.warn('local site_visits save failed', e); }
      }catch(e){ console.warn('recordVisitOncePerDay general error', e); }
    }

    async function loadVisitCounts(){
      // Support both the banner IDs and the older inline IDs for compatibility
      const todayEl = document.getElementById('visits-today-banner') || document.getElementById('visits-today');
      const weekEl = document.getElementById('visits-week-banner') || document.getElementById('visits-week');
      if(!todayEl || !weekEl) return;

      const now = new Date();
      const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
      const weekAgo = new Date(now.getTime() - 7*24*60*60*1000).toISOString();

      try{
        const dayRes = await supabase.from('site_visits').select('id', { count: 'exact' }).gte('created_at', startOfDay);
        const weekRes = await supabase.from('site_visits').select('id', { count: 'exact' }).gte('created_at', weekAgo);
        if(dayRes.error || weekRes.error){ throw new Error('db count error'); }
        const dayCount = dayRes.count ?? 0;
        const weekCount = weekRes.count ?? 0;
        todayEl.textContent = String(dayCount);
        weekEl.textContent = String(weekCount);
        return;
      }catch(err){
        // DB unavailable â€” compute from local fallback
        try{
          const arr = JSON.parse(localStorage.getItem(siteVisitsLocalKey) || '[]');
          let dayCount = 0, weekCount = 0;
          for(const it of arr){
            if(!it.created_at) continue;
            if(it.created_at >= startOfDay) dayCount++;
            if(it.created_at >= weekAgo) weekCount++;
          }
          todayEl.textContent = String(dayCount || 'â€”');
          weekEl.textContent = String(weekCount || 'â€”');
        }catch(e){
          console.warn('loadVisitCounts fallback failed', e);
          try{ if(todayEl) todayEl.textContent = 'â€”'; if(weekEl) weekEl.textContent = 'â€”'; }catch(_){}
        }
      }
    }

    // Record and load counts on page load
    (async ()=>{ await recordVisitOncePerDay(); await loadVisitCounts(); })();

    // Sync local visits button (uploads site_visits_local to Edge Function)
    const syncBtn = document.getElementById('sync-visits-btn');
    const syncStatusEl = document.getElementById('sync-status');
    if(syncBtn){
      syncBtn.addEventListener('click', async ()=>{
        try{
          syncBtn.disabled = true; syncStatusEl.textContent = 'Syncing...';
          const arr = JSON.parse(localStorage.getItem(siteVisitsLocalKey) || '[]');
          if(!arr || arr.length === 0){ syncStatusEl.textContent = 'No local visits to sync.'; syncBtn.disabled = false; return; }

          // Call Edge Function via Supabase client functions.invoke
          const payload = { type: 'sync-visits', visits: arr };
          let res;
          try{
            res = await supabase.functions.invoke('record-point-event', { body: payload });
          }catch(e){
            console.error('functions.invoke error', e);
            syncStatusEl.textContent = 'Sync failed (network).'; syncBtn.disabled = false; return;
          }

          if(res.error){
            console.error('sync response error', res.error);
            syncStatusEl.textContent = 'Sync failed: '+(res.error.message||res.error); syncBtn.disabled = false; return;
          }

          // On success clear local fallback and refresh counts
          localStorage.removeItem(siteVisitsLocalKey);
          syncStatusEl.textContent = 'Synced '+(arr.length)+' visits.';
          await loadVisitCounts();
        }catch(err){
          console.error('sync error', err);
          syncStatusEl.textContent = 'Sync failed.';
        }finally{ syncBtn.disabled = false; setTimeout(()=>{ syncStatusEl.textContent=''; }, 4000); }
      });
    }


    // Activity feed rendering + loading (member_point_events)
    const activityContainer = document.getElementById('activity-feed');

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    function renderActivities(items){
      activityContainer.innerHTML = '';
      if(!items || items.length === 0){ activityContainer.innerHTML = '<div class="empty">No recent activity.</div>'; return; }
      for(const it of items){
        const el = document.createElement('div'); el.className = 'ann';
        el.innerHTML = `<div class="activity-item"><div class="activity-left"><div style="font-weight:700">${escapeHtml(it.action || 'Action')}</div><div style="margin-top:6px">${escapeHtml(it.meta || '')}</div></div><div class="activity-right"><div>${escapeHtml(it.display_name || 'Member')}</div><div class="meta">${it.points ? '+'+escapeHtml(String(it.points))+' pts' : ''}${it.created_at ? ' â€¢ '+escapeHtml(new Date(it.created_at).toLocaleString()) : ''}</div></div></div>`;
        activityContainer.appendChild(el);
      }
    }

    async function loadActivities(){
      activityContainer.innerHTML = '<div class="empty">Loading activity...</div>';
      try{
        const { data, error } = await supabase
          .from('member_point_events')
          .select('id,display_name,action,meta,points,created_at')
          .order('created_at', { ascending: false })
          .limit(50);
        if(error){
          console.warn('member_point_events load error', error.message);
          const local = JSON.parse(localStorage.getItem('member_point_events_local') || '[]');
          renderActivities(local);
          return;
        }
        renderActivities(data || []);
      }catch(e){
        console.error('loadActivities error', e);
        const local = JSON.parse(localStorage.getItem('member_point_events_local') || '[]');
        renderActivities(local);
      }
    }

    // After successful post, refresh activities (keeps activity feed fresh)
    async function refreshActivities(){ await loadActivities(); }

    // Initial load + periodic refresh
    (async ()=>{ await loadActivities(); setInterval(()=>{ loadActivities().catch(()=>{}); }, 60_000); })();

    </script>
</body>
</html>
