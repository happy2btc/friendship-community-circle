<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Circle Pulse â€” What's Happening This Week</title>
  <script type="module" src="/lib/supabase.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--accent:#2e8b57;--muted:#666;--card:#fff;--bg:#f7faf7}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;padding:1.25rem;background:var(--bg);color:#111}
    .wrap{max-width:900px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center;margin-bottom:1rem}
    h1{margin:0;font-size:1.5rem}
    .lead{color:var(--muted);margin-top:0.25rem}
    .card{background:var(--card);border:1px solid #eee;border-radius:10px;padding:1rem;margin-bottom:1rem;box-shadow:0 2px 6px rgba(0,0,0,0.04)}
    form{display:grid;gap:8px}
    input,textarea,select{padding:10px;border-radius:6px;border:1px solid #ddd;font-size:1rem}
    button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
    .small{font-size:0.9rem;color:var(--muted)}
    .ann-list{display:grid;gap:8px}
    .ann{border-left:4px solid var(--accent);padding:8px 12px;background:#fff;border-radius:6px}
    .meta{font-size:0.85rem;color:var(--muted)}
    .empty{color:var(--muted);padding:8px}
    .status{font-size:0.95rem;color:var(--muted)}
    .actions{display:flex;gap:8px}
  .visit-banner{background:var(--accent);color:#fff;padding:12px;border-radius:10px;margin-bottom:12px;display:flex;gap:18px;align-items:center;justify-content:space-between}
  .visit-banner .big{font-size:1.15rem;font-weight:800}
  .visit-banner .small{color:rgba(255,255,255,0.95);font-weight:600}
  .activity-item{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
  .activity-left{flex:1}
  .activity-right{white-space:nowrap;color:var(--muted);font-size:0.85rem}
    /* Back to Menu: fixed on wider screens, inline/static on small screens to avoid overlap */
    .back-to-menu{position:fixed; top:16px; right:16px; z-index:1200; background:#2b6b4f; color:#fff; padding:8px 12px; border-radius:8px; text-decoration:none; font-weight:600; box-shadow:0 2px 6px rgba(0,0,0,0.15);}
    @media (max-width:600px){
      body{padding:0.75rem}
  .back-to-menu{position:static; margin:10px 0 12px 0; box-shadow:none; float:right}
      /* ensure header is pushed down on very small screens to avoid overlap */
      header{margin-top:12px}
    }
  </style>
</head>
<body>
  <a href="main-menu.html" class="back-to-menu" aria-label="Back to Menu">ðŸ”™ Back to Menu</a>
  <div class="wrap">
    <!-- Page title (moved to top so it's visible immediately) -->
    <header>
      <div>
  <h1 style="font-size:1.75rem; margin-bottom:6px;">Circle Pulse â€” <span style="font-weight:700; font-size:1.75rem;">What's Happening This Week</span></h1>
    <div class="lead">Recent member activity that awarded points (most recent actions appear first).</div>
      </div>
    </header>

    <!-- Prominent visit banner (first thing on the page) -->
    <div class="visit-banner" id="visit-banner">
      <div>
        <div class="small">Visits today</div>
        <div class="big" id="visits-today-banner">â€¦</div>
      </div>
      <div style="text-align:right">
        <div class="small">Visits this week</div>
        <div class="big" id="visits-week-banner">â€¦</div>
      </div>
      <div style="margin-left:12px;display:flex;align-items:center;gap:8px">
        <button id="sync-visits-btn" type="button" style="background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.18);color:#fff;padding:6px 8px;border-radius:6px;font-weight:700">Sync visits</button>
        <div id="sync-status" class="small" style="color:rgba(255,255,255,0.9)"></div>
      </div>
    </div>
    <!-- header removed (title moved above the banner) -->

    <!-- Posting form removed â€” this page now focuses on activity and site metrics -->

    <!-- Activity feed: show member actions that awarded points -->
    <section class="card" id="activity-section">
      <h2 style="margin-top:0">Recent activity (points awarded)</h2>
      <div id="activity-feed" class="ann-list">
        <div class="empty">Loading activity...</div>
      </div>
    </section>

    

    <!-- footer removed per request -->
  </div>

  <script type="module">
    import { supabase } from '/lib/supabase.js';

    // ----------------------
    // Visit counting (day / week)
    // Records one visit per browser per day. Tries to insert into `site_visits` table.
    // If DB insert fails, stores a local fallback list under 'site_visits_local'.
    // Then loads counts from DB when available, otherwise computes from local fallback.
    // ----------------------

    const visitRecordedKey = 'site_visit_recorded_date';
    const siteVisitsLocalKey = 'site_visits_local';
  const visitorIdKey = 'visitor_id_v1';

    async function recordVisitOncePerDay(){
      try{
        const now = new Date();
        const today = now.toISOString().slice(0,10);
        // create or reuse a persistent visitor id so we can correlate pre-login activity
        let visitorId = localStorage.getItem(visitorIdKey);
        if (!visitorId) {
          try { visitorId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : 'v-' + Date.now() + '-' + Math.floor(Math.random()*1000000); }catch(e){ visitorId = 'v-' + Date.now() + '-' + Math.floor(Math.random()*1000000); }
          localStorage.setItem(visitorIdKey, visitorId);
        }

        if(localStorage.getItem(visitRecordedKey) === today) return; // already recorded today from this browser

        // collect referrer and utm params
        const referrer = document.referrer || null;
        const landing_url = window.location.href || null;
        const urlParams = new URLSearchParams(window.location.search || '');
        const utm_source = urlParams.get('utm_source');
        const utm_medium = urlParams.get('utm_medium');
        const utm_campaign = urlParams.get('utm_campaign');

        // Attempt DB insert (includes visitor_id and referrer/UTM info)
        try{
          await supabase.from('site_visits').insert([{
            path: window.location.pathname,
            user_agent: navigator.userAgent,
            visitor_id: visitorId,
            referrer,
            landing_url,
            utm_source,
            utm_medium,
            utm_campaign
          }]);
          localStorage.setItem(visitRecordedKey, today);
          return;
        }catch(dbErr){
          console.warn('site_visits insert failed, saving locally', dbErr);
          // fall through to local save
        }

        // Local fallback record
        try{
          const arr = JSON.parse(localStorage.getItem(siteVisitsLocalKey) || '[]');
          arr.unshift({ id: 'local-'+Date.now(), visitor_id: visitorId, path: window.location.pathname, user_agent: navigator.userAgent, referrer: document.referrer || null, landing_url: window.location.href || null, utm_source, utm_medium, utm_campaign, created_at: new Date().toISOString() });
          localStorage.setItem(siteVisitsLocalKey, JSON.stringify(arr.slice(0, 1000)));
          localStorage.setItem(visitRecordedKey, today);
        }catch(e){ console.warn('local site_visits save failed', e); }
      }catch(e){ console.warn('recordVisitOncePerDay general error', e); }
    }

    async function loadVisitCounts(){
      // Support both the banner IDs and the older inline IDs for compatibility
      const todayEl = document.getElementById('visits-today-banner') || document.getElementById('visits-today');
      const weekEl = document.getElementById('visits-week-banner') || document.getElementById('visits-week');
      if(!todayEl || !weekEl) return;

      const now = new Date();
      const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
      const weekAgo = new Date(now.getTime() - 7*24*60*60*1000).toISOString();

      try{
        const dayRes = await supabase.from('site_visits').select('id', { count: 'exact' }).gte('created_at', startOfDay);
        const weekRes = await supabase.from('site_visits').select('id', { count: 'exact' }).gte('created_at', weekAgo);
        if(dayRes.error || weekRes.error){ throw new Error('db count error'); }
        const dayCount = dayRes.count ?? 0;
        const weekCount = weekRes.count ?? 0;
        todayEl.textContent = String(dayCount);
        weekEl.textContent = String(weekCount);
        return;
      }catch(err){
        // DB unavailable â€” compute from local fallback
        try{
          const arr = JSON.parse(localStorage.getItem(siteVisitsLocalKey) || '[]');
          let dayCount = 0, weekCount = 0;
          for(const it of arr){
            if(!it.created_at) continue;
            if(it.created_at >= startOfDay) dayCount++;
            if(it.created_at >= weekAgo) weekCount++;
          }
          todayEl.textContent = String(dayCount || 'â€”');
          weekEl.textContent = String(weekCount || 'â€”');
        }catch(e){
          console.warn('loadVisitCounts fallback failed', e);
          try{ if(todayEl) todayEl.textContent = 'â€”'; if(weekEl) weekEl.textContent = 'â€”'; }catch(_){}
        }
      }
    }

    // Record and load counts on page load
    (async ()=>{ await recordVisitOncePerDay(); await loadVisitCounts(); })();

    // Sync local visits button (uploads site_visits_local to Edge Function)
    const syncBtn = document.getElementById('sync-visits-btn');
    const syncStatusEl = document.getElementById('sync-status');
    if(syncBtn){
      // --- AGGREGATE: Read from all activity tables and merge into a single feed ---
      const activityContainer = document.getElementById('activity-feed');
      let currentItems = [];

      function escapeHtml(s){
        if(!s) return '';
        return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
      }

      function renderActivities(items){
        // Only show activities from the last 7 days
        const now = Date.now();
        const weekAgo = now - 7*24*60*60*1000;
        const list = (items || currentItems || []).filter(it => {
          if (!it.created_at) return false;
          const t = new Date(it.created_at).getTime();
          return t >= weekAgo && t <= now;
        });
        activityContainer.innerHTML = '';
        if(!list.length){
          activityContainer.innerHTML = '<div class="empty">No recent activity in the last 7 days.</div>';
          return;
        }
        for(const it of list){
          const el = document.createElement('div');
          el.className = 'ann';
          el.innerHTML = `<div class="activity-item"><div class="activity-left"><div style="font-weight:700">${escapeHtml(it.action || 'Action')}</div><div style="margin-top:6px">${escapeHtml(it.meta || '')}</div></div><div class="activity-right"><div>${escapeHtml(it.display_name || 'Member')}</div><div class="meta">${it.points ? '+'+escapeHtml(String(it.points))+' pts' : ''}${it.created_at ? ' â€¢ '+escapeHtml(new Date(it.created_at).toLocaleString()) : ''}</div></div></div>`;
          activityContainer.appendChild(el);
        }
      }

      async function loadActivities(){
        activityContainer.innerHTML = '<div class="empty">Loading activity...</div>';
        try{
          // Fetch from all activity tables in parallel
          const [votesRes, suggRes, commentsRes, celebrRes, eventsRes, groupProjRes, writersRes, profilesRes] = await Promise.all([
            supabase.from('agreement_votes').select('voter_id,created_at').order('created_at',{ascending:false}).limit(100),
            supabase.from('suggestions').select('id,author_id,title,created_at').order('created_at',{ascending:false}).limit(100),
            supabase.from('comments').select('author_id,created_at,reply_text').order('created_at',{ascending:false}).limit(100),
            supabase.from('celebrations').select('user_id,created_at').order('created_at',{ascending:false}).limit(100),
            supabase.from('events').select('created_by,created_at').order('created_at',{ascending:false}).limit(100),
            supabase.from('group_projects').select('proposer_id,created_at').order('created_at',{ascending:false}).limit(100),
            supabase.from('writers_wall').select('author_id,author_name,title,created_at').order('created_at',{ascending:false}).limit(100),
            supabase.from('profiles').select('id,full_name')
          ]);

          // Map profiles for display names
          const idToName = {};
          (profilesRes.data || []).forEach(p => { if(p && p.id) idToName[p.id] = p.full_name || p.id; });

          const now = Date.now();
          const weekAgo = now - 7*24*60*60*1000;
          const items = [];

          (votesRes.data || []).forEach(v => {
            if(!v || !v.voter_id) return;
            const t = new Date(v.created_at).getTime();
            if (t < weekAgo || t > now) return;
            items.push({ display_name: idToName[v.voter_id] || 'Member', action: 'Voted', meta: '', points: 1, created_at: v.created_at });
          });

          (suggRes.data || []).forEach(s => {
            if(!s || !s.author_id) return;
            const t = new Date(s.created_at).getTime();
            if (t < weekAgo || t > now) return;
            const meta = s.title ? `Suggestion: ${s.title}` : 'Submitted a suggestion';
            items.push({ display_name: idToName[s.author_id] || 'Member', action: 'Suggested', meta, points: 1, created_at: s.created_at });
          });

          (commentsRes.data || []).forEach(c => {
            if(!c || !c.author_id) return;
            const t = new Date(c.created_at).getTime();
            if (t < weekAgo || t > now) return;
            const meta = c.reply_text ? c.reply_text.slice(0,120) : 'Commented';
            items.push({ display_name: idToName[c.author_id] || 'Member', action: 'Commented', meta, points: 1, created_at: c.created_at });
          });

          (celebrRes.data || []).forEach(c => {
            if(!c || !c.user_id) return;
            const t = new Date(c.created_at).getTime();
            if (t < weekAgo || t > now) return;
            items.push({ display_name: idToName[c.user_id] || 'Member', action: "Posted on Celebration Wall", meta: '', points: 5, created_at: c.created_at });
          });

          (eventsRes.data || []).forEach(e => {
            if(!e || !e.created_by) return;
            const t = new Date(e.created_at).getTime();
            if (t < weekAgo || t > now) return;
            items.push({ display_name: idToName[e.created_by] || 'Member', action: 'Created event', meta: '', points: 5, created_at: e.created_at });
          });

          (groupProjRes.data || []).forEach(gp => {
            if(!gp || !gp.proposer_id) return;
            const t = new Date(gp.created_at).getTime();
            if (t < weekAgo || t > now) return;
            items.push({ display_name: idToName[gp.proposer_id] || 'Member', action: 'Proposed a project', meta: '', points: 5, created_at: gp.created_at });
          });

          (writersRes.data || []).forEach(w => {
            if(!w) return;
            const t = new Date(w.created_at).getTime();
            if (t < weekAgo || t > now) return;
            const display = (w.author_id && idToName[w.author_id]) || w.author_name || (w.author_id || 'Member');
            items.push({ display_name: display, action: 'Wrote for Writers Wall', meta: w.title || '', points: 1, created_at: w.created_at });
          });

          // Sort by created_at desc and limit to 50
          items.sort((a,b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
          const recent = items.slice(0,50);
          currentItems = recent.slice();
          renderActivities(currentItems);
        }catch(e){
          activityContainer.innerHTML = '<div class="empty">Failed to load activity.</div>';
        }
      }

      // Normalize realtime insert for each table
      function normalizeInsert(table, row, idToName) {
        if(!row) return null;
        const now = Date.now();
        const weekAgo = now - 7*24*60*60*1000;
        let t = null;
        switch(table){
          case 'agreement_votes':
            t = row.created_at ? new Date(row.created_at).getTime() : null;
            if (!row.voter_id || t === null || t < weekAgo || t > now) return null;
            return { display_name: idToName[row.voter_id] || row.voter_id, action: 'Voted', meta: '', points: 1, created_at: row.created_at };
          case 'suggestions':
            t = row.created_at ? new Date(row.created_at).getTime() : null;
            if (!row.author_id || t === null || t < weekAgo || t > now) return null;
            return { display_name: idToName[row.author_id] || row.author_id, action: 'Suggested', meta: row.title ? `Suggestion: ${row.title}` : 'Submitted a suggestion', points:1, created_at: row.created_at };
          case 'comments':
            t = row.created_at ? new Date(row.created_at).getTime() : null;
            if (!row.author_id || t === null || t < weekAgo || t > now) return null;
            return { display_name: idToName[row.author_id] || row.author_id, action: 'Commented', meta: row.reply_text ? row.reply_text.slice(0,120) : 'Commented', points:1, created_at: row.created_at };
          case 'celebrations':
            t = row.created_at ? new Date(row.created_at).getTime() : null;
            if (!row.user_id || t === null || t < weekAgo || t > now) return null;
            return { display_name: idToName[row.user_id] || row.user_id, action: 'Posted on Celebration Wall', meta:'', points:5, created_at: row.created_at };
          case 'events':
            t = row.created_at ? new Date(row.created_at).getTime() : null;
            if (!row.created_by || t === null || t < weekAgo || t > now) return null;
            return { display_name: idToName[row.created_by] || row.created_by, action: 'Created event', meta:'', points:5, created_at: row.created_at };
          case 'group_projects':
            t = row.created_at ? new Date(row.created_at).getTime() : null;
            if (!row.proposer_id || t === null || t < weekAgo || t > now) return null;
            return { display_name: idToName[row.proposer_id] || row.proposer_id, action: 'Proposed a project', meta:'', points:5, created_at: row.created_at };
          case 'writers_wall':
            t = row.created_at ? new Date(row.created_at).getTime() : null;
            if (!(row.author_id || row.author_name) || t === null || t < weekAgo || t > now) return null;
            return { display_name: (row.author_id && idToName[row.author_id]) || row.author_name || row.author_id, action: 'Wrote for Writers Wall', meta: row.title || '', points: 1, created_at: row.created_at };
          default: return null;
        }
      }

      // Setup realtime subscriptions for all tables
      async function setupRealtime(){
        // Fetch profiles for display names
        let idToName = {};
        try {
          const profilesRes = await supabase.from('profiles').select('id,full_name');
          (profilesRes.data || []).forEach(p => { if(p && p.id) idToName[p.id] = p.full_name || p.id; });
        } catch(e) {}

        const tables = ['agreement_votes','suggestions','comments','celebrations','events','group_projects','writers_wall'];
        try{
          if(typeof supabase.channel === 'function'){
            const channel = supabase.channel('realtime-activity');
            tables.forEach(table => {
              channel.on('postgres_changes', { event: 'INSERT', schema: 'public', table }, (payload)=>{
                try {
                  const item = normalizeInsert(table, payload.new, idToName);
                  if(!item) return;
                  // Avoid duplicates
                  const key = `${item.display_name}|${item.action}|${item.created_at}`;
                  if(currentItems.some(it => `${it.display_name}|${it.action}|${it.created_at}` === key)) return;
                  currentItems.unshift(item);
                  // Remove activities older than 7 days
                  const now = Date.now();
                  const weekAgo = now - 7*24*60*60*1000;
                  currentItems = currentItems.filter(it => {
                    if (!it.created_at) return false;
                    const t = new Date(it.created_at).getTime();
                    return t >= weekAgo && t <= now;
                  }).slice(0,50);
                  renderActivities(currentItems);
                } catch(e){ console.warn('realtime payload error', e); }
              });
            });
            await channel.subscribe();
            return;
          }
        }catch(e){ console.warn('realtime channel subscribe failed', e); }
        // Fallback: older API
        try{
          tables.forEach(table => {
            supabase.from(table).on('INSERT', payload => {
              try {
                const item = normalizeInsert(table, payload.new, idToName);
                if(!item) return;
                const key = `${item.display_name}|${item.action}|${item.created_at}`;
                if(currentItems.some(it => `${it.display_name}|${it.action}|${it.created_at}` === key)) return;
                currentItems.unshift(item);
                currentItems = currentItems.slice(0,50);
                renderActivities(currentItems);
              } catch(e){}
            }).subscribe();
          });
        }catch(e){ console.warn('realtime fallback failed', e); }
      }

      // Initial load + realtime setup + periodic refresh
      (async ()=>{
        await loadActivities();
        await setupRealtime();
        setInterval(()=>{ loadActivities().catch(()=>{}); }, 60_000);
      })();

      // ...existing code...
    }

    

    // After successful post, refresh activities (keeps activity feed fresh)
    async function refreshActivities(){ await loadActivities(); }

    // Handle realtime inserts (preferred) with a graceful fallback to polling.
    function normalizeInsert(table, row){
      if(!row) return null;
      try{
        switch(table){
          case 'agreement_votes': return row.voter_id ? { display_name: row.voter_id, action: 'Voted', meta: '', points: 1, created_at: row.created_at || new Date().toISOString() } : null;
          case 'suggestions': return row.author_id ? { display_name: row.author_id, action: 'Suggested', meta: row.title ? `Suggestion: ${row.title}` : 'Submitted a suggestion', points:1, created_at: row.created_at || new Date().toISOString() } : null;
          case 'comments': return row.author_id ? { display_name: row.author_id, action: 'Commented', meta: row.reply_text ? row.reply_text.slice(0,120) : 'Commented', points:1, created_at: row.created_at || new Date().toISOString() } : null;
          case 'celebrations': return row.user_id ? { display_name: row.user_id, action: 'Posted on Celebration Wall', meta:'', points:5, created_at: row.created_at || new Date().toISOString() } : null;
          case 'events': return row.created_by ? { display_name: row.created_by, action: 'Created event', meta:'', points:5, created_at: row.created_at || new Date().toISOString() } : null;
          case 'group_projects': return row.proposer_id ? { display_name: row.proposer_id, action: 'Proposed a project', meta:'', points:5, created_at: row.created_at || new Date().toISOString() } : null;
          case 'writers_wall': return (row.author_id || row.author_name) ? { display_name: (row.author_id || row.author_name), action: 'Wrote for Writers Wall', meta: row.title || '', points: 1, created_at: row.created_at || new Date().toISOString() } : null;
          case 'site_visits': return { created_at: row.created_at || new Date().toISOString(), visit:true };
          default: return null;
        }
      }catch(e){ return null; }
    }

    function handleRealtimeInsert(table, row){
      const item = normalizeInsert(table, row);
      if(!item) return;
      // site_visits updates update the banner counts
      if(table === 'site_visits'){
        // fast-path: try to increment banners, otherwise reload counts
        try{
          const todayEl = document.getElementById('visits-today-banner');
          const weekEl = document.getElementById('visits-week-banner');
          if(todayEl && weekEl && item.created_at){
            // simple increment (best-effort); also schedule a full reload shortly
            if(!isNaN(Number(todayEl.textContent))) todayEl.textContent = String(Number(todayEl.textContent) + 1);
            if(!isNaN(Number(weekEl.textContent))) weekEl.textContent = String(Number(weekEl.textContent) + 1);
            setTimeout(loadVisitCounts, 5000);
            return;
          }
        }catch(e){}
        loadVisitCounts().catch(()=>{});
        return;
      }

      // Avoid duplicates: compare created_at + display_name + action
      const key = `${item.display_name}|${item.action}|${item.created_at}`;
      if(currentItems.some(it => `${it.display_name}|${it.action}|${it.created_at}` === key)) return;
      currentItems.unshift(item);
      // keep size bounded
      currentItems = currentItems.slice(0,50);
      renderActivities(currentItems);
    }

    async function setupRealtime(){
      const tables = ['agreement_votes','suggestions','comments','celebrations','events','group_projects','writers_wall','site_visits'];
      try{
        // Preferred API (supabase-js v2+): channel with postgres_changes
        if(typeof supabase.channel === 'function'){
          const channel = supabase.channel('realtime-activity');
          tables.forEach(table => {
            channel.on('postgres_changes', { event: 'INSERT', schema: 'public', table }, (payload)=>{
              try{ handleRealtimeInsert(table, payload.new); }catch(e){ console.warn('realtime payload handling error', e); }
            });
          });
          await channel.subscribe();
          console.log('Realtime channel subscribed for activity tables');
          return;
        }
      }catch(e){ console.warn('channel subscribe failed', e); }

      // Fallback: older API using from().on()
      try{
        tables.forEach(table => {
          try{
            const sub = supabase.from(table).on('INSERT', payload => { try{ handleRealtimeInsert(table, payload.new); }catch(e){}}).subscribe();
            // note: older SDKs return a subscription object; we don't need to store it here for simple pages
          }catch(e){ /* ignore per-table subscription error */ }
        });
        console.log('Realtime fallback subscriptions registered');
      }catch(e){ console.warn('realtime fallback failed', e); }
    }

    // Initial load + periodic refresh and realtime setup
    (async ()=>{ await loadActivities(); await setupRealtime(); setInterval(()=>{ loadActivities().catch(()=>{}); }, 60_000); })();

    </script>
</body>
</html>
