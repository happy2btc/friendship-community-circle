<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Community Agreements</title>
  <script type="module" src="/lib/supabase.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f9f9f9; color: #333; padding: 2rem; }
    h1 { text-align: center; color: #4a7c59; }
    
    /* --- CSS CHANGES ARE HERE --- */

    .agreements-container { 
      /* We no longer need flexbox here. */
    }
    .agreement-card { 
      background: #fff; 
      border: 1px solid #ddd; 
      padding: 1.5rem; 
      border-radius: 8px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
      text-align: center;
      width: 90%;
      max-width: 700px;
      /* This is the key change: auto margins on left/right will center the block */
      margin: 0 auto 2rem auto; 
    }

    /* --- END OF CSS CHANGES --- */

    .agreement-card h2 { color: #6b4f1d; }
    .agreement-text { background-color: #eef6f0; padding: 1rem; border-radius: 6px; margin: 1rem 0; font-style: italic; }
    .vote-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
    .vote-buttons button { border: 2px solid transparent; padding: 10px 20px; cursor: pointer; border-radius: 5px; font-weight: bold; }
    .agree-btn { background-color: #2e8b57; color: white; }
    .disagree-btn { background-color: #c94c4c; color: white; }
    .vote-buttons button.user-voted { border-color: #000; box-shadow: 0 0 5px #000; }
    .vote-count { margin-top: 1rem; font-weight: bold; }
    .menu-button { 
      background-color: #6b4f1d; 
      color: #fff; 
      padding: 12px 20px; 
      border-radius: 6px; 
      text-decoration: none; 
      font-weight: bold; 
      display: block;
      width: fit-content;
      margin: 30px auto 0;
    }
  </style>
</head>
<body>
  <h1>üìú Community Agreements for Voting</h1>
  <div id="agreements-container"></div>
  <a href="menu.html" class="menu-button">üîô Return to Menu</a>

  <script type="module">
    // The JavaScript is unchanged
    import { supabase } from '/lib/supabase.js';

    const agreementsContainer = document.getElementById('agreements-container');

    async function handleVote(agreementId, voteValue) {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return alert('You must be logged in to vote.');

      const { error } = await supabase
        .from('votes')
        .upsert({
          agreement_id: agreementId,
          user_id: user.id,
          vote: voteValue
        }, {
          onConflict: 'agreement_id, user_id'
        });

      if (error) {
        alert(`Error casting vote: ${error.message}`);
      } else {
        location.reload();
      }
    }

    async function loadAgreements() {
      const { data: { user } } = await supabase.auth.getUser();

      const { data: agreements, error } = await supabase
        .from('agreements')
        .select(`
          id,
          agreement_text,
          suggestions (
            title
          )
        `);

      if (error) {
        agreementsContainer.innerHTML = `<p>Error loading agreements: ${error.message}</p>`;
        return;
      }
      if (agreements.length === 0) {
        agreementsContainer.innerHTML = `<p>No agreements have been proposed for voting yet.</p>`;
        return;
      }

      const { data: allVotes } = await supabase.from('votes').select('*');

      for (const agreement of agreements) {
        const card = document.createElement('div');
        card.className = 'agreement-card';

        const votesForThis = allVotes ? allVotes.filter(v => v.agreement_id === agreement.id) : [];
        const agreeVotes = votesForThis.filter(v => v.vote === true).length;
        const disagreeVotes = votesForThis.filter(v => v.vote === false).length;
        const totalVotes = agreeVotes + disagreeVotes;
        
        const userVote = user ? votesForThis.find(v => v.user_id === user.id) : null;

        card.innerHTML = `
          <h2>${agreement.suggestions.title}</h2>
          <p><strong>Proposed Agreement:</strong></p>
          <div class="agreement-text">${agreement.agreement_text}</div>
          <div class="vote-buttons">
            <button class="agree-btn ${userVote && userVote.vote === true ? 'user-voted' : ''}">
              ‚úÖ Agree
            </button>
            <button class="disagree-btn ${userVote && userVote.vote === false ? 'user-voted' : ''}">
              ‚ùå Disagree
            </button>
          </div>
          <div class="vote-count">
            Votes: ${agreeVotes} Agree, ${disagreeVotes} Disagree (Total: ${totalVotes})
          </div>
        `;

        card.querySelector('.agree-btn').onclick = () => handleVote(agreement.id, true);
        card.querySelector('.disagree-btn').onclick = () => handleVote(agreement.id, false);

        agreementsContainer.appendChild(card);
      }
    }

    loadAgreements();
  </script>
</body>
</html>