<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agreements for Voting</title>
  <style>
    body { font-family: Georgia, serif; background-color: #f9f6f1; color: #3b2f2f; padding: 2rem; }
    h1 { text-align: center; color: #6b4f1d; }
    .agreements-container { max-width: 800px; margin: auto; }
    .agreement-card { background: #fff; border: 1px solid #d8bfa3; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .agreement-card p { margin: 0.5rem 0; line-height: 1.5; font-size: 1.1em; }
    .proposer { font-size: 0.95em; color: #666; }
    .menu-button { display: block; width: fit-content; margin: 3rem auto 0 auto; background-color: #6c757d; color: #fff; padding: 10px 18px; border-radius: 6px; text-decoration: none; font-weight: bold; text-align: center; }
  </style>
</head>
<body>
  <h1>üó≥Ô∏è Agreements for Voting</h1>
  <div id="agreements-container" class="agreements-container">
    <p>Loading agreements for voting...</p>
  </div>
  <a href="menu.html" class="menu-button">üîô Return to Menu</a>

  <script type="module">
    import { supabase } from '/lib/supabase.js';

    const container = document.getElementById('agreements-container');
    const ONE_WEEK_MS = 7 * 24 * 60 * 60 * 1000;

    async function getMemberCount() {
      const { count, error } = await supabase
        .from('profiles')
        .select('id', { count: 'exact', head: true });
      return count || 1;
    }

    async function getVoteCount(agreementId) {
      const { count, error } = await supabase
        .from('agreement_votes')
        .select('id', { count: 'exact', head: true })
        .eq('agreement_id', agreementId);
      return count || 0;
    }

    async function loadAgreements() {
      // Fetch agreements with status 'voting'
      const { data: agreements, error } = await supabase
        .from('agreements')
        .select('id, agreement_text, proposer_id, created_at, status')
        .eq('status', 'voting');

      if (error) {
        container.innerHTML = `<p style="color: red;">Error loading agreements: ${error.message}</p>`;
        return;
      }

      if (!agreements || agreements.length === 0) {
        container.innerHTML = '<p>There are no agreements up for voting at this time.</p>';
        return;
      }

      // Get total member count
      const memberCount = await getMemberCount();
      const now = Date.now();

      // For each agreement, get vote count and filter
      const filtered = [];
      for (const agreement of agreements) {
        const createdAt = new Date(agreement.created_at).getTime();
        const age = now - createdAt;
        const voteCount = await getVoteCount(agreement.id);
        const percent = voteCount / memberCount;

        // Hide if older than a week and less than 50% voted
        if (age > ONE_WEEK_MS && percent < 0.5) continue;

        // Attach vote info for display
        agreement.voteCount = voteCount;
        agreement.votePercent = Math.round(percent * 100);
        filtered.push(agreement);
      }

      container.innerHTML = '';

      if (filtered.length === 0) {
        container.innerHTML = '<p>No agreements meet the voting criteria.</p>';
        return;
      }

      for (const agreement of filtered) {
        const card = document.createElement('div');
        card.className = 'agreement-card';

        card.innerHTML = `
          <p><strong>${agreement.agreement_text}</strong></p>
          <p class="proposer">Proposed by: ${agreement.proposer_id || 'A Circle Member'}</p>
          <p>Votes: ${agreement.voteCount} (${agreement.votePercent}% of members)</p>
        `;
        container.appendChild(card);
      }
    }

    loadAgreements();
  </script>
</body>
</html>