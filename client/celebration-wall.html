<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Celebration & Gratitude Wall</title>
  <style>
    body { font-family: sans-serif; background: #f9f9f9; padding: 2rem; }
    .wall-form { margin-bottom: 2rem; background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px #eee; }
    .story-card { background: #fff; border: 1px solid #bdbdbd; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .headline { font-weight: bold; font-size: 1.2em; margin-bottom: 0.5em; }
    .read-more { color: #007bff; text-decoration: underline; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Celebration & Gratitude Wall</h1>
  <a href="menu.html" class="back-menu-btn" style="display:inline-block;margin-bottom:1.5rem;padding:12px 24px;background:#2e8b57;color:#fff;border-radius:8px;text-decoration:none;font-weight:bold;font-size:1.1em;box-shadow:0 2px 6px #eee;transition:background 0.2s;">‚Üê Back to Menu</a>
  <form id="wall-form" class="wall-form">
    <div>
      <label for="headline">Headline</label><br>
      <input type="text" id="headline" maxlength="80" style="width:100%;" required>
    </div>
    <div>
      <label for="story">Your Story</label><br>
  <textarea id="story" rows="4" style="width:100%;" required></textarea>
    </div>
    <button type="submit">Share Your Story</button>
    <span id="wall-status"></span>
  </form>
  <div id="stories"></div>
  <script type="module">
    import { supabase } from '/lib/supabase.js';

    // Submit a new story
    document.getElementById('wall-form').onsubmit = async (e) => {
      e.preventDefault();
      const headline = document.getElementById('headline').value.trim();
      const story = document.getElementById('story').value.trim();
      const status = document.getElementById('wall-status');
      status.textContent = '';
      if (!headline || !story) {
        status.textContent = 'Please fill out both fields.';
        return;
      }
      const { data: userData } = await supabase.auth.getUser();
      const user_id = userData?.user?.id;
      if (!user_id) {
        status.textContent = 'You must be signed in to share a story.';
        return;
      }
      const { error } = await supabase
        .from('celebrations')
        .insert([{ headline, story, user_id }]);
      if (error) {
        status.textContent = 'Error: ' + error.message;
        return;
      }
      status.textContent = 'Story shared!';
      document.getElementById('wall-form').reset();
      loadStories();
    };

    // Load and display stories
    async function loadStories() {
      const { data: userData } = await supabase.auth.getUser();
      const currentUserId = userData?.user?.id;
      const { data: stories } = await supabase
        .from('celebrations')
        .select('id, headline, story, created_at, user_id')
        .eq('visible', true)
        .order('created_at', { ascending: false });
      const storiesDiv = document.getElementById('stories');
      storiesDiv.innerHTML = '';
      stories?.forEach(story => {
        const isOwner = currentUserId === story.user_id;
        const preview = story.story.length > 120 ? story.story.slice(0, 120) + '...' : story.story;
        storiesDiv.innerHTML += `
          <div class="story-card">
            <div class="headline">${story.headline}</div>
            <div>
              <span id="preview-${story.id}">${preview}</span>
              ${story.story.length > 120 ? `<span class="read-more" style="margin-left:8px;" onclick="document.getElementById('preview-${story.id}').style.display='none';document.getElementById('full-${story.id}').style.display='inline';this.style.display='none';">Read More</span>` : ''}
              <span id="full-${story.id}" style="display:none;">${story.story}</span>
            </div>
            <div style="color:#888;font-size:0.9em;">${new Date(story.created_at).toLocaleString()}</div>
            ${isOwner ? `<button class="edit-btn" data-id="${story.id}" data-headline="${story.headline.replace(/"/g, '&quot;')}" data-story="${story.story.replace(/"/g, '&quot;')}">Edit</button>` : ''}
            <div id="edit-form-${story.id}" style="display:none;margin-top:1em;"></div>
          </div>
        `;
      });
    }
    loadStories();

    window.editStory = function(id, headline, story) {
      const formDiv = document.getElementById(`edit-form-${id}`);
      formDiv.innerHTML = `
        <form onsubmit="return false;">
          <input type="text" id="edit-headline-${id}" value="${headline}" style="width:100%;margin-bottom:0.5em;">
          <textarea id="edit-story-${id}" rows="4" style="width:100%;">${story}</textarea>
          <button type="button" class="save-edit-btn" data-id="${id}">Save</button>
          <button type="button" class="cancel-edit-btn" data-id="${id}">Cancel</button>
        </form>
      `;
      formDiv.style.display = 'block';
    };

    window.cancelEdit = function(id) {
      document.getElementById(`edit-form-${id}`).style.display = 'none';
    };

    window.saveEdit = async function(id) {
      const headline = document.getElementById(`edit-headline-${id}`).value.trim();
      const story = document.getElementById(`edit-story-${id}`).value.trim();
      if (!headline || !story) {
        alert('Please fill out both fields.');
        return;
      }
      const { error } = await supabase
        .from('celebrations')
        .update({ headline, story })
        .eq('id', id);
      if (error) {
        alert('Error: ' + error.message);
        return;
      }
      document.getElementById(`edit-form-${id}`).style.display = 'none';
      loadStories();
    };
    // Event delegation for edit, save, and cancel buttons
    document.getElementById('stories').addEventListener('click', function(e) {
      if (e.target.classList.contains('edit-btn')) {
        const id = e.target.getAttribute('data-id');
        const headline = e.target.getAttribute('data-headline');
        const story = e.target.getAttribute('data-story');
        window.editStory(id, headline, story);
      }
      if (e.target.classList.contains('save-edit-btn')) {
        const id = e.target.getAttribute('data-id');
        window.saveEdit(id);
      }
      if (e.target.classList.contains('cancel-edit-btn')) {
        const id = e.target.getAttribute('data-id');
        window.cancelEdit(id);
      }
    });
  </script>
</script>
</body>
</html>