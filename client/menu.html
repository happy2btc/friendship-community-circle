<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Community Menu</title>
    <script type="module" src="/lib/supabase.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #e6f7f2;
            color: #333;
            margin: 0;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            text-align: center;
            color: #2e8b57;
        }
        .menu-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            max-width: 800px;
            margin-top: 30px;
        }
        .menu-button, .logout-button {
            background-color: #6b4f1d;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            text-align: center;
            font-size: 1.1em;
            transition: background-color 0.2s;
        }
        .menu-button:hover, .logout-button:hover {
            background-color: #8c6f4e;
        }
        .logout-button {
            background-color: #a94442;
            cursor: pointer;
            border: none;
            width: 100%;
            margin-top: 20px;
            grid-column: 1 / -1;
        }
        #featured-member {
            max-width: 400px;
            margin: 2rem auto 0 auto;
            padding: 1rem;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px #eee;
            text-align: center;
        }
        #featured-member img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-bottom: 1rem;
            object-fit: cover;
            background: #eee;
        }
        #featured-member h3 {
            margin: 0.5rem 0 0.5rem 0;
        }
        #featured-member .activity-breakdown {
            margin-top: 1rem;
            font-size: 0.95em;
            color: #555;
            text-align: left;
        }
        #featured-member .personal-story {
            font-style: italic;
            color: #4a7c59;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <h1>🌸 Welcome to the Community</h1>

        <div style="display: flex; gap: 2rem; flex-wrap: wrap; margin-bottom: 2rem;">
            <div style="flex: 1; min-width: 300px; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #eee; padding: 1rem;">
                <h2>🌟 Most Active Member</h2>
                <div id="most-active-member"></div>
            </div>
            <div style="flex: 1; min-width: 300px; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #eee; padding: 1rem;">
                <h2>🆕 Newest Member</h2>
                <div id="newest-member"></div>
            </div>
        </div>

    <div class="menu-container">
    <a href="welcome.html" class="menu-button" style="background:#ffe082;color:#6b4f1d;font-weight:bold;">👋 In Case You Missed It</a>
    <a href="what's-new.html" class="menu-button">🆕 What's New</a>
    <a href="profile.html" class="menu-button">👤 My Profile</a>
    <a href="view-profiles.html" class="menu-button">👥 View All Profiles</a>
    <a href="new-members.html" class="menu-button">🆕 New Members</a>
    <a href="activities.html" class="menu-button">🏆 Member Activities</a>
    <a href="exchange.html" class="menu-button">🎁 Wants and Offers</a>
    <a href="view-exchanges.html" class="menu-button">🎁 Browse All Offerings</a>
    <a href="contribute.html" class="menu-button">✍️ Submit Your Project</a>
    <a href="view-proj-strug.html" class="menu-button">📜 View Personal Projects - Struggles</a>
    <a href="suggest.html" class="menu-button">💡 Make a Suggestion</a>
    <a href="discussions.html" class="menu-button">�️ View Current Discussions</a>
    <a href="agreements.html" class="menu-button">⚖️ Proposed Agreements & Voting</a>
    <a href="completed-agreements.html" class="menu-button">📜 Completed Agreements</a>
    <a href="create-circle.html" class="menu-button">➕ Create a New Circle</a>
    <a href="circle-list.html" class="menu-button">🌐 Manage Circles</a>
    <a href="event-details.html" class="menu-button">� Event Details & Attendance</a>
    <a href="group-projects.html" class="menu-button" id="group-projects-btn">🛠️ Group Projects</a>
    <a href="skill-shares.html" class="menu-button" id="skill-shares-btn">🎬 Skill Shares</a>
    <a href="celebration-wall.html" class="menu-button">🎉 Celebration Wall</a>
    <a href="community-chat.html" class="menu-button">💬 Community Chat</a>
    <a href="agreements-voting.html" class="menu-button">🗳️ Vote on Agreements</a>
    <button id="logout-button" class="logout-button">Log Out</button>
    <a href="events-calendar.html" class="menu-button">📅 Events Calendar</a>
    <div style="display:flex;gap:20px;margin-top:24px;max-width:800px;width:100%;">
    <a href="circle.html?id=1d9493e2-b9b0-48f4-b12f-6411939809e9" class="menu-button" style="flex:1;text-align:center;">🧙 Coven Community Network</a>
    <a href="http://localhost:5174/friendship-community-circle/circle.html?id=5516d022-5354-409d-9fcc-cc151df649b3" class="menu-button" style="flex:1;text-align:center;">💸 Universal Basic Income Circle</a>
    </div>
</div>
    </div>

    <script type="module">
// Optional: If you want to filter projects by circle, you can add a dropdown and redirect logic here.
import { supabase } from '/lib/supabase.js';

// Most Active Member
async function showMostActiveMember() {
    // Fetch all activities
    const [votesRes, suggestionsRes, commentsRes, offeringsRes, contributionsRes, profilesFullRes, circlesRes, membersRes, celebrationsRes, eventsRes] = await Promise.all([
        supabase.from('agreement_votes').select('voter_id, created_at'),
        supabase.from('suggestions').select('author_id, created_at'),
        supabase.from('comments').select('author_id, created_at'),
        supabase.from('member_offerings').select('user_id, want, give, passion'),
        supabase.from('contributions').select('user_id, project, challenge, help, collab, skills, urgency, contact'),
        supabase.from('profiles').select('id, full_name, avatar_url, personal_story, bio, youtube, twitter, substack, facebook, instagram, linkedin, website'),
        supabase.from('circles').select('id, name, created_by'),
        supabase.from('circle_members').select('added_by'),
        supabase.from('celebrations').select('user_id'),
        supabase.from('events').select('id, created_by'),
    ]);
    // eventsRes is already available from destructuring above
        let attendanceRes = await supabase.from('event_attendance').select('event_id, user_id');
    const builderId = "81c50097-74f3-4c7a-b00c-598995b8d1cb";
    const breakdown = {};
    function initBreakdown(id) {
        if (!breakdown[id]) {
            breakdown[id] = {
                votes: 0,
                suggestions: 0,
                comments: 0,
                wants: 0,
                offers: 0,
                passion: 0,
                projects: 0,
                profile: 0,
                circles_created: 0,
                members_added: 0,
                celebrations_posted: 0,
                events_created: 0,
                events_attended: 0
            };
        }
    }
    // Votes
    votesRes.data?.forEach(v => {
        if (v.voter_id !== builderId) {
            initBreakdown(v.voter_id);
            breakdown[v.voter_id].votes += 1;
        }
    });
    // Suggestions
    suggestionsRes.data?.forEach(s => {
        if (s.author_id !== builderId) {
            initBreakdown(s.author_id);
            breakdown[s.author_id].suggestions += 1;
        }
    });
    // Comments
    commentsRes.data?.forEach(c => {
        if (c.author_id !== builderId) {
            initBreakdown(c.author_id);
            breakdown[c.author_id].comments += 1;
        }
    });
    // Wants, Offers, Passion
    offeringsRes.data?.forEach(o => {
        if (o.user_id !== builderId) {
            initBreakdown(o.user_id);
            if (o.want && o.want.trim() !== "") breakdown[o.user_id].wants += 1;
            if (o.give && o.give.trim() !== "") breakdown[o.user_id].offers += 1;
            if (o.passion && o.passion.trim() !== "") breakdown[o.user_id].passion += 1;
        }
    });
    // Projects & Struggles
    const contribByUser = {};
    contributionsRes.data?.forEach(con => {
        if (con.user_id !== builderId) {
            if (!contribByUser[con.user_id]) contribByUser[con.user_id] = [];
            contribByUser[con.user_id].push(con);
        }
    });
    Object.entries(contribByUser).forEach(([userId, contribs]) => {
        initBreakdown(userId);
        let fieldsFilled = 0;
        contribs.forEach(con => {
            ['project','challenge','help','collab','skills','urgency','contact'].forEach(field => {
                if (con[field] && con[field].trim() !== '') {
                    fieldsFilled += 1;
                }
            });
        });
        breakdown[userId].projects += fieldsFilled;
    });
    // Profile completion
    profilesFullRes.data?.forEach(p => {
        if (p.id !== builderId) {
            let filled = 0;
            if (p.full_name && p.full_name.trim() !== "") filled++;
            if (p.bio && p.bio.trim() !== "") filled++;
            if (p.avatar_url && p.avatar_url.trim() !== "") filled++;
            if (p.youtube || p.twitter || p.substack || p.facebook || p.instagram || p.linkedin || p.website) filled++;
            if (filled >= 2) {
                initBreakdown(p.id);
                breakdown[p.id].profile = 1;
            }
        }
    });
    // Circles created: credit by created_by (profile id)
    if (Array.isArray(circlesRes.data)) {
        circlesRes.data.forEach(c => {
            const creatorId = c && c.created_by;
            if (creatorId && typeof creatorId === 'string' && creatorId.trim() !== '' && creatorId !== builderId) {
                initBreakdown(creatorId);
                breakdown[creatorId].circles_created += 1;
            }
        });
    } else if (circlesRes.data && typeof circlesRes.data === 'object' && circlesRes.data.created_by) {
        const creatorId = circlesRes.data.created_by;
        if (creatorId && typeof creatorId === 'string' && creatorId.trim() !== '' && creatorId !== builderId) {
            initBreakdown(creatorId);
            breakdown[creatorId].circles_created += 1;
        }
    }
    // Members added
    membersRes.data?.forEach(m => {
        const userId = m.added_by || m.user_id;
        if (userId && typeof userId === 'string' && userId.trim() !== '' && userId !== builderId) {
            initBreakdown(userId);
            breakdown[userId].members_added += 1;
        }
    });
    // Celebration wall posts
    celebrationsRes.data?.forEach(c => {
        const userId = c.user_id || c.creator_id;
        if (userId && typeof userId === 'string' && userId.trim() !== '' && userId !== builderId) {
            initBreakdown(userId);
            breakdown[userId].celebrations_posted += 1;
        }
    });
    // Events created
    eventsRes.data?.forEach(e => {
        const creatorId = e.created_by;
        if (creatorId && typeof creatorId === 'string' && creatorId.trim() !== '' && creatorId !== builderId) {
            initBreakdown(creatorId);
            breakdown[creatorId].events_created += 1;
        }
    });
    // Events attended
    attendanceRes.data?.forEach(a => {
        const userId = a.user_id;
        if (userId && typeof userId === 'string' && userId.trim() !== '' && userId !== builderId) {
            initBreakdown(userId);
            breakdown[userId].events_attended += 1;
        }
    });
    // Get profiles for display
    const idToProfile = {};
    if (Array.isArray(profilesFullRes.data)) {
        profilesFullRes.data.forEach(p => {
            if (p && typeof p.id === 'string' && p.id.trim() !== '') {
                idToProfile[p.id] = p;
            }
        });
    }
    // Build member activity list
    const userIds = Object.keys(breakdown).filter(id => id && id !== 'null');
    const container = document.getElementById('most-active-member');
    container.innerHTML = '';
    if (userIds.length === 0) {
        container.innerHTML = "<em>No other member has been active.</em>";
        return;
    }
    // Optionally show debug info if needed:
    // const debugBox = document.createElement('pre');
    // debugBox.style.background = '#f8f8f8';
    // debugBox.style.fontSize = '0.8em';
    // debugBox.style.maxHeight = '200px';
    // debugBox.style.overflow = 'auto';
    // debugBox.style.margin = '1em 0';
    // debugBox.textContent = 'DEBUG: userIds=' + JSON.stringify(userIds, null, 2) + '\n' +
    //     'breakdown=' + JSON.stringify(breakdown, null, 2);
    // container.appendChild(debugBox);
    // Calculate total for each user
    const members = userIds.map(id => {
        const b = breakdown[id];
        const profile = idToProfile[id] || { full_name: id, avatar_url: '', personal_story: '' };
        const total =
            (b.votes || 0) * 1 +
            (b.suggestions || 0) * 1 +
            (b.comments || 0) * 1 +
            (b.wants || 0) * 1 +
            (b.offers || 0) * 1 +
            (b.passion || 0) * 1 +
            (b.projects || 0) * 1 +
            (b.projects_proposed || 0) * 5 +
            (b.events_created || 0) * 5 +
            (b.events_attended || 0) * 5 +
            (b.profile || 0) * 5 +
            (b.circles_created || 0) * 10 +
            (b.members_added || 0) * 2 +
            (b.celebrations_posted || 0) * 5;
        return {
            id,
            profile,
            total,
            breakdown: b
        };
    });
    members.sort((a, b) => b.total - a.total);
    const m = members[0];
    container.innerHTML = `
        <img src="${m.profile.avatar_url && m.profile.avatar_url.trim() !== '' ? m.profile.avatar_url : 'default-avatar.png'}" alt="Profile Picture" style="width:64px;height:64px;border-radius:50%;object-fit:cover;margin-bottom:1em;">
        <h3>${m.profile.full_name}</h3>
        <div class="activity-breakdown" >
            <strong>All-Time Activities:</strong><br>
            Votes: ${m.breakdown.votes || 0}<br>
            Suggestions: ${m.breakdown.suggestions || 0}<br>
            Comments: ${m.breakdown.comments || 0}<br>
            Wants: ${m.breakdown.wants || 0}<br>
            Offers: ${m.breakdown.offers || 0}<br>
            Passion: ${m.breakdown.passion || 0}<br>
            Projects & Struggles: ${m.breakdown.projects || 0}<br>
            Events Created: ${m.breakdown.events_created || 0}<br>
            Events Attended: ${m.breakdown.events_attended || 0}<br>
            Profile Completed: ${m.breakdown.profile ? "✔️" : "—"}<br>
            Circles Created: ${m.breakdown.circles_created || 0}<br>
            Members Added: ${m.breakdown.members_added || 0}<br>
            Celebration Wall Posts: ${m.breakdown.celebrations_posted || 0}<br>
            <strong>Total:</strong> ${m.total}
        </div>
        <div class="personal-story">${m.profile.personal_story || ''}</div>
    `;
}

// Newest Member
async function showNewestMember() {
    const cutoffDate = new Date('2025-09-19T00:00:00Z');
    const { data: profiles } = await supabase
        .from('profiles')
        .select('id, full_name, avatar_url, affirmation_text, affirmation_date')
        .order('affirmation_date', { ascending: false });
    const recentProfiles = (profiles || [])
        .filter(p => p.affirmation_date && new Date(p.affirmation_date) >= cutoffDate)
        .sort((a, b) => new Date(b.affirmation_date) - new Date(a.affirmation_date))
        .slice(0, 3); // Show up to 3 recent members

    const newestMemberDiv = document.getElementById('newest-member');
    newestMemberDiv.innerHTML = '';
    if (recentProfiles.length === 0) {
        newestMemberDiv.innerHTML = "<em>No new member since 9/19/2025.</em>";
        return;
    }
    for (const profile of recentProfiles) {
        // Get circles for this member (membership)
        const { data: memberCircles } = await supabase
            .from('circle_members')
            .select('circle_id')
            .eq('user_id', profile.id);
        // Get circles created by this member (credit)
        const { data: createdCircles } = await supabase
            .from('circles')
            .select('id, name')
            .eq('created_by', profile.id);
        let circleNames = [];
        // Always add circles created by member, marked as creator
        let createdNames = [];
        if (createdCircles && createdCircles.length > 0) {
            for (const c of createdCircles) {
                createdNames.push(c.name);
                circleNames.push(c.name + ' (creator)');
            }
        }
        // Add circles where member is a member, but not already credited as creator
        if (memberCircles && memberCircles.length > 0) {
            const circleIds = memberCircles.map(c => c.circle_id);
            const { data: circleData } = await supabase
                .from('circles')
                .select('id, name')
                .in('id', circleIds);
            if (circleData) {
                for (const c of circleData) {
                    // Only add if not already credited as creator (by name)
                    if (!createdNames.includes(c.name) && !circleNames.includes(c.name)) {
                        circleNames.push(c.name);
                    }
                }
            }
        }

        const memberCard = document.createElement('div');
        memberCard.className = 'member-card';
        memberCard.style.marginBottom = '1em';
        memberCard.innerHTML = `
            <strong>${profile.full_name || 'Unnamed Member'}</strong>
            <div style="color:#888;">Joined: ${profile.affirmation_date ? new Date(profile.affirmation_date).toLocaleDateString() : '—'}</div>
            <div style="color:#555;">Circles: ${circleNames.length ? circleNames.join(', ') : 'None'}</div>
        `;
        newestMemberDiv.appendChild(memberCard);
    }
}

const logoutButton = document.getElementById('logout-button');
logoutButton.addEventListener('click', async () => {
    const { error } = await supabase.auth.signOut();
    if (error) {
        console.error('Error logging out:', error);
    } else {
    window.location.href = 'index.html';
    }
});

// Initial loads
showMostActiveMember();
showNewestMember();

</script>
</body>
</html>