<!DOCTYPE html>
<html> 
<head>
  <meta charset="UTF-8">
  <title>Affirm Your Values ‚Äì New Paradigm Friendship Community</title>
  <script type="module" src="/lib/supabase.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #e6f7f2;
      color: #333;
      margin: 40px;
      font-size: 1.2em;
    }
    h1, h2, p {
      text-align: center;
    }
    .affirm-box {
      background-color: #fff;
      border: 1px solid #a3d9c5;
      border-radius: 12px;
      padding: 30px;
      margin: 40px auto;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      width: 80%;
      max-width: 700px;
    }
    .affirm-box label {
      display: block;
      margin: 10px 0;
    }
    button {
      background-color: #2e8b57;
      color: #fff;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      display: block;
      margin: 20px auto;
    }
    .next-buttons {
      text-align: center;
      margin-top: 30px;
    }
    .next-buttons a {
      background-color: #6b4f1d;
      color: #fff;
      padding: 12px 20px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      margin: 10px;
      display: inline-block;
    }
    #affirmStatus {
      text-align: center;
      font-style: italic;
      margin-top: 10px;
    }
  </style>
</head>
<body> 
    <h1>üå± Affirm Your Values</h1>
  <p id="introText">Welcome. The final step is to affirm the values of our community.</p>

  <div class="affirm-box" id="affirmBox">
    <h2>üß≠ What Are Your Values?</h2>
    <form id="affirmForm">
      <label><input type="checkbox" name="value" value="authenticity"> I value authenticity in how I show up.</label>
      <label><input type="checkbox" name="value" value="collaboration"> I value collaboration over competition.</label>
      <label><input type="checkbox" name="value" value="belonging"> I value creating belonging for others.</label>
      <label><input type="checkbox" name="value" value="transparency"> I value transparent decision-making.</label>
      <label><input type="checkbox" name="value" value="accountability"> I value accountability as a form of care.</label>
      <label><input type="checkbox" name="value" value="ritual"> I value ritual and emotional safety in how we gather.</label>
    </form>
    <button id="affirmButton">‚úÖ Affirm & Continue</button>
    <p id="affirmStatus"></p>
  </div>

  <div class="next-buttons" id="nextButtons" style="display:none;">
    <a href="suggest.html" class="menu-button">üí° Make a Suggestion</a>
    <a href="discussions.html" class="menu-button">üó£Ô∏è View Current Discussions</a>
    <a href="agreements.html" class="menu-button">üìú View Agreements & Voting</a>
    <a href="mutual-aid.html" class="menu-button">üåø Tend to the Mutual Aid Scrolls</a>
    <a href="contribute.html" class="menu-button">‚úçÔ∏è Fill Out the Contribution Form</a>
    <a href="exchange.html" class="menu-button">üéÅ Enter the Gift Circle of Exchange</a>
  </div>

  <script type="module">
    import { supabase } from '/lib/supabase.js';

    const affirmButton = document.getElementById('affirmButton');
    const affirmStatus = document.getElementById('affirmStatus');
    const introText = document.getElementById('introText');
    const affirmBox = document.getElementById('affirmBox');
    const nextButtons = document.getElementById('nextButtons');

    // Check if user is logged in and has already affirmed
    (async function checkAffirmation() {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('affirmation_text')
                .eq('id', user.id)
                .single();
            
            if (profile && profile.affirmation_text) {
                affirmBox.style.display = "none";
                introText.innerText = "üå∏ You‚Äôve already affirmed your values. Choose how to engage:";
                nextButtons.style.display = "block";
            }
        }
    })();

    affirmButton.addEventListener('click', async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        affirmStatus.innerText = "Could not find user. Please log in again.";
        affirmStatus.style.color = 'red';
        return;
      }

      const checkboxes = document.querySelectorAll('input[name="value"]:checked');
      if (checkboxes.length === 0) {
        affirmStatus.innerText = "üå∏ Please affirm at least one value.";
        return;
      }

      const affirmedValues = Array.from(checkboxes).map(cb => cb.value);
      const affirmationText = `Affirmed: ${affirmedValues.join(", ")}`;

      const { error } = await supabase
        .from('profiles')
        .update({ affirmation_text: affirmationText })
        .eq('id', user.id);

      if (error) {
        affirmStatus.innerText = `Error saving affirmation: ${error.message}`;
        affirmStatus.style.color = 'red';
      } else {
        affirmStatus.innerText = `‚úÖ You‚Äôve affirmed: ${affirmedValues.join(", ")}. Welcome to the circle.`;
        affirmBox.style.display = "none";
        introText.innerText = "üå∏ You‚Äôve affirmed your values. Choose how to engage:";
        nextButtons.style.display = "block";
      }
    });
  </script>
</body>