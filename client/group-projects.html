<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Group Projects</title>
  <script type="module" src="/lib/supabase.js"></script>
  <style>
    .menu-button {
      background-color: #6b4f1d;
      color: #fff;
      padding: 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      text-align: center;
      font-size: 1.1em;
      transition: background-color 0.2s;
      display: inline-block;
      margin-bottom: 2rem;
    }
    .menu-button:hover {
      background-color: #8c6f4e;
    }
    body {
      font-family: sans-serif;
      background: #f7fafc;
      color: #333;
      margin: 0;
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

    h1 {
      color: #2e8b57;
      margin-bottom: 2rem;
    }
    .projects-table {
      width: 100%;
      max-width: 900px;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 8px #eee;
      border-radius: 10px;
      overflow: hidden;
    }
    .projects-table th, .projects-table td {
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    .projects-table th {
      background: #e6f7f2;
      color: #2e8b57;
    }
    .projects-table tr:last-child td {
      border-bottom: none;
    }
    .status {
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 6px;
      text-transform: capitalize;
    }
    .status.pending { background: #fff3cd; color: #856404; }
    .status.started { background: #d1ecf1; color: #0c5460; }
    .status[status="in process"] { background: #cce5ff; color: #004085; }
    .status.completed { background: #d4edda; color: #155724; }
    .add-project-btn {
      margin: 2rem 0 1rem 0;
      padding: 10px 24px;
      background: #2e8b57;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
    }
    .add-project-btn:hover {
      background: #4cae4c;
    }
    .project-form {
      margin-bottom: 2rem;
      background: #fff;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 2px 8px #eee;
      max-width: 600px;
      width: 100%;
      display: none;
    }
    .project-form label {
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      color: #2e8b57;
    }
    .project-form input, .project-form textarea, .project-form select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 1rem;
      font-size: 1em;
    }
    .project-form button {
      background: #2e8b57;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 24px;
      font-size: 1em;
      cursor: pointer;
    }
    .project-form button:hover {
      background: #4cae4c;
    }
    .error {
      color: #a94442;
      margin-bottom: 1rem;
    }
    .success {
      color: #2e8b57;
      margin-bottom: 1rem;
    }

    /* Mobile Card Layout */
    .projects-cards {
      display: none;
      width: 100%;
      max-width: 600px;
    }

    .project-card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px #eee;
      margin-bottom: 1rem;
      padding: 1rem;
      border-left: 4px solid #2e8b57;
    }

    .project-card h3 {
      color: #2e8b57;
      margin: 0 0 0.5rem 0;
      font-size: 1.1em;
    }

    .project-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      font-size: 0.9em;
      color: #666;
    }

    .project-meta span {
      background: #f0f8f0;
      padding: 2px 8px;
      border-radius: 12px;
    }

    .project-description {
      margin-bottom: 1rem;
      line-height: 1.4;
    }

    .project-actions {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .project-actions button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 0.9em;
      cursor: pointer;
      flex: 1;
      min-width: 80px;
    }

    .join-btn {
      background: #1976d2;
      color: #fff;
    }

    .joined-btn {
      background: #4caf50 !important;
      color: #fff !important;
      cursor: default !important;
    }

    .joined-btn:hover {
      background: #4caf50 !important;
    }

    .view-participants-btn {
      background: #6b4f1d;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 0.9em;
    }

    .view-participants-btn:hover {
      background: #8c6f4e;
    }

    /* Modal Styles */
    #update-modal,
    #participants-modal {
      font-family: sans-serif;
    }

    #update-modal .modal-content,
    #participants-modal .modal-content {
      background: #fff;
      padding: 2rem;
      border-radius: 10px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    #update-modal form input,
    #update-modal form textarea,
    #update-modal form select {
      font-size: 16px; /* Prevents zoom on iOS */
    }

    .update-btn {
      background: #ffc107;
      color: #333;
    }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      body {
        padding: 20px 10px;
        font-size: 14px;
      }

      h1 {
        font-size: 1.5em;
        margin-bottom: 1rem;
      }

      .menu-button {
        padding: 12px 16px;
        font-size: 1em;
        margin-bottom: 1rem;
        width: 100%;
        max-width: 300px;
      }

      /* Hide table, show cards on mobile */
      .projects-table {
        display: none;
      }

      .projects-cards {
        display: block;
      }

      .project-form {
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .project-form input,
      .project-form textarea,
      .project-form select {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 10px;
        margin-bottom: 0.75rem;
        width: 100%;
      }

      .project-form button {
        padding: 12px 20px;
        font-size: 1em;
        width: 100%;
        margin-bottom: 0.5rem;
      }

      .project-form button[type="button"] {
        width: auto;
        margin-left: 0;
      }

      .add-project-btn {
        width: 100%;
        padding: 12px;
        font-size: 1em;
      }

      .comments-section {
        padding: 8px 10px;
        margin-top: 12px;
        background: #f4f8fb;
        border-radius: 6px;
      }

      .comment-form {
        flex-direction: column;
        gap: 8px;
        margin-top: 8px;
      }

      .comment-input,
      .display-name-input {
        width: 100%;
        padding: 8px;
        font-size: 16px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }

      .comment-form button {
        padding: 8px 16px;
        background: #2e8b57;
        color: #fff;
        border: none;
        border-radius: 4px;
        width: 100%;
      }

      .project-thumbnails {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 0.5rem;
      }

      .project-thumbnails img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
        box-shadow: 0 1px 4px #ccc;
        cursor: pointer;
      }

      /* Gallery modal mobile adjustments */
      #gallery-modal {
        padding: 20px;
        align-items: flex-start;
        padding-top: 60px;
      }

      #gallery-content {
        max-width: 95vw;
        max-height: 80vh;
      }

      #gallery-prev,
      #gallery-next {
        width: 40px;
        height: 40px;
        font-size: 1.2em;
        top: 40%;
      }

      #gallery-prev {
        left: 10px;
      }

      #gallery-next {
        right: 10px;
      }

      #gallery-images img {
        max-width: 90vw;
        max-height: 70vh;
        border-radius: 10px;
        box-shadow: 0 2px 12px #222;
      }

      /* Mobile modal styles */
      #update-modal,
      #participants-modal {
        padding: 10px;
        align-items: flex-start;
        padding-top: 20px;
      }

      #update-modal .modal-content,
      #participants-modal .modal-content {
        padding: 1rem;
        width: 95%;
        max-height: 85vh;
      }

      #update-modal form input,
      #update-modal form textarea,
      #update-modal form select {
        padding: 10px;
        margin-bottom: 0.5rem;
      }

      #update-modal form button {
        padding: 12px 16px;
        font-size: 1em;
      }

      /* Filter dropdown mobile */
      #circle-filter {
        width: 100%;
        max-width: 300px;
        margin-left: 0;
        margin-top: 0.5rem;
        padding: 8px;
        font-size: 16px;
      }

      label[for="circle-filter"] {
        display: block;
        margin-bottom: 0.5rem;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 15px 5px;
      }

      h1 {
        font-size: 1.3em;
      }

      /* Mobile info section */
      body > div:first-of-type {
        padding: 0.75rem;
        margin-bottom: 1rem;
      }

      body > div:first-of-type h3 {
        font-size: 1em;
      }

      body > div:first-of-type ul {
        padding-left: 1rem;
      }

      .project-card {
        padding: 0.75rem;
        margin-bottom: 0.75rem;
      }

      .menu-button {
        padding: 10px 14px;
        font-size: 0.9em;
      }

      .project-card {
        padding: 0.75rem;
        margin-bottom: 0.75rem;
      }

      .project-form {
        padding: 0.75rem;
      }

      .project-actions button {
        padding: 6px 12px;
        font-size: 0.8em;
      }

      .view-participants-btn {
        padding: 6px 12px;
        font-size: 0.8em;
      }
    }
  </style>
</head>
<body>
  <h1>üåê Group Projects</h1>
  <div id="auth-status" style="background:#fff3cd;border:1px solid #ffeeba;border-radius:5px;padding:8px 12px;margin-bottom:1rem;font-size:0.9em;color:#856404;display:none;">
    ‚ö†Ô∏è You are not logged in. Please log in to join projects and view members.
  </div>
  <div style="background:#f0f8f0;border:2px solid #2e8b57;border-radius:10px;padding:1rem;margin-bottom:1.5rem;">
    <h3 style="color:#2e8b57;margin-top:0;">ü§ù Join Community Projects</h3>
    <p style="margin-bottom:0.5rem;"><strong>What you get when you join:</strong></p>
    <ul style="margin:0;padding-left:1.5rem;">
      <li>üìù Participate in project discussions and planning</li>
      <li>üë• Connect with like-minded community members</li>
      <li>üéØ Contribute to meaningful community initiatives</li>
      <li>üìä Track project progress and milestones</li>
      <li>üèÜ Help create positive impact in your community</li>
    </ul>
    <p style="margin-top:0.5rem;font-size:0.9em;color:#666;"><em>Use the "üë• View Members" button to see who's already participating!</em></p>
  </div>
  <a href="main-menu.html" class="menu-button" id="back-to-menu-btn" style="margin-bottom:2rem;">üîô Return to Menu</a>
  <div style="margin-bottom:1.5rem;">
    <label for="circle-filter" style="font-weight:bold;color:#2e8b57;">Filter by Circle:</label>
    <select id="circle-filter" style="margin-left:1rem;padding:6px 12px;border-radius:6px;border:1px solid #ccc;"></select>
  </div> 
  <button class="add-project-btn" id="show-form-btn">‚ûï Add New Project</button>
  <form class="project-form" id="project-form">
    <div class="error" id="form-error"></div>
    <div class="success" id="form-success"></div>
  <label for="circle">Circle</label>
  <select id="circle" name="circle" required></select>
  <label for="proposer-name">Proposer Name</label>
  <select id="proposer-name" name="proposer-name" required></select>
    <label for="name">Project Name</label>
    <input type="text" id="name" name="name" required />
    <label for="description">Short Description</label>
    <textarea id="description" name="description" rows="3" required></textarea>
    <label for="num-participants">Number of Participants</label>
    <input type="number" id="num-participants" name="num-participants" min="1" value="1" required />
    <label for="status">Status</label>
    <select id="status" name="status" required>
      <option value="pending">Pending</option>
      <option value="started">Started</option>
      <option value="in process">In Process</option>
      <option value="completed">Completed</option>
    </select>
    <label for="project-images">Project Images</label>
    <input type="file" id="project-images" name="project-images" accept="image/*" multiple />
    <button type="submit">Submit Project</button>
    <button type="button" id="cancel-form-btn" style="margin-left:1rem;background:#ccc;color:#333;">Cancel</button>
  </form>
  <table class="projects-table" id="projects-table">
    <thead>
      <tr>
        <th>Circle</th>
        <th>Project Name</th>
        <th>Description</th>
        <th>Proposer</th>
        <th>Date Entered</th>
        <th>Participants</th>
        <th>Status</th>
        <th>Gallery</th>
      </tr>
    </thead>
    <tbody id="projects-tbody">
      <!-- Projects will be loaded here -->
    </tbody>
  </table>

  <!-- Mobile Cards Container -->
  <div class="projects-cards" id="projects-cards">
    <!-- Project cards will be loaded here -->
  </div>
  <script type="module">
    import { supabase } from '/lib/supabase.js';
  const showFormBtn = document.getElementById('show-form-btn');
  const projectForm = document.getElementById('project-form');
  const cancelFormBtn = document.getElementById('cancel-form-btn');
  const formError = document.getElementById('form-error');
  const formSuccess = document.getElementById('form-success');
  const circleSelect = document.getElementById('circle');
  const circleFilter = document.getElementById('circle-filter');
  const projectsTbody = document.getElementById('projects-tbody');
  let circles = [];
  let profiles = {};
  let selectedCircleId = '';

    async function loadCircles() {
      const { data } = await supabase.from('circles').select('id, name');
  circles = data || [];
  // For project form
  // Dropdown: show names, value is UUID
  circleSelect.innerHTML = circles.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  // For filter dropdown
  let filterOptions = '<option value="">All Circles</option>';
  filterOptions += circles.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
  circleFilter.innerHTML = filterOptions;
    }

    async function loadProfiles() {
      const { data } = await supabase.from('profiles').select('id, full_name');
      profiles = {};
  (data || []).forEach(p => { profiles[p.id] = p.full_name; });
  // Populate proposer-name dropdown
  const proposerSelect = document.getElementById('proposer-name');
  proposerSelect.innerHTML = (data || []).map(p => `<option value="${p.id}">${p.full_name}</option>`).join('');
    }

    async function loadProjects() {
      let query = supabase.from('group_projects').select('*').order('entered_at', { ascending: false });
      if (selectedCircleId) {
        query = query.eq('circle_id', selectedCircleId);
      }
      const { data: projects } = await query;
      projectsTbody.innerHTML = '';
      const projectsCards = document.getElementById('projects-cards');
      projectsCards.innerHTML = '';

      // Get current user to check participation status
      const { data: userData } = await supabase.auth.getUser();
      const currentUserId = userData?.user?.id;

      for (const project of projects || []) {
        const circleName = circles.find(c => c.id === project.circle_id)?.name || 'Unknown';
        const proposerName = profiles[project.proposer_id] || 'Unknown';
        const date = project.entered_at ? new Date(project.entered_at).toLocaleDateString() : '';

        // Check if current user is a participant
        let isParticipant = false;
        if (currentUserId) {
          console.log('Checking participation for user:', currentUserId, 'project:', project.id); // Debug log
          const { data: participation, error: participationError } = await supabase
            .from('group_project_participants')
            .select('*')
            .eq('project_id', project.id)
            .eq('user_id', currentUserId)
            .single();

          console.log('Participation check result:', participation); // Debug log
          console.log('Participation check error:', participationError); // Debug log
          isParticipant = !!participation;
        }

        let galleryHtml = '';
        // Fetch all images from the bucket folder for this project (by project.id)
        let imageUrls = [];
        try {
          const { data: files, error: listError } = await supabase.storage.from('project-images').list(`${project.id}/`);
          if (!listError && files && files.length > 0) {
            imageUrls = files.filter(f => f.name.match(/\.(jpg|jpeg|png|gif|webp)$/i)).map(f => {
              const { data: publicUrlData } = supabase.storage.from('project-images').getPublicUrl(`${project.id}/${f.name}`);
              return publicUrlData.publicUrl;
            });
          }
        } catch (e) { /* ignore */ }
        if (imageUrls.length > 0) {
          galleryHtml = `
            <div class="project-thumbnails" style="display:flex;gap:6px;flex-wrap:wrap;cursor:pointer;" data-images='${JSON.stringify(imageUrls)}'>
              ${imageUrls.map(url => `<img src="${url}" style="width:60px;height:60px;object-fit:cover;border-radius:6px;box-shadow:0 1px 4px #ccc;" loading="lazy" />`).join('')}
            </div>
          `;
        }

        // Desktop table row
        const joinButtonText = isParticipant ? '‚úÖ Joined' : 'Join';
        const joinButtonClass = isParticipant ? 'joined-btn' : 'join-btn';
        projectsTbody.innerHTML += `
          <tr>
            <td>${circleName}</td>
            <td>${project.name}</td>
            <td>${project.description || ''}
              <div style="margin-top:10px;">
                <button class="${joinButtonClass}" data-project="${project.id}" ${isParticipant ? 'disabled' : ''} style="background:#1976d2;color:#fff;border:none;border-radius:5px;padding:4px 10px;cursor:pointer;margin-right:8px;">${joinButtonText}</button>
                <button class="update-btn" data-project="${project.id}" style="background:#ffc107;color:#333;border:none;border-radius:5px;padding:4px 10px;cursor:pointer;">Update</button>
                <button class="view-participants-btn" data-project="${project.id}" style="background:#6b4f1d;color:#fff;border:none;border-radius:5px;padding:4px 10px;cursor:pointer;margin-left:8px;">üë• View Members</button>
              </div>
              <div class="comments-section" data-project="${project.id}" style="margin-top:12px;background:#f4f8fb;padding:8px 10px;border-radius:6px;">
                <div class="comments-list" id="comments-list-${project.id}"></div>
                <form class="comment-form" data-project="${project.id}" style="margin-top:8px;display:flex;gap:6px;align-items:center;">
                  <input type="text" class="comment-input" placeholder="Add a comment..." style="flex:1;padding:4px 8px;border-radius:4px;border:1px solid #ccc;" required />
                  <input type="text" class="display-name-input" placeholder="Display name (optional)" style="width:180px;padding:4px 8px;border-radius:4px;border:1px solid #ccc;" />
                  <button type="submit" style="background:#2e8b57;color:#fff;border:none;border-radius:4px;padding:4px 12px;">Post</button>
                </form>
              </div>
            </td>
            <td>${proposerName}</td>
            <td>${date}</td>
            <td>${project.num_participants || 0}</td>
            <td><span class="status ${project.status}">${project.status}</span></td>
            <td>${galleryHtml}</td>
          </tr>
        `;

        // Mobile card
        const mobileJoinButtonText = isParticipant ? '‚úÖ Member' : 'Join Project';
        const mobileJoinButtonClass = isParticipant ? 'joined-btn' : 'join-btn';
        const cardHtml = `
          <div class="project-card">
            <h3>${project.name}</h3>
            <div class="project-meta">
              <span>Circle: ${circleName}</span>
              <span>By: ${proposerName}</span>
              <span>Date: ${date}</span>
              <span>Participants: ${project.num_participants || 0}</span>
              <span class="status ${project.status}">${project.status}</span>
            </div>
            <div class="project-description">${project.description || ''}</div>
            <div class="project-actions">
              <button class="${mobileJoinButtonClass}" data-project="${project.id}" ${isParticipant ? 'disabled' : ''}>${mobileJoinButtonText}</button>
              <button class="update-btn" data-project="${project.id}">Update</button>
              <button class="view-participants-btn" data-project="${project.id}">üë• Members</button>
            </div>
            ${galleryHtml ? `<div style="margin-bottom:1rem;">${galleryHtml}</div>` : ''}
            <div class="comments-section" data-project="${project.id}">
              <div class="comments-list" id="comments-list-mobile-${project.id}"></div>
              <form class="comment-form" data-project="${project.id}">
                <input type="text" class="comment-input" placeholder="Add a comment..." required />
                <input type="text" class="display-name-input" placeholder="Display name (optional)" />
                <button type="submit">Post Comment</button>
              </form>
            </div>
          </div>
        `;
        projectsCards.innerHTML += cardHtml;
  // Gallery modal HTML
  const galleryModalHtml = `
    <div id="gallery-modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.85);align-items:center;justify-content:center;">
      <div id="gallery-content" style="position:relative;max-width:90vw;max-height:90vh;">
        <span id="gallery-close" style="position:absolute;top:-32px;right:0;font-size:2em;color:#fff;cursor:pointer;">&times;</span>
        <button id="gallery-prev" style="position:absolute;left:-60px;top:50%;transform:translateY(-50%);background:#fff;border:none;border-radius:50%;width:44px;height:44px;font-size:2em;cursor:pointer;box-shadow:0 2px 8px #222;">&#8592;</button>
        <button id="gallery-next" style="position:absolute;right:-60px;top:50%;transform:translateY(-50%);background:#fff;border:none;border-radius:50%;width:44px;height:44px;font-size:2em;cursor:pointer;box-shadow:0 2px 8px #222;">&#8594;</button>
        <div id="gallery-images" style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;align-items:center;"></div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', galleryModalHtml);

  // --- Comment, Join, and Update Handlers ---
  setTimeout(() => {
    // Comment submit
    document.querySelectorAll('.comment-form').forEach(form => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const projectId = form.getAttribute('data-project');
        const input = form.querySelector('.comment-input');
        const displayNameInput = form.querySelector('.display-name-input');
        const comment = input.value.trim();
        const display_name = (displayNameInput && displayNameInput.value.trim()) || null;
        if (!comment) return;
        // Get current user info
        const { data: userData } = await supabase.auth.getUser();
        let author_name = 'Member';
        let user_id = null;
        if (userData && userData.user) {
          user_id = userData.user.id;
          // Try to get full name from profiles
          const { data: profile } = await supabase.from('profiles').select('full_name,is_admin').eq('id', user_id).single();
          if (profile && profile.full_name) author_name = profile.full_name;
        } else if (display_name) {
          // anonymous with provided display name
          author_name = display_name;
        }
        // Insert with moderation flag: approved = false by default
        await supabase.from('group_project_comments').insert([{ project_id: projectId, comment, author_name, user_id, display_name, approved: false }]);
        input.value = '';
        if (displayNameInput) displayNameInput.value = '';
        loadComments(projectId);
      });
    });
    // Join button
    document.querySelectorAll('.join-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const projectId = btn.getAttribute('data-project');

        // Get current user info
        const { data: userData } = await supabase.auth.getUser();
        console.log('Current user data:', userData); // Debug log

        if (!userData || !userData.user) {
          alert('Please log in to join projects.');
          return;
        }

        const userId = userData.user.id;
        console.log('User ID:', userId); // Debug log

        try {
          // Check if user is already a participant
          const { data: existingParticipant } = await supabase
            .from('group_project_participants')
            .select('*')
            .eq('project_id', projectId)
            .eq('user_id', userId)
            .single();

          if (existingParticipant) {
            alert('You are already a participant in this project!');
            return;
          }

          // Add user as participant
          console.log('Inserting participant record for project:', projectId, 'user:', userId); // Debug log
          const { error: insertError, data: insertData } = await supabase
            .from('group_project_participants')
            .insert([{
              project_id: projectId,
              user_id: userId,
              joined_at: new Date().toISOString()
            }]);

          console.log('Insert result:', insertData); // Debug log
          console.log('Insert error:', insertError); // Debug log

          if (insertError) {
            console.error('Error joining project:', insertError);
            alert('Failed to join project. Please try again.');
            return;
          }

          // Update participant count in the project
          const { data: project } = await supabase
            .from('group_projects')
            .select('num_participants')
            .eq('id', projectId)
            .single();

          if (project) {
            const { error: updateError } = await supabase
              .from('group_projects')
              .update({
                num_participants: (project.num_participants || 0) + 1,
                updated_at: new Date().toISOString()
              })
              .eq('id', projectId);

            if (updateError) {
              console.warn('Could not update participant count:', updateError);
            }
          }

          alert(`Successfully joined the project! üéâ\n\nAs a member you can:\n‚Ä¢ Participate in project discussions\n‚Ä¢ Contribute to project updates\n‚Ä¢ Connect with other members\n‚Ä¢ Access project resources\n‚Ä¢ Help drive the project forward!\n\nDebug: Joined as user ${userId}`);
          // Reload projects to show updated participant count and member status
          await loadProjects();

        } catch (error) {
          console.error('Error joining project:', error);
          alert('An error occurred. Please try again.');
        }
      });
    });

    // View Participants button
    document.querySelectorAll('.view-participants-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const projectId = btn.getAttribute('data-project');

        // Check if user is logged in first
        const { data: userData } = await supabase.auth.getUser();
        if (!userData?.user) {
          alert('Please log in to view project members.');
          return;
        }

        try {
          // Get project details
          const { data: project } = await supabase
            .from('group_projects')
            .select('*')
            .eq('id', projectId)
            .single();

          if (!project) {
            alert('Project not found.');
            return;
          }

          // Get all participants with their profile information
          console.log('Fetching participants for project:', projectId); // Debug log

          // First get participants
          const { data: participantsData, error: participantsError } = await supabase
            .from('group_project_participants')
            .select('user_id, joined_at')
            .eq('project_id', projectId)
            .order('joined_at', { ascending: true });

          console.log('Raw participants data:', participantsData); // Debug log
          console.log('Participants error:', participantsError); // Debug log

          // Then get profile info for each participant
          let participants = [];
          if (participantsData && !participantsError) {
            for (const participant of participantsData) {
              const { data: profile, error: profileError } = await supabase
                .from('profiles')
                .select('full_name')
                .eq('id', participant.user_id)
                .single();

              participants.push({
                user_id: participant.user_id,
                joined_at: participant.joined_at,
                profiles: profile || { full_name: 'Anonymous Member' }
              });
            }
          }

          console.log('Final participants data:', participants); // Debug log

          // Create participants modal
          const modalHtml = `
            <div id="participants-modal" style="position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;">
              <div style="background:#fff;padding:2rem;border-radius:10px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;">
                <h3 style="margin-top:0;color:#2e8b57;">${project.name} - Members</h3>
                <p style="color:#666;margin-bottom:1rem;">${participants?.length || 0} participant(s)</p>

                ${participants && participants.length > 0 ? `
                  <div style="margin-bottom:1rem;">
                    ${participants.map(p => `
                      <div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem;border-bottom:1px solid #eee;">
                        <span style="font-weight:bold;color:#2e8b57;">${p.profiles?.full_name || 'Anonymous Member'}</span>
                        <span style="font-size:0.9em;color:#666;">Joined ${new Date(p.joined_at).toLocaleDateString()}</span>
                      </div>
                    `).join('')}
                  </div>
                ` : `
                  <p style="color:#666;text-align:center;padding:2rem;">No participants yet. Be the first to join!</p>
                `}

                <div style="text-align:right;">
                  <button id="close-participants-modal" style="background:#6b4f1d;color:#fff;border:none;border-radius:5px;padding:8px 16px;cursor:pointer;">Close</button>
                </div>
              </div>
            </div>
          `;

          document.body.insertAdjacentHTML('beforeend', modalHtml);

          // Close modal functionality
          document.getElementById('close-participants-modal').addEventListener('click', () => {
            document.getElementById('participants-modal').remove();
          });

          document.getElementById('participants-modal').addEventListener('click', (e) => {
            if (e.target.id === 'participants-modal') {
              document.getElementById('participants-modal').remove();
            }
          });

        } catch (error) {
          console.error('Error loading participants:', error);
          alert('Failed to load participants. Please try again.');
        }
      });
    });

    // Update button - opens universal update form
    document.querySelectorAll('.update-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const projectId = btn.getAttribute('data-project');

        try {
          // Get current project data
          const { data: project } = await supabase
            .from('group_projects')
            .select('*')
            .eq('id', projectId)
            .single();

          if (!project) {
            alert('Project not found.');
            return;
          }

          // Get circles for dropdown
          const { data: circles } = await supabase
            .from('circles')
            .select('id, name');

          // Get profiles for proposer dropdown
          const { data: profiles } = await supabase
            .from('profiles')
            .select('id, full_name');

          // Create update form modal
          const modalHtml = `
            <div id="update-modal" style="position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;">
              <div style="background:#fff;padding:2rem;border-radius:10px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto;">
                <h3 style="margin-top:0;color:#2e8b57;">Update Project: ${project.name}</h3>

                <form id="update-project-form">
                  <div style="margin-bottom:1rem;">
                    <label for="update-circle" style="display:block;margin-bottom:0.5rem;color:#2e8b57;font-weight:bold;">Circle</label>
                    <select id="update-circle" name="circle" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                      ${circles?.map(c => `<option value="${c.id}" ${c.id === project.circle_id ? 'selected' : ''}>${c.name}</option>`).join('') || ''}
                    </select>
                  </div>

                  <div style="margin-bottom:1rem;">
                    <label for="update-proposer" style="display:block;margin-bottom:0.5rem;color:#2e8b57;font-weight:bold;">Proposer Name</label>
                    <select id="update-proposer" name="proposer" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                      ${profiles?.map(p => `<option value="${p.id}" ${p.id === project.proposer_id ? 'selected' : ''}>${p.full_name}</option>`).join('') || ''}
                    </select>
                  </div>

                  <div style="margin-bottom:1rem;">
                    <label for="update-name" style="display:block;margin-bottom:0.5rem;color:#2e8b57;font-weight:bold;">Project Name</label>
                    <input type="text" id="update-name" name="name" value="${project.name || ''}" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;" />
                  </div>

                  <div style="margin-bottom:1rem;">
                    <label for="update-description" style="display:block;margin-bottom:0.5rem;color:#2e8b57;font-weight:bold;">Description</label>
                    <textarea id="update-description" name="description" rows="4" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">${project.description || ''}</textarea>
                  </div>

                  <div style="margin-bottom:1rem;">
                    <label for="update-num-participants" style="display:block;margin-bottom:0.5rem;color:#2e8b57;font-weight:bold;">Number of Participants</label>
                    <input type="number" id="update-num-participants" name="num-participants" min="1" value="${project.num_participants || 1}" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;" />
                  </div>

                  <div style="margin-bottom:1.5rem;">
                    <label for="update-status" style="display:block;margin-bottom:0.5rem;color:#2e8b57;font-weight:bold;">Status</label>
                    <select id="update-status" name="status" required style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                      <option value="pending" ${project.status === 'pending' ? 'selected' : ''}>Pending</option>
                      <option value="started" ${project.status === 'started' ? 'selected' : ''}>Started</option>
                      <option value="in process" ${project.status === 'in process' ? 'selected' : ''}>In Process</option>
                      <option value="completed" ${project.status === 'completed' ? 'selected' : ''}>Completed</option>
                    </select>
                  </div>

                  <div style="text-align:right;gap:10px;display:flex;justify-content:flex-end;">
                    <button type="button" id="cancel-update-btn" style="background:#ccc;color:#333;border:none;border-radius:6px;padding:10px 20px;cursor:pointer;">Cancel</button>
                    <button type="submit" style="background:#2e8b57;color:#fff;border:none;border-radius:6px;padding:10px 20px;cursor:pointer;">Update Project</button>
                  </div>
                </form>
              </div>
            </div>
          `;

          document.body.insertAdjacentHTML('beforeend', modalHtml);

          // Handle form submission
          document.getElementById('update-project-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const updateData = {
              circle_id: formData.get('circle'),
              proposer_id: formData.get('proposer'),
              name: formData.get('name').trim(),
              description: formData.get('description').trim(),
              num_participants: parseInt(formData.get('num-participants'), 10) || 1,
              status: formData.get('status'),
              updated_at: new Date().toISOString()
            };

            try {
              const { error: updateError } = await supabase
                .from('group_projects')
                .update(updateData)
                .eq('id', projectId);

              if (updateError) {
                console.error('Error updating project:', updateError);
                alert('Failed to update project. Please try again.');
                return;
              }

              alert('Project updated successfully! üéâ');
              document.getElementById('update-modal').remove();
              await loadProjects(); // Refresh the display

            } catch (error) {
              console.error('Error updating project:', error);
              alert('An error occurred. Please try again.');
            }
          });

          // Handle cancel
          document.getElementById('cancel-update-btn').addEventListener('click', () => {
            document.getElementById('update-modal').remove();
          });

          // Close modal when clicking outside
          document.getElementById('update-modal').addEventListener('click', (e) => {
            if (e.target.id === 'update-modal') {
              document.getElementById('update-modal').remove();
            }
          });

        } catch (error) {
          console.error('Error loading project for update:', error);
          alert('Failed to load project data. Please try again.');
        }
      });
    });
    // Load comments for each project
    document.querySelectorAll('.comments-section').forEach(sec => {
      const projectId = sec.getAttribute('data-project');
      loadComments(projectId);
    });
  }, 0);

  async function loadComments(projectId) {
    // Determine if current viewer is admin (so they can see pending comments)
    const { data: userData } = await supabase.auth.getUser();
    let viewerIsAdmin = false;
    if (userData && userData.user) {
      const uid = userData.user.id;
      const { data: profile } = await supabase.from('profiles').select('is_admin').eq('id', uid).single();
      if (profile && profile.is_admin) viewerIsAdmin = true;
    }
    // If viewer is admin, fetch all comments for management; otherwise fetch only approved ones
    let query = supabase.from('group_project_comments').select('*').eq('project_id', projectId).order('created_at', { ascending: true });
    if (!viewerIsAdmin) query = query.eq('approved', true);
    const { data: comments } = await query;

    // Load comments for both desktop table and mobile cards
    const desktopList = document.getElementById('comments-list-' + projectId);
    const mobileList = document.getElementById('comments-list-mobile-' + projectId);

    [desktopList, mobileList].forEach(list => {
      if (!list) return;
      list.innerHTML = '';
      (comments || []).forEach(c => {
        const name = c.author_name || c.display_name || 'Member';
        const approvedBadge = c.approved ? '' : '<span style="color:#856404;margin-left:6px;font-size:0.9em">(pending)</span>';
        const approveButton = viewerIsAdmin && !c.approved ? ` <button data-comment="${c.id}" data-project="${projectId}" class="approve-comment-btn" style="margin-left:8px;padding:2px 6px;border-radius:4px;background:#28a745;color:#fff;border:none;cursor:pointer;">Approve</button>` : '';
        const row = document.createElement('div');
        row.style.marginBottom = '6px';
        row.innerHTML = `<span style="color:#1976d2;font-weight:bold;">${escapeHtml(name)}:</span> ${escapeHtml(c.comment)} ${approvedBadge} ${approveButton}`;
        list.appendChild(row);
      });
    });

    // Wire approve buttons
    document.querySelectorAll('.approve-comment-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const commentId = btn.getAttribute('data-comment');
        await supabase.from('group_project_comments').update({ approved: true }).eq('id', commentId);
        loadComments(btn.getAttribute('data-project'));
      });
    });
  }

  function escapeHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  // Gallery modal logic with next/prev
  const galleryModal = document.getElementById('gallery-modal');
  const galleryImagesDiv = document.getElementById('gallery-images');
  const galleryClose = document.getElementById('gallery-close');
  const galleryPrev = document.getElementById('gallery-prev');
  const galleryNext = document.getElementById('gallery-next');
  let galleryImagesArr = [];
  let galleryIndex = 0;

  function showGalleryImage(idx) {
    if (!galleryImagesArr.length) return;
    galleryIndex = ((idx % galleryImagesArr.length) + galleryImagesArr.length) % galleryImagesArr.length;
    galleryImagesDiv.innerHTML = `<img src="${galleryImagesArr[galleryIndex]}" style="max-width:80vw;max-height:70vh;margin:8px;border-radius:10px;box-shadow:0 2px 12px #222;" />`;
  }

  projectsTbody.addEventListener('click', function(e) {
    const thumbDiv = e.target.closest('.project-thumbnails');
    if (thumbDiv) {
      galleryImagesArr = JSON.parse(thumbDiv.getAttribute('data-images'));
      galleryIndex = 0;
      showGalleryImage(galleryIndex);
      galleryModal.style.display = 'flex';
    }
  });
  galleryClose.onclick = () => { galleryModal.style.display = 'none'; };
  galleryModal.onclick = (e) => {
    if (e.target === galleryModal) galleryModal.style.display = 'none';
  };
  galleryPrev.onclick = (e) => {
    e.stopPropagation();
    showGalleryImage(galleryIndex - 1);
  };
  galleryNext.onclick = (e) => {
    e.stopPropagation();
    showGalleryImage(galleryIndex + 1);
  };
      }
    }

    showFormBtn.addEventListener('click', () => {
      projectForm.style.display = 'block';
      formError.textContent = '';
      formSuccess.textContent = '';
    });
    cancelFormBtn.addEventListener('click', () => {
      projectForm.reset();
      projectForm.style.display = 'none';
      formError.textContent = '';
      formSuccess.textContent = '';
    });

    projectForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      formError.textContent = '';
      formSuccess.textContent = '';
      const circle_id = circleSelect.value; // UUID
      const proposer_id = document.getElementById('proposer-name').value; // UUID
      const name = projectForm.name.value.trim();
      const description = projectForm.description.value.trim();
      const num_participants = parseInt(projectForm['num-participants'].value, 10) || 1;
      const status = projectForm.status.value;
      // Insert project first to get the project id
      const { data: inserted, error: insertError } = await supabase.from('group_projects').insert([
        {
          circle_id,
          proposer_id,
          name,
          description,
          num_participants,
          status
        }
      ]).select();
      if (insertError || !inserted || !inserted[0] || !inserted[0].id) {
        formError.textContent = (insertError && insertError.message) || 'Could not create project.';
        return;
      }
      const projectId = inserted[0].id;
      // Handle image upload to project folder
      const imageInput = document.getElementById('project-images');
      if (imageInput.files.length > 0) {
        for (let i = 0; i < imageInput.files.length; i++) {
          const file = imageInput.files[i];
          const fileExt = file.name.split('.').pop();
          const fileName = `${projectId}/${Date.now()}_${Math.random().toString(36).substr(2, 6)}.${fileExt}`;
          const { error: uploadError } = await supabase.storage.from('project-images').upload(fileName, file);
          if (uploadError) {
            formError.textContent = 'Image upload failed: ' + uploadError.message;
            return;
          }
        }
      }
      formSuccess.textContent = 'Project submitted!';
      projectForm.reset();
      projectForm.style.display = 'none';
      await loadProjects();
    });

    // Initial load
    await loadCircles();
    await loadProfiles();
    await loadProjects();

    // Check auth status and show/hide warning
    const { data: userData } = await supabase.auth.getUser();
    const authStatus = document.getElementById('auth-status');
    if (userData?.user) {
      authStatus.style.display = 'none';
    } else {
      authStatus.style.display = 'block';
    }
    circleFilter.addEventListener('change', async (e) => {
      selectedCircleId = circleFilter.value;
      await loadProjects();
    });
  </script>
</body>
</html>
