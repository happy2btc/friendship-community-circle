<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Circle Pulse â€” What's Happening This Week</title>
  <script type="module" src="/lib/supabase.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--accent:#2e8b57;--muted:#666;--card:#fff;--bg:#f7faf7}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;padding:1.25rem;background:var(--bg);color:#111}
    .wrap{max-width:900px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center;margin-bottom:1rem}
    h1{margin:0;font-size:1.5rem}
    .lead{color:var(--muted);margin-top:0.25rem}
    .card{background:var(--card);border:1px solid #eee;border-radius:10px;padding:1rem;margin-bottom:1rem;box-shadow:0 2px 6px rgba(0,0,0,0.04)}
    form{display:grid;gap:8px}
    input,textarea,select{padding:10px;border-radius:6px;border:1px solid #ddd;font-size:1rem}
    button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
    .small{font-size:0.9rem;color:var(--muted)}
    .ann-list{display:grid;gap:8px}
    .ann{border-left:4px solid var(--accent);padding:8px 12px;background:#fff;border-radius:6px}
    .meta{font-size:0.85rem;color:var(--muted)}
    .empty{color:var(--muted);padding:8px}
    .status{font-size:0.95rem;color:var(--muted)}
    .actions{display:flex;gap:8px}
    @media (max-width:600px){body{padding:0.75rem}} 
  </style>
</head>
<body>
  <a href="main-menu.html" aria-label="Back to Menu" style="position:fixed; top:16px; left:16px; z-index:1200; background:#2b6b4f; color:#fff; padding:8px 12px; border-radius:8px; text-decoration:none; font-weight:600; box-shadow:0 2px 6px rgba(0,0,0,0.15);">ðŸ”™ Back to Menu</a>
  <div class="wrap">
    <header>
      <div>
        <h1>Circle Pulse</h1>
        <div class="lead">This week's announcements â€” what can we / are we working on as a circle that will make a difference in our lives?</div>
      </div>
    </header>

    <section class="card" aria-labelledby="post-heading">
      <h2 id="post-heading" style="margin:0 0 6px 0">Share a weekly announcement</h2>
      <p class="small">Post a short update, request, event, or a small ask that others can respond to this week.</p>
      <form id="pulse-form">
        <input id="title" placeholder="Short headline (e.g., Community Garden Work Day)" />
        <textarea id="body" rows="3" placeholder="Details: time, place, what help is needed, connection options..."></textarea>
        <input id="display_name" placeholder="Optional display name (leave blank for 'Member')" />
        <div class="actions">
          <button id="submit">Share to Circle</button>
          <button type="button" id="view-local-btn" style="background:#eee;color:#111;padding:8px 10px;border-radius:8px;font-weight:600;border:1px solid #ddd">View saved</button>
          <div class="status" id="form-status" aria-live="polite"></div>
        </div>
        <div id="local-saves" style="display:none;margin-top:10px"></div>
      </form>
  <!-- explanatory note removed per request -->
    </section>

    <!-- Announcements (visible to visitors) -->
    <section class="card" id="announcements-section">
      <h2 style="margin-top:0">This Week</h2>
      <div id="announcements" class="ann-list">
        <div class="empty">Loading announcements...</div>
      </div>
    </section>

    <!-- footer removed per request -->
  </div>

  <script type="module">
    import { supabase } from '/lib/supabase.js';

    const form = document.getElementById('pulse-form');
    const titleEl = document.getElementById('title');
    const bodyEl = document.getElementById('body');
    const nameEl = document.getElementById('display_name');
  const statusEl = document.getElementById('form-status');

    // Utilities
    function showStatus(msg, timeout=4000){ statusEl.textContent = msg; if(timeout) setTimeout(()=>{ if(statusEl.textContent===msg) statusEl.textContent=''; }, timeout); }

    const viewLocalBtn = document.getElementById('view-local-btn');
    const localSavesEl = document.getElementById('local-saves');

    function loadLocalSaves(){ try{ return JSON.parse(localStorage.getItem('circle_pulse_local_announcements_v1') || '[]'); }catch(e){ console.warn('local parse failed', e); return []; } }

    function renderLocalSaves(){ const arr = loadLocalSaves(); if(!arr || arr.length===0){ localSavesEl.innerHTML = '<div class="small">No local saves.</div>'; return; } localSavesEl.innerHTML = ''; for(const it of arr){ const el = document.createElement('div'); el.className = 'card'; el.style.marginBottom = '6px'; const who = it.display_name || 'Member'; const date = it.created_at ? new Date(it.created_at).toLocaleString() : ''; el.innerHTML = `<div style="font-weight:700">${escapeHtml(it.title || it.body || 'Untitled')}</div><div style="margin:6px 0">${escapeHtml(it.body || '')}</div><div class="meta">Saved locally â€¢ ${escapeHtml(who)}${date ? ' â€¢ '+escapeHtml(date) : ''}</div>`; localSavesEl.appendChild(el); } }

    viewLocalBtn.addEventListener('click', ()=>{
      if(localSavesEl.style.display === 'none' || !localSavesEl.style.display){ renderLocalSaves(); localSavesEl.style.display = 'block'; viewLocalBtn.textContent = 'Hide saved'; }
      else { localSavesEl.style.display = 'none'; viewLocalBtn.textContent = 'View saved'; }
    });

    form.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const title = (titleEl.value||'').trim();
      const body = (bodyEl.value||'').trim();
      const display_name = (nameEl.value||'').trim() || null;
      if(!title && !body){ showStatus('Please enter a headline or details.'); return; }

      const payload = { title, body, display_name };

      // Try to insert into preferred tables in order (single loop)
      const candidates = ['circle_announcements','what_s_new','suggestions'];
      let posted = false;
      for (const t of candidates) {
        try {
          const { data, error } = await supabase.from(t).insert([{ ...payload, approved: true }]).select();
          if (!error) {
            posted = true;
            showStatus('Shared to circle.');
            titleEl.value = '';
            bodyEl.value = '';
            nameEl.value = '';
            try{ await refreshAnnouncements(); }catch(e){ console.warn('refreshAnnouncements failed', e); }
            break;
          }
        } catch (err) {
          console.warn('Insert attempt error for', t, err);
        }
      }

      if (!posted) {
        // Fallback: store locally so user doesn't lose the content
        const now = new Date().toISOString();
        try{
          const key = 'circle_pulse_local_announcements_v1';
          const raw = localStorage.getItem(key);
          const arr = raw ? JSON.parse(raw) : [];
          arr.unshift({ id: 'local-'+Date.now(), title, body, display_name, created_at: now });
          localStorage.setItem(key, JSON.stringify(arr.slice(0,50)));
        }catch(e){ console.warn('local save failed', e); }
        showStatus('Saved locally (table not available).');
        titleEl.value=''; bodyEl.value=''; nameEl.value='';
      }
    });


    // Announcements rendering + loading
    const annContainer = document.getElementById('announcements');

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    function renderAnnouncements(items){
      annContainer.innerHTML = '';
      if(!items || items.length === 0){ annContainer.innerHTML = '<div class="empty">No announcements yet â€” be the first to share!</div>'; return; }
      for(const it of items){
        const el = document.createElement('div'); el.className = 'ann';
        const who = it.display_name || 'Member';
        const date = it.created_at ? new Date(it.created_at).toLocaleString() : '';
        el.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${escapeHtml(it.title || it.body || 'Untitled')}</div>
                        <div style="margin-bottom:8px">${escapeHtml(it.body || '')}</div>
                        <div class="meta">Posted by ${escapeHtml(who)}${date ? ' â€¢ '+escapeHtml(date) : ''}</div>`;
        annContainer.appendChild(el);
      }
    }

    async function loadAnnouncements(){
      annContainer.innerHTML = '<div class="empty">Loading announcements...</div>';
      try{
        const { data, error } = await supabase
          .from('circle_announcements')
          .select('id,title,body,display_name,created_at')
          .eq('approved', true)
          .order('created_at', { ascending: false })
          .limit(50);
        if(error){
          console.warn('circle_announcements load error', error.message);
          // fallback to local
          const local = JSON.parse(localStorage.getItem('circle_pulse_local_announcements_v1') || '[]');
          renderAnnouncements(local);
          return;
        }
        renderAnnouncements(data || []);
      }catch(e){
        console.error('loadAnnouncements error', e);
        const local = JSON.parse(localStorage.getItem('circle_pulse_local_announcements_v1') || '[]');
        renderAnnouncements(local);
      }
    }

    // After successful post, refresh announcements
    async function refreshAnnouncements(){ await loadAnnouncements(); }

    // Initial load
    (async ()=>{ await loadAnnouncements(); })();

    </script>
</body>
</html>
