<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Member Activities</title>
    <style>
        body { font-family: sans-serif; background: #f9f9f9; padding: 2rem; max-width: 800px; margin: auto; }
        h1 { text-align: center; }
        .member-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: flex-start;
            gap: 1.5rem;
        }
        .member-card img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            background: #eee;
        }
        .member-info {
            flex: 1;
        }
        .activity-breakdown {
            font-size: 1em;
            color: #555;
            margin: 0.5rem 0 0 0;
        }
        .personal-story {
            font-style: italic;
            color: #4a7c59;
            margin-top: 0.5rem;
        }
        .back-menu-btn {
            background: #2e8b57;
            color: #fff;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 6px #eee;
            transition: background 0.2s;
            position: fixed;
            top: 20px;
            right: 30px;
            z-index: 1000;
            padding: 12px 24px;
            margin: 0;
        }
        .back-menu-btn:hover {
            background: #4a7c59;
        }
    </style>
</head>
<body>
    <div class="legend-container" style="background:#f5f5e6;border:1px solid #e0dcb7;border-radius:10px;padding:1.5em 2em;margin-bottom:2em;max-width:700px;margin-left:auto;margin-right:auto;box-shadow:0 2px 8px #eee;">
        <h2 style="margin-top:0;">Activities Legend</h2>
        <div style="font-size:1.05em;line-height:1.7;">
            <strong>Points awarded for an activity</strong><br>
            Votes = 1 point per vote<br>
            Suggestions = 1 point per suggestion<br>
            Comments = 1 point per comment<br>
            Wants = 1 point for entering what you want<br>
            Offers = 1 point for entering what you offer<br>
            Passion = 1 point for entering what your passion<br>
            Projects & Struggles = 1 point for each line entered<br>
            Help Given = 5 points per hour<br>
            Profile Completed = 5 points<br>
            Circles Created = 10 points for each circle created<br>
            Events Created = 5 points per event created<br>
            Events Attended = 5 points per attendance<br>
            Member Added = 2 points per member added<br>
            Celebration Wall Posts = 5 points per post<br>
            Projects Proposed = 5 points per proposal<br>
            Support Responses = 5 points per response<br>
            Writer's Post = 1 point per 1000 words
        </div>
    </div>
    <h1>Community Member Activities</h1>
    <div id="members"></div>
    <a href="menu.html" class="back-menu-btn">← Back to Menu</a>
    <script type="module">
        import { supabase } from '/lib/supabase.js';

        async function getActivities() {
            // Declare these at the top to avoid ReferenceError
            const builderId = "81c50097-74f3-4c7a-b00c-598995b8d1cb";
            const activity = {};
            const breakdown = {};
            // Writer's Wall: tally posts and points per author
            const { data: writersWall } = await supabase
                .from('writers_wall')
                .select('author_id, points');
            if (writersWall) {
                writersWall.forEach(row => {
                    if (row.author_id) {
                        breakdown[row.author_id] = breakdown[row.author_id] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, help_hours: 0, help_points: 0, help_hours_recent: 0, support_responses: 0, events_created: 0, events_attended: 0, projects_proposed: 0, writer_posts: 0, writer_points: 0 };
                        breakdown[row.author_id].writer_posts = (breakdown[row.author_id].writer_posts || 0) + 1;
                        breakdown[row.author_id].writer_points = (breakdown[row.author_id].writer_points || 0) + (row.points || 0);
                    }
                });
            }
            // Count help given (5 points per hour)
            const { data: helpGiven } = await supabase
                .from('help_given')
                .select('helper_id, hours')
                .order('created_at', { ascending: false });
            const helpByUser = {};
            const helpByUserRecent = {};
            helpGiven?.forEach(row => {
                if (row.helper_id && row.hours && row.helper_id !== builderId) {
                    helpByUser[row.helper_id] = (helpByUser[row.helper_id] || 0) + Number(row.hours);
                    helpByUserRecent[row.helper_id] = helpByUserRecent[row.helper_id] || [];
                    // To correctly sum all help given, remove the limit on pushing to helpByUserRecent
                    helpByUserRecent[row.helper_id].push(Number(row.hours));
                }
            });
            Object.entries(helpByUser).forEach(([userId, hours]) => {
                breakdown[userId] = breakdown[userId] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, help_hours: 0, help_points: 0, help_hours_recent: 0, support_responses: 0 };
                breakdown[userId].help_hours = hours;
                breakdown[userId].help_points = hours * 5;
                breakdown[userId].help_hours_recent = (helpByUserRecent[userId] || []).reduce((a, b) => a + b, 0);
                activity[userId] = (activity[userId] || 0) + (hours * 5);
            });
            // Count events attended (5 points each, from event_attendance table)
            const { data: attendedActs } = await supabase
                .from('event_attendance')
                .select('user_id');
            console.log('DEBUG: attendedActs from event_attendance', attendedActs);
            const attendedByUser = {};
            attendedActs?.forEach(row => {
                if (row.user_id && row.user_id !== builderId) {
                    attendedByUser[row.user_id] = (attendedByUser[row.user_id] || 0) + 1;
                }
            });
            Object.entries(attendedByUser).forEach(([userId, count]) => {
                breakdown[userId] = breakdown[userId] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, events_created: 0, events_attended: 0, projects_proposed: 0, support_responses: 0 };
                breakdown[userId].events_attended = count;
                activity[userId] = (activity[userId] || 0) + (count * 5);
            });
            // Count events created (5 points each)
            const { data: events } = await supabase
                .from('events')
                .select('created_by');
            const eventsByUser = {};
            events?.forEach(ev => {
                if (ev.created_by && ev.created_by !== builderId) {
                    eventsByUser[ev.created_by] = (eventsByUser[ev.created_by] || 0) + 1;
                }
            });
            Object.entries(eventsByUser).forEach(([userId, count]) => {
                breakdown[userId] = breakdown[userId] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, events_created: 0, support_responses: 0 };
                breakdown[userId].events_created = count;
                activity[userId] = (activity[userId] || 0) + (count * 5);
            });
            // Count support responses (5 points each)
            const { data: supportResponses } = await supabase
                .from('support_responses')
                .select('responder_id');
            const responsesByUser = {};
            supportResponses?.forEach(sr => {
                if (sr.responder_id && sr.responder_id !== builderId) {
                    responsesByUser[sr.responder_id] = (responsesByUser[sr.responder_id] || 0) + 1;
                }
            });
            Object.entries(responsesByUser).forEach(([userId, count]) => {
                breakdown[userId] = breakdown[userId] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, events_created: 0, events_attended: 0, projects_proposed: 0, support_responses: 0 };
                breakdown[userId].support_responses = count;
                activity[userId] = (activity[userId] || 0) + (count * 5);
            });
            // Restore missing queries for legacy activities
            const { data: votes } = await supabase
                .from('agreement_votes')
                .select('voter_id, created_at');

            const { data: suggestions } = await supabase
                .from('suggestions')
                .select('author_id, created_at');

            const { data: comments } = await supabase
                .from('comments')
                .select('author_id, created_at');

            const { data: offerings } = await supabase
                .from('member_offerings')
                .select('user_id, want, give, passion');

            const { data: contributions } = await supabase
                .from('contributions')
                .select('user_id, project, challenge, help, collab, skills, urgency, contact');

            const { data: profilesFull } = await supabase
                .from('profiles')
                .select('id, full_name, bio, avatar_url, youtube, twitter, substack, facebook, instagram, linkedin, website');

            // Get new activities
            const { data: circles } = await supabase
                .from('circles')
                .select('created_by');

            const { data: membersData } = await supabase
                .from('circle_members')
                .select('added_by');

            const { data: celebrations } = await supabase
                .from('celebrations')
                .select('user_id');

                // Get group projects for proposal points
                const { data: groupProjects } = await supabase
                    .from('group_projects')
                    .select('proposer_id');
            // Tally activity per user (already declared above)

            // Existing activities
            votes?.forEach(v => {
                if (v.voter_id !== builderId) {
                    activity[v.voter_id] = (activity[v.voter_id] || 0) + 1;
                    breakdown[v.voter_id] = breakdown[v.voter_id] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
                    breakdown[v.voter_id].votes += 1;
                }
            });
            suggestions?.forEach(s => {
                if (s.author_id !== builderId) {
                    activity[s.author_id] = (activity[s.author_id] || 0) + 1;
                    breakdown[s.author_id] = breakdown[s.author_id] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
                    breakdown[s.author_id].suggestions += 1;
                }
            });
            comments?.forEach(c => {
                if (c.author_id !== builderId) {
                    activity[c.author_id] = (activity[c.author_id] || 0) + 1;
                    breakdown[c.author_id] = breakdown[c.author_id] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
                    breakdown[c.author_id].comments += 1;
                }
            });

                // Count projects proposed (5 points each)
                const proposalsByUser = {};
                groupProjects?.forEach(gp => {
                    if (gp.proposer_id && gp.proposer_id !== builderId) {
                        proposalsByUser[gp.proposer_id] = (proposalsByUser[gp.proposer_id] || 0) + 1;
                    }
                });
                Object.entries(proposalsByUser).forEach(([userId, count]) => {
                    breakdown[userId] = breakdown[userId] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
                    breakdown[userId].projects_proposed = count;
                    activity[userId] = (activity[userId] || 0) + (count * 5);
                });

            // Count wants, offers, passion
            offerings?.forEach(o => {
                if (o.user_id !== builderId) {
                    let points = 0;
                    breakdown[o.user_id] = breakdown[o.user_id] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
                    if (o.want && o.want.trim() !== "") { breakdown[o.user_id].wants += 1; points += 1; }
                    if (o.give && o.give.trim() !== "") { breakdown[o.user_id].offers += 1; points += 1; }
                    if (o.passion && o.passion.trim() !== "") { breakdown[o.user_id].passion += 1; points += 1; }
                    activity[o.user_id] = (activity[o.user_id] || 0) + points;
                }
            });

            // Count projects and struggles
            const contribByUser = {};
            contributions?.forEach(con => {
                if (con.user_id !== builderId) {
                    if (!contribByUser[con.user_id]) contribByUser[con.user_id] = [];
                    contribByUser[con.user_id].push(con);
                }
            });
            Object.entries(contribByUser).forEach(([userId, contribs]) => {
                breakdown[userId] = breakdown[userId] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
                let fieldsFilled = 0;
                contribs.forEach(con => {
                    ['project','challenge','help','collab','skills','urgency','contact'].forEach(field => {
                        if (con[field] && con[field].trim() !== '') {
                            fieldsFilled += 1;
                        }
                    });
                });
                breakdown[userId].projects += fieldsFilled;
                activity[userId] = (activity[userId] || 0) + fieldsFilled;
            });

            // Count profile completion
            profilesFull?.forEach(p => {
                if (p.id !== builderId) {
                    let filled = 0;
                    if (p.full_name && p.full_name.trim() !== "") filled++;
                    if (p.bio && p.bio.trim() !== "") filled++;
                    if (p.avatar_url && p.avatar_url.trim() !== "") filled++;
                    if (p.youtube || p.twitter || p.substack || p.facebook || p.instagram || p.linkedin || p.website) filled++;
                    if (filled >= 2) {
                        breakdown[p.id] = breakdown[p.id] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
                        breakdown[p.id].profile = 1;
                        activity[p.id] = (activity[p.id] || 0) + 5;
                    }
                }
            });

            // New: Count circles created (10 points each)
            circles?.forEach(c => {
                if (c.created_by && c.created_by !== builderId) {
                    activity[c.created_by] = (activity[c.created_by] || 0) + 10;
                    breakdown[c.created_by] = breakdown[c.created_by] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
                    breakdown[c.created_by].circles_created = (breakdown[c.created_by].circles_created || 0) + 1;
                }
            });

            // New: Count members added (2 points each)
            membersData?.forEach(m => {
                if (m.added_by && m.added_by !== builderId) {
                    activity[m.added_by] = (activity[m.added_by] || 0) + 2;
                    breakdown[m.added_by] = breakdown[m.added_by] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
                    breakdown[m.added_by].members_added = (breakdown[m.added_by].members_added || 0) + 1;
                }
            });

            // New: Count celebration wall posts (5 points each)
            celebrations?.forEach(c => {
                if (c.user_id && c.user_id !== builderId) {
                    activity[c.user_id] = (activity[c.user_id] || 0) + 5;
                    breakdown[c.user_id] = breakdown[c.user_id] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
                    breakdown[c.user_id].celebrations_posted = (breakdown[c.user_id].celebrations_posted || 0) + 1;
                }
            });

            // Get all involved user IDs, filter out null/empty
            const userIds = Object.keys(activity).filter(id => id && id !== 'null');
            if (userIds.length === 0) return [];

            // Get profiles for display
            const { data: profiles } = await supabase
                .from('profiles')
                .select('id, full_name, avatar_url, personal_story');

            // Map profiles by id
            const idToProfile = {};
            profiles?.forEach(p => { idToProfile[p.id] = p; });

            // Build member activity list
            const members = userIds.map(id => ({
                id,
                profile: idToProfile[id] || { full_name: id, avatar_url: '', personal_story: '' },
                total: activity[id],
                breakdown: breakdown[id]
            }));

            // Sort by most active
            members.sort((a, b) => b.total - a.total);

            return members;
        }

        async function showMembers() {
            const members = await getActivities();
            const container = document.getElementById('members');
            if (!members || members.length === 0) {
                container.innerHTML = "<em>No member activities yet.</em>";
                return;
            }

                container.innerHTML += members.map(m => `
                    <div class="member-card">
                        <img src="${m.profile.avatar_url || 'default-avatar.png'}" alt="Profile Picture">
                        <div class="member-info">
                            <h2>${m.profile.full_name || m.id}</h2>
                            <div class="activity-breakdown">
                                <strong>All-Time Activities:</strong><br>
                                Votes: ${m.breakdown.votes || 0}<br>
                                Suggestions: ${m.breakdown.suggestions || 0}<br>
                                Comments: ${m.breakdown.comments || 0}<br>
                                Wants: ${m.breakdown.wants || 0}<br>
                                Offers: ${m.breakdown.offers || 0}<br>
                                Passion: ${m.breakdown.passion || 0}<br>
                                Projects & Struggles: ${m.breakdown.projects || 0}<br>
                                <span style="color:#4a7c59;font-weight:bold;">Writer's Posts: ${m.breakdown.writer_posts || 0}</span><br>
                                Help Given: ${m.breakdown.help_hours_recent || 0}<br>
                                Profile Completed: ${m.breakdown.profile ? "✔️" : "—"}<br>
                                Circles Created: ${m.breakdown.circles_created || 0}<br>
                                Events Created: ${m.breakdown.events_created || 0}<br>
                                Events Attended: ${m.breakdown.events_attended || 0}<br>
                                Members Added: ${m.breakdown.members_added || 0}<br>
                                Celebration Wall Posts: ${m.breakdown.celebrations_posted || 0}<br>
                                Projects Proposed: ${m.breakdown.projects_proposed || 0}<br>
                                Support Responses: ${m.breakdown.support_responses || 0}<br>
                                <strong>Total:</strong> ${m.total}
                            </div>
                            <div class="personal-story">${m.profile.personal_story || ''}</div>
                        </div>
                    </div>
                `).join('');

            // Always display all members with activity, even if profile is 'Unknown'
            container.innerHTML += members.map(m => `
                <div class="member-card">
                    <img src="${m.profile.avatar_url || 'default-avatar.png'}" alt="Profile Picture">
                    <div class="member-info">
                        <h2>${m.profile.full_name || m.id}</h2>
                        <div class="activity-breakdown">
                            <strong>All-Time Activities:</strong><br>
                            Votes: ${m.breakdown.votes || 0}<br>
                            Suggestions: ${m.breakdown.suggestions || 0}<br>
                            Comments: ${m.breakdown.comments || 0}<br>
                            Wants: ${m.breakdown.wants || 0}<br>
                            Offers: ${m.breakdown.offers || 0}<br>
                            Passion: ${m.breakdown.passion || 0}<br>
                            Projects & Struggles: ${m.breakdown.projects || 0}<br>
                            Help Given: ${m.breakdown.help_hours_recent || 0}<br>
                            Profile Completed: ${m.breakdown.profile ? "✔️" : "—"}<br>
                            Circles Created: ${m.breakdown.circles_created || 0}<br>
                            Events Created: ${m.breakdown.events_created || 0}<br>
                            Events Attended: ${m.breakdown.events_attended || 0}<br>
                            Members Added: ${m.breakdown.members_added || 0}<br>
                            Celebration Wall Posts: ${m.breakdown.celebrations_posted || 0}<br>
                            Projects Proposed: ${m.breakdown.projects_proposed || 0}<br>
                            <strong>Total:</strong> ${m.total}
                        </div>
                        <div class="personal-story">${m.profile.personal_story || ''}</div>
                    </div>
                </div>
            `).join('');
        }

        showMembers();
    </script>
</body>
</html>