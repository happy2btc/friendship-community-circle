<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Request Financial Support</title>
  <style>
    body { font-family: sans-serif; background: #f9f9f9; padding: 2rem; }
    .form-container { max-width: 600px; margin: 0 auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #eee; padding: 2rem; }
    form label, form select, form input, form textarea, form button {
      display: block;
      width: 100%;
      margin-top: 1em;
      box-sizing: border-box;
    }
    form input, form select, form textarea {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1em;
      margin-top: 8px;
    }
    button {
      background: linear-gradient(90deg, #2e8b57 60%, #6b4f1d 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1.1em;
      padding: 14px 0;
      margin-top: 2em;
      text-align: center;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
    }
    button:hover {
      background: linear-gradient(90deg, #6b4f1d 60%, #2e8b57 100%);
      box-shadow: 0 4px 16px rgba(107,79,29,0.18);
    }
    .form-status { margin-top: 1em; text-align: center; font-weight: bold; min-height: 1.5em; }
    .menu-button { display: block; margin: 30px auto 0 auto; background-color: #6b4f1d; color: #fff; padding: 12px 24px; border-radius: 8px; text-align: center; font-weight: bold; text-decoration: none; font-size: 1.1em; width: fit-content; }
    .received-support-section { margin-top: 3rem; padding-top: 2rem; border-top: 2px solid #eee; }
    .received-support-section h3 { color: #2e8b57; }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>ðŸ’¸ Request Financial Support for a Member</h2>
    <form id="support-form">
      <label for="member-in-need">Which member needs support?</label>
      <select id="member-in-need" name="member_in_need_id" required></select>

      <label for="mission-title">Mission/Project Title</label>
      <input type="text" id="mission-title" name="mission_title" required>

      <label for="mission-description">Description of the Mission</label>
      <textarea id="mission-description" name="mission_description" rows="4"></textarea>

      <label for="funding-goal">Funding Goal ($)</label>
      <input type="number" id="funding-goal" name="funding_goal" min="0" step="1">

      <label for="funds-usage">How will the funds be used?</label>
      <textarea id="funds-usage" name="funds_usage_details" rows="3"></textarea>

      <label for="payment-link">Payment Link (e.g., GoFundMe, PayPal.me)</label>
      <input type="url" id="payment-link" name="payment_link" placeholder="https://">

      <label for="payment-link-2">Alternative Payment Link (optional, e.g., Venmo, Cash App)</label>
      <input type="url" id="payment-link-2" name="payment_link_2" placeholder="https://">

      <button type="submit">Submit Request</button>
      <div id="form-status" class="form-status"></div>
    </form>

    <div id="received-support-section" class="received-support-section" style="display:none;">
      <h3>Log Received Support</h3>
      <p>As a recipient of support requests, you can log when you receive funds here.</p>
      <form id="received-support-form">
        <label for="support-sought-select">Support Sought</label>
        <select id="support-sought-select" name="support_sought" required>
          <option value="">Select a support request...</option>
        </select>

        <label for="dollars-received">Dollars Received ($)</label>
        <input type="number" id="dollars-received" name="dollars_received" min="0" step="0.01" required>

        <label for="received-at">Date Received</label>
        <input type="datetime-local" id="received-at" name="received_at" required>

        <button type="submit">Log Received Support</button>
        <div id="received-status" class="form-status"></div>
      </form>
    </div>
  </div>
  <a href="menu.html" class="menu-button">ðŸ”™ Back to Menu</a>

  <script type="module">
    import { supabase } from '/lib/supabase.js';

    async function populateMembers() {
      const { data: profiles, error } = await supabase.from('profiles').select('id, full_name').order('full_name');
      if (error) return;
      const memberSelect = document.getElementById('member-in-need');
      profiles.forEach(profile => {
        const option = document.createElement('option');
        option.value = profile.id;
        option.textContent = profile.full_name;
        memberSelect.appendChild(option);
      });
    }
    populateMembers();

    // Check if user is a recipient and show received support form
    async function checkRecipientStatus() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data: requests, error } = await supabase
        .from('support_requests')
        .select('id, mission_title')
        .eq('member_in_need_id', user.id)
        .eq('status', 'active');

      if (error || !requests || requests.length === 0) return;

      // User is a recipient, show the form
      document.getElementById('received-support-section').style.display = 'block';

      // Populate support sought options
      const select = document.getElementById('support-sought-select');
      requests.forEach(request => {
        const option = document.createElement('option');
        option.value = request.mission_title;
        option.textContent = request.mission_title;
        select.appendChild(option);
      });
    }
    checkRecipientStatus();

    document.getElementById('support-form').onsubmit = async (e) => {
      e.preventDefault();
      const formStatus = document.getElementById('form-status');
      formStatus.textContent = 'Submitting...';
      formStatus.style.color = '#333';

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        formStatus.textContent = 'Error: You must be logged in to submit a request.';
        formStatus.style.color = 'red';
        return;
      }

      const formData = new FormData(e.target);
      const requestData = {
        requestor_id: user.id,
        member_in_need_id: formData.get('member_in_need_id'),
        mission_title: formData.get('mission_title'),
        mission_description: formData.get('mission_description'),
        funding_goal: formData.get('funding_goal') ? parseFloat(formData.get('funding_goal')) : null,
        funds_usage_details: formData.get('funds_usage_details'),
        payment_link: formData.get('payment_link'),
        payment_link_2: formData.get('payment_link_2'),
      };

      const { error } = await supabase.from('support_requests').insert([requestData]);

      if (error) {
        formStatus.textContent = 'Error: ' + error.message;
        formStatus.style.color = 'red';
      } else {
        formStatus.textContent = 'Success! Your support request has been posted.';
        formStatus.style.color = '#2e8b57';
        e.target.reset();
        // Refresh recipient status in case they requested for themselves
        checkRecipientStatus();
      }
    };

    document.getElementById('received-support-form').onsubmit = async (e) => {
      e.preventDefault();
      const receivedStatus = document.getElementById('received-status');
      receivedStatus.textContent = 'Logging...';
      receivedStatus.style.color = '#333';

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        receivedStatus.textContent = 'Error: You must be logged in.';
        receivedStatus.style.color = 'red';
        return;
      }

      const formData = new FormData(e.target);
      const receivedData = {
        recipient_id: user.id,
        support_sought: formData.get('support_sought'),
        dollars_received: parseFloat(formData.get('dollars_received')),
        received_at: formData.get('received_at'),
      };

      const { error } = await supabase.from('support_received').insert([receivedData]);

      if (error) {
        receivedStatus.textContent = 'Error: ' + error.message;
        receivedStatus.style.color = 'red';
      } else {
        receivedStatus.textContent = 'Success! Received support logged.';
        receivedStatus.style.color = '#2e8b57';
        e.target.reset();
      }
    };
  </script>
</body>
</html>