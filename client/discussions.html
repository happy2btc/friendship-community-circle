<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Current Discussions</title>
    <script type="module" src="/lib/supabase.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #e6f7f2; color: #333; margin: 40px; }
        h1 { text-align: center; color: #2e8b57; }
        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .discussion-item { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 4px; }
        .discussion-item h3 { margin-top: 0; }
        button { background-color: #2e8b57; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #3a9d6b; }
        .status { font-style: italic; color: #555; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó£Ô∏è View Current Discussions</h1>
        <a href="menu.html">‚Üê Back to Menu</a>
        <div id="discussion-list">
            <!-- Discussions will be loaded here -->
        </div>
    </div>

    <script type="module">
        import { supabase } from '/lib/supabase.js';

        const discussionList = document.getElementById('discussion-list');
        let currentUser;

        async function getUser() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                currentUser = user;
            } else {
                window.location.href = 'index.html'; // Redirect if not logged in
            }
        }

        async function loadDiscussions() {
            const { data: discussions, error } = await supabase
                .from('suggestions')
                .select('*')
                .eq('status', 'discussion');

            if (error) {
                discussionList.innerHTML = `<p style="color:red;">Error loading discussions: ${error.message}</p>`;
                return;
            }

            if (discussions.length === 0) {
                discussionList.innerHTML = '<p>There are no active discussions right now.</p>';
                return;
            }

            discussionList.innerHTML = '';
            for (const discussion of discussions) {
                const discussionEl = document.createElement('div');
                discussionEl.className = 'discussion-item';
                discussionEl.innerHTML = `
                    <h3>${discussion.suggestion_text}</h3>
                    <p>Proposed by: A community member</p>
                    <button class="propose-btn" data-id="${discussion.id}" data-text="${discussion.suggestion_text}">Propose as Agreement</button>
                    <p class="status" id="status-${discussion.id}">Once submitted, this discussion will move to the voting page.</p>
                `;
                discussionList.appendChild(discussionEl);
            }

            document.querySelectorAll('.propose-btn').forEach(button => {
                button.addEventListener('click', handleProposeClick);
            });
        }

        async function handleProposeClick(event) {
            if (!currentUser) {
                alert('Error: User not found. Please log in again.');
                return;
            }

            const button = event.target;
            const suggestionId = button.dataset.id;
            const agreementText = button.dataset.text;
            const statusEl = document.getElementById(`status-${suggestionId}`);

            button.disabled = true;
            statusEl.textContent = 'Submitting...';

            const endTime = new Date();
            endTime.setHours(endTime.getHours() + 24);

            const { error: insertError } = await supabase
                .from('agreements')
                .insert({
                    agreement_text: agreementText,
                    proposed_by: currentUser.id,
                    end_time: endTime.toISOString(),
                    status: 'polling'
                });

            if (insertError) {
                statusEl.textContent = `Error: ${insertError.message}`;
                statusEl.style.color = 'red';
                button.disabled = false;
                console.error(insertError);
                return;
            }

            const { error: updateError } = await supabase
                .from('suggestions')
                .update({ status: 'complete' })
                .eq('id', suggestionId);
            
            if (updateError) {
                statusEl.textContent = `Agreement created, but failed to update discussion status: ${updateError.message}`;
                return;
            }

            statusEl.textContent = '‚úÖ Success! Moved to voting page.';
            statusEl.style.color = 'green';
        }

        // THIS IS THE FIX: Ensure user is loaded BEFORE loading discussions
        async function init() {
            await getUser();
            if (currentUser) { // Only load discussions if we successfully got a user
                await loadDiscussions();
            }
        }

        init();
    </script>
</body>
</html>