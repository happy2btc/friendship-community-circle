<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Friendship Community Circle</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: 
        linear-gradient(rgba(255,255,255,0.7), rgba(255,255,255,0.7)),
        url('public/from-the-ashes.jpg') no-repeat center center fixed;
  background-size: cover;
  background-repeat: no-repeat;
  background-position: center center;
    }
    h1 {
      text-align: center;
      color: #2e8b57;
      margin-top: 2rem;
      margin-bottom: 2.5rem;
    }
    .main-menu-bar {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 2rem;
  background: #e6f7f2;
  padding: 1.5rem 0 1rem 0;
  box-shadow: 0 2px 8px #eee;
  position: sticky;
  top: 0;
  z-index: 10;
    }
    .menu-dropdown {
      position: relative;
      display: inline-block;
    }
    .menu-btn {
      background: #6b4f1d;
      color: #fff;
      border: none;
      border-radius: 8px 8px 0 0;
      font-weight: bold;
      font-size: 1.1em;
      padding: 12px 24px;
      cursor: pointer;
      transition: background 0.2s;
      min-width: 170px;
      letter-spacing: 0.5px;
    }
    .menu-btn:hover, .menu-dropdown.open .menu-btn {
      background: #2e8b57;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      left: 0;
      top: 100%;
      background: #fff;
      min-width: 220px;
      box-shadow: 0 4px 16px #ccc;
      border-radius: 0 0 10px 10px;
      z-index: 100;
      padding: 0.5em 0;
    }
    .menu-dropdown.open .dropdown-content {
      display: block;
    }
    .dropdown-content a {
      display: block;
      padding: 12px 20px;
      color: #333;
      text-decoration: none;
      font-size: 1em;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }
    .dropdown-content a:last-child {
      border-bottom: none;
    }
    .dropdown-content a:hover {
      background: #e6f7f2;
      color: #2e8b57;
    }
    @media (max-width: 1100px) {
      .main-menu-bar {
        flex-wrap: wrap;
        gap: 1rem;
      }
      .menu-btn {
        min-width: 120px;
        font-size: 1em;
        padding: 10px 10px;
      }
      .dropdown-content {
        min-width: 150px;
      }
    }
    @media (max-width: 700px) {
      .main-menu-bar {
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
      }
      .menu-btn {
        width: 100%;
        min-width: 0;
      }
    }
  </style>
</head>
<body>
  <h1>The Friendship Community Circle</h1>
  <nav class="main-menu-bar">
    <div class="menu-dropdown">
      <button class="menu-btn">Profiles & Members</button>
      <div class="dropdown-content">
  <a href="profile.html">My Profile</a>
  <a href="view-profiles.html">View All Profiles</a>
  <a href="new-members.html">New Members</a>
  <a href="activities.html">Member Activities</a>
  <a href="message-center.html">Message Center</a>
      </div>
    </div>
    <div class="menu-dropdown">
      <button class="menu-btn">Wants & Offers</button>
      <div class="dropdown-content">
        <a href="exchange.html">Wants and Offers</a>
        <a href="view-exchanges.html">Browse All Offerings</a>
      </div>
    </div>
    <div class="menu-dropdown">
      <button class="menu-btn">Projects & Contributions</button>
      <div class="dropdown-content">
  <a href="contribute.html">Submit Project/Struggle</a>
  <a href="group-projects.html">Group Projects</a>
  <a href="skill-shares.html">Skill Shares</a>
  <a href="view-proj-strug.html">View Projects & Struggles</a>
  <a href="community-videos.html">Community Videos</a>
      </div>
    </div>
    <div class="menu-dropdown">
      <button class="menu-btn">Suggestions & Agreements</button>
      <div class="dropdown-content">
  <a href="suggest.html">Make a Suggestion</a>
  <a href="discussions.html">View Current Discussions</a>
  <a href="agreements.html">Proposed Agreements & Voting</a>
  <a href="completed-agreements.html">Completed Agreements</a>
      </div>
    </div>
    <div class="menu-dropdown">
      <button class="menu-btn">Circles</button>
      <div class="dropdown-content">
        <a href="circle-list.html">All Circles</a>
        <a href="create-circle.html">Create a Circle</a>
        <a href="circle-discussion.html">Circle Discussions</a>
      </div>
    </div>
    <!-- Direct link to the Circle Pulse announcements page -->
  <a class="menu-btn" href="Circle-Pulse.html" style="background:#fff3cd;color:#654;display:inline-flex;align-items:center;justify-content:center;">📣 Circle Pulse</a>
    <div class="menu-dropdown">
      <button class="menu-btn">Events & Community</button>
      <div class="dropdown-content">
  <a href="events-calendar.html">Events Calendar</a>
  <a href="events.html">All Events</a>
  <a href="event-details.html">Event Details</a>
  <a href="community-chat.html">Community Chat</a>
  <a href="personal-chat.html">Personal Messages</a>
  <a href="celebration-wall.html">Celebration Wall</a>
  <a href="writer's-wall.html">Writer's Wall</a>
  <a href="inbox.html">Inbox</a>
      </div>
    </div>
    <div class="menu-dropdown">
      <button class="menu-btn">Support & Help</button>
      <div class="dropdown-content">
        <a href="request-support.html">Request Support</a>
        <a href="view-support-requests.html">View Support Requests</a>
        <a href="support-received.html">Support Received</a>
        <a href="submit-help.html">Submit Help Given</a>
        <a href="help-given.html">Help Given</a>
        <a href="mutual-aid.html">Mutual Aid</a>
      </div>
    </div>
  </nav>

  <!-- Welcome and Notification Bell Section -->
  <div class="welcome-box" style="max-width:700px;margin:2em auto 0 auto;">
    <h1 style="display: flex; align-items: center; justify-content: center; gap: 1rem;">
      🌸 Welcome!
      <div id="notification-bell-container" style="position: relative;">
        <button id="notification-bell" style="background: none; border: none; cursor: pointer; position: relative; font-size: 1.7em;">
          🔔
          <span id="notification-count" style="display:none; position: absolute; top: -8px; right: -8px; background: red; color: white; border-radius: 50%; padding: 2px 7px; font-size: 0.8em; font-weight: bold; min-width: 18px; text-align: center;"></span>
        </button>
        <div id="notification-dropdown" style="display: none; position: absolute; right: 0; top: 2.5em; background: #fff; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 8px #eee; min-width: 260px; z-index: 2000; max-height: 350px; overflow-y: auto; overflow-wrap: break-word;">
          <div id="notification-list" style="padding: 0.5em 0.5em 0.5em 0.5em;"></div>
          <div style="text-align: right; padding: 0.5em 0.7em 0.5em 0.5em;">
            <button id="mark-all-read" style="background: #e6f7f2; color: #333; border: none; border-radius: 5px; padding: 4px 10px; font-size: 0.95em; cursor: pointer;">Mark all as read</button>
          </div>
        </div>
      </div>
    </h1>

    <!-- Enable Desktop Notifications Button -->
    <div style="text-align:center; margin: 1.5em 0 1.5em 0;">
      <button id="notif-test-btn" style="background: #2196f3; color: #fff; border: none; border-radius: 6px; padding: 10px 18px; font-size: 1em; font-weight: bold; cursor: pointer;">Enable Desktop Notifications</button>
    </div>

    <!-- Most Active Member and Newest Members Section -->
    <div style="display: flex; gap: 2rem; flex-wrap: wrap; margin-bottom: 2rem; justify-content:center; margin-top: 2em;">
      <div style="flex: 1; min-width: 300px; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #eee; padding: 1rem;">
  <h2>🌟 Most Active Member</h2>
  <div id="most-active-member"></div>
      <div id="community-total" style="margin-top:12px;padding:10px;border-radius:8px;background:#f6fbf9;border:1px solid #e6f7f2;font-weight:700;text-align:center;">Loading community total...</div>
  <script type="module">
    import { supabase } from '/lib/supabase.js';
    async function getActivitiesMostActive() {
      const builderId = "81c50097-74f3-4c7a-b00c-598995b8d1cb";
      const activity = {};
      const breakdown = {};
      // Writer's Wall: tally posts and points per author
      const { data: writersWall } = await supabase
        .from('writers_wall')
        .select('author_id, points');
      if (writersWall) {
        writersWall.forEach(row => {
          if (row.author_id) {
            breakdown[row.author_id] = breakdown[row.author_id] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, help_hours: 0, help_points: 0, help_hours_recent: 0, support_responses: 0, events_created: 0, events_attended: 0, projects_proposed: 0, writer_posts: 0, writer_points: 0 };
            breakdown[row.author_id].writer_posts = (breakdown[row.author_id].writer_posts || 0) + 1;
            breakdown[row.author_id].writer_points = (breakdown[row.author_id].writer_points || 0) + (row.points || 0);
          }
        });
      }
      // Count help given (5 points per hour)
      const { data: helpGiven } = await supabase
        .from('help_given')
        .select('helper_id, hours')
        .order('created_at', { ascending: false });
      const helpByUser = {};
      const helpByUserRecent = {};
      helpGiven?.forEach(row => {
        if (row.helper_id && row.hours && row.helper_id !== builderId) {
          helpByUser[row.helper_id] = (helpByUser[row.helper_id] || 0) + Number(row.hours);
          helpByUserRecent[row.helper_id] = helpByUserRecent[row.helper_id] || [];
          helpByUserRecent[row.helper_id].push(Number(row.hours));
        }
      });
      Object.entries(helpByUser).forEach(([userId, hours]) => {
        breakdown[userId] = breakdown[userId] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, help_hours: 0, help_points: 0, help_hours_recent: 0, support_responses: 0 };
        breakdown[userId].help_hours = hours;
        breakdown[userId].help_points = hours * 5;
        breakdown[userId].help_hours_recent = (helpByUserRecent[userId] || []).reduce((a, b) => a + b, 0);
        activity[userId] = (activity[userId] || 0) + (hours * 5);
      });
      // Count events attended (5 points each, from event_attendance table)
      const { data: attendedActs } = await supabase
        .from('event_attendance')
        .select('user_id');
      const attendedByUser = {};
      attendedActs?.forEach(row => {
        if (row.user_id && row.user_id !== builderId) {
          attendedByUser[row.user_id] = (attendedByUser[row.user_id] || 0) + 1;
        }
      });
      Object.entries(attendedByUser).forEach(([userId, count]) => {
        breakdown[userId] = breakdown[userId] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, events_created: 0, events_attended: 0, projects_proposed: 0, support_responses: 0 };
        breakdown[userId].events_attended = count;
        activity[userId] = (activity[userId] || 0) + (count * 5);
      });
      // Count events created (5 points each)
      const { data: events } = await supabase
        .from('events')
        .select('created_by');
      const eventsByUser = {};
      events?.forEach(ev => {
        if (ev.created_by && ev.created_by !== builderId) {
          eventsByUser[ev.created_by] = (eventsByUser[ev.created_by] || 0) + 1;
        }
      });
      Object.entries(eventsByUser).forEach(([userId, count]) => {
        breakdown[userId] = breakdown[userId] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, events_created: 0, support_responses: 0 };
        breakdown[userId].events_created = count;
        activity[userId] = (activity[userId] || 0) + (count * 5);
      });
      // Count support responses (5 points each)
      const { data: supportResponses } = await supabase
        .from('support_responses')
        .select('responder_id');
      const responsesByUser = {};
      supportResponses?.forEach(sr => {
        if (sr.responder_id && sr.responder_id !== builderId) {
          responsesByUser[sr.responder_id] = (responsesByUser[sr.responder_id] || 0) + 1;
        }
      });
      Object.entries(responsesByUser).forEach(([userId, count]) => {
        breakdown[userId] = breakdown[userId] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, events_created: 0, events_attended: 0, projects_proposed: 0, support_responses: 0 };
        breakdown[userId].support_responses = count;
        activity[userId] = (activity[userId] || 0) + (count * 5);
      });
      // Restore missing queries for legacy activities
      const { data: votes } = await supabase
        .from('agreement_votes')
        .select('voter_id, created_at');
      const { data: suggestions } = await supabase
        .from('suggestions')
        .select('author_id, created_at');
      const { data: comments } = await supabase
        .from('comments')
        .select('author_id, created_at');
      const { data: offerings } = await supabase
        .from('member_offerings')
        .select('user_id, want, give, passion');
      const { data: contributions } = await supabase
        .from('contributions')
        .select('user_id, project, challenge, help, collab, skills, urgency, contact');
      const { data: profilesFull } = await supabase
        .from('profiles')
        .select('id, full_name, bio, avatar_url, youtube, twitter, substack, facebook, instagram, linkedin, website');
      const { data: circles } = await supabase
        .from('circles')
        .select('created_by');
      const { data: membersData } = await supabase
        .from('circle_members')
        .select('added_by');
      const { data: celebrations } = await supabase
        .from('celebrations')
        .select('user_id');
      const { data: groupProjects } = await supabase
        .from('group_projects')
        .select('proposer_id');
      votes?.forEach(v => {
        if (v.voter_id !== builderId) {
          activity[v.voter_id] = (activity[v.voter_id] || 0) + 1;
          breakdown[v.voter_id] = breakdown[v.voter_id] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
          breakdown[v.voter_id].votes += 1;
        }
      });
      suggestions?.forEach(s => {
        if (s.author_id !== builderId) {
          activity[s.author_id] = (activity[s.author_id] || 0) + 1;
          breakdown[s.author_id] = breakdown[s.author_id] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
          breakdown[s.author_id].suggestions += 1;
        }
      });
      comments?.forEach(c => {
        if (c.author_id !== builderId) {
          activity[c.author_id] = (activity[c.author_id] || 0) + 1;
          breakdown[c.author_id] = breakdown[c.author_id] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
          breakdown[c.author_id].comments += 1;
        }
      });
      const proposalsByUser = {};
      groupProjects?.forEach(gp => {
        if (gp.proposer_id && gp.proposer_id !== builderId) {
          proposalsByUser[gp.proposer_id] = (proposalsByUser[gp.proposer_id] || 0) + 1;
        }
      });
      Object.entries(proposalsByUser).forEach(([userId, count]) => {
        breakdown[userId] = breakdown[userId] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
        breakdown[userId].projects_proposed = count;
        activity[userId] = (activity[userId] || 0) + (count * 5);
      });
      offerings?.forEach(o => {
        if (o.user_id !== builderId) {
          let points = 0;
          breakdown[o.user_id] = breakdown[o.user_id] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
          if (o.want && o.want.trim() !== "") { breakdown[o.user_id].wants += 1; points += 1; }
          if (o.give && o.give.trim() !== "") { breakdown[o.user_id].offers += 1; points += 1; }
          if (o.passion && o.passion.trim() !== "") { breakdown[o.user_id].passion += 1; points += 1; }
          activity[o.user_id] = (activity[o.user_id] || 0) + points;
        }
      });
      const contribByUser = {};
      contributions?.forEach(con => {
        if (con.user_id !== builderId) {
          if (!contribByUser[con.user_id]) contribByUser[con.user_id] = [];
          contribByUser[con.user_id].push(con);
        }
      });
      Object.entries(contribByUser).forEach(([userId, contribs]) => {
        breakdown[userId] = breakdown[userId] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
        let fieldsFilled = 0;
        contribs.forEach(con => {
          ['project','challenge','help','collab','skills','urgency','contact'].forEach(field => {
            if (con[field] && con[field].trim() !== '') {
              fieldsFilled += 1;
            }
          });
        });
        breakdown[userId].projects += fieldsFilled;
        activity[userId] = (activity[userId] || 0) + fieldsFilled;
      });
      profilesFull?.forEach(p => {
        if (p.id !== builderId) {
          let filled = 0;
          if (p.full_name && p.full_name.trim() !== "") filled++;
          if (p.bio && p.bio.trim() !== "") filled++;
          if (p.avatar_url && p.avatar_url.trim() !== "") filled++;
          if (p.youtube || p.twitter || p.substack || p.facebook || p.instagram || p.linkedin || p.website) filled++;
          if (filled >= 2) {
            breakdown[p.id] = breakdown[p.id] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
            breakdown[p.id].profile = 1;
            activity[p.id] = (activity[p.id] || 0) + 5;
          }
        }
      });
      circles?.forEach(c => {
        if (c.created_by && c.created_by !== builderId) {
          activity[c.created_by] = (activity[c.created_by] || 0) + 10;
          breakdown[c.created_by] = breakdown[c.created_by] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
          breakdown[c.created_by].circles_created = (breakdown[c.created_by].circles_created || 0) + 1;
        }
      });
      membersData?.forEach(m => {
        if (m.added_by && m.added_by !== builderId) {
          activity[m.added_by] = (activity[m.added_by] || 0) + 2;
          breakdown[m.added_by] = breakdown[m.added_by] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
          breakdown[m.added_by].members_added = (breakdown[m.added_by].members_added || 0) + 1;
        }
      });
      celebrations?.forEach(c => {
        if (c.user_id && c.user_id !== builderId) {
          activity[c.user_id] = (activity[c.user_id] || 0) + 5;
          breakdown[c.user_id] = breakdown[c.user_id] || { votes: 0, suggestions: 0, comments: 0, wants: 0, offers: 0, passion: 0, projects: 0, profile: 0, circles_created: 0, members_added: 0, celebrations_posted: 0, support_responses: 0 };
          breakdown[c.user_id].celebrations_posted = (breakdown[c.user_id].celebrations_posted || 0) + 1;
        }
      });
      const userIds = Object.keys(activity).filter(id => id && id !== 'null');
      if (userIds.length === 0) return [];
      const { data: profiles } = await supabase
        .from('profiles')
        .select('id, full_name, avatar_url, personal_story');
      const idToProfile = {};
      profiles?.forEach(p => { idToProfile[p.id] = p; });
      const members = userIds.map(id => ({
        id,
        profile: idToProfile[id] || { full_name: id, avatar_url: '', personal_story: '' },
        total: activity[id],
        breakdown: breakdown[id]
      }));
      members.sort((a, b) => b.total - a.total);
      return members;
    }
    async function showMostActiveMemberActivities() {
      const members = await getActivitiesMostActive();
      const container = document.getElementById('most-active-member');
      if (!members || members.length === 0) {
        container.innerHTML = "<em>No member activities yet.</em>";
        return;
      }
      const m = members[0];
      container.innerHTML = `
        <a href="view-profile.html?id=${m.id}" style="text-decoration: none; color: inherit; display: block;">
            <img src="${m.profile.avatar_url || 'default-avatar.png'}" alt="Profile Picture" style="width:64px;height:64px;border-radius:50%;object-fit:cover;margin-bottom:1em;">
            <h3>${m.profile.full_name}</h3>
            <div class="activity-breakdown" style="margin-top:0.5em;">
                <strong>Total:</strong> ${m.total}
            </div>
            <div class="personal-story">${m.profile.personal_story || ''}</div>
        </a>`;
    }
    showMostActiveMemberActivities();
  </script>
  <a href="welcome.html" class="menu-button" style="background:#ffe082;color:#6b4f1d;font-weight:bold;margin-top:1.2em;display:inline-block;">👋 In Case You Missed It</a>
      </div>
      <div style="flex: 1; min-width: 300px; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #eee; padding: 1rem;">
  <h2>🆕 Newest Members</h2>
  <div id="newest-member"></div>
  <a href="what's-new.html" class="menu-button" style="background:#b3c6e6;color:#2e2e2e;font-weight:bold;margin-top:1.2em;display:inline-block;">🆕 What's New</a>
      </div>
    </div>
  </div>
  <script>
    // Dropdown open/close logic
    document.querySelectorAll('.menu-dropdown').forEach(drop => {
      const btn = drop.querySelector('.menu-btn');
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        // Close all other dropdowns
        document.querySelectorAll('.menu-dropdown').forEach(d => {
          if (d !== drop) d.classList.remove('open');
        });
        drop.classList.toggle('open');
      });
    });
    document.addEventListener('click', function() {
      document.querySelectorAll('.menu-dropdown').forEach(d => d.classList.remove('open'));
    });
  </script>

<script type="module">
  // --- Most Active Member ---
  async function showMostActiveMember() {
    // Fetch all activities
    const [votesRes, suggestionsRes, commentsRes, offeringsRes, contributionsRes, profilesFullRes, circlesRes, membersRes, celebrationsRes, eventsRes, helpGivenRes, supportResponsesRes, writersWallRes] = await Promise.all([
      supabase.from('agreement_votes').select('voter_id, created_at'),
      supabase.from('suggestions').select('author_id, created_at'),
      supabase.from('comments').select('author_id, created_at'),
      supabase.from('member_offerings').select('user_id, want, give, passion'),
      supabase.from('contributions').select('user_id, project, challenge, help, collab, skills, urgency, contact'),
      supabase.from('profiles').select('id, full_name, avatar_url, personal_story, bio, youtube, twitter, substack, facebook, instagram, linkedin, website'),
      supabase.from('circles').select('id, name, created_by'),
      supabase.from('circle_members').select('added_by'),
      supabase.from('celebrations').select('user_id'),
      supabase.from('events').select('id, created_by'),
      supabase.from('help_given').select('helper_id, hours'),
      supabase.from('support_responses').select('responder_id'),
      supabase.from('writers_wall').select('author_id, points')
    ]);
    let attendanceRes = await supabase.from('event_attendance').select('event_id, user_id');
    const builderId = "81c50097-74f3-4c7a-b00c-598995b8d1cb";
    const breakdown = {};
    function initBreakdown(id) {
      if (!breakdown[id]) {
        breakdown[id] = {
          votes: 0,
          suggestions: 0,
          comments: 0,
          wants: 0,
          offers: 0,
          passion: 0,
          projects: 0,
          profile: 0,
          circles_created: 0,
          members_added: 0,
          celebrations_posted: 0,
          events_created: 0,
          events_attended: 0,
          help_hours: 0,
          help_points: 0,
          support_responses: 0,
          writer_posts: 0,
          writer_points: 0
        };
      }
    }
    // Help Given: tally hours and points per helper
    if (helpGivenRes.data) {
      helpGivenRes.data.forEach(row => {
        if (row.helper_id && row.hours && row.helper_id !== builderId) {
          initBreakdown(row.helper_id);
          breakdown[row.helper_id].help_hours = (Number(breakdown[row.helper_id].help_hours) || 0) + Number(row.hours);
          breakdown[row.helper_id].help_points = (breakdown[row.helper_id].help_points || 0) + (row.hours * 5);
        }
      });
    }
    // Support Responses
    if (supportResponsesRes.data) {
      supportResponsesRes.data.forEach(row => {
        if (row.responder_id && row.responder_id !== builderId) {
          initBreakdown(row.responder_id);
          breakdown[row.responder_id].support_responses = (breakdown[row.responder_id].support_responses || 0) + 1;
        }
      });
    }
    // Votes
    votesRes.data?.forEach(v => {
      if (v.voter_id !== builderId) {
        initBreakdown(v.voter_id);
        breakdown[v.voter_id].votes += 1;
      }
    });
    // Suggestions
    suggestionsRes.data?.forEach(s => {
      if (s.author_id !== builderId) {
        initBreakdown(s.author_id);
        breakdown[s.author_id].suggestions += 1;
      }
    });
    // Comments
    commentsRes.data?.forEach(c => {
      if (c.author_id !== builderId) {
        initBreakdown(c.author_id);
        breakdown[c.author_id].comments += 1;
      }
    });
    // Wants, Offers, Passion
    offeringsRes.data?.forEach(o => {
      if (o.user_id !== builderId) {
        initBreakdown(o.user_id);
        if (o.want && o.want.trim() !== "") breakdown[o.user_id].wants += 1;
        if (o.give && o.give.trim() !== "") breakdown[o.user_id].offers += 1;
        if (o.passion && o.passion.trim() !== "") breakdown[o.user_id].passion += 1;
      }
    });
    // Projects & Struggles
    const contribByUser = {};
    contributionsRes.data?.forEach(con => {
      if (con.user_id !== builderId) {
        if (!contribByUser[con.user_id]) contribByUser[con.user_id] = [];
        contribByUser[con.user_id].push(con);
      }
    });
    Object.entries(contribByUser).forEach(([userId, contribs]) => {
      initBreakdown(userId);
      let fieldsFilled = 0;
      contribs.forEach(con => {
        ['project','challenge','help','collab','skills','urgency','contact'].forEach(field => {
          if (con[field] && con[field].trim() !== '') {
            fieldsFilled += 1;
          }
        });
      });
      breakdown[userId].projects += fieldsFilled;
    });
    // Profile completion
    profilesFullRes.data?.forEach(p => {
      if (p.id !== builderId) {
        let filled = 0;
        if (p.full_name && p.full_name.trim() !== "") filled++;
        if (p.bio && p.bio.trim() !== "") filled++;
        if (p.avatar_url && p.avatar_url.trim() !== "") filled++;
        if (p.youtube || p.twitter || p.substack || p.facebook || p.instagram || p.linkedin || p.website) filled++;
        if (filled >= 2) {
          initBreakdown(p.id);
          breakdown[p.id].profile = 1;
        }
      }
    });
    // Circles created: credit by created_by (profile id)
    if (Array.isArray(circlesRes.data)) {
      circlesRes.data.forEach(c => {
        const creatorId = c && c.created_by;
        if (creatorId && typeof creatorId === 'string' && creatorId.trim() !== '' && creatorId !== builderId) {
          initBreakdown(creatorId);
          breakdown[creatorId].circles_created += 1;
        }
      });
    } else if (circlesRes.data && typeof circlesRes.data === 'object' && circlesRes.data.created_by) {
      const creatorId = circlesRes.data.created_by;
      if (creatorId && typeof creatorId === 'string' && creatorId.trim() !== '' && creatorId !== builderId) {
        initBreakdown(creatorId);
        breakdown[creatorId].circles_created += 1;
      }
    }
    // Members added
    membersRes.data?.forEach(m => {
      const userId = m.added_by || m.user_id;
      if (userId && typeof userId === 'string' && userId.trim() !== '' && userId !== builderId) {
        initBreakdown(userId);
        breakdown[userId].members_added += 1;
      }
    });
    // Celebration wall posts
    celebrationsRes.data?.forEach(c => {
      const userId = c.user_id || c.creator_id;
      if (userId && typeof userId === 'string' && userId.trim() !== '' && userId !== builderId) {
        initBreakdown(userId);
        breakdown[userId].celebrations_posted += 1;
      }
    });
    // Events created
    eventsRes.data?.forEach(e => {
      const creatorId = e.created_by;
      if (creatorId && typeof creatorId === 'string' && creatorId.trim() !== '' && creatorId !== builderId) {
        initBreakdown(creatorId);
        breakdown[creatorId].events_created += 1;
      }
    });
    // Events attended
    attendanceRes.data?.forEach(a => {
      const userId = a.user_id;
      if (userId && typeof userId === 'string' && userId.trim() !== '' && userId !== builderId) {
        initBreakdown(userId);
        breakdown[userId].events_attended += 1;
      }
    });
    // Writer's Wall: tally posts and points per author
    if (writersWallRes.data) {
      writersWallRes.data.forEach(row => {
        if (row.author_id) {
          initBreakdown(row.author_id);
          breakdown[row.author_id].writer_posts = (breakdown[row.author_id].writer_posts || 0) + 1;
          breakdown[row.author_id].writer_points = (breakdown[row.author_id].writer_points || 0) + (row.points || 0);
        }
      });
    }
    // Get profiles for display
    const idToProfile = {};
    if (Array.isArray(profilesFullRes.data)) {
      profilesFullRes.data.forEach(p => {
        if (p && typeof p.id === 'string' && p.id.trim() !== '') {
          idToProfile[p.id] = p;
        }
      });
    }
    // Build member activity list
    const userIds = Object.keys(breakdown).filter(id => id && id !== 'null');
    const container = document.getElementById('most-active-member');
    container.innerHTML = '';
    if (userIds.length === 0) {
      container.innerHTML = `<em>No other member has been active.</em>`;
      return;
    }
    // Calculate total for each user
    const members = userIds.map(id => {
      const b = breakdown[id];
      const profile = idToProfile[id] || { full_name: id, avatar_url: '', personal_story: '' };
      const total =
        (b.votes || 0) * 1 +
        (b.suggestions || 0) * 1 +
        (b.comments || 0) * 1 +
        (b.wants || 0) * 1 +
        (b.offers || 0) * 1 +
        (b.passion || 0) * 1 +
        (b.projects || 0) * 1 +
        (b.projects_proposed || 0) * 5 +
        (b.events_created || 0) * 5 +
        (b.events_attended || 0) * 5 +
        (b.profile || 0) * 5 +
        (b.circles_created || 0) * 10 +
        (b.members_added || 0) * 2 +
        (b.celebrations_posted || 0) * 5 +
        (b.help_points || 0) +
        (b.support_responses || 0) * 5 +
        (b.writer_points || 0);
      return {
        id,
        profile,
        total,
        breakdown: b
      };
    });
    members.sort((a, b) => b.total - a.total);
    // Show most active member at the top
    const m = members[0];
    container.innerHTML += `
      <a href="view-profile.html?id=${m.id}" style="text-decoration: none; color: inherit; display: block;">
          <img src="${m.profile.avatar_url && m.profile.avatar_url.trim() !== '' ? m.profile.avatar_url : 'default-avatar.png'}" alt="Profile Picture" style="width:64px;height:64px;border-radius:50%;object-fit:cover;margin-bottom:1em;">
          <h3>${m.profile.full_name}</h3>
          <div class="activity-breakdown" style="margin-top:0.5em;">
              <strong>All-Time Activities:</strong><br>
              Votes: ${m.breakdown.votes || 0}<br>
              Suggestions: ${m.breakdown.suggestions || 0}<br>
              Comments: ${m.breakdown.comments || 0}<br>
              Wants: ${m.breakdown.wants || 0}<br>
              Offers: ${m.breakdown.offers || 0}<br>
              Passion: ${m.breakdown.passion || 0}<br>
              Projects & Struggles: ${m.breakdown.projects || 0}<br>
              <span style="color:#2e8b57;font-weight:bold;">Help Given: ${m.breakdown.help_hours || 0} hours</span><br>
              Events Created: ${m.breakdown.events_created || 0}<br>
              Events Attended: ${m.breakdown.events_attended || 0}<br>
              Profile Completed: ${m.breakdown.profile ? "✔️" : "—"}<br>
              Circles Created: ${m.breakdown.circles_created || 0}<br>
              Members Added: ${m.breakdown.members_added || 0}<br>
              Celebration Wall Posts: ${m.breakdown.celebrations_posted || 0}<br>
              Support Responses: ${m.breakdown.support_responses || 0}<br>
              <span style="color:#4a7c59;font-weight:bold;">Writer's Posts: ${m.breakdown.writer_posts || 0}</span><br>
              <strong>Total:</strong> ${m.total}
          </div>
          <div class="personal-story">${m.profile.personal_story || ''}</div>
      </a>`;
  }

  // --- Community total derived from activities breakdown ---
  async function computeActivitiesTotals() {
    const builderId = "81c50097-74f3-4c7a-b00c-598995b8d1cb";
    const activity = {};
    const breakdown = {};

    const [writersWallRes, helpGivenRes, attendanceRes, eventsRes, supportResponsesRes, votesRes, suggestionsRes, commentsRes, offeringsRes, contributionsRes, profilesFullRes, circlesRes, membersRes, celebrationsRes, groupProjectsRes] = await Promise.all([
      supabase.from('writers_wall').select('author_id, points'),
      supabase.from('help_given').select('helper_id, hours'),
      supabase.from('event_attendance').select('user_id'),
      supabase.from('events').select('created_by'),
      supabase.from('support_responses').select('responder_id'),
      supabase.from('agreement_votes').select('voter_id'),
      supabase.from('suggestions').select('author_id'),
      supabase.from('comments').select('author_id'),
      supabase.from('member_offerings').select('user_id, want, give, passion'),
      supabase.from('contributions').select('user_id, project, challenge, help, collab, skills, urgency, contact'),
      supabase.from('profiles').select('id'),
      supabase.from('circles').select('created_by'),
      supabase.from('circle_members').select('added_by'),
      supabase.from('celebrations').select('user_id'),
      supabase.from('group_projects').select('proposer_id')
    ]);

    // helper to init
    function initBreak(id) {
      if (!breakdown[id]) breakdown[id] = {};
    }

    // Writers wall
    (writersWallRes.data || []).forEach(r => {
      if (r.author_id && r.author_id !== builderId) {
        initBreak(r.author_id);
        breakdown[r.author_id].writer_points = (breakdown[r.author_id].writer_points || 0) + (r.points || 0);
        breakdown[r.author_id].writer_posts = (breakdown[r.author_id].writer_posts || 0) + 1;
        activity[r.author_id] = (activity[r.author_id] || 0) + (r.points || 0);
      }
    });

    // Help given
    (helpGivenRes.data || []).forEach(r => {
      if (r.helper_id && r.helper_id !== builderId) {
        initBreak(r.helper_id);
        breakdown[r.helper_id].help_hours = (breakdown[r.helper_id].help_hours || 0) + Number(r.hours || 0);
        breakdown[r.helper_id].help_points = (breakdown[r.helper_id].help_points || 0) + (Number(r.hours || 0) * 5);
        activity[r.helper_id] = (activity[r.helper_id] || 0) + (Number(r.hours || 0) * 5);
      }
    });

    // Event attendance
    const attendedBy = {};
    (attendanceRes.data || []).forEach(a => { if (a.user_id && a.user_id !== builderId) attendedBy[a.user_id] = (attendedBy[a.user_id] || 0) + 1; });
    Object.entries(attendedBy).forEach(([id, count]) => { activity[id] = (activity[id] || 0) + (count * 5); });

    // Events created
    (eventsRes.data || []).forEach(e => { if (e.created_by && e.created_by !== builderId) activity[e.created_by] = (activity[e.created_by] || 0) + 5; });

    // Support responses
    (supportResponsesRes.data || []).forEach(r => { if (r.responder_id && r.responder_id !== builderId) activity[r.responder_id] = (activity[r.responder_id] || 0) + 5; });

    // Votes, suggestions, comments
    (votesRes.data || []).forEach(v => { if (v.voter_id && v.voter_id !== builderId) activity[v.voter_id] = (activity[v.voter_id] || 0) + 1; });
    (suggestionsRes.data || []).forEach(s => { if (s.author_id && s.author_id !== builderId) activity[s.author_id] = (activity[s.author_id] || 0) + 1; });
    (commentsRes.data || []).forEach(c => { if (c.author_id && c.author_id !== builderId) activity[c.author_id] = (activity[c.author_id] || 0) + 1; });

    // Offerings
    (offeringsRes.data || []).forEach(o => {
      if (o.user_id && o.user_id !== builderId) {
        let points = 0;
        if (o.want && o.want.trim()) points += 1;
        if (o.give && o.give.trim()) points += 1;
        if (o.passion && o.passion.trim()) points += 1;
        activity[o.user_id] = (activity[o.user_id] || 0) + points;
      }
    });

    // Contributions (fields filled)
    const contribByUser = {};
    (contributionsRes.data || []).forEach(con => {
      if (con.user_id && con.user_id !== builderId) {
        contribByUser[con.user_id] = contribByUser[con.user_id] || [];
        contribByUser[con.user_id].push(con);
      }
    });
    Object.entries(contribByUser).forEach(([id, list]) => {
      let fields = 0;
      list.forEach(con => { ['project','challenge','help','collab','skills','urgency','contact'].forEach(f => { if (con[f] && con[f].toString().trim() !== '') fields++; }); });
      activity[id] = (activity[id] || 0) + fields;
    });

    // Profile completion
    (profilesFullRes.data || []).forEach(p => {
      if (p.id && p.id !== builderId) {
        // very light check - award 5 if filled
        activity[p.id] = (activity[p.id] || 0) + 0; // handled elsewhere if needed
      }
    });

    // Circles created
    (circlesRes.data || []).forEach(c => { if (c.created_by && c.created_by !== builderId) activity[c.created_by] = (activity[c.created_by] || 0) + 10; });
    // Members added
    (membersRes.data || []).forEach(m => { if (m.added_by && m.added_by !== builderId) activity[m.added_by] = (activity[m.added_by] || 0) + 2; });
    // Celebrations
    (celebrationsRes.data || []).forEach(c => { if (c.user_id && c.user_id !== builderId) activity[c.user_id] = (activity[c.user_id] || 0) + 5; });
    // Group project proposals
    (groupProjectsRes.data || []).forEach(gp => { if (gp.proposer_id && gp.proposer_id !== builderId) activity[gp.proposer_id] = (activity[gp.proposer_id] || 0) + 5; });

    // Build members list and totals
    const userIds = Object.keys(activity).filter(id => id && id !== 'null');
    const { data: profiles } = await supabase.from('profiles').select('id, full_name, avatar_url');
    const idToProfile = {};
    (profiles || []).forEach(p => { idToProfile[p.id] = p; });
    const members = userIds.map(id => ({ id, profile: idToProfile[id] || { full_name: id }, total: activity[id] }));
    members.sort((a,b) => b.total - a.total);
    return members;
  }

  async function loadCommunityTotal() {
    const el = document.getElementById('community-total');
    if (!el) return;
    el.textContent = 'Loading community total...';
    try {
      const members = await computeActivitiesTotals();
      const total = (members || []).reduce((s,m) => s + (Number(m.total) || 0), 0);
      el.textContent = `Community Total Achievement Points: ${total}`;
    } catch (err) {
      console.error('Error computing community total from activities:', err);
      el.textContent = 'Community total unavailable';
    }
  }

  // realtime listeners for tables that affect activity totals
  function subscribeActivityChanges() {
    const tables = ['agreement_votes','suggestions','comments','member_offerings','contributions','profiles','circles','circle_members','celebrations','events','help_given','support_responses','writers_wall','event_attendance','group_projects'];
    tables.forEach(t => {
      try {
        supabase.from(t).on('*', payload => {
          // debounce-ish: schedule a refresh shortly
          if (window._communityTotalTimer) clearTimeout(window._communityTotalTimer);
          window._communityTotalTimer = setTimeout(loadCommunityTotal, 500);
        }).subscribe();
      } catch (e) { console.warn('Realtime subscribe failed for', t, e); }
    });
  }

  loadCommunityTotal();
  subscribeActivityChanges();

  // --- Newest Members ---
  async function showNewestMember() {
    const cutoffDate = new Date('2025-09-19T00:00:00Z');
    const { data: profiles } = await supabase
      .from('profiles')
      .select('id, full_name, avatar_url, affirmation_text, affirmation_date')
      .order('affirmation_date', { ascending: false });
    const recentProfiles = (profiles || [])
      .filter(p => p.affirmation_date && new Date(p.affirmation_date) >= cutoffDate)
      .sort((a, b) => new Date(b.affirmation_date) - new Date(a.affirmation_date))
      .slice(0, 3); // Show up to 3 recent members

    const newestMemberDiv = document.getElementById('newest-member');
    newestMemberDiv.innerHTML = '';
    if (recentProfiles.length === 0) {
      newestMemberDiv.innerHTML = "<em>No new member since 9/19/2025.</em>";
      return;
    }
    for (const profile of recentProfiles) {
      // Get circles for this member (membership)
      const { data: memberCircles } = await supabase
        .from('circle_members')
        .select('circle_id')
        .eq('user_id', profile.id);
      // Get circles created by this member (credit)
      const { data: createdCircles } = await supabase
        .from('circles')
        .select('id, name')
        .eq('created_by', profile.id);
      let circleNames = [];
      // Always add circles created by member, marked as creator
      let createdNames = [];
      if (createdCircles && createdCircles.length > 0) {
        for (const c of createdCircles) {
          createdNames.push(c.name);
          circleNames.push(c.name + ' (creator)');
        }
      }
      // Add circles where member is a member, but not already credited as creator
      if (memberCircles && memberCircles.length > 0) {
        const circleIds = memberCircles.map(c => c.circle_id);
        const { data: circleData } = await supabase
          .from('circles')
          .select('id, name')
          .in('id', circleIds);
        if (circleData) {
          for (const c of circleData) {
            // Only add if not already credited as creator (by name)
            if (!createdNames.includes(c.name) && !circleNames.includes(c.name)) {
              circleNames.push(c.name);
            }
          }
        }
      }

      const memberCard = document.createElement('a');
      memberCard.href = `view-profile.html?id=${profile.id}`;
      memberCard.className = 'member-card';
      memberCard.style.marginBottom = '1em';
      memberCard.style.textDecoration = 'none';
      memberCard.style.color = 'inherit';
      memberCard.style.display = 'block';
      // Use avatar_url or default
      const avatarUrl = profile.avatar_url && profile.avatar_url.trim() !== ''
        ? profile.avatar_url
        : 'public/default-avatar.png';
      memberCard.innerHTML = `
          <img src="${avatarUrl}" alt="Profile Picture" style="width:64px;height:64px;border-radius:50%;object-fit:cover;margin-bottom:0.5em;">
          <strong>${profile.full_name || 'Unnamed Member'}</strong>
          <div style="color:#888;">Joined: ${profile.affirmation_date ? new Date(profile.affirmation_date).toLocaleDateString() : '—'}</div>
          <div style="color:#555;">Circles: ${circleNames.length ? circleNames.join(', ') : 'None'}</div>
      `;
      newestMemberDiv.appendChild(memberCard);
    }
  }

  showMostActiveMember();
  showNewestMember();
  // --- Desktop Notification Permission & Test ---
  async function requestAndShowNotification() {
    if (!('Notification' in window)) {
      alert('This browser does not support desktop notification');
      return;
    }
    let permission = Notification.permission;
    if (permission === 'default') {
      try {
        permission = await Notification.requestPermission();
      } catch (e) {
        alert('Error requesting notification permission: ' + e);
        return;
      }
    }
    if (permission === 'granted') {
      alert('Permission granted! Showing test notification.');
      new Notification('🔔 Friendship Community Circle', {
        body: 'This is a test notification! You will see real notifications here soon.',
        icon: '/default-avatar.png'
      });
    } else {
      alert('Notifications are blocked or denied. Please enable them in your browser settings.');
    }
  }

  // --- Notification Bell Logic ---
  import { supabase } from './lib/supabase.js';
  const bell = document.getElementById('notification-bell');
  const dropdown = document.getElementById('notification-dropdown');
  const notifCount = document.getElementById('notification-count');
  const notifList = document.getElementById('notification-list');
  const markAllReadBtn = document.getElementById('mark-all-read');
  let notifications = [];
  let unreadCount = 0;
  let pollingInterval = null;
  function showDropdown(show) {
    dropdown.style.display = show ? 'block' : 'none';
  }
  bell.addEventListener('click', (e) => {
    e.stopPropagation();
    showDropdown(dropdown.style.display !== 'block');
  });
  document.addEventListener('click', (e) => {
    if (!dropdown.contains(e.target) && e.target !== bell) {
      showDropdown(false);
    }
  });
  async function fetchNotifications() {
    const { data: userData } = await supabase.auth.getUser();
    const userId = userData?.user?.id;
    if (!userId) return;
    const { data, error } = await supabase
      .from('notifications')
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: false })
      .limit(20);
    if (error) {
      notifList.innerHTML = '<em>Error loading notifications</em>';
      notifCount.style.display = 'none';
      return;
    }
    notifications = data || [];
    unreadCount = notifications.filter(n => !n.read).length;
    renderNotifications();
  }
  function renderNotifications() {
    notifList.innerHTML = '';
    if (!notifications.length) {
      notifList.innerHTML = '<em>No notifications</em>';
      notifCount.style.display = 'none';
      return;
    }
    notifications.forEach(n => {
      const div = document.createElement('div');
      div.style.padding = '0.5em 0.2em';
      div.style.borderBottom = '1px solid #eee';
      div.style.background = n.read ? '#f7f7f7' : '#e6f7f2';
      div.style.cursor = 'pointer';
      div.innerHTML = `<span style="font-size:1.1em;">${n.icon || '🔔'}</span> <span style="font-size:12pt;">${n.message}</span><br><span style="font-size:0.85em;color:#888;">${new Date(n.created_at).toLocaleString()}</span>`;
      if (!n.read) {
        div.style.fontWeight = 'bold';
      }
      div.addEventListener('click', async () => {
        if (!n.read) {
          await markNotificationRead(n.id);
          n.read = true;
          renderNotifications();
        }
        if (n.link) {
          window.location.href = n.link;
        }
      });
      notifList.appendChild(div);
    });
    if (unreadCount > 0) {
      notifCount.textContent = unreadCount;
      notifCount.style.display = 'inline-block';
    } else {
      notifCount.style.display = 'none';
    }
  }
  async function markNotificationRead(id) {
    await supabase.from('notifications').update({ read: true }).eq('id', id);
    fetchNotifications();
  }
  markAllReadBtn.addEventListener('click', async () => {
    const { data: userData } = await supabase.auth.getUser();
    const userId = userData?.user?.id;
    if (!userId) return;
    await supabase.from('notifications').update({ read: true }).eq('user_id', userId);
    fetchNotifications();
  });
  function startNotificationPolling() {
    fetchNotifications();
    if (pollingInterval) clearInterval(pollingInterval);
    pollingInterval = setInterval(fetchNotifications, 15000); // every 15s
  }
  startNotificationPolling();
</script>
</body>
</html>
