<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Events Calendar</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css">
  <style>
    body { font-family: Georgia, serif; background: #f9f6f1; color: #3b2f2f; padding: 2rem; }
    .container { max-width: 900px; margin: auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.07); padding: 2em; }
    h1 { color: #4a7c59; text-align: center; margin-bottom: 1em; }
    #calendar { margin: 2em auto; }
    .menu-button { display: block; width: fit-content; margin: 2em auto 0 auto; background-color: #4a7c59; color: #fff; padding: 10px 18px; border-radius: 6px; text-decoration: none; font-weight: bold; text-align: center; }
    .menu-button:hover { background: #388e3c; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Community Events Calendar</h1>
    <form id="event-form" style="margin-bottom:2em;background:#f3e7d3;padding:1em 2em;border-radius:8px;max-width:600px;margin:auto;">
      <h2 style="color:#4a7c59;">Add / Edit Event</h2>
      <input type="hidden" id="event-id">
      <div style="margin-bottom:1em;"><label>Title:<br><input type="text" id="event-title" required style="width:100%;padding:8px;"></label></div>
      <div style="margin-bottom:1em;"><label>Description:<br><textarea id="event-description" rows="2" style="width:100%;padding:8px;"></textarea></label></div>
      <div style="margin-bottom:1em;"><label>Location:<br><input type="text" id="event-location" style="width:100%;padding:8px;"></label></div>
      <div style="margin-bottom:1em;display:flex;gap:1em;"><label>Start Time:<br><input type="datetime-local" id="event-start" required></label><label>End Time:<br><input type="datetime-local" id="event-end"></label></div>
      <div style="margin-bottom:1em;"><label>Time Zone:<br>
        <select id="event-timezone" style="width:100%;padding:8px;">
          <option value="UTC">UTC</option>
          <option value="America/New_York">America/New_York</option>
          <option value="America/Chicago">America/Chicago</option>
          <option value="America/Denver">America/Denver</option>
          <option value="America/Los_Angeles">America/Los_Angeles</option>
          <option value="Europe/London">Europe/London</option>
          <option value="Europe/Paris">Europe/Paris</option>
          <option value="Asia/Tokyo">Asia/Tokyo</option>
          <option value="Australia/Sydney">Australia/Sydney</option>
        </select>
      </label></div>
      <div style="margin-bottom:1em;"><label>Repeats:<br>
        <select id="event-repeat" style="width:100%;padding:8px;">
          <option value="none">Does not repeat</option>
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
        </select>
      </label></div>
      <button type="submit" style="background:#4a7c59;color:#fff;padding:10px 18px;border-radius:6px;font-weight:bold;">Save Event</button>
      <button type="button" id="event-cancel" style="margin-left:1em;background:#aaa;color:#fff;padding:10px 18px;border-radius:6px;font-weight:bold;">Cancel</button>
      <div id="event-status" style="margin-top:1em;color:#a94442;font-weight:bold;"></div>
    </form>
    <div id="calendar"></div>
    <a href="menu.html" class="menu-button">‚Üê Back to Menu</a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script type="module">
    import { supabase } from '/lib/supabase.js';

    async function fetchEvents() {
      const { data, error } = await supabase
        .from('events')
        .select('id, title, description, start_time, end_time, location, timezone, repeat');
      if (error) {
        console.error('Error loading events:', error);
        return [];
      }
      // Expand repeating events
      let events = [];
      (data || []).forEach(ev => {
        if (ev.repeat && ev.repeat !== 'none') {
          // Generate up to 12 future events for display
          let start = new Date(ev.start_time);
          let end = ev.end_time ? new Date(ev.end_time) : null;
          for (let i = 0; i < 12; i++) {
            let newStart = new Date(start);
            let newEnd = end ? new Date(end) : null;
            if (ev.repeat === 'daily') {
              newStart.setDate(start.getDate() + i);
              if (newEnd) newEnd.setDate(end.getDate() + i);
            } else if (ev.repeat === 'weekly') {
              newStart.setDate(start.getDate() + i * 7);
              if (newEnd) newEnd.setDate(end.getDate() + i * 7);
            } else if (ev.repeat === 'monthly') {
              newStart.setMonth(start.getMonth() + i);
              if (newEnd) newEnd.setMonth(end.getMonth() + i);
            }
            events.push({
              id: ev.id + '-' + i,
              title: ev.title,
              start: newStart.toISOString(),
              end: newEnd ? newEnd.toISOString() : null,
              description: ev.description,
              location: ev.location,
              timezone: ev.timezone,
              repeat: ev.repeat,
              originalId: ev.id
            });
          }
        } else {
          events.push({
            id: ev.id,
            title: ev.title,
            start: ev.start_time,
            end: ev.end_time,
            description: ev.description,
            location: ev.location,
            timezone: ev.timezone,
            repeat: ev.repeat
          });
        }
      });
      return events;
    }

    let calendar;

    document.addEventListener('DOMContentLoaded', async function() {
      const calendarEl = document.getElementById('calendar');
      const events = await fetchEvents();
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        events,
        eventClick: function(info) {
          let details = `<strong>${info.event.title}</strong><br>`;
          if (info.event.extendedProps.description) details += info.event.extendedProps.description + '<br>';
          if (info.event.extendedProps.location) details += '<b>Location:</b> ' + info.event.extendedProps.location + '<br>';
          details += `<b>Start:</b> ${formatDate(info.event.start, info.event.extendedProps.timezone)}<br>`;
          if (info.event.end) details += `<b>End:</b> ${formatDate(info.event.end, info.event.extendedProps.timezone)}<br>`;
          if (info.event.extendedProps.timezone) details += `<b>Time Zone:</b> ${info.event.extendedProps.timezone}<br>`;
          if (info.event.extendedProps.repeat && info.event.extendedProps.repeat !== 'none') details += `<b>Repeats:</b> ${info.event.extendedProps.repeat}<br>`;
          details += `<button id='edit-event-btn' style='margin-top:1em;background:#4a7c59;color:#fff;padding:6px 14px;border-radius:6px;font-weight:bold;'>Edit</button>`;
          // Show details in a modal
          showModal(details);
          document.getElementById('edit-event-btn').onclick = function() {
            // Fill form with event data
            document.getElementById('event-id').value = info.event.extendedProps.originalId || info.event.id;
            document.getElementById('event-title').value = info.event.title;
            document.getElementById('event-description').value = info.event.extendedProps.description || '';
            document.getElementById('event-location').value = info.event.extendedProps.location || '';
            document.getElementById('event-start').value = info.event.start.toISOString().slice(0,16);
            document.getElementById('event-end').value = info.event.end ? info.event.end.toISOString().slice(0,16) : '';
            document.getElementById('event-timezone').value = info.event.extendedProps.timezone || 'UTC';
            document.getElementById('event-repeat').value = info.event.extendedProps.repeat || 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };
        }
      });
      calendar.render();
    });

    // Simple modal for event details
    function showModal(html) {
      let modal = document.getElementById('event-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'event-modal';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        modal.style.background = 'rgba(0,0,0,0.3)';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = '9999';
        modal.innerHTML = `<div style='background:#fff;padding:2em;border-radius:10px;max-width:400px;'>${html}<br><button id='close-modal-btn' style='margin-top:1em;background:#aaa;color:#fff;padding:6px 14px;border-radius:6px;font-weight:bold;'>Close</button></div>`;
        document.body.appendChild(modal);
        document.getElementById('close-modal-btn').onclick = function() {
          modal.remove();
        };
      } else {
        modal.innerHTML = `<div style='background:#fff;padding:2em;border-radius:10px;max-width:400px;'>${html}<br><button id='close-modal-btn' style='margin-top:1em;background:#aaa;color:#fff;padding:6px 14px;border-radius:6px;font-weight:bold;'>Close</button></div>`;
        document.getElementById('close-modal-btn').onclick = function() {
          modal.remove();
        };
      }
    }

    // Format date in time zone
    function formatDate(date, tz) {
      try {
        return new Date(date).toLocaleString('en-US', { timeZone: tz || 'UTC' });
      } catch {
        return new Date(date).toLocaleString();
      }
    }

    // Event form logic
    document.getElementById('event-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const statusDiv = document.getElementById('event-status');
      statusDiv.textContent = '';
      const id = document.getElementById('event-id').value;
      const title = document.getElementById('event-title').value.trim();
      const description = document.getElementById('event-description').value.trim();
      const location = document.getElementById('event-location').value.trim();
      const start = document.getElementById('event-start').value;
      const end = document.getElementById('event-end').value;
      const timezone = document.getElementById('event-timezone').value;
      const repeat = document.getElementById('event-repeat').value;
      if (!title || !start) {
        statusDiv.textContent = 'Title and start time are required.';
        return;
      }
      // Get current user
      const { data: { user } } = await supabase.auth.getUser();
      const created_by = user ? user.id : null;
      let error;
      if (id) {
        // Update existing event
        ({ error } = await supabase.from('events').update({
          title,
          description,
          location,
          start_time: start,
          end_time: end || null,
          timezone,
          repeat
        }).eq('id', id));
      } else {
        // Insert new event
        ({ error } = await supabase.from('events').insert({
          title,
          description,
          location,
          start_time: start,
          end_time: end || null,
          timezone,
          repeat,
          created_by
        }));
      }
      if (error) {
        statusDiv.textContent = 'Error saving event: ' + error.message;
      } else {
        statusDiv.style.color = 'green';
        statusDiv.textContent = id ? 'Event updated!' : 'Event added!';
        document.getElementById('event-form').reset();
        document.getElementById('event-id').value = '';
        // Refresh calendar events
        const events = await fetchEvents();
        calendar.removeAllEvents();
        calendar.addEventSource(events);
      }
    });

    // Cancel button resets form
    document.getElementById('event-cancel').addEventListener('click', function() {
      document.getElementById('event-form').reset();
      document.getElementById('event-id').value = '';
      document.getElementById('event-status').textContent = '';
    });
  </script>
</body>
</html>
